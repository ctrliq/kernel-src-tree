wifi: mt76: dma: fix a regression in adding rx buffers

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-496.el8
commit-author Felix Fietkau <nbd@nbd.name>
commit 953519b35227d5dbbb5c5724f1f539735fbf7781
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-496.el8/953519b3.failed

When adding WED support, mt76_dma_add_buf was accidentally changed to set
the skip_buf0 flag for tx buffers on the wrong queue descriptor entry.
Additionally, there is a rxwi leak when rx buffer allocation fails.

Fix this and make the code more readable by adding a separate function for
adding rx buffers.

	Reported-by: Mikhail Gavrilov <mikhail.v.gavrilov@gmail.com>
	Tested-by: Mikhail Gavrilov <mikhail.v.gavrilov@gmail.com>
Link: https://lore.kernel.org/r/CABXGCsMEnQd=gYKTd1knRsWuxCb=Etv5nAre%2BXJS_s5FgVteYA@mail.gmail.com/
	Reported-by: Mike Lothian <mike@fireburn.co.uk>
Link: https://bugzilla.kernel.org/show_bug.cgi?id=216829
	Reported-by: AngeloGioacchino Del Regno <angelogioacchino.delregno@collabora.com>
Link: https://lore.kernel.org/lkml/20230112171706.294550-1-angelogioacchino.delregno@collabora.com/
Fixes: cd372b8c99c5 ("wifi: mt76: add WED RX support to mt76_dma_{add,get}_buf")
	Signed-off-by: Felix Fietkau <nbd@nbd.name>
	Signed-off-by: Kalle Valo <kvalo@kernel.org>
Link: https://lore.kernel.org/r/20230113105848.34642-3-nbd@nbd.name
(cherry picked from commit 953519b35227d5dbbb5c5724f1f539735fbf7781)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/wireless/mediatek/mt76/dma.c
diff --cc drivers/net/wireless/mediatek/mt76/dma.c
index fc24b353acfc,06161815c180..000000000000
--- a/drivers/net/wireless/mediatek/mt76/dma.c
+++ b/drivers/net/wireless/mediatek/mt76/dma.c
@@@ -570,15 -612,7 +598,18 @@@ mt76_dma_rx_fill(struct mt76_dev *dev, 
  		struct mt76_queue_buf qbuf;
  		void *buf = NULL;
  
++<<<<<<< HEAD
 +		if ((q->flags & MT_QFLAG_WED) &&
 +		    FIELD_GET(MT_QFLAG_WED_TYPE, q->flags) == MT76_WED_Q_RX) {
 +			t = mt76_get_rxwi(dev);
 +			if (!t)
 +				break;
 +		}
 +
 +		buf = page_frag_alloc(&q->rx_page, q->buf_size, GFP_ATOMIC);
++=======
+ 		buf = page_frag_alloc(rx_page, q->buf_size, GFP_ATOMIC);
++>>>>>>> 953519b35227 (wifi: mt76: dma: fix a regression in adding rx buffers)
  		if (!buf)
  			break;
  
* Unmerged path drivers/net/wireless/mediatek/mt76/dma.c
