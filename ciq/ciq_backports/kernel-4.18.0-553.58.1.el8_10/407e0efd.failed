idpf: fix idpf_vport_splitq_napi_poll()

jira LE-3467
Rebuild_History Non-Buildable kernel-4.18.0-553.58.1.el8_10
commit-author Eric Dumazet <edumazet@google.com>
commit 407e0efdf8baf1672876d5948b75049860a93e59
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.58.1.el8_10/407e0efd.failed

idpf_vport_splitq_napi_poll() can incorrectly return @budget
after napi_complete_done() has been called.

This violates NAPI rules, because after napi_complete_done(),
current thread lost napi ownership.

Move the test against POLL_MODE before the napi_complete_done().

Fixes: c2d548cad150 ("idpf: add TX splitq napi poll support")
	Reported-by: Peter Newman <peternewman@google.com>
Closes: https://lore.kernel.org/netdev/20250520121908.1805732-1-edumazet@google.com/T/#u
	Signed-off-by: Eric Dumazet <edumazet@google.com>
	Cc: Joshua Hay <joshua.a.hay@intel.com>
	Cc: Alan Brady <alan.brady@intel.com>
	Cc: Madhu Chittim <madhu.chittim@intel.com>
	Cc: Phani Burra <phani.r.burra@intel.com>
	Cc: Pavan Kumar Linga <pavan.kumar.linga@intel.com>
Link: https://patch.msgid.link/20250520124030.1983936-1-edumazet@google.com
	Signed-off-by: Jakub Kicinski <kuba@kernel.org>
(cherry picked from commit 407e0efdf8baf1672876d5948b75049860a93e59)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/intel/idpf/idpf_txrx.c
diff --cc drivers/net/ethernet/intel/idpf/idpf_txrx.c
index 7501a74f8dd9,2d5f5c9f91ce..000000000000
--- a/drivers/net/ethernet/intel/idpf/idpf_txrx.c
+++ b/drivers/net/ethernet/intel/idpf/idpf_txrx.c
@@@ -3926,15 -4043,7 +3934,19 @@@ static int idpf_vport_splitq_napi_poll(
  	else
  		idpf_vport_intr_set_wb_on_itr(q_vector);
  
++<<<<<<< HEAD
 +	/* Switch to poll mode in the tear-down path after sending disable
 +	 * queues virtchnl message, as the interrupts will be disabled after
 +	 * that
 +	 */
 +	if (unlikely(q_vector->num_txq && test_bit(__IDPF_Q_POLL_MODE,
 +						   q_vector->tx[0]->flags)))
 +		return budget;
 +	else
 +		return work_done;
++=======
+ 	return work_done;
++>>>>>>> 407e0efdf8ba (idpf: fix idpf_vport_splitq_napi_poll())
  }
  
  /**
* Unmerged path drivers/net/ethernet/intel/idpf/idpf_txrx.c
