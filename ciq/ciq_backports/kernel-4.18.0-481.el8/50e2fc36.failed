drm/amdkfd: Fix UBSAN shift-out-of-bounds warning

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-481.el8
commit-author Anson Jacob <Anson.Jacob@amd.com>
commit 50e2fc36e72d4ad672032ebf646cecb48656efe0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-481.el8/50e2fc36.failed

If get_num_sdma_queues or get_num_xgmi_sdma_queues is 0, we end up
doing a shift operation where the number of bits shifted equals
number of bits in the operand. This behaviour is undefined.

Set num_sdma_queues or num_xgmi_sdma_queues to ULLONG_MAX, if the
count is >= number of bits in the operand.

Bug: https://gitlab.freedesktop.org/drm/amd/-/issues/1472

	Reported-by: Lyude Paul <lyude@redhat.com>
	Signed-off-by: Anson Jacob <Anson.Jacob@amd.com>
	Reviewed-by: Alex Deucher <alexander.deucher@amd.com>
	Reviewed-by: Felix Kuehling <Felix.Kuehling@amd.com>
	Tested-by: Lyude Paul <lyude@redhat.com>
	Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
(cherry picked from commit 50e2fc36e72d4ad672032ebf646cecb48656efe0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/amd/amdkfd/kfd_device_queue_manager.c
diff --cc drivers/gpu/drm/amd/amdkfd/kfd_device_queue_manager.c
index 007a3db69df1,965f9f230045..000000000000
--- a/drivers/gpu/drm/amd/amdkfd/kfd_device_queue_manager.c
+++ b/drivers/gpu/drm/amd/amdkfd/kfd_device_queue_manager.c
@@@ -1470,9 -1146,6 +1470,12 @@@ static int initialize_cpsch(struct devi
  	else
  		dqm->sdma_bitmap = (BIT_ULL(num_sdma_queues) - 1);
  
++<<<<<<< HEAD
 +	dqm->sdma_bitmap &= ~(get_reserved_sdma_queues_bitmap(dqm));
 +	pr_info("sdma_bitmap: %llx\n", dqm->sdma_bitmap);
 +
++=======
++>>>>>>> 50e2fc36e72d (drm/amdkfd: Fix UBSAN shift-out-of-bounds warning)
  	num_xgmi_sdma_queues = get_num_xgmi_sdma_queues(dqm);
  	if (num_xgmi_sdma_queues >= BITS_PER_TYPE(dqm->xgmi_sdma_bitmap))
  		dqm->xgmi_sdma_bitmap = ULLONG_MAX;
* Unmerged path drivers/gpu/drm/amd/amdkfd/kfd_device_queue_manager.c
