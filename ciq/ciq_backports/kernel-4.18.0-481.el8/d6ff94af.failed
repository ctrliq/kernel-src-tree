vlan: move dev_put into vlan_dev_uninit

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-481.el8
commit-author Xin Long <lucien.xin@gmail.com>
commit d6ff94afd90b0ce8d1715f8ef77d4347d7a7f2c0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-481.el8/d6ff94af.failed

Shuang Li reported an QinQ issue by simply doing:

  # ip link add dummy0 type dummy
  # ip link add link dummy0 name dummy0.1 type vlan id 1
  # ip link add link dummy0.1 name dummy0.1.2 type vlan id 2
  # rmmod 8021q

 unregister_netdevice: waiting for dummy0.1 to become free. Usage count = 1

When rmmods 8021q, all vlan devs are deleted from their real_dev's vlan grp
and added into list_kill by unregister_vlan_dev(). dummy0.1 is unregistered
before dummy0.1.2, as it's using for_each_netdev() in __rtnl_kill_links().

When unregisters dummy0.1, dummy0.1.2 is not unregistered in the event of
NETDEV_UNREGISTER, as it's been deleted from dummy0.1's vlan grp. However,
due to dummy0.1.2 still holding dummy0.1, dummy0.1 will keep waiting in
netdev_wait_allrefs(), while dummy0.1.2 will never get unregistered and
release dummy0.1, as it delays dev_put until calling dev->priv_destructor,
vlan_dev_free().

This issue was introduced by Commit 563bcbae3ba2 ("net: vlan: fix a UAF in
vlan_dev_real_dev()"), and this patch is to fix it by moving dev_put() into
vlan_dev_uninit(), which is called after NETDEV_UNREGISTER event but before
netdev_wait_allrefs().

Fixes: 563bcbae3ba2 ("net: vlan: fix a UAF in vlan_dev_real_dev()")
	Reported-by: Shuang Li <shuali@redhat.com>
	Signed-off-by: Xin Long <lucien.xin@gmail.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit d6ff94afd90b0ce8d1715f8ef77d4347d7a7f2c0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/8021q/vlan_dev.c
diff --cc net/8021q/vlan_dev.c
index 5fcad771d239,d1902828a18a..000000000000
--- a/net/8021q/vlan_dev.c
+++ b/net/8021q/vlan_dev.c
@@@ -834,9 -856,6 +839,12 @@@ static void vlan_dev_free(struct net_de
  
  	free_percpu(vlan->vlan_pcpu_stats);
  	vlan->vlan_pcpu_stats = NULL;
++<<<<<<< HEAD
 +
 +	/* Get rid of the vlan's reference to real_dev */
 +	dev_put(vlan->real_dev);
++=======
++>>>>>>> d6ff94afd90b (vlan: move dev_put into vlan_dev_uninit)
  }
  
  void vlan_setup(struct net_device *dev)
* Unmerged path net/8021q/vlan_dev.c
