net/mlx5: E-switch, Introduce flag to indicate if fdb table is created

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-481.el8
commit-author Chris Mi <cmi@nvidia.com>
commit fbd43b7259bc699e540ef8e7eb81631d57618a2e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-481.el8/fbd43b72.failed

Introduce flag to indicate if fdb table is created as a pre-step
to prepare for removing dependency between sriov and eswitch mode
in the downstream patches.

	Signed-off-by: Chris Mi <cmi@nvidia.com>
	Reviewed-by: Mark Bloch <mbloch@nvidia.com>
	Reviewed-by: Roi Dayan <roid@nvidia.com>
	Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
(cherry picked from commit fbd43b7259bc699e540ef8e7eb81631d57618a2e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/eswitch.h
diff --cc drivers/net/ethernet/mellanox/mlx5/core/eswitch.h
index 7682abe70a34,a9ba0e324834..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/eswitch.h
+++ b/drivers/net/ethernet/mellanox/mlx5/core/eswitch.h
@@@ -579,6 -567,27 +583,30 @@@ static inline bool mlx5_eswitch_is_func
  	return mlx5_core_is_ecpf_esw_manager(dev);
  }
  
++<<<<<<< HEAD
++=======
+ static inline unsigned int
+ mlx5_esw_vport_to_devlink_port_index(const struct mlx5_core_dev *dev,
+ 				     u16 vport_num)
+ {
+ 	return (MLX5_CAP_GEN(dev, vhca_id) << 16) | vport_num;
+ }
+ 
+ static inline u16
+ mlx5_esw_devlink_port_index_to_vport_num(unsigned int dl_port_index)
+ {
+ 	return dl_port_index & 0xffff;
+ }
+ 
+ static inline bool mlx5_esw_is_fdb_created(struct mlx5_eswitch *esw)
+ {
+ 	return esw->fdb_table.flags & MLX5_ESW_FDB_CREATED;
+ }
+ 
+ /* TODO: This mlx5e_tc function shouldn't be called by eswitch */
+ void mlx5e_tc_clean_fdb_peer_flows(struct mlx5_eswitch *esw);
+ 
++>>>>>>> fbd43b7259bc (net/mlx5: E-switch, Introduce flag to indicate if fdb table is created)
  /* Each mark identifies eswitch vport type.
   * MLX5_ESW_VPT_HOST_FN is used to identify both PF and VF ports using
   * a single mark.
diff --git a/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c b/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
index 7af76810cb8f..548a6fa183ef 100644
--- a/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
@@ -1274,6 +1274,8 @@ int mlx5_eswitch_enable_locked(struct mlx5_eswitch *esw, int mode, int num_vfs)
 	if (err)
 		goto abort;
 
+	esw->fdb_table.flags |= MLX5_ESW_FDB_CREATED;
+
 	mlx5_eswitch_event_handlers_register(esw);
 
 	esw_info(esw->dev, "Enable: mode(%s), nvfs(%d), active vports(%d)\n",
@@ -1356,6 +1358,7 @@ void mlx5_eswitch_disable_locked(struct mlx5_eswitch *esw, bool clear_vf)
 
 	mlx5_eswitch_event_handlers_unregister(esw);
 
+	esw->fdb_table.flags &= ~MLX5_ESW_FDB_CREATED;
 	if (esw->mode == MLX5_ESWITCH_LEGACY)
 		esw_legacy_disable(esw);
 	else if (esw->mode == MLX5_ESWITCH_OFFLOADS)
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/eswitch.h
