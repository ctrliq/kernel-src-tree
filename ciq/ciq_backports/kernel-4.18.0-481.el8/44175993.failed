perf/x86/amd: Add branch-brs helper event for Fam19h BRS

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-481.el8
commit-author Stephane Eranian <eranian@google.com>
commit 44175993efbae04e8b2d7f7795ff512c3a726db0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-481.el8/44175993.failed

Add a pseudo event called branch-brs to help use the FAM Fam19h
Branch Sampling feature (BRS). BRS samples taken branches, so it is best used
when sampling on a retired taken branch event (0xc4) which is what BRS
captures.  Instead of trying to remember the event code or actual event name,
users can simply do:

$ perf record -b -e cpu/branch-brs/ -c 1000037 .....

	Signed-off-by: Stephane Eranian <eranian@google.com>
	Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
Link: https://lore.kernel.org/r/20220322221517.2510440-5-eranian@google.com
(cherry picked from commit 44175993efbae04e8b2d7f7795ff512c3a726db0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/events/amd/core.c
diff --cc arch/x86/events/amd/core.c
index fc84e3f05348,f7bce8364fe4..000000000000
--- a/arch/x86/events/amd/core.c
+++ b/arch/x86/events/amd/core.c
@@@ -937,6 -1119,52 +937,55 @@@ static __initconst const struct x86_pm
  	.amd_nb_constraints	= 1,
  };
  
++<<<<<<< HEAD
++=======
+ static ssize_t branches_show(struct device *cdev,
+ 			      struct device_attribute *attr,
+ 			      char *buf)
+ {
+ 	return snprintf(buf, PAGE_SIZE, "%d\n", x86_pmu.lbr_nr);
+ }
+ 
+ static DEVICE_ATTR_RO(branches);
+ 
+ static struct attribute *amd_pmu_brs_attrs[] = {
+ 	&dev_attr_branches.attr,
+ 	NULL,
+ };
+ 
+ static umode_t
+ amd_brs_is_visible(struct kobject *kobj, struct attribute *attr, int i)
+ {
+ 	return x86_pmu.lbr_nr ? attr->mode : 0;
+ }
+ 
+ static struct attribute_group group_caps_amd_brs = {
+ 	.name  = "caps",
+ 	.attrs = amd_pmu_brs_attrs,
+ 	.is_visible = amd_brs_is_visible,
+ };
+ 
+ EVENT_ATTR_STR(branch-brs, amd_branch_brs,
+ 	       "event=" __stringify(AMD_FAM19H_BRS_EVENT)"\n");
+ 
+ static struct attribute *amd_brs_events_attrs[] = {
+ 	EVENT_PTR(amd_branch_brs),
+ 	NULL,
+ };
+ 
+ static struct attribute_group group_events_amd_brs = {
+ 	.name       = "events",
+ 	.attrs      = amd_brs_events_attrs,
+ 	.is_visible = amd_brs_is_visible,
+ };
+ 
+ static const struct attribute_group *amd_attr_update[] = {
+ 	&group_caps_amd_brs,
+ 	&group_events_amd_brs,
+ 	NULL,
+ };
+ 
++>>>>>>> 44175993efba (perf/x86/amd: Add branch-brs helper event for Fam19h BRS)
  static int __init amd_core_pmu_init(void)
  {
  	u64 even_ctr_mask = 0ULL;
* Unmerged path arch/x86/events/amd/core.c
