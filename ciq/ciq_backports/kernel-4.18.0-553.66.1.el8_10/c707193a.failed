Revert "smb: client: Fix netns refcount imbalance causing leaks and use-after-free"

jira LE-3845
Rebuild_History Non-Buildable kernel-4.18.0-553.66.1.el8_10
commit-author Kuniyuki Iwashima <kuniyu@amazon.com>
commit c707193a17128fae2802d10cbad7239cc57f0c95
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.66.1.el8_10/c707193a.failed

This reverts commit 4e7f1644f2ac6d01dc584f6301c3b1d5aac4eaef.

The commit e9f2517a3e18 ("smb: client: fix TCP timers deadlock after
rmmod") is not only a bogus fix for LOCKDEP null-ptr-deref but also
introduces a real issue, TCP sockets leak, which will be explained in
detail in the next revert.

Also, CNA assigned CVE-2024-54680 to it but is rejecting it. [0]

Thus, we are reverting the commit and its follow-up commit 4e7f1644f2ac
("smb: client: Fix netns refcount imbalance causing leaks and
use-after-free").

Link: https://lore.kernel.org/all/2025040248-tummy-smilingly-4240@gregkh/ #[0]
Fixes: 4e7f1644f2ac ("smb: client: Fix netns refcount imbalance causing leaks and use-after-free")
	Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
	Cc: stable@vger.kernel.org
	Signed-off-by: Steve French <stfrench@microsoft.com>
(cherry picked from commit c707193a17128fae2802d10cbad7239cc57f0c95)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/cifs/connect.c
diff --cc fs/cifs/connect.c
index bd2ad3b69c7e,370b79b2eaa6..000000000000
--- a/fs/cifs/connect.c
+++ b/fs/cifs/connect.c
@@@ -2719,6 -3365,14 +2719,17 @@@ generic_ip_connect(struct TCP_Server_In
  			return rc;
  		}
  
++<<<<<<< HEAD:fs/cifs/connect.c
++=======
+ 		/*
+ 		 * Grab netns reference for the socket.
+ 		 *
+ 		 * It'll be released here, on error, or in clean_demultiplex_info() upon server
+ 		 * teardown.
+ 		 */
+ 		get_net(net);
+ 
++>>>>>>> c707193a1712 (Revert "smb: client: Fix netns refcount imbalance causing leaks and use-after-free"):fs/smb/client/connect.c
  		/* BB other socket options to set KEEPALIVE, NODELAY? */
  		cifs_dbg(FYI, "Socket created\n");
  		socket = server->ssocket;
@@@ -2773,9 -3431,21 +2786,12 @@@
  		return rc;
  	}
  	trace_smb3_connect_done(server->hostname, server->conn_id, &server->dstaddr);
 -
 -	/*
 -	 * Establish RFC1001 NetBIOS session when it was explicitly requested
 -	 * by mount option -o nbsessinit, or when connecting to default RFC1001
 -	 * server port (139) and it was not explicitly disabled by mount option
 -	 * -o nonbsessinit.
 -	 */
 -	if (server->with_rfc1001 ||
 -	    server->rfc1001_sessinit == 1 ||
 -	    (server->rfc1001_sessinit == -1 && sport == htons(RFC1001_PORT)))
 +	if (sport == htons(RFC1001_PORT))
  		rc = ip_rfc1001_connect(server);
  
+ 	if (rc < 0)
+ 		put_net(cifs_net_ns(server));
+ 
  	return rc;
  }
  
* Unmerged path fs/cifs/connect.c
