iommu/amd: Update alloc_irq_table and alloc_irq_index

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-492.el8
commit-author Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
commit e6457d7cfca14e8f7f2199cd724c4f03abe493c2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-492.el8/e6457d7c.failed

Pass amd_iommu structure as one of the parameter to these functions
as its needed to retrieve variable tables inside these functions.

Co-developed-by: Vasant Hegde <vasant.hegde@amd.com>
	Signed-off-by: Vasant Hegde <vasant.hegde@amd.com>
	Signed-off-by: Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
Link: https://lore.kernel.org/r/20220706113825.25582-20-vasant.hegde@amd.com
	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit e6457d7cfca14e8f7f2199cd724c4f03abe493c2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/amd/iommu.c
diff --cc drivers/iommu/amd/iommu.c
index ac3701a8e645,5ee1af9a0a54..000000000000
--- a/drivers/iommu/amd/iommu.c
+++ b/drivers/iommu/amd/iommu.c
@@@ -3444,7 -3392,29 +3436,31 @@@ static void irq_remapping_deactivate(st
  					    irte_info->index);
  }
  
++<<<<<<< HEAD
++=======
+ static int irq_remapping_select(struct irq_domain *d, struct irq_fwspec *fwspec,
+ 				enum irq_domain_bus_token bus_token)
+ {
+ 	struct amd_iommu *iommu;
+ 	int devid = -1;
+ 
+ 	if (!amd_iommu_irq_remap)
+ 		return 0;
+ 
+ 	if (x86_fwspec_is_ioapic(fwspec))
+ 		devid = get_ioapic_devid(fwspec->param[0]);
+ 	else if (x86_fwspec_is_hpet(fwspec))
+ 		devid = get_hpet_devid(fwspec->param[0]);
+ 
+ 	if (devid < 0)
+ 		return 0;
+ 	iommu = __rlookup_amd_iommu((devid >> 16), (devid & 0xffff));
+ 
+ 	return iommu && iommu->ir_domain == d;
+ }
+ 
++>>>>>>> e6457d7cfca1 (iommu/amd: Update alloc_irq_table and alloc_irq_index)
  static const struct irq_domain_ops amd_ir_domain_ops = {
 -	.select = irq_remapping_select,
  	.alloc = irq_remapping_alloc,
  	.free = irq_remapping_free,
  	.activate = irq_remapping_activate,
* Unmerged path drivers/iommu/amd/iommu.c
