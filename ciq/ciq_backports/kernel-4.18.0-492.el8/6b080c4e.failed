iommu/amd: Add map/unmap_pages() iommu_domain_ops callback support

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-492.el8
commit-author Vasant Hegde <vasant.hegde@amd.com>
commit 6b080c4e815ceba3c08ffa980c858595c07e786a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-492.el8/6b080c4e.failed

Implement the map_pages() and unmap_pages() callback for the AMD IOMMU
driver to allow calls from iommu core to map and unmap multiple pages.
Also deprecate map/unmap callbacks.

Finally gatherer is not updated by iommu_v1_unmap_pages(). Hence pass
NULL instead of gather to iommu_v1_unmap_pages.

	Suggested-by: Robin Murphy <robin.murphy@arm.com>
	Signed-off-by: Vasant Hegde <vasant.hegde@amd.com>
Link: https://lore.kernel.org/r/20220825063939.8360-4-vasant.hegde@amd.com
	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit 6b080c4e815ceba3c08ffa980c858595c07e786a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/amd/iommu.c
diff --cc drivers/iommu/amd/iommu.c
index 1a3fd46dcc44,07c47a7088be..000000000000
--- a/drivers/iommu/amd/iommu.c
+++ b/drivers/iommu/amd/iommu.c
@@@ -2273,12 -2396,21 +2276,27 @@@ const struct iommu_ops amd_iommu_ops = 
  	.probe_finalize = amd_iommu_probe_finalize,
  	.device_group = amd_iommu_device_group,
  	.get_resv_regions = amd_iommu_get_resv_regions,
 +	.put_resv_regions = generic_iommu_put_resv_regions,
  	.is_attach_deferred = amd_iommu_is_attach_deferred,
  	.pgsize_bitmap	= AMD_IOMMU_PGSIZES,
 +	.flush_iotlb_all = amd_iommu_flush_iotlb_all,
 +	.iotlb_sync = amd_iommu_iotlb_sync,
  	.def_domain_type = amd_iommu_def_domain_type,
++<<<<<<< HEAD
++=======
+ 	.default_domain_ops = &(const struct iommu_domain_ops) {
+ 		.attach_dev	= amd_iommu_attach_device,
+ 		.detach_dev	= amd_iommu_detach_device,
+ 		.map_pages	= amd_iommu_map_pages,
+ 		.unmap_pages	= amd_iommu_unmap_pages,
+ 		.iotlb_sync_map	= amd_iommu_iotlb_sync_map,
+ 		.iova_to_phys	= amd_iommu_iova_to_phys,
+ 		.flush_iotlb_all = amd_iommu_flush_iotlb_all,
+ 		.iotlb_sync	= amd_iommu_iotlb_sync,
+ 		.free		= amd_iommu_domain_free,
+ 		.enforce_cache_coherency = amd_iommu_enforce_cache_coherency,
+ 	}
++>>>>>>> 6b080c4e815c (iommu/amd: Add map/unmap_pages() iommu_domain_ops callback support)
  };
  
  /*****************************************************************************
* Unmerged path drivers/iommu/amd/iommu.c
