iommu/vt-d: Support cpumask for IOMMU perfmon

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-492.el8
commit-author Kan Liang <kan.liang@linux.intel.com>
commit 46284c6ceb5e4dfddcb00dafb7c2f3c1437fdca4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-492.el8/46284c6c.failed

The perf subsystem assumes that all counters are by default per-CPU. So
the user space tool reads a counter from each CPU. However, the IOMMU
counters are system-wide and can be read from any CPU. Here we use a CPU
mask to restrict counting to one CPU to handle the issue. (with CPU
hotplug notifier to choose a different CPU if the chosen one is taken
off-line).

The CPU is exposed to /sys/bus/event_source/devices/dmar*/cpumask for
the user space perf tool.

	Signed-off-by: Kan Liang <kan.liang@linux.intel.com>
Link: https://lore.kernel.org/r/20230128200428.1459118-6-kan.liang@linux.intel.com
	Signed-off-by: Lu Baolu <baolu.lu@linux.intel.com>
	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit 46284c6ceb5e4dfddcb00dafb7c2f3c1437fdca4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	Documentation/ABI/testing/sysfs-bus-event_source-devices-iommu
#	drivers/iommu/intel/perfmon.c
#	include/linux/cpuhotplug.h
diff --cc include/linux/cpuhotplug.h
index 0547ff9b75cc,f2ea348ce3b0..000000000000
--- a/include/linux/cpuhotplug.h
+++ b/include/linux/cpuhotplug.h
@@@ -162,9 -220,9 +162,14 @@@ enum cpuhp_state 
  	CPUHP_AP_PERF_X86_RAPL_ONLINE,
  	CPUHP_AP_PERF_X86_CQM_ONLINE,
  	CPUHP_AP_PERF_X86_CSTATE_ONLINE,
++<<<<<<< HEAD
 +	/* kABI: CPUHP_AP_PERF_X86_IDXD_ONLINE, */
++=======
+ 	CPUHP_AP_PERF_X86_IDXD_ONLINE,
+ 	CPUHP_AP_PERF_X86_IOMMU_PERF_ONLINE,
++>>>>>>> 46284c6ceb5e (iommu/vt-d: Support cpumask for IOMMU perfmon)
  	CPUHP_AP_PERF_S390_CF_ONLINE,
 +	/* kABI: CPUHP_AP_PERF_S390_CFD_ONLINE, */
  	CPUHP_AP_PERF_S390_SF_ONLINE,
  	CPUHP_AP_PERF_ARM_CCI_ONLINE,
  	CPUHP_AP_PERF_ARM_CCN_ONLINE,
* Unmerged path Documentation/ABI/testing/sysfs-bus-event_source-devices-iommu
* Unmerged path drivers/iommu/intel/perfmon.c
* Unmerged path Documentation/ABI/testing/sysfs-bus-event_source-devices-iommu
* Unmerged path drivers/iommu/intel/perfmon.c
* Unmerged path include/linux/cpuhotplug.h
