rxrpc: Fold __rxrpc_unuse_local() into rxrpc_unuse_local()

jira LE-1907
Rebuild_History Non-Buildable kernel-5.14.0-284.30.1.el9_2
commit-author David Howells <dhowells@redhat.com>
commit a2cf3264f331acfeb7e463ad7b7fe1ac647a829d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-5.14.0-284.30.1.el9_2/a2cf3264.failed

Fold __rxrpc_unuse_local() into rxrpc_unuse_local() as the latter is now
the only user of the former.

	Signed-off-by: David Howells <dhowells@redhat.com>
cc: Marc Dionne <marc.dionne@auristor.com>
cc: linux-afs@lists.infradead.org
(cherry picked from commit a2cf3264f331acfeb7e463ad7b7fe1ac647a829d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/rxrpc/ar-internal.h
#	net/rxrpc/local_object.c
diff --cc net/rxrpc/ar-internal.h
index 46ce41afb431,2a4928249a64..000000000000
--- a/net/rxrpc/ar-internal.h
+++ b/net/rxrpc/ar-internal.h
@@@ -967,22 -994,33 +967,27 @@@ extern void rxrpc_process_local_events(
   * local_object.c
   */
  struct rxrpc_local *rxrpc_lookup_local(struct net *, const struct sockaddr_rxrpc *);
 -struct rxrpc_local *rxrpc_get_local(struct rxrpc_local *, enum rxrpc_local_trace);
 -struct rxrpc_local *rxrpc_get_local_maybe(struct rxrpc_local *, enum rxrpc_local_trace);
 -void rxrpc_put_local(struct rxrpc_local *, enum rxrpc_local_trace);
 -struct rxrpc_local *rxrpc_use_local(struct rxrpc_local *, enum rxrpc_local_trace);
 -void rxrpc_unuse_local(struct rxrpc_local *, enum rxrpc_local_trace);
 -void rxrpc_destroy_local(struct rxrpc_local *local);
 +struct rxrpc_local *rxrpc_get_local(struct rxrpc_local *);
 +struct rxrpc_local *rxrpc_get_local_maybe(struct rxrpc_local *);
 +void rxrpc_put_local(struct rxrpc_local *);
 +struct rxrpc_local *rxrpc_use_local(struct rxrpc_local *);
 +void rxrpc_unuse_local(struct rxrpc_local *);
 +void rxrpc_queue_local(struct rxrpc_local *);
  void rxrpc_destroy_all_locals(struct rxrpc_net *);
  
 -static inline bool __rxrpc_use_local(struct rxrpc_local *local,
 -				     enum rxrpc_local_trace why)
++<<<<<<< HEAD
 +static inline bool __rxrpc_unuse_local(struct rxrpc_local *local)
  {
 -	int r, u;
 -
 -	r = refcount_read(&local->ref);
 -	u = atomic_fetch_add_unless(&local->active_users, 1, 0);
 -	trace_rxrpc_local(local->debug_id, why, r, u);
 -	return u != 0;
 +	return atomic_dec_return(&local->active_users) == 0;
  }
  
 -static inline void rxrpc_see_local(struct rxrpc_local *local,
 -				   enum rxrpc_local_trace why)
 +static inline bool __rxrpc_use_local(struct rxrpc_local *local)
++=======
++static inline bool __rxrpc_use_local(struct rxrpc_local *local,
++				     enum rxrpc_local_trace why)
++>>>>>>> a2cf3264f331 (rxrpc: Fold __rxrpc_unuse_local() into rxrpc_unuse_local())
  {
 -	int r, u;
 -
 -	r = refcount_read(&local->ref);
 -	u = atomic_read(&local->active_users);
 -	trace_rxrpc_local(local->debug_id, why, r, u);
 +	return atomic_fetch_add_unless(&local->active_users, 1, 0) != 0;
  }
  
  /*
diff --cc net/rxrpc/local_object.c
index 846558613c7f,1e994a83db2b..000000000000
--- a/net/rxrpc/local_object.c
+++ b/net/rxrpc/local_object.c
@@@ -347,15 -355,19 +347,27 @@@ struct rxrpc_local *rxrpc_use_local(str
  
  /*
   * Cease using a local endpoint.  Once the number of active users reaches 0, we
 - * start the closure of the transport in the I/O thread..
 + * start the closure of the transport in the work processor.
   */
 -void rxrpc_unuse_local(struct rxrpc_local *local, enum rxrpc_local_trace why)
 +void rxrpc_unuse_local(struct rxrpc_local *local)
  {
++<<<<<<< HEAD
 +	if (local) {
 +		if (__rxrpc_unuse_local(local)) {
 +			rxrpc_get_local(local);
 +			rxrpc_queue_local(local);
 +		}
++=======
+ 	unsigned int debug_id = local->debug_id;
+ 	int r, u;
+ 
+ 	if (local) {
+ 		r = refcount_read(&local->ref);
+ 		u = atomic_dec_return(&local->active_users);
+ 		trace_rxrpc_local(debug_id, why, r, u);
+ 		if (u == 0)
+ 			kthread_stop(local->io_thread);
++>>>>>>> a2cf3264f331 (rxrpc: Fold __rxrpc_unuse_local() into rxrpc_unuse_local())
  	}
  }
  
* Unmerged path net/rxrpc/ar-internal.h
* Unmerged path net/rxrpc/local_object.c
