selftests/vm: anon_cow: add liburing test cases

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-542.el8
commit-author David Hildenbrand <david@redhat.com>
commit e487ebbd12986facc7f77129d3ca80de84841170
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-542.el8/e487ebbd.failed

io_uring provides a simple mechanism to test long-term, R/W GUP pins
-- via fixed buffers -- and can be used to verify that GUP pins stay
in sync with the pages in the page table even if a page would
temporarily get mapped R/O or concurrent fork() could accidentially
end up sharing pinned pages with the child.

Note that this essentially re-introduces local_config support that was
removed recently in commit 6f83d6c74ea5 ("Kselftests: remove support of
libhugetlbfs from kselftests").

[david@redhat.com: s/size_t/ssize_t/ on `cur', `total'.]
  Link: https://lkml.kernel.org/r/445fe1ae-9e22-0d1d-4d09-272231d2f84a@redhat.com
Link: https://lkml.kernel.org/r/20220927110120.106906-6-david@redhat.com
	Signed-off-by: David Hildenbrand <david@redhat.com>
	Cc: Andrea Arcangeli <aarcange@redhat.com>
	Cc: Christoph von Recklinghausen <crecklin@redhat.com>
	Cc: Don Dutile <ddutile@redhat.com>
	Cc: Jason Gunthorpe <jgg@nvidia.com>
	Cc: John Hubbard <jhubbard@nvidia.com>
	Cc: Mike Rapoport <rppt@kernel.org>
	Cc: Nadav Amit <namit@vmware.com>
	Cc: Peter Xu <peterx@redhat.com>
	Cc: Shuah Khan <shuah@kernel.org>
	Cc: Vlastimil Babka <vbabka@suse.cz>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
(cherry picked from commit e487ebbd12986facc7f77129d3ca80de84841170)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/vm/Makefile
#	tools/testing/selftests/vm/anon_cow.c
#	tools/testing/selftests/vm/check_config.sh
diff --cc tools/testing/selftests/vm/Makefile
index 7799278a1068,00920cb8b499..000000000000
--- a/tools/testing/selftests/vm/Makefile
+++ b/tools/testing/selftests/vm/Makefile
@@@ -134,21 -154,25 +134,42 @@@ warn_32bit_failure
  endif
  endif
  
++<<<<<<< HEAD
 +$(OUTPUT)/mlock-random-test: LDLIBS += -lcap
++=======
+ # ANON_COW_EXTRA_LIBS may get set in local_config.mk, or it may be left empty.
+ $(OUTPUT)/anon_cow: LDLIBS += $(ANON_COW_EXTRA_LIBS)
+ 
+ $(OUTPUT)/mlock-random-test $(OUTPUT)/memfd_secret: LDLIBS += -lcap
++>>>>>>> e487ebbd1298 (selftests/vm: anon_cow: add liburing test cases)
  
 -$(OUTPUT)/ksm_tests: LDLIBS += -lnuma
 +# HMM_EXTRA_LIBS may get set in local_config.mk, or it may be left empty.
 +$(OUTPUT)/hmm-tests: LDLIBS += $(HMM_EXTRA_LIBS)
  
++<<<<<<< HEAD
++=======
+ $(OUTPUT)/migration: LDLIBS += -lnuma
+ 
++>>>>>>> e487ebbd1298 (selftests/vm: anon_cow: add liburing test cases)
  local_config.mk local_config.h: check_config.sh
  	/bin/sh ./check_config.sh $(CC)
  
  EXTRA_CLEAN += local_config.mk local_config.h
  
++<<<<<<< HEAD
 +ifeq ($(HMM_EXTRA_LIBS),)
 +all: warn_missing_hugelibs
 +
 +warn_missing_hugelibs:
 +	@echo ; \
 +	echo "Warning: missing libhugetlbfs support. Some HMM tests will be skipped." ; \
++=======
+ ifeq ($(ANON_COW_EXTRA_LIBS),)
+ all: warn_missing_liburing
+ 
+ warn_missing_liburing:
+ 	@echo ; \
+ 	echo "Warning: missing liburing support. Some COW tests will be skipped." ; \
++>>>>>>> e487ebbd1298 (selftests/vm: anon_cow: add liburing test cases)
  	echo
  endif
diff --cc tools/testing/selftests/vm/check_config.sh
index 079c8a40b85d,9a44c6520925..000000000000
--- a/tools/testing/selftests/vm/check_config.sh
+++ b/tools/testing/selftests/vm/check_config.sh
@@@ -7,25 -7,25 +7,43 @@@
  OUTPUT_H_FILE=local_config.h
  OUTPUT_MKFILE=local_config.mk
  
++<<<<<<< HEAD
 +# libhugetlbfs
++=======
++>>>>>>> e487ebbd1298 (selftests/vm: anon_cow: add liburing test cases)
  tmpname=$(mktemp)
  tmpfile_c=${tmpname}.c
  tmpfile_o=${tmpname}.o
  
++<<<<<<< HEAD
 +echo "#include <sys/types.h>"        > $tmpfile_c
 +echo "#include <hugetlbfs.h>"       >> $tmpfile_c
++=======
+ # liburing
+ echo "#include <sys/types.h>"        > $tmpfile_c
+ echo "#include <liburing.h>"        >> $tmpfile_c
++>>>>>>> e487ebbd1298 (selftests/vm: anon_cow: add liburing test cases)
  echo "int func(void) { return 0; }" >> $tmpfile_c
  
  CC=${1:?"Usage: $0 <compiler> # example compiler: gcc"}
  $CC -c $tmpfile_c -o $tmpfile_o >/dev/null 2>&1
  
  if [ -f $tmpfile_o ]; then
++<<<<<<< HEAD
 +    echo "#define LOCAL_CONFIG_HAVE_LIBHUGETLBFS 1" > $OUTPUT_H_FILE
 +    echo "HMM_EXTRA_LIBS = -lhugetlbfs"             > $OUTPUT_MKFILE
 +else
 +    echo "// No libhugetlbfs support found"      > $OUTPUT_H_FILE
 +    echo "# No libhugetlbfs support found, so:"  > $OUTPUT_MKFILE
 +    echo "HMM_EXTRA_LIBS = "                    >> $OUTPUT_MKFILE
++=======
+     echo "#define LOCAL_CONFIG_HAVE_LIBURING 1"  > $OUTPUT_H_FILE
+     echo "ANON_COW_EXTRA_LIBS = -luring"         > $OUTPUT_MKFILE
+ else
+     echo "// No liburing support found"          > $OUTPUT_H_FILE
+     echo "# No liburing support found, so:"      > $OUTPUT_MKFILE
+     echo "ANON_COW_EXTRA_LIBS = "               >> $OUTPUT_MKFILE
++>>>>>>> e487ebbd1298 (selftests/vm: anon_cow: add liburing test cases)
  fi
  
  rm ${tmpname}.*
* Unmerged path tools/testing/selftests/vm/anon_cow.c
* Unmerged path tools/testing/selftests/vm/Makefile
* Unmerged path tools/testing/selftests/vm/anon_cow.c
* Unmerged path tools/testing/selftests/vm/check_config.sh
