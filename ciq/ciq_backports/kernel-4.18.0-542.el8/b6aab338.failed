selftests/mm/kugepaged: restore thp settings at exit

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-542.el8
commit-author Ryan Roberts <ryan.roberts@arm.com>
commit b6aab3384cafba151c53d3b5f7e1f8d073aadf03
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-542.el8/b6aab338.failed

Previously, the saved thp settings would be restored upon a signal or at
the natural end of the test suite.  But there are some tests that directly
call exit() upon failure.  In this case, the thp settings were not being
restored, which could then influence other tests.

Fix this by installing an atexit() handler to do the actual restore.  The
signal handler can now just call exit() and the atexit handler is invoked.

Link: https://lkml.kernel.org/r/20231207161211.2374093-6-ryan.roberts@arm.com
	Signed-off-by: Ryan Roberts <ryan.roberts@arm.com>
	Reviewed-by: Alistair Popple <apopple@nvidia.com>
	Reviewed-by: David Hildenbrand <david@redhat.com>
	Tested-by: Kefeng Wang <wangkefeng.wang@huawei.com>
	Tested-by: John Hubbard <jhubbard@nvidia.com>
	Cc: Anshuman Khandual <anshuman.khandual@arm.com>
	Cc: Barry Song <v-songbaohua@oppo.com>
	Cc: Catalin Marinas <catalin.marinas@arm.com>
	Cc: David Rientjes <rientjes@google.com>
	Cc: "Huang, Ying" <ying.huang@intel.com>
	Cc: Hugh Dickins <hughd@google.com>
	Cc: Itaru Kitayama <itaru.kitayama@gmail.com>
	Cc: Kirill A. Shutemov <kirill.shutemov@linux.intel.com>
	Cc: Luis Chamberlain <mcgrof@kernel.org>
	Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
	Cc: Vlastimil Babka <vbabka@suse.cz>
	Cc: Yang Shi <shy828301@gmail.com>
	Cc: Yin Fengwei <fengwei.yin@intel.com>
	Cc: Yu Zhao <yuzhao@google.com>
	Cc: Zi Yan <ziy@nvidia.com>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
(cherry picked from commit b6aab3384cafba151c53d3b5f7e1f8d073aadf03)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/mm/khugepaged.c
* Unmerged path tools/testing/selftests/mm/khugepaged.c
* Unmerged path tools/testing/selftests/mm/khugepaged.c
