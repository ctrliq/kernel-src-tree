driver core: introduce device_set_driver() helper

jira LE-3587
Rebuild_History Non-Buildable kernel-4.18.0-553.62.1.el8_10
commit-author Dmitry Torokhov <dmitry.torokhov@gmail.com>
commit 04d3e5461c1f5cf8eec964ab64948ebed826e95e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.62.1.el8_10/04d3e546.failed

In preparation to closing a race when reading driver pointer in
dev_uevent() code, instead of setting device->driver pointer directly
introduce device_set_driver() helper.

	Signed-off-by: Dmitry Torokhov <dmitry.torokhov@gmail.com>
	Reviewed-by: Masami Hiramatsu (Google) <mhiramat@kernel.org>
Link: https://lore.kernel.org/r/20250311052417.1846985-2-dmitry.torokhov@gmail.com
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 04d3e5461c1f5cf8eec964ab64948ebed826e95e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/base/base.h
#	drivers/base/dd.c
diff --cc drivers/base/base.h
index f1ca94ed4ea3,eb203cf8370b..000000000000
--- a/drivers/base/base.h
+++ b/drivers/base/base.h
@@@ -161,19 -176,23 +161,33 @@@ static inline void dev_sync_state(struc
  		dev->driver->sync_state(dev);
  }
  
 -int driver_add_groups(const struct device_driver *drv, const struct attribute_group **groups);
 -void driver_remove_groups(const struct device_driver *drv, const struct attribute_group **groups);
 +extern int driver_add_groups(struct device_driver *drv,
 +			     const struct attribute_group **groups);
 +extern void driver_remove_groups(struct device_driver *drv,
 +				 const struct attribute_group **groups);
  void device_driver_detach(struct device *dev);
  
++<<<<<<< HEAD
 +extern int devres_release_all(struct device *dev);
 +extern void device_block_probing(void);
 +extern void device_unblock_probing(void);
++=======
+ static inline void device_set_driver(struct device *dev, const struct device_driver *drv)
+ {
+ 	// FIXME - this cast should not be needed "soon"
+ 	dev->driver = (struct device_driver *)drv;
+ }
+ 
+ int devres_release_all(struct device *dev);
+ void device_block_probing(void);
+ void device_unblock_probing(void);
+ void deferred_probe_extend_timeout(void);
+ void driver_deferred_probe_trigger(void);
++>>>>>>> 04d3e5461c1f (driver core: introduce device_set_driver() helper)
  const char *device_get_devnode(const struct device *dev, umode_t *mode,
  			       kuid_t *uid, kgid_t *gid, const char **tmp);
 +extern void deferred_probe_extend_timeout(void);
 +extern void driver_deferred_probe_trigger(void);
  
  /* /sys/devices directory */
  extern struct kset *devices_kset;
diff --cc drivers/base/dd.c
index 9c5db2007422,b526e0e0f52d..000000000000
--- a/drivers/base/dd.c
+++ b/drivers/base/dd.c
@@@ -648,12 -620,16 +648,16 @@@ static int really_probe(struct device *
  	if (link_ret == -EPROBE_DEFER)
  		return link_ret;
  
 -	dev_dbg(dev, "bus: '%s': %s: probing driver %s with device\n",
 -		drv->bus->name, __func__, drv->name);
 -	if (!list_empty(&dev->devres_head)) {
 -		dev_crit(dev, "Resources present before probing\n");
 -		ret = -EBUSY;
 -		goto done;
 -	}
 +	pr_debug("bus: '%s': %s: probing driver %s with device %s\n",
 +		 drv->bus->name, __func__, drv->name, dev_name(dev));
 +	WARN_ON(!list_empty(&dev->devres_head));
  
  re_probe:
++<<<<<<< HEAD
 +	dev->driver = drv;
++=======
+ 	device_set_driver(dev, drv);
++>>>>>>> 04d3e5461c1f (driver core: introduce device_set_driver() helper)
  
  	/* If using pinctrl, bind pins now before probing */
  	ret = pinctrl_bind_pins(dev);
* Unmerged path drivers/base/base.h
diff --git a/drivers/base/core.c b/drivers/base/core.c
index 85168dc6be18..2e041155b2da 100644
--- a/drivers/base/core.c
+++ b/drivers/base/core.c
@@ -3603,7 +3603,7 @@ int device_add(struct device *dev)
 	device_pm_remove(dev);
 	dpm_sysfs_remove(dev);
  DPMError:
-	dev->driver = NULL;
+	device_set_driver(dev, NULL);
 	bus_remove_device(dev);
  BusError:
 	device_remove_attrs(dev);
* Unmerged path drivers/base/dd.c
