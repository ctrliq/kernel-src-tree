mm/slab: make __free(kfree) accept error pointers

jira LE-3587
Rebuild_History Non-Buildable kernel-4.18.0-553.62.1.el8_10
commit-author Dan Carpenter <dan.carpenter@linaro.org>
commit cd7eb8f83fcf258f71e293f7fc52a70be8ed0128
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.62.1.el8_10/cd7eb8f8.failed

Currently, if an automatically freed allocation is an error pointer that
will lead to a crash.  An example of this is in wm831x_gpio_dbg_show().

   171	char *label __free(kfree) = gpiochip_dup_line_label(chip, i);
   172	if (IS_ERR(label)) {
   173		dev_err(wm831x->dev, "Failed to duplicate label\n");
   174		continue;
   175  }

The auto clean up function should check for error pointers as well,
otherwise we're going to keep hitting issues like this.

Fixes: 54da6a092431 ("locking: Introduce __cleanup() based infrastructure")
	Cc: <stable@vger.kernel.org>
	Signed-off-by: Dan Carpenter <dan.carpenter@linaro.org>
	Acked-by: David Rientjes <rientjes@google.com>
	Signed-off-by: Vlastimil Babka <vbabka@suse.cz>
(cherry picked from commit cd7eb8f83fcf258f71e293f7fc52a70be8ed0128)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/linux/slab.h
diff --cc include/linux/slab.h
index 7cec7ba2bcd8,739b21262507..000000000000
--- a/include/linux/slab.h
+++ b/include/linux/slab.h
@@@ -185,11 -261,12 +185,20 @@@ int kmem_cache_shrink(struct kmem_cach
  /*
   * Common kmalloc functions provided by all allocators
   */
++<<<<<<< HEAD
 +void * __must_check __krealloc(const void *, size_t, gfp_t);
 +void * __must_check krealloc(const void *, size_t, gfp_t);
 +void kfree(const void *);
 +void kfree_sensitive(const void *);
 +size_t __ksize(const void *);
++=======
+ void * __must_check krealloc(const void *objp, size_t new_size, gfp_t flags) __realloc_size(2);
+ void kfree(const void *objp);
+ void kfree_sensitive(const void *objp);
+ size_t __ksize(const void *objp);
+ 
+ DEFINE_FREE(kfree, void *, if (!IS_ERR_OR_NULL(_T)) kfree(_T))
++>>>>>>> cd7eb8f83fcf (mm/slab: make __free(kfree) accept error pointers)
  
  /**
   * ksize - Report actual allocation size of associated object
@@@ -772,9 -789,11 +781,14 @@@ static inline void *kvcalloc(size_t n, 
  	return kvmalloc_array(n, size, flags | __GFP_ZERO);
  }
  
 -extern void *kvrealloc(const void *p, size_t oldsize, size_t newsize, gfp_t flags)
 -		      __realloc_size(3);
 +extern void *kvrealloc(const void *p, size_t oldsize, size_t newsize,
 +		gfp_t flags);
  extern void kvfree(const void *addr);
++<<<<<<< HEAD
++=======
+ DEFINE_FREE(kvfree, void *, if (!IS_ERR_OR_NULL(_T)) kvfree(_T))
+ 
++>>>>>>> cd7eb8f83fcf (mm/slab: make __free(kfree) accept error pointers)
  extern void kvfree_sensitive(const void *addr, size_t len);
  
  unsigned int kmem_cache_size(struct kmem_cache *s);
* Unmerged path include/linux/slab.h
