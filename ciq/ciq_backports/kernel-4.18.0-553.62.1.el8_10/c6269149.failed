file: add take_fd() cleanup helper

jira LE-3587
Rebuild_History Non-Buildable kernel-4.18.0-553.62.1.el8_10
commit-author Christian Brauner <brauner@kernel.org>
commit c6269149cbf7053272d918101981869438ff7c1e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.62.1.el8_10/c6269149.failed

Add a helper that returns the file descriptor and ensures that the old
variable contains a negative value. This makes it easy to rely on
CLASS(get_unused_fd).

Link: https://lore.kernel.org/r/20240627-work-pidfs-v1-1-7e9ab6cc3bb1@kernel.org
	Reviewed-by: Jeff Layton <jlayton@kernel.org>
	Reviewed-by: Josef Bacik <josef@toxicpanda.com>
	Reviewed-by: Alexander Mikhalitsyn <aleksandr.mikhalitsyn@canonical.com>
	Signed-off-by: Christian Brauner <brauner@kernel.org>
(cherry picked from commit c6269149cbf7053272d918101981869438ff7c1e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/linux/cleanup.h
#	include/linux/file.h
diff --cc include/linux/file.h
index e6f5d05a242c,237931f20739..000000000000
--- a/include/linux/file.h
+++ b/include/linux/file.h
@@@ -89,8 -94,35 +89,34 @@@ extern int __get_unused_fd_flags(unsign
  extern int get_unused_fd_flags(unsigned flags);
  extern void put_unused_fd(unsigned int fd);
  
++<<<<<<< HEAD
++=======
+ DEFINE_CLASS(get_unused_fd, int, if (_T >= 0) put_unused_fd(_T),
+ 	     get_unused_fd_flags(flags), unsigned flags)
+ 
+ /*
+  * take_fd() will take care to set @fd to -EBADF ensuring that
+  * CLASS(get_unused_fd) won't call put_unused_fd(). This makes it
+  * easier to rely on CLASS(get_unused_fd):
+  *
+  * struct file *f;
+  *
+  * CLASS(get_unused_fd, fd)(O_CLOEXEC);
+  * if (fd < 0)
+  *         return fd;
+  *
+  * f = dentry_open(&path, O_RDONLY, current_cred());
+  * if (IS_ERR(f))
+  *         return PTR_ERR(fd);
+  *
+  * fd_install(fd, f);
+  * return take_fd(fd);
+  */
+ #define take_fd(fd) __get_and_null(fd, -EBADF)
+ 
++>>>>>>> c6269149cbf7 (file: add take_fd() cleanup helper)
  extern void fd_install(unsigned int fd, struct file *file);
  
 -int receive_fd(struct file *file, int __user *ufd, unsigned int o_flags);
 -
 -int receive_fd_replace(int new_fd, struct file *file, unsigned int o_flags);
 -
  extern void flush_delayed_fput(void);
  extern void __fput_sync(struct file *);
  
* Unmerged path include/linux/cleanup.h
* Unmerged path include/linux/cleanup.h
* Unmerged path include/linux/file.h
