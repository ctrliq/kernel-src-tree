net/mlx5: Move IPsec file to relevant directory

jira LE-1907
Rebuild_History Non-Buildable kernel-rt-4.18.0-477.10.1.rt7.274.el8_8
commit-author Leon Romanovsky <leonro@nvidia.com>
commit 16fe5a1c5c074a836626e3bd9560d3c4a39a3fcf
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-rt-4.18.0-477.10.1.rt7.274.el8_8/16fe5a1c.failed

IPsec is part of ethernet side of mlx5 driver and needs to be placed
in en_accel folder.

Link: https://lore.kernel.org/r/a0ca88f4d9c602c574106c0de0511803e7dcbdff.1649232994.git.leonro@nvidia.com
	Reviewed-by: Raed Salem <raeds@nvidia.com>
	Signed-off-by: Leon Romanovsky <leonro@nvidia.com>
(cherry picked from commit 16fe5a1c5c074a836626e3bd9560d3c4a39a3fcf)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/Makefile
#	drivers/net/ethernet/mellanox/mlx5/core/en/params.c
#	drivers/net/ethernet/mellanox/mlx5/core/en_accel/accel.h
#	drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec.h
#	drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec_stats.c
#	drivers/net/ethernet/mellanox/mlx5/core/en_main.c
#	drivers/net/ethernet/mellanox/mlx5/core/en_rx.c
#	drivers/net/ethernet/mellanox/mlx5/core/main.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/Makefile
index 4bc666714a35,f7aafbfcdb61..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/Makefile
+++ b/drivers/net/ethernet/mellanox/mlx5/core/Makefile
@@@ -96,9 -93,10 +96,14 @@@ mlx5_core-$(CONFIG_MLX5_ACCEL)      += 
  mlx5_core-$(CONFIG_MLX5_FPGA) += fpga/cmd.o fpga/core.o fpga/conn.o fpga/sdk.o
  
  mlx5_core-$(CONFIG_MLX5_EN_IPSEC) += en_accel/ipsec.o en_accel/ipsec_rxtx.o \
++<<<<<<< HEAD
 +				     en_accel/ipsec_stats.o en_accel/ipsec_fs.o
++=======
+ 				     en_accel/ipsec_stats.o en_accel/ipsec_fs.o \
+ 				     en_accel/ipsec_offload.o
++>>>>>>> 16fe5a1c5c07 (net/mlx5: Move IPsec file to relevant directory)
  
 -mlx5_core-$(CONFIG_MLX5_EN_TLS) += en_accel/ktls_stats.o \
 +mlx5_core-$(CONFIG_MLX5_EN_TLS) += en_accel/tls.o en_accel/tls_rxtx.o en_accel/tls_stats.o \
  				   en_accel/fs_tcp.o en_accel/ktls.o en_accel/ktls_txrx.o \
  				   en_accel/ktls_tx.o en_accel/ktls_rx.o
  
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en/params.c
index 5c4711be6fae,1e8700957280..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en/params.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en/params.c
@@@ -5,8 -5,7 +5,12 @@@
  #include "en/txrx.h"
  #include "en/port.h"
  #include "en_accel/en_accel.h"
++<<<<<<< HEAD
 +#include "accel/ipsec.h"
 +#include "fpga/ipsec.h"
++=======
+ #include "en_accel/ipsec_offload.h"
++>>>>>>> 16fe5a1c5c07 (net/mlx5: Move IPsec file to relevant directory)
  
  static bool mlx5e_rx_is_xdp(struct mlx5e_params *params,
  			    struct mlx5e_xsk_param *xsk)
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec.h
index 45f71910d196,a0e9dade09e9..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec.h
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec.h
@@@ -40,7 -40,7 +40,11 @@@
  #include <net/xfrm.h>
  #include <linux/idr.h>
  
++<<<<<<< HEAD
 +#include "accel/ipsec.h"
++=======
+ #include "ipsec_offload.h"
++>>>>>>> 16fe5a1c5c07 (net/mlx5: Move IPsec file to relevant directory)
  
  #define MLX5E_IPSEC_SADB_RX_BITS 10
  #define MLX5E_IPSEC_ESN_SCOPE_MID 0x80000000L
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec_stats.c
index 5cb936541b9e,3aace1c2a763..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec_stats.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec_stats.c
@@@ -35,27 -35,9 +35,31 @@@
  #include <net/sock.h>
  
  #include "en.h"
++<<<<<<< HEAD
 +#include "accel/ipsec.h"
++=======
+ #include "ipsec_offload.h"
++>>>>>>> 16fe5a1c5c07 (net/mlx5: Move IPsec file to relevant directory)
  #include "fpga/sdk.h"
  #include "en_accel/ipsec.h"
 +#include "fpga/ipsec.h"
 +
 +static const struct counter_desc mlx5e_ipsec_hw_stats_desc[] = {
 +	{ MLX5E_DECLARE_STAT(struct mlx5e_ipsec_stats, ipsec_dec_in_packets) },
 +	{ MLX5E_DECLARE_STAT(struct mlx5e_ipsec_stats, ipsec_dec_out_packets) },
 +	{ MLX5E_DECLARE_STAT(struct mlx5e_ipsec_stats, ipsec_dec_bypass_packets) },
 +	{ MLX5E_DECLARE_STAT(struct mlx5e_ipsec_stats, ipsec_enc_in_packets) },
 +	{ MLX5E_DECLARE_STAT(struct mlx5e_ipsec_stats, ipsec_enc_out_packets) },
 +	{ MLX5E_DECLARE_STAT(struct mlx5e_ipsec_stats, ipsec_enc_bypass_packets) },
 +	{ MLX5E_DECLARE_STAT(struct mlx5e_ipsec_stats, ipsec_dec_drop_packets) },
 +	{ MLX5E_DECLARE_STAT(struct mlx5e_ipsec_stats, ipsec_dec_auth_fail_packets) },
 +	{ MLX5E_DECLARE_STAT(struct mlx5e_ipsec_stats, ipsec_enc_drop_packets) },
 +	{ MLX5E_DECLARE_STAT(struct mlx5e_ipsec_stats, ipsec_add_sa_success) },
 +	{ MLX5E_DECLARE_STAT(struct mlx5e_ipsec_stats, ipsec_add_sa_fail) },
 +	{ MLX5E_DECLARE_STAT(struct mlx5e_ipsec_stats, ipsec_del_sa_success) },
 +	{ MLX5E_DECLARE_STAT(struct mlx5e_ipsec_stats, ipsec_del_sa_fail) },
 +	{ MLX5E_DECLARE_STAT(struct mlx5e_ipsec_stats, ipsec_cmd_drop) },
 +};
  
  static const struct counter_desc mlx5e_ipsec_sw_stats_desc[] = {
  	{ MLX5E_DECLARE_STAT(struct mlx5e_ipsec_sw_stats, ipsec_rx_drop_sp_alloc) },
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_main.c
index 22f111312bee,12b72a0bcb1a..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
@@@ -47,9 -47,8 +47,14 @@@
  #include "en_rep.h"
  #include "en_accel/ipsec.h"
  #include "en_accel/en_accel.h"
++<<<<<<< HEAD
 +#include "en_accel/tls.h"
 +#include "accel/ipsec.h"
 +#include "accel/tls.h"
++=======
+ #include "en_accel/ktls.h"
+ #include "en_accel/ipsec_offload.h"
++>>>>>>> 16fe5a1c5c07 (net/mlx5: Move IPsec file to relevant directory)
  #include "lib/vxlan.h"
  #include "lib/clock.h"
  #include "en/port.h"
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_rx.c
index 6181b0baf324,a5f6fd16b665..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_rx.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_rx.c
@@@ -48,10 -48,9 +48,14 @@@
  #include "en_rep.h"
  #include "en/rep/tc.h"
  #include "ipoib/ipoib.h"
++<<<<<<< HEAD
 +#include "accel/ipsec.h"
 +#include "fpga/ipsec.h"
++=======
+ #include "en_accel/ipsec_offload.h"
++>>>>>>> 16fe5a1c5c07 (net/mlx5: Move IPsec file to relevant directory)
  #include "en_accel/ipsec_rxtx.h"
 -#include "en_accel/ktls_txrx.h"
 +#include "en_accel/tls_rxtx.h"
  #include "en/xdp.h"
  #include "en/xsk/rx.h"
  #include "en/health.h"
diff --cc drivers/net/ethernet/mellanox/mlx5/core/main.c
index 1883604be731,032de078723c..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/main.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/main.c
@@@ -63,9 -62,7 +63,13 @@@
  #include "lib/mlx5.h"
  #include "lib/tout.h"
  #include "fpga/core.h"
++<<<<<<< HEAD
 +#include "fpga/ipsec.h"
 +#include "accel/ipsec.h"
 +#include "accel/tls.h"
++=======
+ #include "en_accel/ipsec_offload.h"
++>>>>>>> 16fe5a1c5c07 (net/mlx5: Move IPsec file to relevant directory)
  #include "lib/clock.h"
  #include "lib/vxlan.h"
  #include "lib/geneve.h"
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_accel/accel.h
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/Makefile
diff --git a/drivers/net/ethernet/mellanox/mlx5/core/accel/accel.h b/drivers/net/ethernet/mellanox/mlx5/core/accel/accel.h
deleted file mode 100644
index 82b185121edb..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/accel/accel.h
+++ /dev/null
@@ -1,36 +0,0 @@
-#ifndef __MLX5E_ACCEL_H__
-#define __MLX5E_ACCEL_H__
-
-#ifdef CONFIG_MLX5_ACCEL
-
-#include <linux/skbuff.h>
-#include <linux/netdevice.h>
-
-static inline bool is_metadata_hdr_valid(struct sk_buff *skb)
-{
-	__be16 *ethtype;
-
-	if (unlikely(skb->len < ETH_HLEN + MLX5E_METADATA_ETHER_LEN))
-		return false;
-	ethtype = (__be16 *)(skb->data + ETH_ALEN * 2);
-	if (*ethtype != cpu_to_be16(MLX5E_METADATA_ETHER_TYPE))
-		return false;
-	return true;
-}
-
-static inline void remove_metadata_hdr(struct sk_buff *skb)
-{
-	struct ethhdr *old_eth;
-	struct ethhdr *new_eth;
-
-	/* Remove the metadata from the buffer */
-	old_eth = (struct ethhdr *)skb->data;
-	new_eth = (struct ethhdr *)(skb->data + MLX5E_METADATA_ETHER_LEN);
-	memmove(new_eth, old_eth, 2 * ETH_ALEN);
-	/* Ethertype is already in its new place */
-	skb_pull_inline(skb, MLX5E_METADATA_ETHER_LEN);
-}
-
-#endif /* CONFIG_MLX5_ACCEL */
-
-#endif /* __MLX5E_EN_ACCEL_H__ */
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en/params.c
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_accel/accel.h
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec.h
diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec_fs.c b/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec_fs.c
index 32093497292f..66b529e36ea1 100644
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec_fs.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec_fs.c
@@ -2,7 +2,7 @@
 /* Copyright (c) 2020, Mellanox Technologies inc. All rights reserved. */
 
 #include <linux/netdevice.h>
-#include "accel/ipsec_offload.h"
+#include "ipsec_offload.h"
 #include "ipsec_fs.h"
 #include "fs_core.h"
 
diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec_fs.h b/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec_fs.h
index 3389b3bb3ef8..b3e23aa5beeb 100644
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec_fs.h
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec_fs.h
@@ -6,7 +6,7 @@
 
 #include "en.h"
 #include "ipsec.h"
-#include "accel/ipsec_offload.h"
+#include "ipsec_offload.h"
 #include "en/fs.h"
 
 #ifdef CONFIG_MLX5_EN_IPSEC
diff --git a/drivers/net/ethernet/mellanox/mlx5/core/accel/ipsec_offload.c b/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec_offload.c
similarity index 100%
rename from drivers/net/ethernet/mellanox/mlx5/core/accel/ipsec_offload.c
rename to drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec_offload.c
diff --git a/drivers/net/ethernet/mellanox/mlx5/core/accel/ipsec_offload.h b/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec_offload.h
similarity index 100%
rename from drivers/net/ethernet/mellanox/mlx5/core/accel/ipsec_offload.h
rename to drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec_offload.h
diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec_rxtx.c b/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec_rxtx.c
index db259092c77d..d2b486fdb7d6 100644
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec_rxtx.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec_rxtx.c
@@ -34,7 +34,7 @@
 #include <crypto/aead.h>
 #include <net/xfrm.h>
 #include <net/esp.h>
-#include "accel/ipsec_offload.h"
+#include "ipsec_offload.h"
 #include "en_accel/ipsec_rxtx.h"
 #include "en_accel/ipsec.h"
 #include "accel/accel.h"
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec_stats.c
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_main.c
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_rx.c
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/main.c
