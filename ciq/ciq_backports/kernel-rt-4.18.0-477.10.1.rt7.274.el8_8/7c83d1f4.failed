net/mlx5: E-switch, Fix switchdev mode after devlink reload

jira LE-1907
Rebuild_History Non-Buildable kernel-rt-4.18.0-477.10.1.rt7.274.el8_8
commit-author Chris Mi <cmi@nvidia.com>
commit 7c83d1f4c5adae9583e7fca1e3e830d6b061522d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-rt-4.18.0-477.10.1.rt7.274.el8_8/7c83d1f4.failed

The cited commit removes eswitch mode none. So after devlink reload
in switchdev mode, eswitch mode is not changed. But actually eswitch
is disabled during devlink reload.

Fix it by setting eswitch mode to legacy when disabling eswitch
which is called by reload_down.

Fixes: f019679ea5f2 ("net/mlx5: E-switch, Remove dependency between sriov and eswitch mode")
	Signed-off-by: Chris Mi <cmi@nvidia.com>
	Reviewed-by: Roi Dayan <roid@nvidia.com>
	Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
(cherry picked from commit 7c83d1f4c5adae9583e7fca1e3e830d6b061522d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
index d3e3533d0bbc,9daf55e90367..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
@@@ -1393,10 -1460,11 +1393,15 @@@ void mlx5_eswitch_disable(struct mlx5_e
  	if (!mlx5_esw_allowed(esw))
  		return;
  
 -	devl_assert_locked(priv_to_devlink(esw->dev));
  	mlx5_lag_disable_change(esw->dev);
  	down_write(&esw->mode_lock);
++<<<<<<< HEAD
 +	mlx5_eswitch_disable_locked(esw, clear_vf);
 +	esw->esw_funcs.num_vfs = 0;
++=======
+ 	mlx5_eswitch_disable_locked(esw);
+ 	esw->mode = MLX5_ESWITCH_LEGACY;
++>>>>>>> 7c83d1f4c5ad (net/mlx5: E-switch, Fix switchdev mode after devlink reload)
  	up_write(&esw->mode_lock);
  	mlx5_lag_enable_change(esw->dev);
  }
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/eswitch.c
