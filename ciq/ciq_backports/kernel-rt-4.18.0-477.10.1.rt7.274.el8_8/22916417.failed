x86/virtio: Have SEV guests enforce restricted virtio memory access

jira LE-1907
Rebuild_History Non-Buildable kernel-rt-4.18.0-477.10.1.rt7.274.el8_8
commit-author Tom Lendacky <thomas.lendacky@amd.com>
commit 229164175ff0c61ff581e6bf37fbfcb608b6e9bb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-rt-4.18.0-477.10.1.rt7.274.el8_8/22916417.failed

An SEV guest requires that virtio devices use the DMA API to allow the
hypervisor to successfully access guest memory as needed.

The VIRTIO_F_VERSION_1 and VIRTIO_F_ACCESS_PLATFORM features tell virtio
to use the DMA API. Add arch_has_restricted_virtio_memory_access() for
x86, to fail the device probe if these features have not been set for the
device when running as an SEV guest.

 [ bp: Fix -Wmissing-prototypes warning
   Reported-by: kernel test robot <lkp@intel.com> ]

	Signed-off-by: Tom Lendacky <thomas.lendacky@amd.com>
	Signed-off-by: Borislav Petkov <bp@suse.de>
Link: https://lkml.kernel.org/r/b46e0211f77ca1831f11132f969d470a6ffc9267.1614897610.git.thomas.lendacky@amd.com
(cherry picked from commit 229164175ff0c61ff581e6bf37fbfcb608b6e9bb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/Kconfig
#	arch/x86/mm/mem_encrypt.c
diff --cc arch/x86/Kconfig
index 970d47f5992e,e80e7268d2c6..000000000000
--- a/arch/x86/Kconfig
+++ b/arch/x86/Kconfig
@@@ -1523,10 -1515,11 +1523,15 @@@ config AMD_MEM_ENCRYP
  	depends on X86_64 && CPU_SUP_AMD
  	select DMA_COHERENT_POOL
  	select DYNAMIC_PHYSICAL_MASK
 -	select ARCH_USE_MEMREMAP_PROT
  	select ARCH_HAS_FORCE_DMA_UNENCRYPTED
  	select INSTRUCTION_DECODER
++<<<<<<< HEAD
 +	select ARCH_HAS_CC_PLATFORM
 +	---help---
++=======
+ 	select ARCH_HAS_RESTRICTED_VIRTIO_MEMORY_ACCESS
+ 	help
++>>>>>>> 229164175ff0 (x86/virtio: Have SEV guests enforce restricted virtio memory access)
  	  Say yes to enable support for the encryption of system memory.
  	  This requires an AMD processor that supports Secure Memory
  	  Encryption (SME).
diff --cc arch/x86/mm/mem_encrypt.c
index 48e92fcc23e3,f3eb53fe0215..000000000000
--- a/arch/x86/mm/mem_encrypt.c
+++ b/arch/x86/mm/mem_encrypt.c
@@@ -22,7 -19,7 +22,11 @@@
  #include <linux/kernel.h>
  #include <linux/bitops.h>
  #include <linux/dma-mapping.h>
++<<<<<<< HEAD
 +#include <linux/cc_platform.h>
++=======
+ #include <linux/virtio_config.h>
++>>>>>>> 229164175ff0 (x86/virtio: Have SEV guests enforce restricted virtio memory access)
  
  #include <asm/tlbflush.h>
  #include <asm/fixmap.h>
@@@ -516,5 -475,18 +520,14 @@@ void __init mem_encrypt_init(void
  	/* Call into SWIOTLB to update the SWIOTLB DMA buffers */
  	swiotlb_update_mem_attributes();
  
 -	/*
 -	 * With SEV, we need to unroll the rep string I/O instructions,
 -	 * but SEV-ES supports them through the #VC handler.
 -	 */
 -	if (sev_active() && !sev_es_active())
 -		static_branch_enable(&sev_enable_key);
 -
  	print_mem_encrypt_feature_info();
  }
++<<<<<<< HEAD
++=======
+ 
+ int arch_has_restricted_virtio_memory_access(void)
+ {
+ 	return sev_active();
+ }
+ EXPORT_SYMBOL_GPL(arch_has_restricted_virtio_memory_access);
++>>>>>>> 229164175ff0 (x86/virtio: Have SEV guests enforce restricted virtio memory access)
* Unmerged path arch/x86/Kconfig
* Unmerged path arch/x86/mm/mem_encrypt.c
