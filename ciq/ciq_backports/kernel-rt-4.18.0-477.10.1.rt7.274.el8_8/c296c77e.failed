net: stmmac: Fix queue statistics reading

jira LE-1907
Rebuild_History Non-Buildable kernel-rt-4.18.0-477.10.1.rt7.274.el8_8
commit-author Kurt Kanzenbach <kurt@linutronix.de>
commit c296c77efb66994d94d9f706446a115581226550
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-rt-4.18.0-477.10.1.rt7.274.el8_8/c296c77e.failed

Correct queue statistics reading. All queue statistics are stored as unsigned
long values. The retrieval for ethtool fetches these values as u64. However, on
some systems the size of the counters are 32 bit. That yields wrong queue
statistic counters e.g., on arm32 systems such as the stm32mp157. Fix it by
using the correct data type.

Tested on Olimex STMP157-OLinuXino-LIME2 by simple running linuxptp for a short
period of time:

Non-patched kernel:
|root@st1:~# ethtool -S eth0 | grep q0
|     q0_tx_pkt_n: 3775276254951 # ???
|     q0_tx_irq_n: 879
|     q0_rx_pkt_n: 1194000908909 # ???
|     q0_rx_irq_n: 278

Patched kernel:
|root@st1:~# ethtool -S eth0 | grep q0
|     q0_tx_pkt_n: 2434
|     q0_tx_irq_n: 1274
|     q0_rx_pkt_n: 1604
|     q0_rx_irq_n: 846

Fixes: 68e9c5dee1cf ("net: stmmac: add ethtool per-queue statistic framework")
	Signed-off-by: Kurt Kanzenbach <kurt@linutronix.de>
	Cc: Vijayakannan Ayyathurai <vijayakannan.ayyathurai@intel.com>
	Cc: Wong Vee Khee <vee.khee.wong@linux.intel.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit c296c77efb66994d94d9f706446a115581226550)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/stmicro/stmmac/stmmac_ethtool.c
diff --cc drivers/net/ethernet/stmicro/stmmac/stmmac_ethtool.c
index 45944f33b00a,35c8dd92d369..000000000000
--- a/drivers/net/ethernet/stmicro/stmmac/stmmac_ethtool.c
+++ b/drivers/net/ethernet/stmicro/stmmac/stmmac_ethtool.c
@@@ -538,6 -540,31 +538,34 @@@ stmmac_set_pauseparam(struct net_devic
  	}
  }
  
++<<<<<<< HEAD
++=======
+ static void stmmac_get_per_qstats(struct stmmac_priv *priv, u64 *data)
+ {
+ 	u32 tx_cnt = priv->plat->tx_queues_to_use;
+ 	u32 rx_cnt = priv->plat->rx_queues_to_use;
+ 	int q, stat;
+ 	char *p;
+ 
+ 	for (q = 0; q < tx_cnt; q++) {
+ 		p = (char *)priv + offsetof(struct stmmac_priv,
+ 					    xstats.txq_stats[q].tx_pkt_n);
+ 		for (stat = 0; stat < STMMAC_TXQ_STATS; stat++) {
+ 			*data++ = (*(unsigned long *)p);
+ 			p += sizeof(unsigned long);
+ 		}
+ 	}
+ 	for (q = 0; q < rx_cnt; q++) {
+ 		p = (char *)priv + offsetof(struct stmmac_priv,
+ 					    xstats.rxq_stats[q].rx_pkt_n);
+ 		for (stat = 0; stat < STMMAC_RXQ_STATS; stat++) {
+ 			*data++ = (*(unsigned long *)p);
+ 			p += sizeof(unsigned long);
+ 		}
+ 	}
+ }
+ 
++>>>>>>> c296c77efb66 (net: stmmac: Fix queue statistics reading)
  static void stmmac_get_ethtool_stats(struct net_device *dev,
  				 struct ethtool_stats *dummy, u64 *data)
  {
* Unmerged path drivers/net/ethernet/stmicro/stmmac/stmmac_ethtool.c
