ALSA: gus: Fix repeated probe for ISA interwave card

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-373.el8
commit-author Takashi Iwai <tiwai@suse.de>
commit c5433f026b27cc100985189fac04969dfbf56dba
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-373.el8/c5433f02.failed

The legacy ISA probe tries to probe the card repeatedly, and this
would conflict with the refactoring using devres.  Put the card
creation out of the loop and only probe GUS object repeatedly.

Fixes: 5b88da3c800f ("ALSA: gus: Allocate resources with device-managed APIs")
Link: https://lore.kernel.org/r/20210907093930.29009-2-tiwai@suse.de
	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit c5433f026b27cc100985189fac04969dfbf56dba)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/isa/gus/interwave.c
diff --cc sound/isa/gus/interwave.c
index 7f27dc5d809d,a04a9d3253f8..000000000000
--- a/sound/isa/gus/interwave.c
+++ b/sound/isa/gus/interwave.c
@@@ -775,24 -756,6 +774,27 @@@ static int snd_interwave_probe(struct s
  	return 0;
  }
  
++<<<<<<< HEAD
 +static int snd_interwave_isa_probe1(int dev, struct device *devptr)
 +{
 +	struct snd_card *card;
 +	int err;
 +
 +	err = snd_interwave_card_new(devptr, dev, &card);
 +	if (err < 0)
 +		return err;
 +
 +	err = snd_interwave_probe(card, dev);
 +	if (err < 0) {
 +		snd_card_free(card);
 +		return err;
 +	}
 +	dev_set_drvdata(devptr, card);
 +	return 0;
 +}
 +
++=======
++>>>>>>> c5433f026b27 (ALSA: gus: Fix repeated probe for ISA interwave card)
  static int snd_interwave_isa_match(struct device *pdev,
  				   unsigned int dev)
  {
@@@ -845,16 -814,18 +853,24 @@@ static int snd_interwave_isa_probe(stru
  			if (! err)
  				return 0;
  		}
- 		return err;
  	}
+ 	if (err < 0)
+ 		return err;
+ 
+ 	err = snd_interwave_probe(card, dev, gus);
+ 	if (err < 0)
+ 		return err;
+ 
+ 	dev_set_drvdata(pdev, card);
+ 	return 0;
  }
  
 +static int snd_interwave_isa_remove(struct device *devptr, unsigned int dev)
 +{
 +	snd_card_free(dev_get_drvdata(devptr));
 +	return 0;
 +}
 +
  static struct isa_driver snd_interwave_driver = {
  	.match		= snd_interwave_isa_match,
  	.probe		= snd_interwave_isa_probe,
@@@ -885,15 -856,14 +902,23 @@@ static int snd_interwave_pnp_detect(str
  		return res;
  
  	res = snd_interwave_pnp(dev, card->private_data, pcard, pid);
 -	if (res < 0)
 +	if (res < 0) {
 +		snd_card_free(card);
  		return res;
++<<<<<<< HEAD
 +	}
 +	res = snd_interwave_probe(card, dev);
 +	if (res < 0) {
 +		snd_card_free(card);
++=======
+ 	res = snd_interwave_probe_gus(card, dev, &gus);
+ 	if (res < 0)
+ 		return res;
+ 	res = snd_interwave_probe(card, dev, gus);
+ 	if (res < 0)
++>>>>>>> c5433f026b27 (ALSA: gus: Fix repeated probe for ISA interwave card)
  		return res;
 +	}
  	pnp_set_card_drvdata(pcard, card);
  	dev++;
  	return 0;
* Unmerged path sound/isa/gus/interwave.c
