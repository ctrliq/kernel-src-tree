ALSA: usb-audio: Move set-interface-first workaround into common quirk

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-373.el8
commit-author Takashi Iwai <tiwai@suse.de>
commit 6e41340994e5b5bd9262246e8d1f64406d72ab8b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-373.el8/6e413409.failed

The recent quirk for WALKMAN (commit 7af5a14371c1: "ALSA: usb-audio:
Fix regression on Sony WALKMAN NW-A45 DAC") may be required for other
devices and is worth to be put into the common quirk flags.
This patch adds a new quirk flag bit QUIRK_FLAG_SET_IFACE_FIRST and a
quirk table entry for the device.

Link: https://lore.kernel.org/r/20210824055720.9240-1-tiwai@suse.de
	Signed-off-by: Takashi Iwai <tiwai@suse.de>
(cherry picked from commit 6e41340994e5b5bd9262246e8d1f64406d72ab8b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/usb/quirks.c
#	sound/usb/usbaudio.h
diff --cc sound/usb/quirks.c
index 9c3d234c8b32,4479a590194f..000000000000
--- a/sound/usb/quirks.c
+++ b/sound/usb/quirks.c
@@@ -1904,9 -1779,19 +1904,16 @@@ static const struct usb_audio_quirk_fla
  	DEVICE_FLG(0x041e, 0x4080, /* Creative Live Cam VF0610 */
  		   QUIRK_FLAG_GET_SAMPLE_RATE),
  	DEVICE_FLG(0x046d, 0x084c, /* Logitech ConferenceCam Connect */
 -		   QUIRK_FLAG_GET_SAMPLE_RATE | QUIRK_FLAG_CTL_MSG_DELAY_1M),
 -	DEVICE_FLG(0x046d, 0x0991, /* Logitech QuickCam Pro */
 -		   QUIRK_FLAG_CTL_MSG_DELAY_1M | QUIRK_FLAG_IGNORE_CTL_ERROR),
 -	DEVICE_FLG(0x046d, 0x09a4, /* Logitech QuickCam E 3500 */
 -		   QUIRK_FLAG_CTL_MSG_DELAY_1M | QUIRK_FLAG_IGNORE_CTL_ERROR),
 +		   QUIRK_FLAG_GET_SAMPLE_RATE),
  	DEVICE_FLG(0x04d8, 0xfeea, /* Benchmark DAC1 Pre */
  		   QUIRK_FLAG_GET_SAMPLE_RATE),
++<<<<<<< HEAD
++=======
+ 	DEVICE_FLG(0x04e8, 0xa051, /* Samsung USBC Headset (AKG) */
+ 		   QUIRK_FLAG_SKIP_CLOCK_SELECTOR | QUIRK_FLAG_CTL_MSG_DELAY_5M),
+ 	DEVICE_FLG(0x054c, 0x0b8c, /* Sony WALKMAN NW-A45 DAC */
+ 		   QUIRK_FLAG_SET_IFACE_FIRST),
++>>>>>>> 6e41340994e5 (ALSA: usb-audio: Move set-interface-first workaround into common quirk)
  	DEVICE_FLG(0x0556, 0x0014, /* Phoenix Audio TMX320VC */
  		   QUIRK_FLAG_GET_SAMPLE_RATE),
  	DEVICE_FLG(0x05a3, 0x9420, /* ELP HD USB Camera */
diff --cc sound/usb/usbaudio.h
index c0a3ac71bf0a,94261d19cceb..000000000000
--- a/sound/usb/usbaudio.h
+++ b/sound/usb/usbaudio.h
@@@ -130,8 -129,58 +130,64 @@@ extern bool snd_usb_skip_validation
   * QUIRK_FLAG_GET_SAMPLE_RATE:
   *  Skip reading sample rate for devices, as some devices behave inconsistently
   *  or return error
++<<<<<<< HEAD
 + */
 +
 +#define QUIRK_FLAG_GET_SAMPLE_RATE	(1U << 0)
++=======
+  * QUIRK_FLAG_SHARE_MEDIA_DEVICE:
+  *  Create Media Controller API entries
+  * QUIRK_FLAG_ALIGN_TRANSFER:
+  *  Allow alignment on audio sub-slot (channel samples) rather than on audio
+  *  slots (audio frames)
+  * QUIRK_TX_LENGTH:
+  *  Add length specifier to transfers
+  * QUIRK_FLAG_PLAYBACK_FIRST:
+  *  Start playback stream at first even in implement feedback mode
+  * QUIRK_FLAG_SKIP_CLOCK_SELECTOR:
+  *  Skip clock selector setup; the device may reset to invalid state
+  * QUIRK_FLAG_IGNORE_CLOCK_SOURCE:
+  *  Ignore errors from clock source search; i.e. hardcoded clock
+  * QUIRK_FLAG_ITF_USB_DSD_DAC:
+  *  Indicates the device is for ITF-USB DSD based DACs that need a vendor cmd
+  *  to switch between PCM and native DSD mode
+  * QUIRK_FLAG_CTL_MSG_DELAY:
+  *  Add a delay of 20ms at each control message handling
+  * QUIRK_FLAG_CTL_MSG_DELAY_1M:
+  *  Add a delay of 1-2ms at each control message handling
+  * QUIRK_FLAG_CTL_MSG_DELAY_5M:
+  *  Add a delay of 5-6ms at each control message handling
+  * QUIRK_FLAG_IFACE_DELAY:
+  *  Add a delay of 50ms at each interface setup
+  * QUIRK_FLAG_VALIDATE_RATES:
+  *  Perform sample rate validations at probe
+  * QUIRK_FLAG_DISABLE_AUTOSUSPEND:
+  *  Disable runtime PM autosuspend
+  * QUIRK_FLAG_IGNORE_CTL_ERROR:
+  *  Ignore errors for mixer access
+  * QUIRK_FLAG_DSD_RAW:
+  *  Support generic DSD raw U32_BE format
+  * QUIRK_FLAG_SET_IFACE_FIRST:
+  *  Set up the interface at first like UAC1
+  */
+ 
+ #define QUIRK_FLAG_GET_SAMPLE_RATE	(1U << 0)
+ #define QUIRK_FLAG_SHARE_MEDIA_DEVICE	(1U << 1)
+ #define QUIRK_FLAG_ALIGN_TRANSFER	(1U << 2)
+ #define QUIRK_FLAG_TX_LENGTH		(1U << 3)
+ #define QUIRK_FLAG_PLAYBACK_FIRST	(1U << 4)
+ #define QUIRK_FLAG_SKIP_CLOCK_SELECTOR	(1U << 5)
+ #define QUIRK_FLAG_IGNORE_CLOCK_SOURCE	(1U << 6)
+ #define QUIRK_FLAG_ITF_USB_DSD_DAC	(1U << 7)
+ #define QUIRK_FLAG_CTL_MSG_DELAY	(1U << 8)
+ #define QUIRK_FLAG_CTL_MSG_DELAY_1M	(1U << 9)
+ #define QUIRK_FLAG_CTL_MSG_DELAY_5M	(1U << 10)
+ #define QUIRK_FLAG_IFACE_DELAY		(1U << 11)
+ #define QUIRK_FLAG_VALIDATE_RATES	(1U << 12)
+ #define QUIRK_FLAG_DISABLE_AUTOSUSPEND	(1U << 13)
+ #define QUIRK_FLAG_IGNORE_CTL_ERROR	(1U << 14)
+ #define QUIRK_FLAG_DSD_RAW		(1U << 15)
+ #define QUIRK_FLAG_SET_IFACE_FIRST	(1U << 16)
++>>>>>>> 6e41340994e5 (ALSA: usb-audio: Move set-interface-first workaround into common quirk)
  
  #endif /* __USBAUDIO_H */
diff --git a/Documentation/sound/alsa-configuration.rst b/Documentation/sound/alsa-configuration.rst
index e3c33b8d6d78..65f61695f561 100644
--- a/Documentation/sound/alsa-configuration.rst
+++ b/Documentation/sound/alsa-configuration.rst
@@ -2278,6 +2278,7 @@ quirk_flags
         * bit 13: Disable runtime PM autosuspend
         * bit 14: Ignore errors for mixer access
         * bit 15: Support generic DSD raw U32_BE format
+        * bit 16: Set up the interface at first like UAC1
 
 This module supports multiple devices, autoprobe and hotplugging.
 
diff --git a/sound/usb/endpoint.c b/sound/usb/endpoint.c
index 41bc6cb295ac..29066a3e0a40 100644
--- a/sound/usb/endpoint.c
+++ b/sound/usb/endpoint.c
@@ -1287,10 +1287,8 @@ int snd_usb_endpoint_configure(struct snd_usb_audio *chip,
 	 * to be set up before parameter setups
 	 */
 	iface_first = ep->cur_audiofmt->protocol == UAC_VERSION_1;
-	/* Workaround for Sony WALKMAN NW-A45 DAC;
-	 * it requires the interface setup at first like UAC1
-	 */
-	if (chip->usb_id == USB_ID(0x054c, 0x0b8c))
+	/* Workaround for devices that require the interface setup at first like UAC1 */
+	if (chip->quirk_flags & QUIRK_FLAG_SET_IFACE_FIRST)
 		iface_first = true;
 	if (iface_first) {
 		err = endpoint_set_interface(chip, ep, true);
* Unmerged path sound/usb/quirks.c
* Unmerged path sound/usb/usbaudio.h
