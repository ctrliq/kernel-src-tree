x86/bugs: Fix spectre_v2 mitigation default on Intel

jira KERNEL-156
Rebuild_History Non-Buildable kernel-6.12.0-124.2.1.el10_1
commit-author Pawan Gupta <pawan.kumar.gupta@linux.intel.com>
commit 6a7c3c2606105a41dde81002c0037420bc1ddf00
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-6.12.0-124.2.1.el10_1/6a7c3c26.failed

Commit

  480e803dacf8 ("x86/bugs: Restructure spectre_v2 mitigation")

inadvertently changed the spectre-v2 mitigation default from eIBRS to IBRS on
Intel. While splitting the spectre_v2 mitigation in select/update/apply
functions, eIBRS and IBRS selection logic was separated in select and update.

This caused IBRS selection to not consider that eIBRS mitigation is already
selected, fix it.

Fixes: 480e803dacf8 ("x86/bugs: Restructure spectre_v2 mitigation")
	Signed-off-by: Pawan Gupta <pawan.kumar.gupta@linux.intel.com>
	Signed-off-by: Borislav Petkov (AMD) <bp@alien8.de>
Link: https://lore.kernel.org/20250520-eibrs-fix-v1-1-91bacd35ed09@linux.intel.com
(cherry picked from commit 6a7c3c2606105a41dde81002c0037420bc1ddf00)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/cpu/bugs.c
diff --cc arch/x86/kernel/cpu/bugs.c
index 95b4e9a10dd7,7f94e6a5497d..000000000000
--- a/arch/x86/kernel/cpu/bugs.c
+++ b/arch/x86/kernel/cpu/bugs.c
@@@ -1932,14 -2098,35 +1932,38 @@@ static void __init spectre_v2_select_mi
  		break;
  
  	case SPECTRE_V2_CMD_EIBRS_RETPOLINE:
 -		spectre_v2_enabled = SPECTRE_V2_EIBRS_RETPOLINE;
 +		mode = SPECTRE_V2_EIBRS_RETPOLINE;
  		break;
  	}
 -}
  
++<<<<<<< HEAD
 +	if (mode == SPECTRE_V2_EIBRS && unprivileged_ebpf_enabled())
++=======
+ static void __init spectre_v2_update_mitigation(void)
+ {
+ 	if (spectre_v2_cmd == SPECTRE_V2_CMD_AUTO &&
+ 	    !spectre_v2_in_eibrs_mode(spectre_v2_enabled)) {
+ 		if (IS_ENABLED(CONFIG_MITIGATION_IBRS_ENTRY) &&
+ 		    boot_cpu_has_bug(X86_BUG_RETBLEED) &&
+ 		    retbleed_mitigation != RETBLEED_MITIGATION_NONE &&
+ 		    retbleed_mitigation != RETBLEED_MITIGATION_STUFF &&
+ 		    boot_cpu_has(X86_FEATURE_IBRS) &&
+ 		    boot_cpu_data.x86_vendor == X86_VENDOR_INTEL) {
+ 			spectre_v2_enabled = SPECTRE_V2_IBRS;
+ 		}
+ 	}
+ 
+ 	if (boot_cpu_has_bug(X86_BUG_SPECTRE_V2) && !cpu_mitigations_off())
+ 		pr_info("%s\n", spectre_v2_strings[spectre_v2_enabled]);
+ }
+ 
+ static void __init spectre_v2_apply_mitigation(void)
+ {
+ 	if (spectre_v2_enabled == SPECTRE_V2_EIBRS && unprivileged_ebpf_enabled())
++>>>>>>> 6a7c3c260610 (x86/bugs: Fix spectre_v2 mitigation default on Intel)
  		pr_err(SPECTRE_V2_EIBRS_EBPF_MSG);
  
 -	if (spectre_v2_in_ibrs_mode(spectre_v2_enabled)) {
 +	if (spectre_v2_in_ibrs_mode(mode)) {
  		if (boot_cpu_has(X86_FEATURE_AUTOIBRS)) {
  			msr_set_bit(MSR_EFER, _EFER_AUTOIBRS);
  		} else {
* Unmerged path arch/x86/kernel/cpu/bugs.c
