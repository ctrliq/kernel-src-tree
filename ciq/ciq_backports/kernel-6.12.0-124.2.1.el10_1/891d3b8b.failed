x86/bugs: Fix SRSO reporting on Zen1/2 with SMT disabled

jira KERNEL-156
Rebuild_History Non-Buildable kernel-6.12.0-124.2.1.el10_1
commit-author Borislav Petkov (AMD) <bp@alien8.de>
commit 891d3b8be32a69ae94d32e3f1e1ee01359020d49
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-6.12.0-124.2.1.el10_1/891d3b8b.failed

1f4bb068b498 ("x86/bugs: Restructure SRSO mitigation") does this:

  if (boot_cpu_data.x86 < 0x19 && !cpu_smt_possible()) {
          setup_force_cpu_cap(X86_FEATURE_SRSO_NO);
          srso_mitigation = SRSO_MITIGATION_NONE;
          return;
  }

and, in particular, sets srso_mitigation to NONE. This leads to
reporting

  Speculative Return Stack Overflow: Vulnerable

on Zen2 machines.

There's a far bigger confusion with what SRSO_NO means and how it is
used in the code but this will be a matter of future fixes and
restructuring to how the SRSO mitigation gets determined.

Fix the reporting issue for now.

	Signed-off-by: Borislav Petkov (AMD) <bp@alien8.de>
	Reviewed-by: David Kaplan <david.kaplan@amd.com>
Link: https://lore.kernel.org/20250513110405.15872-1-bp@kernel.org
(cherry picked from commit 891d3b8be32a69ae94d32e3f1e1ee01359020d49)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/cpu/bugs.c
diff --cc arch/x86/kernel/cpu/bugs.c
index 95b4e9a10dd7,dd8b50b4ceaa..000000000000
--- a/arch/x86/kernel/cpu/bugs.c
+++ b/arch/x86/kernel/cpu/bugs.c
@@@ -2829,8 -2933,23 +2829,26 @@@ ibpb_on_vmexit
  	default:
  		break;
  	}
 -}
  
++<<<<<<< HEAD
 +out:
++=======
+ static void __init srso_update_mitigation(void)
+ {
+ 	/* If retbleed is using IBPB, that works for SRSO as well */
+ 	if (retbleed_mitigation == RETBLEED_MITIGATION_IBPB &&
+ 	    boot_cpu_has(X86_FEATURE_IBPB_BRTYPE))
+ 		srso_mitigation = SRSO_MITIGATION_IBPB;
+ 
+ 	if (boot_cpu_has_bug(X86_BUG_SRSO) &&
+ 	    !cpu_mitigations_off() &&
+ 	    !boot_cpu_has(X86_FEATURE_SRSO_NO))
+ 		pr_info("%s\n", srso_strings[srso_mitigation]);
+ }
+ 
+ static void __init srso_apply_mitigation(void)
+ {
++>>>>>>> 891d3b8be32a (x86/bugs: Fix SRSO reporting on Zen1/2 with SMT disabled)
  	/*
  	 * Clear the feature flag if this mitigation is not selected as that
  	 * feature flag controls the BpSpecReduce MSR bit toggling in KVM.
* Unmerged path arch/x86/kernel/cpu/bugs.c
