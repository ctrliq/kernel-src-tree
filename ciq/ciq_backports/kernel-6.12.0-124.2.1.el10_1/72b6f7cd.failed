iommu/virtio: Make instance lookup robust

jira KERNEL-156
Rebuild_History Non-Buildable kernel-6.12.0-124.2.1.el10_1
commit-author Robin Murphy <robin.murphy@arm.com>
commit 72b6f7cd89cea8251979b65528d302f9c0ed37bf
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-6.12.0-124.2.1.el10_1/72b6f7cd.failed

Much like arm-smmu in commit 7d835134d4e1 ("iommu/arm-smmu: Make
instance lookup robust"), virtio-iommu appears to have the same issue
where iommu_device_register() makes the IOMMU instance visible to other
API callers (including itself) straight away, but internally the
instance isn't ready to recognise itself for viommu_probe_device() to
work correctly until after viommu_probe() has returned. This matters a
lot more now that bus_iommu_probe() has the DT/VIOT knowledge to probe
client devices the way that was always intended. Tweak the lookup and
initialisation in much the same way as for arm-smmu, to ensure that what
we register is functional and ready to go.

	Cc: stable@vger.kernel.org
Fixes: bcb81ac6ae3c ("iommu: Get DT/ACPI parsing into the proper probe path")
	Signed-off-by: Robin Murphy <robin.murphy@arm.com>
	Tested-by: Eric Auger <eric.auger@redhat.com>
Link: https://lore.kernel.org/r/308911aaa1f5be32a3a709996c7bd6cf71d30f33.1755190036.git.robin.murphy@arm.com
	Signed-off-by: Joerg Roedel <joerg.roedel@amd.com>
(cherry picked from commit 72b6f7cd89cea8251979b65528d302f9c0ed37bf)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/virtio-iommu.c
diff --cc drivers/iommu/virtio-iommu.c
index b85ce6310ddb,b39d6f134ab2..000000000000
--- a/drivers/iommu/virtio-iommu.c
+++ b/drivers/iommu/virtio-iommu.c
@@@ -972,8 -998,7 +972,12 @@@ static void viommu_get_resv_regions(str
  	iommu_dma_get_resv_regions(dev, head);
  }
  
++<<<<<<< HEAD
 +static struct iommu_ops viommu_ops;
 +static struct virtio_driver virtio_iommu_drv;
++=======
+ static const struct bus_type *virtio_bus_type;
++>>>>>>> 72b6f7cd89ce (iommu/virtio: Make instance lookup robust)
  
  static int viommu_match_node(struct device *dev, const void *data)
  {
* Unmerged path drivers/iommu/virtio-iommu.c
