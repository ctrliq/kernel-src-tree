scsi: lpfc: Delete NLP_TARGET_REMOVE flag due to obsolete usage

jira KERNEL-548
Rebuild_History Non-Buildable kernel-4.18.0-553.97.1.el8_10
commit-author Justin Tee <justin.tee@broadcom.com>
commit bb33b07ac6e3fede9b54cd8bf83a66dbdc6afe89
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.97.1.el8_10/bb33b07a.failed

Remove the NLP_TARGET_REMOVE flag as its usage is obsolete.  The current
framework is to rely on the lpfc_dev_loss_tmo_callbk from upper layer to
notify final ndlp kref release.  There's no need to specifically set
NLP_EVT_DEVICE_RM when a LOGO completes.  The dev_loss_tmo_callbk is
responsible for the final kref put.

	Signed-off-by: Justin Tee <justin.tee@broadcom.com>
Link: https://lore.kernel.org/r/20241212233309.71356-4-justintee8345@gmail.com
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit bb33b07ac6e3fede9b54cd8bf83a66dbdc6afe89)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/lpfc/lpfc_disc.h
#	drivers/scsi/lpfc/lpfc_els.c
#	drivers/scsi/lpfc/lpfc_nportdisc.c
diff --cc drivers/scsi/lpfc/lpfc_disc.h
index dbc11f2f14d8,81cfa35dab98..000000000000
--- a/drivers/scsi/lpfc/lpfc_disc.h
+++ b/drivers/scsi/lpfc/lpfc_disc.h
@@@ -183,37 -182,36 +183,46 @@@ struct lpfc_node_rrq 
  #define lpfc_ndlp_check_qdepth(phba, ndlp) \
  	(ndlp->cmd_qdepth < phba->sli4_hba.max_cfg_param.max_xri)
  
 -/* nlp_flag mask bits */
 -enum lpfc_nlp_flag {
 -	NLP_IGNR_REG_CMPL  = 0,         /* Rcvd rscn before we cmpl reg login */
 -	NLP_REG_LOGIN_SEND = 1,         /* sent reglogin to adapter */
 -	NLP_SUPPRESS_RSP   = 4,         /* Remote NPort supports suppress rsp */
 -	NLP_PLOGI_SND      = 5,         /* sent PLOGI request for this entry */
 -	NLP_PRLI_SND       = 6,         /* sent PRLI request for this entry */
 -	NLP_ADISC_SND      = 7,         /* sent ADISC request for this entry */
 -	NLP_LOGO_SND       = 8,         /* sent LOGO request for this entry */
 -	NLP_RNID_SND       = 10,        /* sent RNID request for this entry */
 -	NLP_NVMET_RECOV    = 12,        /* NVMET auditing node for recovery. */
 -	NLP_UNREG_INP      = 15,        /* UNREG_RPI cmd is in progress */
 -	NLP_DROPPED        = 16,        /* Init ref count has been dropped */
 -	NLP_DELAY_TMO      = 17,        /* delay timeout is running for node */
 -	NLP_NPR_2B_DISC    = 18,        /* node is included in num_disc_nodes */
 -	NLP_RCV_PLOGI      = 19,        /* Rcv'ed PLOGI from remote system */
 -	NLP_LOGO_ACC       = 20,        /* Process LOGO after ACC completes */
 -	NLP_TGT_NO_SCSIID  = 21,        /* good PRLI but no binding for scsid */
 -	NLP_ISSUE_LOGO     = 22,        /* waiting to issue a LOGO */
 -	NLP_IN_DEV_LOSS    = 23,        /* devloss in progress */
 -	NLP_ACC_REGLOGIN   = 24,        /* Issue Reg Login after successful
 +/* Defines for nlp_flag (uint32) */
 +#define NLP_IGNR_REG_CMPL  0x00000001 /* Rcvd rscn before we cmpl reg login */
 +#define NLP_REG_LOGIN_SEND 0x00000002   /* sent reglogin to adapter */
 +#define NLP_RELEASE_RPI    0x00000004   /* Release RPI to free pool */
 +#define NLP_SUPPRESS_RSP   0x00000010	/* Remote NPort supports suppress rsp */
 +#define NLP_PLOGI_SND      0x00000020	/* sent PLOGI request for this entry */
 +#define NLP_PRLI_SND       0x00000040	/* sent PRLI request for this entry */
 +#define NLP_ADISC_SND      0x00000080	/* sent ADISC request for this entry */
 +#define NLP_LOGO_SND       0x00000100	/* sent LOGO request for this entry */
 +#define NLP_RNID_SND       0x00000400	/* sent RNID request for this entry */
 +#define NLP_ELS_SND_MASK   0x000007e0	/* sent ELS request for this entry */
 +#define NLP_NVMET_RECOV    0x00001000   /* NVMET auditing node for recovery. */
 +#define NLP_UNREG_INP      0x00008000	/* UNREG_RPI cmd is in progress */
 +#define NLP_DROPPED        0x00010000	/* Init ref count has been dropped */
 +#define NLP_DELAY_TMO      0x00020000	/* delay timeout is running for node */
 +#define NLP_NPR_2B_DISC    0x00040000	/* node is included in num_disc_nodes */
 +#define NLP_RCV_PLOGI      0x00080000	/* Rcv'ed PLOGI from remote system */
 +#define NLP_LOGO_ACC       0x00100000	/* Process LOGO after ACC completes */
 +#define NLP_TGT_NO_SCSIID  0x00200000	/* good PRLI but no binding for scsid */
 +#define NLP_ISSUE_LOGO     0x00400000	/* waiting to issue a LOGO */
 +#define NLP_IN_DEV_LOSS    0x00800000	/* devloss in progress */
 +#define NLP_ACC_REGLOGIN   0x01000000	/* Issue Reg Login after successful
  					   ACC */
 -	NLP_NPR_ADISC      = 25,        /* Issue ADISC when dq'ed from
 +#define NLP_NPR_ADISC      0x02000000	/* Issue ADISC when dq'ed from
  					   NPR list */
++<<<<<<< HEAD
 +#define NLP_RM_DFLT_RPI    0x04000000	/* need to remove leftover dflt RPI */
 +#define NLP_NODEV_REMOVE   0x08000000	/* Defer removal till discovery ends */
 +#define NLP_TARGET_REMOVE  0x10000000   /* Target remove in process */
 +#define NLP_SC_REQ         0x20000000	/* Target requires authentication */
 +#define NLP_FIRSTBURST     0x40000000	/* Target supports FirstBurst */
 +#define NLP_RPI_REGISTERED 0x80000000	/* nlp_rpi is valid */
++=======
+ 	NLP_RM_DFLT_RPI    = 26,        /* need to remove leftover dflt RPI */
+ 	NLP_NODEV_REMOVE   = 27,        /* Defer removal till discovery ends */
+ 	NLP_SC_REQ         = 29,        /* Target requires authentication */
+ 	NLP_FIRSTBURST     = 30,        /* Target supports FirstBurst */
+ 	NLP_RPI_REGISTERED = 31         /* nlp_rpi is valid */
+ };
++>>>>>>> bb33b07ac6e3 (scsi: lpfc: Delete NLP_TARGET_REMOVE flag due to obsolete usage)
  
  /* There are 4 different double linked lists nodelist entries can reside on.
   * The Port Login (PLOGI) list and Address Discovery (ADISC) list are used
diff --cc drivers/scsi/lpfc/lpfc_els.c
index 5c9369b9b870,842b67e37f10..000000000000
--- a/drivers/scsi/lpfc/lpfc_els.c
+++ b/drivers/scsi/lpfc/lpfc_els.c
@@@ -3051,23 -3035,6 +3051,26 @@@ lpfc_cmpl_els_logo(struct lpfc_hba *phb
  	/* Call state machine. This will unregister the rpi if needed. */
  	lpfc_disc_state_machine(vport, ndlp, cmdiocb, NLP_EVT_CMPL_LOGO);
  
++<<<<<<< HEAD
 +	if (skip_recovery)
 +		goto out;
 +
 +	/* The driver sets this flag for an NPIV instance that doesn't want to
 +	 * log into the remote port.
 +	 */
 +	if (ndlp->nlp_flag & NLP_TARGET_REMOVE) {
 +		spin_lock_irq(&ndlp->lock);
 +		if (phba->sli_rev == LPFC_SLI_REV4)
 +			ndlp->nlp_flag |= NLP_RELEASE_RPI;
 +		ndlp->nlp_flag &= ~NLP_NPR_2B_DISC;
 +		spin_unlock_irq(&ndlp->lock);
 +		lpfc_disc_state_machine(vport, ndlp, cmdiocb,
 +					NLP_EVT_DEVICE_RM);
 +		goto out_rsrc_free;
 +	}
 +
++=======
++>>>>>>> bb33b07ac6e3 (scsi: lpfc: Delete NLP_TARGET_REMOVE flag due to obsolete usage)
  out:
  	/* At this point, the LOGO processing is complete. NOTE: For a
  	 * pt2pt topology, we are assuming the NPortID will only change
@@@ -10238,10 -10398,6 +10241,13 @@@ lpfc_els_unsol_buffer(struct lpfc_hba *
  			}
  		}
  
++<<<<<<< HEAD
 +		spin_lock_irq(&ndlp->lock);
 +		ndlp->nlp_flag &= ~NLP_TARGET_REMOVE;
 +		spin_unlock_irq(&ndlp->lock);
 +
++=======
++>>>>>>> bb33b07ac6e3 (scsi: lpfc: Delete NLP_TARGET_REMOVE flag due to obsolete usage)
  		lpfc_disc_state_machine(vport, ndlp, elsiocb,
  					NLP_EVT_RCV_PLOGI);
  
diff --cc drivers/scsi/lpfc/lpfc_nportdisc.c
index 297b4db5a986,71c76d90e8e7..000000000000
--- a/drivers/scsi/lpfc/lpfc_nportdisc.c
+++ b/drivers/scsi/lpfc/lpfc_nportdisc.c
@@@ -2265,13 -2255,13 +2265,19 @@@ lpfc_cmpl_prli_prli_issue(struct lpfc_v
  	    (vport->port_type == LPFC_NPIV_PORT) &&
  	     vport->cfg_restrict_login) {
  out:
++<<<<<<< HEAD
 +		spin_lock_irq(&ndlp->lock);
 +		ndlp->nlp_flag |= NLP_TARGET_REMOVE;
 +		spin_unlock_irq(&ndlp->lock);
++=======
+ 		lpfc_printf_vlog(vport, KERN_INFO,
+ 				 LOG_ELS | LOG_DISCOVERY | LOG_NODE,
+ 				 "6228 Sending LOGO, determined nlp_type "
+ 				 "0x%x nlp_flag x%lx refcnt %u\n",
+ 				 ndlp->nlp_type, ndlp->nlp_flag,
+ 				 kref_read(&ndlp->kref));
++>>>>>>> bb33b07ac6e3 (scsi: lpfc: Delete NLP_TARGET_REMOVE flag due to obsolete usage)
  		lpfc_issue_els_logo(vport, ndlp, 0);
- 
- 		ndlp->nlp_prev_state = NLP_STE_PRLI_ISSUE;
- 		lpfc_nlp_set_state(vport, ndlp, NLP_STE_NPR_NODE);
  		return ndlp->nlp_state;
  	}
  
* Unmerged path drivers/scsi/lpfc/lpfc_disc.h
* Unmerged path drivers/scsi/lpfc/lpfc_els.c
* Unmerged path drivers/scsi/lpfc/lpfc_nportdisc.c
