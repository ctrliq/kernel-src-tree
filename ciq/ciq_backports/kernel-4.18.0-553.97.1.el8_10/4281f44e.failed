scsi: lpfc: Prevent NDLP reference count underflow in dev_loss_tmo callback

jira KERNEL-548
Rebuild_History Non-Buildable kernel-4.18.0-553.97.1.el8_10
commit-author Justin Tee <justin.tee@broadcom.com>
commit 4281f44ea8bfedd25938a0031bebba1473ece9ad
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.97.1.el8_10/4281f44e.failed

Current dev_loss_tmo handling checks whether there has been a previous
call to unregister with SCSI transport.  If so, the NDLP kref count is
decremented a second time in dev_loss_tmo as the final kref release.
However, this can sometimes result in a reference count underflow if
there is also a race to unregister with NVMe transport as well.  Add a
check for NVMe transport registration before decrementing the final
kref.  If NVMe transport is still registered, then the NVMe transport
unregistration is designated as the final kref decrement.

	Signed-off-by: Justin Tee <justin.tee@broadcom.com>
Link: https://lore.kernel.org/r/20241031223219.152342-8-justintee8345@gmail.com
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 4281f44ea8bfedd25938a0031bebba1473ece9ad)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/lpfc/lpfc_hbadisc.c
diff --cc drivers/scsi/lpfc/lpfc_hbadisc.c
index 16096da1c658,3c8cb6ecc0ac..000000000000
--- a/drivers/scsi/lpfc/lpfc_hbadisc.c
+++ b/drivers/scsi/lpfc/lpfc_hbadisc.c
@@@ -181,8 -182,9 +182,14 @@@ lpfc_dev_loss_tmo_callbk(struct fc_rpor
  			 ndlp->nlp_state, ndlp->fc4_xpt_flags);
  
  	/* Don't schedule a worker thread event if the vport is going down. */
++<<<<<<< HEAD
 +	if (vport->load_flag & FC_UNLOADING ||
 +		!(phba->hba_flag & HBA_SETUP)) {
++=======
+ 	if (test_bit(FC_UNLOADING, &vport->load_flag) ||
+ 	    !test_bit(HBA_SETUP, &phba->hba_flag)) {
+ 
++>>>>>>> 4281f44ea8bf (scsi: lpfc: Prevent NDLP reference count underflow in dev_loss_tmo callback)
  		spin_lock_irqsave(&ndlp->lock, iflags);
  		ndlp->rport = NULL;
  
* Unmerged path drivers/scsi/lpfc/lpfc_hbadisc.c
