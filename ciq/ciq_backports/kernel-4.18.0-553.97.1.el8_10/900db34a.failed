scsi: lpfc: Add condition to delete ndlp object after sending BLS_RJT to an ABTS

jira KERNEL-548
Rebuild_History Non-Buildable kernel-4.18.0-553.97.1.el8_10
commit-author Justin Tee <justin.tee@broadcom.com>
commit 900db34ad26554d83ae033065a047358994bfe88
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.97.1.el8_10/900db34a.failed

The "Nodelist not empty" log message and an accompanying delay may be
observed when deleting an NPIV port or unloading the lpfc driver.  This can
occur due to receipt of an ABTS for which there is no corresponding login
context or ndlp allocated.  In such cases, the driver allocates a new ndlp
object to send a BLS_RJT after which the ndlp object unintentionally
remains in the NLP_STE_UNUSED_NODE state forever.

Add a check to conditionally remove ndlp's initial reference count when
queuing a BLS response.  If the initial reference is removed, then set
the NLP_DROPPED flag to notify other code paths.

	Signed-off-by: Justin Tee <justin.tee@broadcom.com>
Link: https://lore.kernel.org/r/20240131185112.149731-9-justintee8345@gmail.com
	Reviewed-by: Himanshu Madhani <himanshu.madhani@oracle.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 900db34ad26554d83ae033065a047358994bfe88)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/lpfc/lpfc_sli.c
diff --cc drivers/scsi/lpfc/lpfc_sli.c
index cde4f0a52f61,29fd2eda70d5..000000000000
--- a/drivers/scsi/lpfc/lpfc_sli.c
+++ b/drivers/scsi/lpfc/lpfc_sli.c
@@@ -19290,10 -18953,11 +19290,15 @@@ lpfc_sli4_seq_abort_rsp(struct lpfc_vpo
  		return;
  	}
  
++<<<<<<< HEAD
 +	ctiocb->vport = phba->pport;
 +	ctiocb->iocb_cmpl = lpfc_sli4_seq_abort_rsp_cmpl;
++=======
+ 	ctiocb->vport = vport;
+ 	ctiocb->cmd_cmpl = lpfc_sli4_seq_abort_rsp_cmpl;
++>>>>>>> 900db34ad265 (scsi: lpfc: Add condition to delete ndlp object after sending BLS_RJT to an ABTS)
  	ctiocb->sli4_lxritag = NO_XRI;
  	ctiocb->sli4_xritag = NO_XRI;
 -	ctiocb->abort_rctl = FC_RCTL_BA_ACC;
  
  	if (fctl & FC_FC_EX_CTX)
  		/* Exchange responder sent the abort so we
@@@ -19356,12 -19034,22 +19361,22 @@@
  		lpfc_printf_vlog(vport, KERN_ERR, LOG_TRACE_EVENT,
  				 "2925 Failed to issue CT ABTS RSP x%x on "
  				 "xri x%x, Data x%x\n",
 -				 ctiocb->abort_rctl, oxid,
 +				 icmd->un.xseq64.w5.hcsw.Rctl, oxid,
  				 phba->link_state);
  		lpfc_nlp_put(ndlp);
 -		ctiocb->ndlp = NULL;
 +		ctiocb->context1 = NULL;
  		lpfc_sli_release_iocbq(phba, ctiocb);
  	}
+ 
+ 	/* if only usage of this nodelist is BLS response, release initial ref
+ 	 * to free ndlp when transmit completes
+ 	 */
+ 	if (ndlp->nlp_state == NLP_STE_UNUSED_NODE &&
+ 	    !(ndlp->nlp_flag & NLP_DROPPED) &&
+ 	    !(ndlp->fc4_xpt_flags & (NVME_XPT_REGD | SCSI_XPT_REGD))) {
+ 		ndlp->nlp_flag |= NLP_DROPPED;
+ 		lpfc_nlp_put(ndlp);
+ 	}
  }
  
  /**
* Unmerged path drivers/scsi/lpfc/lpfc_sli.c
