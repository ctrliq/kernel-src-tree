net: dst: add four helpers to annotate data-races around dst->dev

jira KERNEL-572
Rebuild_History Non-Buildable kernel-6.12.0-124.31.1.el10_1
commit-author Eric Dumazet <edumazet@google.com>
commit 88fe14253e181878c2ddb51a298ae8c468a63010
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-6.12.0-124.31.1.el10_1/88fe1425.failed

dst->dev is read locklessly in many contexts,
and written in dst_dev_put().

Fixing all the races is going to need many changes.

We probably will have to add full RCU protection.

Add three helpers to ease this painful process.

static inline struct net_device *dst_dev(const struct dst_entry *dst)
{
       return READ_ONCE(dst->dev);
}

static inline struct net_device *skb_dst_dev(const struct sk_buff *skb)
{
       return dst_dev(skb_dst(skb));
}

static inline struct net *skb_dst_dev_net(const struct sk_buff *skb)
{
       return dev_net(skb_dst_dev(skb));
}

static inline struct net *skb_dst_dev_net_rcu(const struct sk_buff *skb)
{
       return dev_net_rcu(skb_dst_dev(skb));
}

Fixes: 4a6ce2b6f2ec ("net: introduce a new function dst_dev_put()")
	Signed-off-by: Eric Dumazet <edumazet@google.com>
	Reviewed-by: Kuniyuki Iwashima <kuniyu@google.com>
Link: https://patch.msgid.link/20250630121934.3399505-7-edumazet@google.com
	Signed-off-by: Jakub Kicinski <kuba@kernel.org>
(cherry picked from commit 88fe14253e181878c2ddb51a298ae8c468a63010)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/core/dst.c
#	net/core/sock.c
diff --cc net/core/dst.c
index 795ca07e28a4,e2de8b68c41d..000000000000
--- a/net/core/dst.c
+++ b/net/core/dst.c
@@@ -145,12 -145,12 +145,18 @@@ void dst_dev_put(struct dst_entry *dst
  {
  	struct net_device *dev = dst->dev;
  
 -	WRITE_ONCE(dst->obsolete, DST_OBSOLETE_DEAD);
 +	dst->obsolete = DST_OBSOLETE_DEAD;
  	if (dst->ops->ifdown)
  		dst->ops->ifdown(dst, dev);
++<<<<<<< HEAD
 +	dst->input = dst_discard;
 +	dst->output = dst_discard_out;
 +	dst->dev = blackhole_netdev;
++=======
+ 	WRITE_ONCE(dst->input, dst_discard);
+ 	WRITE_ONCE(dst->output, dst_discard_out);
+ 	WRITE_ONCE(dst->dev, blackhole_netdev);
++>>>>>>> 88fe14253e18 (net: dst: add four helpers to annotate data-races around dst->dev)
  	netdev_ref_replace(dev, blackhole_netdev, &dst->dev_tracker,
  			   GFP_ATOMIC);
  }
diff --cc net/core/sock.c
index 4379447ccd02,8b7623c7d547..000000000000
--- a/net/core/sock.c
+++ b/net/core/sock.c
@@@ -2544,9 -2600,13 +2544,16 @@@ void sk_setup_caps(struct sock *sk, str
  {
  	u32 max_segs = 1;
  
++<<<<<<< HEAD
 +	sk->sk_route_caps = dst->dev->features;
 +	if (sk_is_tcp(sk))
++=======
+ 	sk->sk_route_caps = dst_dev(dst)->features;
+ 	if (sk_is_tcp(sk)) {
+ 		struct inet_connection_sock *icsk = inet_csk(sk);
+ 
++>>>>>>> 88fe14253e18 (net: dst: add four helpers to annotate data-races around dst->dev)
  		sk->sk_route_caps |= NETIF_F_GSO;
 -		icsk->icsk_ack.dst_quick_ack = dst_metric(dst, RTAX_QUICKACK);
 -	}
  	if (sk->sk_route_caps & NETIF_F_GSO)
  		sk->sk_route_caps |= NETIF_F_GSO_SOFTWARE;
  	if (unlikely(sk->sk_gso_disabled))
diff --git a/include/net/dst.h b/include/net/dst.h
index 08647c99d79c..281d94998cff 100644
--- a/include/net/dst.h
+++ b/include/net/dst.h
@@ -561,6 +561,26 @@ static inline void skb_dst_update_pmtu_no_confirm(struct sk_buff *skb, u32 mtu)
 		dst->ops->update_pmtu(dst, NULL, skb, mtu, false);
 }
 
+static inline struct net_device *dst_dev(const struct dst_entry *dst)
+{
+	return READ_ONCE(dst->dev);
+}
+
+static inline struct net_device *skb_dst_dev(const struct sk_buff *skb)
+{
+	return dst_dev(skb_dst(skb));
+}
+
+static inline struct net *skb_dst_dev_net(const struct sk_buff *skb)
+{
+	return dev_net(skb_dst_dev(skb));
+}
+
+static inline struct net *skb_dst_dev_net_rcu(const struct sk_buff *skb)
+{
+	return dev_net_rcu(skb_dst_dev(skb));
+}
+
 struct dst_entry *dst_blackhole_check(struct dst_entry *dst, u32 cookie);
 void dst_blackhole_update_pmtu(struct dst_entry *dst, struct sock *sk,
 			       struct sk_buff *skb, u32 mtu, bool confirm_neigh);
* Unmerged path net/core/dst.c
* Unmerged path net/core/sock.c
