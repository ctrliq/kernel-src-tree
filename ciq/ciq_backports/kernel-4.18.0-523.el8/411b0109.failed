s390/vfio-ap: wait for response code 05 to clear on queue reset

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-523.el8
commit-author Tony Krowiak <akrowiak@linux.ibm.com>
commit 411b0109daa52d1cc5be39635631e22a5590c5d8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-523.el8/411b0109.failed

Response code 05, AP busy, is a valid response code for a ZAPQ or TAPQ.
Instead of returning error -EIO when a ZAPQ fails with response code 05,
let's wait until the queue is no longer busy and try the ZAPQ again.

	Signed-off-by: Tony Krowiak <akrowiak@linux.ibm.com>
	Acked-by: Janosch Frank <frankja@linux.ibm.com>
	Tested-by: Viktor Mihajlovski <mihajlov@linux.ibm.com>
Link: https://lore.kernel.org/r/20230815184333.6554-4-akrowiak@linux.ibm.com
	Signed-off-by: Heiko Carstens <hca@linux.ibm.com>
(cherry picked from commit 411b0109daa52d1cc5be39635631e22a5590c5d8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/s390/crypto/vfio_ap_ops.c
diff --cc drivers/s390/crypto/vfio_ap_ops.c
index ef0d06898296,3f67cfb53d0c..000000000000
--- a/drivers/s390/crypto/vfio_ap_ops.c
+++ b/drivers/s390/crypto/vfio_ap_ops.c
@@@ -1594,28 -1655,35 +1595,49 @@@ retry_zapq
  	switch (status.response_code) {
  	case AP_RESPONSE_NORMAL:
  		ret = 0;
 -		if (!status.irq_enabled)
 -			vfio_ap_free_aqic_resources(q);
 -		if (!status.queue_empty || status.irq_enabled) {
 +		/* if the reset has not completed, wait for it to take effect */
 +		if (!status.queue_empty || status.irq_enabled)
  			ret = apq_reset_check(q);
 -			if (status.irq_enabled && ret == 0)
 -				vfio_ap_free_aqic_resources(q);
 -		}
  		break;
  	case AP_RESPONSE_RESET_IN_PROGRESS:
++<<<<<<< HEAD
 +		if (retry--) {
 +			msleep(20);
 +			goto retry_zapq;
 +		}
 +		ret = -EBUSY;
++=======
+ 	case AP_RESPONSE_BUSY:
+ 		/*
+ 		 * There is a reset issued by another process in progress. Let's wait
+ 		 * for that to complete. Since we have no idea whether it was a RAPQ or
+ 		 * ZAPQ, then if it completes successfully, let's issue the ZAPQ.
+ 		 */
+ 		ret = apq_reset_check(q);
+ 		if (ret)
+ 			break;
+ 		goto retry_zapq;
+ 	case AP_RESPONSE_DECONFIGURED:
+ 		/*
+ 		 * When an AP adapter is deconfigured, the associated
+ 		 * queues are reset, so let's return a value indicating the reset
+ 		 * completed successfully.
+ 		 */
+ 		ret = 0;
+ 		vfio_ap_free_aqic_resources(q);
++>>>>>>> 411b0109daa5 (s390/vfio-ap: wait for response code 05 to clear on queue reset)
  		break;
 +	case AP_RESPONSE_Q_NOT_AVAIL:
 +	case AP_RESPONSE_DECONFIGURED:
 +	case AP_RESPONSE_CHECKSTOPPED:
 +		WARN_ONCE(status.irq_enabled,
 +			  "PQAP/ZAPQ for %02x.%04x failed with rc=%u while IRQ enabled",
 +			  AP_QID_CARD(q->apqn), AP_QID_QUEUE(q->apqn),
 +			  status.response_code);
 +		ret = -EBUSY;
 +		goto free_resources;
  	default:
 +		/* things are really broken, give up */
  		WARN(true,
  		     "PQAP/ZAPQ for %02x.%04x failed with invalid rc=%u\n",
  		     AP_QID_CARD(q->apqn), AP_QID_QUEUE(q->apqn),
* Unmerged path drivers/s390/crypto/vfio_ap_ops.c
