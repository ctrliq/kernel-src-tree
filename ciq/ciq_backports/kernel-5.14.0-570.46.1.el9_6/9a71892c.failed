Revert "driver core: Fix uevent_show() vs driver detach race"

jira LE-4311
Rebuild_History Non-Buildable kernel-5.14.0-570.46.1.el9_6
commit-author Greg Kroah-Hartman <gregkh@linuxfoundation.org>
commit 9a71892cbcdb9d1459c84f5a4c722b14354158a5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-5.14.0-570.46.1.el9_6/9a71892c.failed

This reverts commit 15fffc6a5624b13b428bb1c6e9088e32a55eb82c.

This commit causes a regression, so revert it for now until it can come
back in a way that works for everyone.

Link: https://lore.kernel.org/all/172790598832.1168608.4519484276671503678.stgit@dwillia2-xfh.jf.intel.com/
Fixes: 15fffc6a5624 ("driver core: Fix uevent_show() vs driver detach race")
	Cc: stable <stable@kernel.org>
	Cc: Ashish Sangwan <a.sangwan@samsung.com>
	Cc: Namjae Jeon <namjae.jeon@samsung.com>
	Cc: Dirk Behme <dirk.behme@de.bosch.com>
	Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
	Cc: Rafael J. Wysocki <rafael@kernel.org>
	Cc: Dan Williams <dan.j.williams@intel.com>
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 9a71892cbcdb9d1459c84f5a4c722b14354158a5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/base/core.c
diff --cc drivers/base/core.c
index b2fe401abd4a,adc0d74fa96c..000000000000
--- a/drivers/base/core.c
+++ b/drivers/base/core.c
@@@ -22,16 -25,13 +22,20 @@@
  #include <linux/notifier.h>
  #include <linux/of.h>
  #include <linux/of_device.h>
 +#include <linux/blkdev.h>
 +#include <linux/mutex.h>
  #include <linux/pm_runtime.h>
++<<<<<<< HEAD
 +#include <linux/netdevice.h>
 +#include <linux/rcupdate.h>
++=======
+ #include <linux/sched/mm.h>
++>>>>>>> 9a71892cbcdb (Revert "driver core: Fix uevent_show() vs driver detach race")
  #include <linux/sched/signal.h>
 -#include <linux/slab.h>
 -#include <linux/string_helpers.h>
 +#include <linux/sched/mm.h>
  #include <linux/swiotlb.h>
  #include <linux/sysfs.h>
 +#include <linux/dma-map-ops.h> /* for dma_default_coherent */
  
  #include "base.h"
  #include "physical_location.h"
* Unmerged path drivers/base/core.c
diff --git a/drivers/base/module.c b/drivers/base/module.c
index 851cc5367c04..46ad4d636731 100644
--- a/drivers/base/module.c
+++ b/drivers/base/module.c
@@ -7,7 +7,6 @@
 #include <linux/errno.h>
 #include <linux/slab.h>
 #include <linux/string.h>
-#include <linux/rcupdate.h>
 #include "base.h"
 
 static char *make_driver_name(struct device_driver *drv)
@@ -78,9 +77,6 @@ void module_remove_driver(struct device_driver *drv)
 	if (!drv)
 		return;
 
-	/* Synchronize with dev_uevent() */
-	synchronize_rcu();
-
 	sysfs_remove_link(&drv->p->kobj, "module");
 
 	if (drv->owner)
