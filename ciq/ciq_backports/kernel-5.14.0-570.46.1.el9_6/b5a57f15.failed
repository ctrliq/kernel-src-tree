scsi: fnic: Add support for target based solicited requests and responses

jira LE-4311
Rebuild_History Non-Buildable kernel-5.14.0-570.46.1.el9_6
commit-author Karan Tilak Kumar <kartilak@cisco.com>
commit b5a57f153bdf772ed41ef286826cef7a1c52f433
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-5.14.0-570.46.1.el9_6/b5a57f15.failed

Add support for target based solicited requests and responses.

Add support for tport definitions and processing.

Add support for restarting the IT nexus.

	Reported-by: kernel test robot <lkp@intel.com>
Closes: https://lore.kernel.org/oe-kbuild-all/202406120146.xchlZbqX-lkp@intel.com/
Closes: https://lore.kernel.org/oe-kbuild-all/202412081427.SlsFIJY4-lkp@intel.com/
	Reviewed-by: Sesidhar Baddela <sebaddel@cisco.com>
Co-developed-by: Gian Carlo Boffa <gcboffa@cisco.com>
	Signed-off-by: Gian Carlo Boffa <gcboffa@cisco.com>
Co-developed-by: Arulprabhu Ponnusamy <arulponn@cisco.com>
	Signed-off-by: Arulprabhu Ponnusamy <arulponn@cisco.com>
Co-developed-by: Arun Easi <aeasi@cisco.com>
	Signed-off-by: Arun Easi <aeasi@cisco.com>
Co-developed-by: Karan Tilak Kumar <kartilak@cisco.com>
	Signed-off-by: Karan Tilak Kumar <kartilak@cisco.com>
Link: https://lore.kernel.org/r/20241212020312.4786-5-kartilak@cisco.com
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit b5a57f153bdf772ed41ef286826cef7a1c52f433)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/fnic/fdls_disc.c
#	drivers/scsi/fnic/fnic.h
diff --cc drivers/scsi/fnic/fnic.h
index 73fb8245c7b7,1676bd8324fc..000000000000
--- a/drivers/scsi/fnic/fnic.h
+++ b/drivers/scsi/fnic/fnic.h
@@@ -88,16 -82,34 +88,24 @@@
  #define FNIC_DEV_RST_TERM_DONE          BIT(20)
  #define FNIC_DEV_RST_ABTS_PENDING       BIT(21)
  
++<<<<<<< HEAD
++=======
+ #define IS_FNIC_FCP_INITIATOR(fnic) (fnic->role == FNIC_ROLE_FCP_INITIATOR)
+ 
+ /* Retry supported by rport (returned by PRLI service parameters) */
+ #define FNIC_FC_RP_FLAGS_RETRY            0x1
+ 
++>>>>>>> b5a57f153bdf (scsi: fnic: Add support for target based solicited requests and responses)
  /*
 - * fnic private data per SCSI command.
 + * Usage of the scsi_cmnd scratchpad.
   * These fields are locked by the hashed io_req_lock.
   */
 -struct fnic_cmd_priv {
 -	struct fnic_io_req *io_req;
 -	enum fnic_ioreq_state state;
 -	u32 flags;
 -	u16 abts_status;
 -	u16 lr_status;
 -};
 -
 -static inline struct fnic_cmd_priv *fnic_priv(struct scsi_cmnd *cmd)
 -{
 -	return scsi_cmd_priv(cmd);
 -}
 -
 -static inline u64 fnic_flags_and_state(struct scsi_cmnd *cmd)
 -{
 -	struct fnic_cmd_priv *fcmd = fnic_priv(cmd);
 -
 -	return ((u64)fcmd->flags << 32) | fcmd->state;
 -}
 +#define CMD_SP(Cmnd)		((Cmnd)->SCp.ptr)
 +#define CMD_STATE(Cmnd)		((Cmnd)->SCp.phase)
 +#define CMD_ABTS_STATUS(Cmnd)	((Cmnd)->SCp.Message)
 +#define CMD_LR_STATUS(Cmnd)	((Cmnd)->SCp.have_data_in)
 +#define CMD_TAG(Cmnd)           ((Cmnd)->SCp.sent_command)
 +#define CMD_FLAGS(Cmnd)         ((Cmnd)->SCp.Status)
  
  #define FCPIO_INVALID_CODE 0x100 /* hdr_status value unused by firmware */
  
@@@ -299,7 -337,11 +308,15 @@@ struct fnic 
  	struct work_struct frame_work;
  	struct work_struct flush_work;
  	struct sk_buff_head frame_queue;
++<<<<<<< HEAD
 +	struct sk_buff_head tx_queue;
++=======
+ 	struct list_head tx_queue;
+ 	mempool_t *frame_pool;
+ 	mempool_t *frame_elem_pool;
+ 	struct work_struct tport_work;
+ 	struct list_head tport_event_list;
++>>>>>>> b5a57f153bdf (scsi: fnic: Add support for target based solicited requests and responses)
  
  	/*** FIP related data members  -- start ***/
  	void (*set_vlan)(struct fnic *, u16 vlan);
* Unmerged path drivers/scsi/fnic/fdls_disc.c
* Unmerged path drivers/scsi/fnic/fdls_disc.c
* Unmerged path drivers/scsi/fnic/fnic.h
diff --git a/drivers/scsi/fnic/fnic_fdls.h b/drivers/scsi/fnic/fnic_fdls.h
index 5d78eea20873..1adab07eb742 100644
--- a/drivers/scsi/fnic/fnic_fdls.h
+++ b/drivers/scsi/fnic/fnic_fdls.h
@@ -388,7 +388,7 @@ void fdls_send_fabric_logo(struct fnic_iport_s *iport);
 int fnic_fdls_validate_and_get_frame_type(struct fnic_iport_s *iport,
 	struct fc_frame_header *fchdr);
 void fdls_send_tport_abts(struct fnic_iport_s *iport,
-			  struct fnic_tport_s *tport);
+						struct fnic_tport_s *tport);
 bool fdls_delete_tport(struct fnic_iport_s *iport,
 		       struct fnic_tport_s *tport);
 void fdls_fdmi_timer_callback(struct timer_list *t);
