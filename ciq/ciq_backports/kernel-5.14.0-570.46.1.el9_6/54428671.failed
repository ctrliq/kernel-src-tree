scsi: fnic: Test for memory allocation failure and return error code

jira LE-4311
Rebuild_History Non-Buildable kernel-5.14.0-570.46.1.el9_6
commit-author Karan Tilak Kumar <kartilak@cisco.com>
commit 54428671aac88dd11074c47cb7e7726e41d40f4a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-5.14.0-570.46.1.el9_6/54428671.failed

Fix kernel test robot warning.  Test for memory allocation failure, and
free memory for queues allocated in a multiqueue and non-multiqueue
scenario.  Return appropriate error code.

	Reported-by: kernel test robot <lkp@intel.com>
Closes: https://lore.kernel.org/r/202412312347.FE4ZgEoM-lkp@intel.com/
	Reported-by: Julia Lawall <julia.lawall@inria.fr>
Closes: https://lore.kernel.org/r/202412312347.FE4ZgEoM-lkp@intel.com/
	Reviewed-by: Sesidhar Baddela <sebaddel@cisco.com>
	Reviewed-by: Arulprabhu Ponnusamy <arulponn@cisco.com>
	Reviewed-by: Gian Carlo Boffa <gcboffa@cisco.com>
	Reviewed-by: Arun Easi <aeasi@cisco.com>
	Signed-off-by: Karan Tilak Kumar <kartilak@cisco.com>
Link: https://lore.kernel.org/r/20250110091924.17729-1-kartilak@cisco.com
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 54428671aac88dd11074c47cb7e7726e41d40f4a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/fnic/fnic_main.c
diff --cc drivers/scsi/fnic/fnic_main.c
index 06fd7b543b33,f8fe67bebf3e..000000000000
--- a/drivers/scsi/fnic/fnic_main.c
+++ b/drivers/scsi/fnic/fnic_main.c
@@@ -558,9 -572,31 +558,30 @@@ static void fnic_set_vlan(struct fnic *
  	vnic_dev_set_default_vlan(fnic->vdev, vlan_id);
  }
  
++<<<<<<< HEAD
++=======
+ static void fnic_scsi_init(struct fnic *fnic)
+ {
+ 	struct Scsi_Host *host = fnic->host;
+ 
+ 	snprintf(fnic->name, sizeof(fnic->name) - 1, "%s%d", DRV_NAME,
+ 			 host->host_no);
+ 
+ 	host->transportt = fnic_fc_transport;
+ }
+ 
+ static void fnic_free_ioreq_tables_mq(struct fnic *fnic)
+ {
+ 	int hwq;
+ 
+ 	for (hwq = 0; hwq < fnic->wq_copy_count; hwq++)
+ 		kfree(fnic->sw_copy_wq[hwq].io_req_table);
+ }
+ 
++>>>>>>> 54428671aac8 (scsi: fnic: Test for memory allocation failure and return error code)
  static int fnic_scsi_drv_init(struct fnic *fnic)
  {
 -	struct Scsi_Host *host = fnic->host;
 -	int err;
 -	struct pci_dev *pdev = fnic->pdev;
 -	struct fnic_iport_s *iport = &fnic->iport;
 -	int hwq;
 +	struct Scsi_Host *host = fnic->lport->host;
  
  	/* Configure maximum outstanding IO reqs*/
  	if (fnic->config.io_throttle_count != FNIC_UCSM_DFLT_THROTTLE_CNT_BLD)
@@@ -571,23 -607,71 +592,81 @@@
  	fnic->fnic_max_tag_id = host->can_queue;
  	host->max_lun = fnic->config.luns_per_tgt;
  	host->max_id = FNIC_MAX_FCP_TARGET;
 -	host->max_cmd_len = FNIC_FCOE_MAX_CMD_LEN;
 +	host->max_cmd_len = FCOE_MAX_CMD_LEN;
  
  	host->nr_hw_queues = fnic->wq_copy_count;
 +	if (host->nr_hw_queues > 1)
 +		shost_printk(KERN_ERR, host,
 +				"fnic: blk-mq is not supported");
 +
 +	host->nr_hw_queues = fnic->wq_copy_count = 1;
  
 -	dev_info(&fnic->pdev->dev, "fnic: can_queue: %d max_lun: %llu",
 +	shost_printk(KERN_INFO, host,
 +			"fnic: can_queue: %d max_lun: %llu",
  			host->can_queue, host->max_lun);
  
 -	dev_info(&fnic->pdev->dev, "fnic: max_id: %d max_cmd_len: %d nr_hw_queues: %d",
 +	shost_printk(KERN_INFO, host,
 +			"fnic: max_id: %d max_cmd_len: %d nr_hw_queues: %d",
  			host->max_id, host->max_cmd_len, host->nr_hw_queues);
  
++<<<<<<< HEAD
++=======
+ 	for (hwq = 0; hwq < fnic->wq_copy_count; hwq++) {
+ 		fnic->sw_copy_wq[hwq].ioreq_table_size = fnic->fnic_max_tag_id;
+ 		fnic->sw_copy_wq[hwq].io_req_table =
+ 			kzalloc((fnic->sw_copy_wq[hwq].ioreq_table_size + 1) *
+ 					sizeof(struct fnic_io_req *), GFP_KERNEL);
+ 
+ 		if (!fnic->sw_copy_wq[hwq].io_req_table) {
+ 			fnic_free_ioreq_tables_mq(fnic);
+ 			return -ENOMEM;
+ 		}
+ 	}
+ 
+ 	dev_info(&fnic->pdev->dev, "fnic copy wqs: %d, Q0 ioreq table size: %d\n",
+ 			fnic->wq_copy_count, fnic->sw_copy_wq[0].ioreq_table_size);
+ 
+ 	fnic_scsi_init(fnic);
+ 
+ 	err = scsi_add_host(fnic->host, &pdev->dev);
+ 	if (err) {
+ 		dev_err(&fnic->pdev->dev, "fnic: scsi add host failed: aborting\n");
+ 		return -1;
+ 	}
+ 	fc_host_maxframe_size(fnic->host) = iport->max_payload_size;
+ 	fc_host_dev_loss_tmo(fnic->host) =
+ 		fnic->config.port_down_timeout / 1000;
+ 	sprintf(fc_host_symbolic_name(fnic->host),
+ 			DRV_NAME " v" DRV_VERSION " over %s", fnic->name);
+ 	fc_host_port_type(fnic->host) = FC_PORTTYPE_NPORT;
+ 	fc_host_node_name(fnic->host) = iport->wwnn;
+ 	fc_host_port_name(fnic->host) = iport->wwpn;
+ 	fc_host_supported_classes(fnic->host) = FC_COS_CLASS3;
+ 	memset(fc_host_supported_fc4s(fnic->host), 0,
+ 		   sizeof(fc_host_supported_fc4s(fnic->host)));
+ 	fc_host_supported_fc4s(fnic->host)[2] = 1;
+ 	fc_host_supported_fc4s(fnic->host)[7] = 1;
+ 	fc_host_supported_speeds(fnic->host) = 0;
+ 	fc_host_supported_speeds(fnic->host) |= FC_PORTSPEED_8GBIT;
+ 
+ 	dev_info(&fnic->pdev->dev, "shost_data: 0x%p\n", fnic->host->shost_data);
+ 	if (fnic->host->shost_data != NULL) {
+ 		if (fnic_tgt_id_binding == 0) {
+ 			dev_info(&fnic->pdev->dev, "Setting target binding to NONE\n");
+ 			fc_host_tgtid_bind_type(fnic->host) = FC_TGTID_BIND_NONE;
+ 		} else {
+ 			dev_info(&fnic->pdev->dev, "Setting target binding to WWPN\n");
+ 			fc_host_tgtid_bind_type(fnic->host) = FC_TGTID_BIND_BY_WWPN;
+ 		}
+ 	}
+ 
+ 	fnic->io_req_pool = mempool_create_slab_pool(2, fnic_io_req_cache);
+ 	if (!fnic->io_req_pool) {
+ 		scsi_remove_host(fnic->host);
+ 		return -ENOMEM;
+ 	}
+ 
++>>>>>>> 54428671aac8 (scsi: fnic: Test for memory allocation failure and return error code)
  	return 0;
  }
  
@@@ -941,16 -1071,25 +1020,30 @@@ static int fnic_probe(struct pci_dev *p
  
  	return 0;
  
++<<<<<<< HEAD
 +err_out_free_exch_mgr:
 +	fc_exch_mgr_free(lp);
 +err_out_remove_scsi_host:
 +	fc_remove_host(lp->host);
 +	scsi_remove_host(lp->host);
 +err_out_free_rq_buf:
 +	for (i = 0; i < fnic->rq_count; i++)
++=======
+ err_out_free_stats_debugfs:
+ 	fnic_stats_debugfs_remove(fnic);
+ 	fnic_free_ioreq_tables_mq(fnic);
+ 	scsi_remove_host(fnic->host);
+ err_out_scsi_drv_init:
+ 	fnic_free_intr(fnic);
+ err_out_fnic_request_intr:
+ err_out_alloc_rq_buf:
+ 	for (i = 0; i < fnic->rq_count; i++) {
+ 		if (ioread32(&fnic->rq[i].ctrl->enable))
+ 			vnic_rq_disable(&fnic->rq[i]);
++>>>>>>> 54428671aac8 (scsi: fnic: Test for memory allocation failure and return error code)
  		vnic_rq_clean(&fnic->rq[i], fnic_free_rq_buf);
 -	}
  	vnic_dev_notify_unset(fnic->vdev);
 -err_out_fnic_notify_set:
 -	mempool_destroy(fnic->frame_elem_pool);
 -err_out_fdls_frame_elem_pool:
 -	mempool_destroy(fnic->frame_pool);
 -err_out_fdls_frame_pool:
 +err_out_free_max_pool:
  	mempool_destroy(fnic->io_sgl_pool[FNIC_SGL_CACHE_MAX]);
  err_out_free_dflt_pool:
  	mempool_destroy(fnic->io_sgl_pool[FNIC_SGL_CACHE_DFLT]);
* Unmerged path drivers/scsi/fnic/fnic_main.c
