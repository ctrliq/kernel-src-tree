scsi: fnic: unlock on error path in fnic_queuecommand()

jira LE-4311
Rebuild_History Non-Buildable kernel-5.14.0-570.46.1.el9_6
commit-author Dan Carpenter <dan.carpenter@linaro.org>
commit 38945c2b006b23a1a7a0c88d76e3294c6199891c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-5.14.0-570.46.1.el9_6/38945c2b.failed

Call spin_unlock_irqrestore(&fnic->wq_copy_lock[hwq], flags) before
returning.

Fixes: c81df08cd294 ("scsi: fnic: Add support for multiqueue (MQ) in fnic driver")
	Signed-off-by: Dan Carpenter <dan.carpenter@linaro.org>
Link: https://lore.kernel.org/r/5360fa20-74bc-4c22-a78e-ea8b18c5410d@moroto.mountain
	Reviewed-by: Karan Tilak Kumar <kartilak@cisco.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 38945c2b006b23a1a7a0c88d76e3294c6199891c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/fnic/fnic_scsi.c
diff --cc drivers/scsi/fnic/fnic_scsi.c
index a9f65dc3f089,8d7fc5284293..000000000000
--- a/drivers/scsi/fnic/fnic_scsi.c
+++ b/drivers/scsi/fnic/fnic_scsi.c
@@@ -557,14 -538,25 +557,31 @@@ static int fnic_queuecommand_lck(struc
  	io_lock_acquired = 1;
  	io_req->port_id = rport->port_id;
  	io_req->start_time = jiffies;
++<<<<<<< HEAD
 +	CMD_STATE(sc) = FNIC_IOREQ_CMD_PENDING;
 +	CMD_SP(sc) = (char *)io_req;
 +	CMD_FLAGS(sc) |= FNIC_IO_INITIALIZED;
 +	sc->scsi_done = done;
++=======
+ 	fnic_priv(sc)->state = FNIC_IOREQ_CMD_PENDING;
+ 	fnic_priv(sc)->io_req = io_req;
+ 	fnic_priv(sc)->flags |= FNIC_IO_INITIALIZED;
+ 	io_req->sc = sc;
+ 
+ 	if (fnic->sw_copy_wq[hwq].io_req_table[blk_mq_unique_tag_to_tag(mqtag)] != NULL) {
+ 		WARN(1, "fnic<%d>: %s: hwq: %d tag 0x%x already exists\n",
+ 				fnic->fnic_num, __func__, hwq, blk_mq_unique_tag_to_tag(mqtag));
+ 		spin_unlock_irqrestore(&fnic->wq_copy_lock[hwq], flags);
+ 		return SCSI_MLQUEUE_HOST_BUSY;
+ 	}
+ 
+ 	fnic->sw_copy_wq[hwq].io_req_table[blk_mq_unique_tag_to_tag(mqtag)] = io_req;
+ 	io_req->tag = mqtag;
++>>>>>>> 38945c2b006b (scsi: fnic: unlock on error path in fnic_queuecommand())
  
  	/* create copy wq desc and enqueue it */
 -	wq = &fnic->hw_copy_wq[hwq];
 -	atomic64_inc(&fnic_stats->io_stats.ios[hwq]);
 -	ret = fnic_queue_wq_copy_desc(fnic, wq, io_req, sc, sg_count, mqtag, hwq);
 +	wq = &fnic->hw_copy_wq[0];
 +	ret = fnic_queue_wq_copy_desc(fnic, wq, io_req, sc, sg_count);
  	if (ret) {
  		/*
  		 * In case another thread cancelled the request,
* Unmerged path drivers/scsi/fnic/fnic_scsi.c
