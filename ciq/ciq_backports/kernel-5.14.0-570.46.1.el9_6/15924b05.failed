scsi: fnic: Replace sgreset tag with max_tag_id

jira LE-4311
Rebuild_History Non-Buildable kernel-5.14.0-570.46.1.el9_6
commit-author Karan Tilak Kumar <kartilak@cisco.com>
commit 15924b0503630016dee4dbb945a8df4df659070b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-5.14.0-570.46.1.el9_6/15924b05.failed

sgreset is issued with a SCSI command pointer. The device reset code
assumes that it was issued on a hardware queue, and calls block multiqueue
layer. However, the assumption is broken, and there is no hardware queue
associated with the sgreset, and this leads to a crash due to a null
pointer exception.

Fix the code to use the max_tag_id as a tag which does not overlap with the
other tags issued by mid layer.

Tested by running FC traffic for a few minutes, and by issuing sgreset on
the device in parallel.  Without the fix, the crash is observed right away.
With this fix, no crash is observed.

	Reviewed-by: Sesidhar Baddela <sebaddel@cisco.com>
	Tested-by: Karan Tilak Kumar <kartilak@cisco.com>
	Signed-off-by: Karan Tilak Kumar <kartilak@cisco.com>
Link: https://lore.kernel.org/r/20230817182146.229059-1-kartilak@cisco.com
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 15924b0503630016dee4dbb945a8df4df659070b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/fnic/fnic.h
#	drivers/scsi/fnic/fnic_scsi.c
diff --cc drivers/scsi/fnic/fnic.h
index 38c8614e6aed,93c68931a593..000000000000
--- a/drivers/scsi/fnic/fnic.h
+++ b/drivers/scsi/fnic/fnic.h
@@@ -39,7 -27,7 +39,11 @@@
  
  #define DRV_NAME		"fnic"
  #define DRV_DESCRIPTION		"Cisco FCoE HBA Driver"
++<<<<<<< HEAD
 +#define DRV_VERSION		"1.6.0.55"
++=======
+ #define DRV_VERSION		"1.6.0.56"
++>>>>>>> 15924b050363 (scsi: fnic: Replace sgreset tag with max_tag_id)
  #define PFX			DRV_NAME ": "
  #define DFX                     DRV_NAME "%d: "
  
diff --cc drivers/scsi/fnic/fnic_scsi.c
index 0e605e372129,8ce3e3c3a882..000000000000
--- a/drivers/scsi/fnic/fnic_scsi.c
+++ b/drivers/scsi/fnic/fnic_scsi.c
@@@ -2278,8 -2248,7 +2277,12 @@@ int fnic_device_reset(struct scsi_cmnd 
  		goto fnic_device_reset_end;
  	}
  
++<<<<<<< HEAD
 +	CMD_FLAGS(sc) = FNIC_DEVICE_RESET;
 +	/* Allocate tag if not present */
++=======
+ 	fnic_priv(sc)->flags = FNIC_DEVICE_RESET;
++>>>>>>> 15924b050363 (scsi: fnic: Replace sgreset tag with max_tag_id)
  
  	if (unlikely(tag < 0)) {
  		/*
@@@ -2459,11 -2429,10 +2463,10 @@@ fnic_device_reset_end
  		  0, ((u64)sc->cmnd[0] << 32 |
  		  (u64)sc->cmnd[2] << 24 | (u64)sc->cmnd[3] << 16 |
  		  (u64)sc->cmnd[4] << 8 | sc->cmnd[5]),
 -		  fnic_flags_and_state(sc));
 +		  (((u64)CMD_FLAGS(sc) << 32) | CMD_STATE(sc)));
  
- 	/* free tag if it is allocated */
- 	if (unlikely(tag_gen_flag))
- 		fnic_scsi_host_end_tag(fnic, sc);
+ 	if (new_sc)
+ 		mutex_unlock(&fnic->sgreset_mutex);
  
  	FNIC_SCSI_DBG(KERN_DEBUG, fnic->lport->host,
  		      "Returning from device reset %s\n",
* Unmerged path drivers/scsi/fnic/fnic.h
* Unmerged path drivers/scsi/fnic/fnic_scsi.c
