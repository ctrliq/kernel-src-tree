xfs: allow setting full range of panic tags

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-539.el8
commit-author Donald Douwsma <ddouwsma@redhat.com>
commit 167ce4cbfa370114fee61ad5b58e401d95e2d5cd
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-539.el8/167ce4cb.failed

xfs will not allow combining other panic masks with
XFS_PTAG_VERIFIER_ERROR.

 # sysctl fs.xfs.panic_mask=511
 sysctl: setting key "fs.xfs.panic_mask": Invalid argument
 fs.xfs.panic_mask = 511

Update to the maximum value that can be set to allow the full range of
masks. Do this using a mask of possible values to prevent this happening
again as suggested by Darrick.

Fixes: d519da41e2b7 ("xfs: Introduce XFS_PTAG_VERIFIER_ERROR panic mask")
	Signed-off-by: Donald Douwsma <ddouwsma@redhat.com>
	Reviewed-by: Darrick J. Wong <djwong@kernel.org>
	Signed-off-by: Darrick J. Wong <djwong@kernel.org>
	Reviewed-by: Dave Chinner <dchinner@redhat.com>
(cherry picked from commit 167ce4cbfa370114fee61ad5b58e401d95e2d5cd)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/xfs/xfs_error.h
diff --cc fs/xfs/xfs_error.h
index 1717b7508356,0b9c5ba8a598..000000000000
--- a/fs/xfs/xfs_error.h
+++ b/fs/xfs/xfs_error.h
@@@ -62,17 -75,39 +62,52 @@@ extern int xfs_errortag_clearall(struc
  
  /*
   * XFS panic tags -- allow a call to xfs_alert_tag() be turned into
-  *			a panic by setting xfs_panic_mask in a sysctl.
+  *			a panic by setting fs.xfs.panic_mask in a sysctl.
   */
++<<<<<<< HEAD
 +#define		XFS_NO_PTAG			0
 +#define		XFS_PTAG_IFLUSH			0x00000001
 +#define		XFS_PTAG_LOGRES			0x00000002
 +#define		XFS_PTAG_AILDELETE		0x00000004
 +#define		XFS_PTAG_ERROR_REPORT		0x00000008
 +#define		XFS_PTAG_SHUTDOWN_CORRUPT	0x00000010
 +#define		XFS_PTAG_SHUTDOWN_IOERROR	0x00000020
 +#define		XFS_PTAG_SHUTDOWN_LOGERROR	0x00000040
 +#define		XFS_PTAG_FSBLOCK_ZERO		0x00000080
 +#define		XFS_PTAG_VERIFIER_ERROR		0x00000100
++=======
+ #define		XFS_NO_PTAG			0u
+ #define		XFS_PTAG_IFLUSH			(1u << 0)
+ #define		XFS_PTAG_LOGRES			(1u << 1)
+ #define		XFS_PTAG_AILDELETE		(1u << 2)
+ #define		XFS_PTAG_ERROR_REPORT		(1u << 3)
+ #define		XFS_PTAG_SHUTDOWN_CORRUPT	(1u << 4)
+ #define		XFS_PTAG_SHUTDOWN_IOERROR	(1u << 5)
+ #define		XFS_PTAG_SHUTDOWN_LOGERROR	(1u << 6)
+ #define		XFS_PTAG_FSBLOCK_ZERO		(1u << 7)
+ #define		XFS_PTAG_VERIFIER_ERROR		(1u << 8)
+ 
+ #define		XFS_PTAG_MASK	(XFS_PTAG_IFLUSH | \
+ 				 XFS_PTAG_LOGRES | \
+ 				 XFS_PTAG_AILDELETE | \
+ 				 XFS_PTAG_ERROR_REPORT | \
+ 				 XFS_PTAG_SHUTDOWN_CORRUPT | \
+ 				 XFS_PTAG_SHUTDOWN_IOERROR | \
+ 				 XFS_PTAG_SHUTDOWN_LOGERROR | \
+ 				 XFS_PTAG_FSBLOCK_ZERO | \
+ 				 XFS_PTAG_VERIFIER_ERROR)
+ 
+ #define XFS_PTAG_STRINGS \
+ 	{ XFS_NO_PTAG,			"none" }, \
+ 	{ XFS_PTAG_IFLUSH,		"iflush" }, \
+ 	{ XFS_PTAG_LOGRES,		"logres" }, \
+ 	{ XFS_PTAG_AILDELETE,		"aildelete" }, \
+ 	{ XFS_PTAG_ERROR_REPORT	,	"error_report" }, \
+ 	{ XFS_PTAG_SHUTDOWN_CORRUPT,	"corrupt" }, \
+ 	{ XFS_PTAG_SHUTDOWN_IOERROR,	"ioerror" }, \
+ 	{ XFS_PTAG_SHUTDOWN_LOGERROR,	"logerror" }, \
+ 	{ XFS_PTAG_FSBLOCK_ZERO,	"fsb_zero" }, \
+ 	{ XFS_PTAG_VERIFIER_ERROR,	"verifier" }
++>>>>>>> 167ce4cbfa37 (xfs: allow setting full range of panic tags)
  
  #endif	/* __XFS_ERROR_H__ */
diff --git a/Documentation/filesystems/xfs.txt b/Documentation/filesystems/xfs.txt
index 20c6aa2c7752..f2db0356dbf8 100644
--- a/Documentation/filesystems/xfs.txt
+++ b/Documentation/filesystems/xfs.txt
@@ -272,7 +272,7 @@ The following sysctls are available for the XFS filesystem:
 		XFS_ERRLEVEL_LOW:       1
 		XFS_ERRLEVEL_HIGH:      5
 
-  fs.xfs.panic_mask		(Min: 0  Default: 0  Max: 256)
+  fs.xfs.panic_mask		(Min: 0  Default: 0  Max: 511)
 	Causes certain error conditions to call BUG(). Value is a bitmask;
 	OR together the tags which represent errors which should cause panics:
 
* Unmerged path fs/xfs/xfs_error.h
diff --git a/fs/xfs/xfs_globals.c b/fs/xfs/xfs_globals.c
index f62fa652c2fd..4a71b945f0a9 100644
--- a/fs/xfs/xfs_globals.c
+++ b/fs/xfs/xfs_globals.c
@@ -4,6 +4,7 @@
  * All Rights Reserved.
  */
 #include "xfs.h"
+#include "xfs_error.h"
 
 /*
  * Tunable XFS parameters.  xfs_params is required even when CONFIG_SYSCTL=n,
@@ -15,7 +16,7 @@ xfs_param_t xfs_params = {
 			  /*	MIN		DFLT		MAX	*/
 	.sgid_inherit	= {	0,		0,		1	},
 	.symlink_mode	= {	0,		0,		1	},
-	.panic_mask	= {	0,		0,		256	},
+	.panic_mask	= {	0,		0,		XFS_PTAG_MASK},
 	.error_level	= {	0,		3,		11	},
 	.syncd_timer	= {	1*100,		30*100,		7200*100},
 	.stats_clear	= {	0,		0,		1	},
