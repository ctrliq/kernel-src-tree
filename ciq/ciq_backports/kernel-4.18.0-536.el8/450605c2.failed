x86/hyperv: fix logical processor creation

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-536.el8
commit-author Praveen Kumar <kumarpraveen@linux.microsoft.com>
commit 450605c28d571eddca39a65fdbc1338add44c6d9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-536.el8/450605c2.failed

Microsoft Hypervisor expects the logical processor index to be the same
as CPU's index during logical processor creation. Using cpu_physical_id
confuses hypervisor's scheduler. That causes the root partition not boot
when core scheduler is used.

This patch removes the call to cpu_physical_id and uses the CPU index
directly for bringing up logical processor. This scheme works for both
classic scheduler and core scheduler.

Fixes: 333abaf5abb3 (x86/hyperv: implement and use hv_smp_prepare_cpus)
	Signed-off-by: Praveen Kumar <kumarpraveen@linux.microsoft.com>
Link: https://lore.kernel.org/r/20210531074046.113452-1-kumarpraveen@linux.microsoft.com
	Signed-off-by: Wei Liu <wei.liu@kernel.org>
(cherry picked from commit 450605c28d571eddca39a65fdbc1338add44c6d9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/cpu/mshyperv.c
diff --cc arch/x86/kernel/cpu/mshyperv.c
index 1189865ffc68,4fa0a4280895..000000000000
--- a/arch/x86/kernel/cpu/mshyperv.c
+++ b/arch/x86/kernel/cpu/mshyperv.c
@@@ -300,6 -222,32 +300,35 @@@ static void __init hv_smp_prepare_boot_
  	hv_init_spinlocks();
  #endif
  }
++<<<<<<< HEAD
++=======
+ 
+ static void __init hv_smp_prepare_cpus(unsigned int max_cpus)
+ {
+ #ifdef CONFIG_X86_64
+ 	int i;
+ 	int ret;
+ #endif
+ 
+ 	native_smp_prepare_cpus(max_cpus);
+ 
+ #ifdef CONFIG_X86_64
+ 	for_each_present_cpu(i) {
+ 		if (i == 0)
+ 			continue;
+ 		ret = hv_call_add_logical_proc(numa_cpu_node(i), i, i);
+ 		BUG_ON(ret);
+ 	}
+ 
+ 	for_each_present_cpu(i) {
+ 		if (i == 0)
+ 			continue;
+ 		ret = hv_call_create_vp(numa_cpu_node(i), hv_current_partition_id, i, i);
+ 		BUG_ON(ret);
+ 	}
+ #endif
+ }
++>>>>>>> 450605c28d57 (x86/hyperv: fix logical processor creation)
  #endif
  
  static void __init ms_hyperv_init_platform(void)
* Unmerged path arch/x86/kernel/cpu/mshyperv.c
