net/mlx5e: Fix NULL pointer derefernce in set channels error flow

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-147.el8
commit-author Maria Pasechnik <mariap@mellanox.com>
commit fb35c534b7881c0f7f94b01ddd95a9b17483252f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-147.el8/fb35c534.failed

New channels are applied to the priv channels only after they
are successfully opened. Then, the indirection table should be built
according to the new number of channels.
Currently, such build is preformed independently of whether the
channels opening is successful, and is not reverted on failure.

The bug is caused due to removal of rss params from channels struct
and moving it to priv struct. That change cause to independency between
channels and rss params.
This causes a crash on a later point, when accessing rqn of a non
existing channel.

This patch fixes it by moving the indirection table build right before
switching the priv channels to new channels struct, after the new set of
channels was successfully opened.

Fixes: bbeb53b8b2c9 ("net/mlx5e: Move RSS params to a dedicated struct")
	Signed-off-by: Maria Pasechnik <mariap@mellanox.com>
	Reviewed-by: Tariq Toukan <tariqt@mellanox.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit fb35c534b7881c0f7f94b01ddd95a9b17483252f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
index d575f970df36,47233b9a4f81..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
@@@ -354,9 -354,6 +354,12 @@@ int mlx5e_ethtool_set_channels(struct m
  
  	new_channels.params = priv->channels.params;
  	new_channels.params.num_channels = count;
++<<<<<<< HEAD
 +	if (!netif_is_rxfh_configured(priv->netdev))
 +		mlx5e_build_default_indir_rqt(new_channels.params.indirection_rqt,
 +					      MLX5E_INDIR_RQT_SIZE, count);
++=======
++>>>>>>> fb35c534b788 (net/mlx5e: Fix NULL pointer derefernce in set channels error flow)
  
  	if (!test_bit(MLX5E_STATE_OPENED, &priv->state)) {
  		priv->channels.params = new_channels.params;
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_ethtool.c
