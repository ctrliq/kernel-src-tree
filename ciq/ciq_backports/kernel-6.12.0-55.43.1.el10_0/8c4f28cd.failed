KVM: nVMX: Always use IBPB to properly virtualize IBRS

jira LE-4694
Rebuild_History Non-Buildable kernel-6.12.0-55.43.1.el10_0
commit-author Yosry Ahmed <yosry.ahmed@linux.dev>
commit 8c4f28cd81fe86033918eec69d5280b532c05842
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-6.12.0-55.43.1.el10_0/8c4f28cd.failed

On synthesized nested VM-exits in VMX, an IBPB is performed if IBRS is
advertised to the guest to properly provide separate prediction domains
for L1 and L2. However, this is currently conditional on
X86_FEATURE_USE_IBPB, which depends on the host spectre_v2_user
mitigation.

In short, if spectre_v2_user=no, IBRS is not virtualized correctly and
L1 becomes susceptible to attacks from L2. Fix this by performing the
IBPB regardless of X86_FEATURE_USE_IBPB.

Fixes: 2e7eab81425a ("KVM: VMX: Execute IBPB on emulated VM-exit when guest has IBRS")
	Signed-off-by: Yosry Ahmed <yosry.ahmed@linux.dev>
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
	Reviewed-by: Jim Mattson <jmattson@google.com>
	Acked-by: Josh Poimboeuf <jpoimboe@kernel.org>
	Acked-by: Sean Christopherson <seanjc@google.com>
Link: https://lore.kernel.org/r/20250227012712.3193063-6-yosry.ahmed@linux.dev
(cherry picked from commit 8c4f28cd81fe86033918eec69d5280b532c05842)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/vmx/nested.c
diff --cc arch/x86/kvm/vmx/nested.c
index 5df2c6bffab8,8a7af02d466e..000000000000
--- a/arch/x86/kvm/vmx/nested.c
+++ b/arch/x86/kvm/vmx/nested.c
@@@ -5015,7 -5026,7 +5015,11 @@@ void nested_vmx_vmexit(struct kvm_vcpu 
  	 * doesn't isolate different VMCSs, i.e. in this case, doesn't provide
  	 * separate modes for L2 vs L1.
  	 */
++<<<<<<< HEAD
 +	if (guest_cpuid_has(vcpu, X86_FEATURE_SPEC_CTRL))
++=======
+ 	if (guest_cpu_cap_has(vcpu, X86_FEATURE_SPEC_CTRL))
++>>>>>>> 8c4f28cd81fe (KVM: nVMX: Always use IBPB to properly virtualize IBRS)
  		indirect_branch_prediction_barrier();
  
  	/* Update any VMCS fields that might have changed while L2 ran */
* Unmerged path arch/x86/kvm/vmx/nested.c
