x86/its: Add support for RSB stuffing mitigation

jira LE-4694
cve CVE-2024-28956
Rebuild_History Non-Buildable kernel-6.12.0-55.43.1.el10_0
commit-author Pawan Gupta <pawan.kumar.gupta@linux.intel.com>
commit facd226f7e0c8ca936ac114aba43cb3e8b94e41e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-6.12.0-55.43.1.el10_0/facd226f.failed

When retpoline mitigation is enabled for spectre-v2, enabling
call-depth-tracking and RSB stuffing also mitigates ITS. Add cmdline option
indirect_target_selection=stuff to allow enabling RSB stuffing mitigation.

When retpoline mitigation is not enabled, =stuff option is ignored, and
default mitigation for ITS is deployed.

	Signed-off-by: Pawan Gupta <pawan.kumar.gupta@linux.intel.com>
	Signed-off-by: Dave Hansen <dave.hansen@linux.intel.com>
	Reviewed-by: Josh Poimboeuf <jpoimboe@kernel.org>
	Reviewed-by: Alexandre Chartre <alexandre.chartre@oracle.com>
(cherry picked from commit facd226f7e0c8ca936ac114aba43cb3e8b94e41e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	Documentation/admin-guide/kernel-parameters.txt
#	arch/x86/kernel/cpu/bugs.c
diff --cc Documentation/admin-guide/kernel-parameters.txt
index aa008b431e3c,8f75ec177399..000000000000
--- a/Documentation/admin-guide/kernel-parameters.txt
+++ b/Documentation/admin-guide/kernel-parameters.txt
@@@ -2149,6 -2202,23 +2149,26 @@@
  			different crypto accelerators. This option can be used
  			to achieve best performance for particular HW.
  
++<<<<<<< HEAD
++=======
+ 	indirect_target_selection= [X86,Intel] Mitigation control for Indirect
+ 			Target Selection(ITS) bug in Intel CPUs. Updated
+ 			microcode is also required for a fix in IBPB.
+ 
+ 			on:     Enable mitigation (default).
+ 			off:    Disable mitigation.
+ 			force:	Force the ITS bug and deploy default
+ 				mitigation.
+ 			vmexit: Only deploy mitigation if CPU is affected by
+ 				guest/host isolation part of ITS.
+ 			stuff:	Deploy RSB-fill mitigation when retpoline is
+ 				also deployed. Otherwise, deploy the default
+ 				mitigation.
+ 
+ 			For details see:
+ 			Documentation/admin-guide/hw-vuln/indirect-target-selection.rst
+ 
++>>>>>>> facd226f7e0c (x86/its: Add support for RSB stuffing mitigation)
  	init=		[KNL]
  			Format: <full_path>
  			Run specified binary instead of /sbin/init as init
diff --cc arch/x86/kernel/cpu/bugs.c
index 4e5188a2730b,c6dcc03a43da..000000000000
--- a/arch/x86/kernel/cpu/bugs.c
+++ b/arch/x86/kernel/cpu/bugs.c
@@@ -1185,6 -1198,145 +1185,148 @@@ do_cmd_auto
  }
  
  #undef pr_fmt
++<<<<<<< HEAD
++=======
+ #define pr_fmt(fmt)     "ITS: " fmt
+ 
+ enum its_mitigation_cmd {
+ 	ITS_CMD_OFF,
+ 	ITS_CMD_ON,
+ 	ITS_CMD_VMEXIT,
+ 	ITS_CMD_RSB_STUFF,
+ };
+ 
+ enum its_mitigation {
+ 	ITS_MITIGATION_OFF,
+ 	ITS_MITIGATION_VMEXIT_ONLY,
+ 	ITS_MITIGATION_ALIGNED_THUNKS,
+ 	ITS_MITIGATION_RETPOLINE_STUFF,
+ };
+ 
+ static const char * const its_strings[] = {
+ 	[ITS_MITIGATION_OFF]			= "Vulnerable",
+ 	[ITS_MITIGATION_VMEXIT_ONLY]		= "Mitigation: Vulnerable, KVM: Not affected",
+ 	[ITS_MITIGATION_ALIGNED_THUNKS]		= "Mitigation: Aligned branch/return thunks",
+ 	[ITS_MITIGATION_RETPOLINE_STUFF]	= "Mitigation: Retpolines, Stuffing RSB",
+ };
+ 
+ static enum its_mitigation its_mitigation __ro_after_init = ITS_MITIGATION_ALIGNED_THUNKS;
+ 
+ static enum its_mitigation_cmd its_cmd __ro_after_init =
+ 	IS_ENABLED(CONFIG_MITIGATION_ITS) ? ITS_CMD_ON : ITS_CMD_OFF;
+ 
+ static int __init its_parse_cmdline(char *str)
+ {
+ 	if (!str)
+ 		return -EINVAL;
+ 
+ 	if (!IS_ENABLED(CONFIG_MITIGATION_ITS)) {
+ 		pr_err("Mitigation disabled at compile time, ignoring option (%s)", str);
+ 		return 0;
+ 	}
+ 
+ 	if (!strcmp(str, "off")) {
+ 		its_cmd = ITS_CMD_OFF;
+ 	} else if (!strcmp(str, "on")) {
+ 		its_cmd = ITS_CMD_ON;
+ 	} else if (!strcmp(str, "force")) {
+ 		its_cmd = ITS_CMD_ON;
+ 		setup_force_cpu_bug(X86_BUG_ITS);
+ 	} else if (!strcmp(str, "vmexit")) {
+ 		its_cmd = ITS_CMD_VMEXIT;
+ 	} else if (!strcmp(str, "stuff")) {
+ 		its_cmd = ITS_CMD_RSB_STUFF;
+ 	} else {
+ 		pr_err("Ignoring unknown indirect_target_selection option (%s).", str);
+ 	}
+ 
+ 	return 0;
+ }
+ early_param("indirect_target_selection", its_parse_cmdline);
+ 
+ static void __init its_select_mitigation(void)
+ {
+ 	enum its_mitigation_cmd cmd = its_cmd;
+ 
+ 	if (!boot_cpu_has_bug(X86_BUG_ITS) || cpu_mitigations_off()) {
+ 		its_mitigation = ITS_MITIGATION_OFF;
+ 		return;
+ 	}
+ 
+ 	/* Retpoline+CDT mitigates ITS, bail out */
+ 	if (boot_cpu_has(X86_FEATURE_RETPOLINE) &&
+ 	    boot_cpu_has(X86_FEATURE_CALL_DEPTH)) {
+ 		its_mitigation = ITS_MITIGATION_RETPOLINE_STUFF;
+ 		goto out;
+ 	}
+ 
+ 	/* Exit early to avoid irrelevant warnings */
+ 	if (cmd == ITS_CMD_OFF) {
+ 		its_mitigation = ITS_MITIGATION_OFF;
+ 		goto out;
+ 	}
+ 	if (spectre_v2_enabled == SPECTRE_V2_NONE) {
+ 		pr_err("WARNING: Spectre-v2 mitigation is off, disabling ITS\n");
+ 		its_mitigation = ITS_MITIGATION_OFF;
+ 		goto out;
+ 	}
+ 	if (!IS_ENABLED(CONFIG_MITIGATION_RETPOLINE) ||
+ 	    !IS_ENABLED(CONFIG_MITIGATION_RETHUNK)) {
+ 		pr_err("WARNING: ITS mitigation depends on retpoline and rethunk support\n");
+ 		its_mitigation = ITS_MITIGATION_OFF;
+ 		goto out;
+ 	}
+ 	if (IS_ENABLED(CONFIG_DEBUG_FORCE_FUNCTION_ALIGN_64B)) {
+ 		pr_err("WARNING: ITS mitigation is not compatible with CONFIG_DEBUG_FORCE_FUNCTION_ALIGN_64B\n");
+ 		its_mitigation = ITS_MITIGATION_OFF;
+ 		goto out;
+ 	}
+ 	if (boot_cpu_has(X86_FEATURE_RETPOLINE_LFENCE)) {
+ 		pr_err("WARNING: ITS mitigation is not compatible with lfence mitigation\n");
+ 		its_mitigation = ITS_MITIGATION_OFF;
+ 		goto out;
+ 	}
+ 
+ 	if (cmd == ITS_CMD_RSB_STUFF &&
+ 	    (!boot_cpu_has(X86_FEATURE_RETPOLINE) || !IS_ENABLED(CONFIG_MITIGATION_CALL_DEPTH_TRACKING))) {
+ 		pr_err("RSB stuff mitigation not supported, using default\n");
+ 		cmd = ITS_CMD_ON;
+ 	}
+ 
+ 	switch (cmd) {
+ 	case ITS_CMD_OFF:
+ 		its_mitigation = ITS_MITIGATION_OFF;
+ 		break;
+ 	case ITS_CMD_VMEXIT:
+ 		if (boot_cpu_has_bug(X86_BUG_ITS_NATIVE_ONLY)) {
+ 			its_mitigation = ITS_MITIGATION_VMEXIT_ONLY;
+ 			goto out;
+ 		}
+ 		fallthrough;
+ 	case ITS_CMD_ON:
+ 		its_mitigation = ITS_MITIGATION_ALIGNED_THUNKS;
+ 		if (!boot_cpu_has(X86_FEATURE_RETPOLINE))
+ 			setup_force_cpu_cap(X86_FEATURE_INDIRECT_THUNK_ITS);
+ 		setup_force_cpu_cap(X86_FEATURE_RETHUNK);
+ 		set_return_thunk(its_return_thunk);
+ 		break;
+ 	case ITS_CMD_RSB_STUFF:
+ 		its_mitigation = ITS_MITIGATION_RETPOLINE_STUFF;
+ 		setup_force_cpu_cap(X86_FEATURE_RETHUNK);
+ 		setup_force_cpu_cap(X86_FEATURE_CALL_DEPTH);
+ 		set_return_thunk(call_depth_return_thunk);
+ 		if (retbleed_mitigation == RETBLEED_MITIGATION_NONE) {
+ 			retbleed_mitigation = RETBLEED_MITIGATION_STUFF;
+ 			pr_info("Retbleed mitigation updated to stuffing\n");
+ 		}
+ 		break;
+ 	}
+ out:
+ 	pr_info("%s\n", its_strings[its_mitigation]);
+ }
+ 
+ #undef pr_fmt
++>>>>>>> facd226f7e0c (x86/its: Add support for RSB stuffing mitigation)
  #define pr_fmt(fmt)     "Spectre V2 : " fmt
  
  static enum spectre_v2_user_mitigation spectre_v2_user_stibp __ro_after_init =
* Unmerged path Documentation/admin-guide/kernel-parameters.txt
* Unmerged path arch/x86/kernel/cpu/bugs.c
