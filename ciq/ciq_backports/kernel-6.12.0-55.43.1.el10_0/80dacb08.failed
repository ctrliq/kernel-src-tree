x86/bugs: Use a static branch to guard IBPB on vCPU switch

jira LE-4694
Rebuild_History Non-Buildable kernel-6.12.0-55.43.1.el10_0
commit-author Yosry Ahmed <yosry.ahmed@linux.dev>
commit 80dacb080461edfc1d854721ee6933a4cfa3b602
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-6.12.0-55.43.1.el10_0/80dacb08.failed

Instead of using X86_FEATURE_USE_IBPB to guard the IBPB execution in KVM
when a new vCPU is loaded, introduce a static branch, similar to
switch_mm_*_ibpb.

This makes it obvious in spectre_v2_user_select_mitigation() what
exactly is being toggled, instead of the unclear X86_FEATURE_USE_IBPB
(which will be shortly removed). It also provides more fine-grained
control, making it simpler to change/add paths that control the IBPB in
the vCPU switch path without affecting other IBPBs.

	Signed-off-by: Yosry Ahmed <yosry.ahmed@linux.dev>
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
	Acked-by: Josh Poimboeuf <jpoimboe@kernel.org>
	Acked-by: Sean Christopherson <seanjc@google.com>
Link: https://lore.kernel.org/r/20250227012712.3193063-5-yosry.ahmed@linux.dev
(cherry picked from commit 80dacb080461edfc1d854721ee6933a4cfa3b602)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/svm/svm.c
#	arch/x86/kvm/vmx/vmx.c
diff --cc arch/x86/kvm/svm/svm.c
index cd896d1a1b4d,a73875ffbc3d..000000000000
--- a/arch/x86/kvm/svm/svm.c
+++ b/arch/x86/kvm/svm/svm.c
@@@ -1564,7 -1565,8 +1564,12 @@@ static void svm_vcpu_load(struct kvm_vc
  	if (sd->current_vmcb != svm->vmcb) {
  		sd->current_vmcb = svm->vmcb;
  
++<<<<<<< HEAD
 +		if (!cpu_feature_enabled(X86_FEATURE_IBPB_ON_VMEXIT))
++=======
+ 		if (!cpu_feature_enabled(X86_FEATURE_IBPB_ON_VMEXIT) &&
+ 		    static_branch_likely(&switch_vcpu_ibpb))
++>>>>>>> 80dacb080461 (x86/bugs: Use a static branch to guard IBPB on vCPU switch)
  			indirect_branch_prediction_barrier();
  	}
  	if (kvm_vcpu_apicv_active(vcpu))
diff --cc arch/x86/kvm/vmx/vmx.c
index 0bc4a4bb002c,956f9143a3c4..000000000000
--- a/arch/x86/kvm/vmx/vmx.c
+++ b/arch/x86/kvm/vmx/vmx.c
@@@ -1478,7 -1477,8 +1478,12 @@@ void vmx_vcpu_load_vmcs(struct kvm_vcp
  		 * performs IBPB on nested VM-Exit (a single nested transition
  		 * may switch the active VMCS multiple times).
  		 */
++<<<<<<< HEAD
 +		if (!buddy || WARN_ON_ONCE(buddy->vmcs != prev))
++=======
+ 		if (static_branch_likely(&switch_vcpu_ibpb) &&
+ 		    (!buddy || WARN_ON_ONCE(buddy->vmcs != prev)))
++>>>>>>> 80dacb080461 (x86/bugs: Use a static branch to guard IBPB on vCPU switch)
  			indirect_branch_prediction_barrier();
  	}
  
diff --git a/arch/x86/include/asm/nospec-branch.h b/arch/x86/include/asm/nospec-branch.h
index 96b410b1d4e8..84a7168bc62c 100644
--- a/arch/x86/include/asm/nospec-branch.h
+++ b/arch/x86/include/asm/nospec-branch.h
@@ -570,6 +570,8 @@ DECLARE_STATIC_KEY_FALSE(switch_to_cond_stibp);
 DECLARE_STATIC_KEY_FALSE(switch_mm_cond_ibpb);
 DECLARE_STATIC_KEY_FALSE(switch_mm_always_ibpb);
 
+DECLARE_STATIC_KEY_FALSE(switch_vcpu_ibpb);
+
 DECLARE_STATIC_KEY_FALSE(mds_idle_clear);
 
 DECLARE_STATIC_KEY_FALSE(switch_mm_cond_l1d_flush);
diff --git a/arch/x86/kernel/cpu/bugs.c b/arch/x86/kernel/cpu/bugs.c
index 1d7afc40f227..7f904d0b0b04 100644
--- a/arch/x86/kernel/cpu/bugs.c
+++ b/arch/x86/kernel/cpu/bugs.c
@@ -113,6 +113,10 @@ DEFINE_STATIC_KEY_FALSE(switch_mm_cond_ibpb);
 /* Control unconditional IBPB in switch_mm() */
 DEFINE_STATIC_KEY_FALSE(switch_mm_always_ibpb);
 
+/* Control IBPB on vCPU load */
+DEFINE_STATIC_KEY_FALSE(switch_vcpu_ibpb);
+EXPORT_SYMBOL_GPL(switch_vcpu_ibpb);
+
 /* Control MDS CPU buffer clear before idling (halt, mwait) */
 DEFINE_STATIC_KEY_FALSE(mds_idle_clear);
 EXPORT_SYMBOL_GPL(mds_idle_clear);
@@ -1365,6 +1369,7 @@ spectre_v2_user_select_mitigation(void)
 	/* Initialize Indirect Branch Prediction Barrier */
 	if (boot_cpu_has(X86_FEATURE_IBPB)) {
 		setup_force_cpu_cap(X86_FEATURE_USE_IBPB);
+		static_branch_enable(&switch_vcpu_ibpb);
 
 		spectre_v2_user_ibpb = mode;
 		switch (cmd) {
* Unmerged path arch/x86/kvm/svm/svm.c
* Unmerged path arch/x86/kvm/vmx/vmx.c
