net: usb: ax88179_178a: wol optimizations

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-540.el8
commit-author Justin Chen <justinpopo6@gmail.com>
commit 5050531610a64f08461e0c309db80ca51b779fd5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-540.el8/50505316.failed

- Check if wol is supported on reset instead of everytime get_wol
is called.
- Save wolopts in private data instead of relying on the HW to save it.
- Defer enabling WoL until suspend instead of enabling it everytime
set_wol is called.

	Signed-off-by: Justin Chen <justinpopo6@gmail.com>
	Signed-off-by: Jakub Kicinski <kuba@kernel.org>
(cherry picked from commit 5050531610a64f08461e0c309db80ca51b779fd5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/usb/ax88179_178a.c
diff --cc drivers/net/usb/ax88179_178a.c
index a5749233f0e8,3b0e8f93e3c8..000000000000
--- a/drivers/net/usb/ax88179_178a.c
+++ b/drivers/net/usb/ax88179_178a.c
@@@ -182,7 -170,9 +182,13 @@@ struct ax88179_data 
  	u8  eee_enabled;
  	u8  eee_active;
  	u16 rxctl;
++<<<<<<< HEAD
 +	u16 reserved;
++=======
+ 	u8 in_pm;
+ 	u32 wol_supported;
+ 	u32 wolopts;
++>>>>>>> 5050531610a6 (net: usb: ax88179_178a: wol optimizations)
  };
  
  struct ax88179_int_data {
@@@ -442,22 -406,37 +449,35 @@@ static int ax88179_suspend(struct usb_i
  	u16 tmp16;
  	u8 tmp8;
  
 -	ax88179_set_pm_mode(dev, true);
 -
  	usbnet_suspend(intf, message);
  
+ 	/* Enable WoL */
+ 	if (priv->wolopts) {
+ 		ax88179_read_cmd(dev, AX_ACCESS_MAC, AX_MONITOR_MOD,
+ 				 1, 1, &tmp8);
+ 		if (priv->wolopts & WAKE_PHY)
+ 			tmp8 |= AX_MONITOR_MODE_RWLC;
+ 		if (priv->wolopts & WAKE_MAGIC)
+ 			tmp8 |= AX_MONITOR_MODE_RWMP;
+ 
+ 		ax88179_write_cmd(dev, AX_ACCESS_MAC, AX_MONITOR_MOD,
+ 				  1, 1, &tmp8);
+ 	}
+ 
  	/* Disable RX path */
 -	ax88179_read_cmd(dev, AX_ACCESS_MAC, AX_MEDIUM_STATUS_MODE,
 -			 2, 2, &tmp16);
 +	ax88179_read_cmd_nopm(dev, AX_ACCESS_MAC, AX_MEDIUM_STATUS_MODE,
 +			      2, 2, &tmp16);
  	tmp16 &= ~AX_MEDIUM_RECEIVE_EN;
 -	ax88179_write_cmd(dev, AX_ACCESS_MAC, AX_MEDIUM_STATUS_MODE,
 -			  2, 2, &tmp16);
 +	ax88179_write_cmd_nopm(dev, AX_ACCESS_MAC, AX_MEDIUM_STATUS_MODE,
 +			       2, 2, &tmp16);
  
  	/* Force bulk-in zero length */
 -	ax88179_read_cmd(dev, AX_ACCESS_MAC, AX_PHYPWR_RSTCTL,
 -			 2, 2, &tmp16);
 +	ax88179_read_cmd_nopm(dev, AX_ACCESS_MAC, AX_PHYPWR_RSTCTL,
 +			      2, 2, &tmp16);
  
  	tmp16 |= AX_PHYPWR_RSTCTL_BZ | AX_PHYPWR_RSTCTL_IPRL;
 -	ax88179_write_cmd(dev, AX_ACCESS_MAC, AX_PHYPWR_RSTCTL,
 -			  2, 2, &tmp16);
 +	ax88179_write_cmd_nopm(dev, AX_ACCESS_MAC, AX_PHYPWR_RSTCTL,
 +			       2, 2, &tmp16);
  
  	/* change clock */
  	tmp8 = 0;
* Unmerged path drivers/net/usb/ax88179_178a.c
