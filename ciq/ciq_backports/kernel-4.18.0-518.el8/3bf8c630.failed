cpufreq: amd-pstate: Update policy->cur in amd_pstate_adjust_perf()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-518.el8
commit-author Wyes Karny <wyes.karny@amd.com>
commit 3bf8c6307bad5c0cc09cde982e146d847859b651
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-518.el8/3bf8c630.failed

Driver should update policy->cur after updating the frequency.
Currently amd_pstate doesn't update policy->cur when `adjust_perf`
is used. Which causes /proc/cpuinfo to show wrong cpu frequency.
Fix this by updating policy->cur with correct frequency value in
adjust_perf function callback.

- Before the fix: (setting min freq to 1.5 MHz)

[root@amd]# cat /proc/cpuinfo | grep "cpu MHz" | sort | uniq --count
      1 cpu MHz         : 1777.016
      1 cpu MHz         : 1797.160
      1 cpu MHz         : 1797.270
    189 cpu MHz         : 400.000

- After the fix: (setting min freq to 1.5 MHz)

[root@amd]# cat /proc/cpuinfo | grep "cpu MHz" | sort | uniq --count
      1 cpu MHz         : 1753.353
      1 cpu MHz         : 1756.838
      1 cpu MHz         : 1776.466
      1 cpu MHz         : 1776.873
      1 cpu MHz         : 1777.308
      1 cpu MHz         : 1779.900
    183 cpu MHz         : 1805.231
      1 cpu MHz         : 1956.815
      1 cpu MHz         : 2246.203
      1 cpu MHz         : 2259.984

Fixes: 1d215f0319c2 ("cpufreq: amd-pstate: Add fast switch function for AMD P-State")
	Signed-off-by: Wyes Karny <wyes.karny@amd.com>
[ rjw: Subject edits ]
	Cc: 5.17+ <stable@vger.kernel.org> # 5.17+
	Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
(cherry picked from commit 3bf8c6307bad5c0cc09cde982e146d847859b651)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/cpufreq/amd-pstate.c
diff --cc drivers/cpufreq/amd-pstate.c
index 2c71ef90154d,ddd346a239e0..000000000000
--- a/drivers/cpufreq/amd-pstate.c
+++ b/drivers/cpufreq/amd-pstate.c
@@@ -364,7 -525,12 +366,16 @@@ static void amd_pstate_adjust_perf(unsi
  	if (max_perf < min_perf)
  		max_perf = min_perf;
  
++<<<<<<< HEAD
 +	amd_pstate_update(cpudata, min_perf, des_perf, max_perf, true);
++=======
+ 	des_perf = clamp_t(unsigned long, des_perf, min_perf, max_perf);
+ 	target_freq = div_u64(des_perf * max_freq, max_perf);
+ 	policy->cur = target_freq;
+ 
+ 	amd_pstate_update(cpudata, min_perf, des_perf, max_perf, true,
+ 			policy->governor->flags);
++>>>>>>> 3bf8c6307bad (cpufreq: amd-pstate: Update policy->cur in amd_pstate_adjust_perf())
  	cpufreq_cpu_put(policy);
  }
  
* Unmerged path drivers/cpufreq/amd-pstate.c
