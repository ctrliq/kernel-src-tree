nvme-ioctl: fix leaked requests on mapping error

jira LE-4192
Rebuild_History Non-Buildable kernel-6.12.0-55.31.1.el10_0
commit-author Keith Busch <kbusch@kernel.org>
commit 00817f0f1c45b007965f5676b9a2013bb39c7228
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-6.12.0-55.31.1.el10_0/00817f0f.failed

All the callers assume nvme_map_user_request() frees the request on a
failure. This wasn't happening on invalid metadata or io_uring command
flags, so we've been leaking those requests.

Fixes: 23fd22e55b767b ("nvme: wire up fixed buffer support for nvme passthrough")
Fixes: 7c2fd76048e95d ("nvme: fix metadata handling in nvme-passthrough")
	Reviewed-by: Damien Le Moal <dlemoal@kernel.org>
	Reviewed-by: Kanchan Joshi <joshi.k@samsung.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Signed-off-by: Keith Busch <kbusch@kernel.org>
(cherry picked from commit 00817f0f1c45b007965f5676b9a2013bb39c7228)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/nvme/host/ioctl.c
diff --cc drivers/nvme/host/ioctl.c
index a96976b22fa7,24e2c702da7a..000000000000
--- a/drivers/nvme/host/ioctl.c
+++ b/drivers/nvme/host/ioctl.c
@@@ -124,8 -125,17 +124,22 @@@ static int nvme_map_user_request(struc
  	struct bio *bio = NULL;
  	int ret;
  
++<<<<<<< HEAD
 +	if (has_metadata && !supports_metadata)
 +		return -EINVAL;
++=======
+ 	if (!nvme_ctrl_sgl_supported(ctrl))
+ 		dev_warn_once(ctrl->device, "using unchecked data buffer\n");
+ 	if (has_metadata) {
+ 		if (!supports_metadata) {
+ 			ret = -EINVAL;
+ 			goto out;
+ 		}
+ 		if (!nvme_ctrl_meta_sgl_supported(ctrl))
+ 			dev_warn_once(ctrl->device,
+ 				      "using unchecked metadata buffer\n");
+ 	}
++>>>>>>> 00817f0f1c45 (nvme-ioctl: fix leaked requests on mapping error)
  
  	if (ioucmd && (ioucmd->flags & IORING_URING_CMD_FIXED)) {
  		struct iov_iter iter;
* Unmerged path drivers/nvme/host/ioctl.c
