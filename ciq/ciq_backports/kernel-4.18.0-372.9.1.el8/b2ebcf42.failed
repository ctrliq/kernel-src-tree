ASoC: SOF: free widgets in sof_tear_down_pipelines() for static pipelines

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-372.9.1.el8
commit-author Ranjani Sridharan <ranjani.sridharan@linux.intel.com>
commit b2ebcf42a48f4560862bb811f3268767d17ebdcd
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-372.9.1.el8/b2ebcf42.failed

Free widgets for static pipelines in sof_tear_down_pipelines().
But this feature is unavailable in older firmware with ABI < 3.19.
Just reset widget use_count's for this case. This would ensure that
the secondary cores enabled required for topology setup are powered
down properly before the primary core is powered off during
system suspend.

	Signed-off-by: Ranjani Sridharan <ranjani.sridharan@linux.intel.com>
	Reviewed-by: Guennadi Liakhovetski <guennadi.liakhovetski@linux.intel.com>
	Reviewed-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
	Signed-off-by: Kai Vehmanen <kai.vehmanen@linux.intel.com>
Link: https://lore.kernel.org/r/20211119192621.4096077-8-kai.vehmanen@linux.intel.com
	Signed-off-by: Mark Brown <broonie@kernel.org>
(cherry picked from commit b2ebcf42a48f4560862bb811f3268767d17ebdcd)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/soc/sof/sof-audio.c
diff --cc sound/soc/sof/sof-audio.c
index f17b0b574e42,669d5c924f6b..000000000000
--- a/sound/soc/sof/sof-audio.c
+++ b/sound/soc/sof/sof-audio.c
@@@ -389,21 -665,38 +389,49 @@@ int sof_set_up_pipelines(struct device 
  }
  
  /*
++<<<<<<< HEAD
 + * This function doesn't free widgets. It only resets the set up status for all routes and
 + * use_count for all widgets.
++=======
+  * For older firmware, this function doesn't free widgets for static pipelines during suspend.
+  * It only resets use_count for all widgets.
++>>>>>>> b2ebcf42a48f (ASoC: SOF: free widgets in sof_tear_down_pipelines() for static pipelines)
   */
 -int sof_tear_down_pipelines(struct snd_sof_dev *sdev, bool verify)
 +void sof_tear_down_pipelines(struct device *dev)
  {
++<<<<<<< HEAD
 +	struct snd_sof_dev *sdev = dev_get_drvdata(dev);
++=======
+ 	struct sof_ipc_fw_version *v = &sdev->fw_ready.version;
++>>>>>>> b2ebcf42a48f (ASoC: SOF: free widgets in sof_tear_down_pipelines() for static pipelines)
  	struct snd_sof_widget *swidget;
  	struct snd_sof_route *sroute;
 -	int ret;
  
  	/*
 -	 * This function is called during suspend and for one-time topology verification during
 -	 * first boot. In both cases, there is no need to protect swidget->use_count and
 -	 * sroute->setup because during suspend all streams are suspended and during topology
 -	 * loading the sound card unavailable to open PCMs.
 +	 * No need to protect swidget->use_count and sroute->setup as this function is called only
 +	 * during the suspend callback and all streams should be suspended by then
  	 */
++<<<<<<< HEAD
 +	list_for_each_entry(swidget, &sdev->widget_list, list)
 +		swidget->use_count = 0;
++=======
+ 	list_for_each_entry_reverse(swidget, &sdev->widget_list, list) {
+ 		if (swidget->dynamic_pipeline_widget)
+ 			continue;
+ 
+ 		/* Do not free widgets for static pipelines with FW ABI older than 3.19 */
+ 		if (!verify && !swidget->dynamic_pipeline_widget &&
+ 		    v->abi_version < SOF_ABI_VER(3, 19, 0)) {
+ 			swidget->use_count = 0;
+ 			swidget->complete = 0;
+ 			continue;
+ 		}
+ 
+ 		ret = sof_widget_free(sdev, swidget);
+ 		if (ret < 0)
+ 			return ret;
+ 	}
++>>>>>>> b2ebcf42a48f (ASoC: SOF: free widgets in sof_tear_down_pipelines() for static pipelines)
  
  	list_for_each_entry(sroute, &sdev->route_list, list)
  		sroute->setup = false;
* Unmerged path sound/soc/sof/sof-audio.c
