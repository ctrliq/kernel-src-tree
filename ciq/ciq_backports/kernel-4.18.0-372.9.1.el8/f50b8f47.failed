xfs: factor out a xfs_ilock_iocb helper

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-372.9.1.el8
commit-author Christoph Hellwig <hch@lst.de>
commit f50b8f475a2c70ae8309c16b6d4ecb305a4aa9d6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-372.9.1.el8/f50b8f47.failed

Add a helper to factor out the nowait locking logical for the read/write
helpers.

	Signed-off-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: Dave Chinner <dchinner@redhat.com>
	Reviewed-by: Brian Foster <bfoster@redhat.com>
	Reviewed-by: Darrick J. Wong <djwong@kernel.org>
	Signed-off-by: Darrick J. Wong <djwong@kernel.org>
(cherry picked from commit f50b8f475a2c70ae8309c16b6d4ecb305a4aa9d6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/xfs/xfs_file.c
diff --cc fs/xfs/xfs_file.c
index 9d260771a573,13ca049c44fd..000000000000
--- a/fs/xfs/xfs_file.c
+++ b/fs/xfs/xfs_file.c
@@@ -239,14 -230,10 +256,21 @@@ xfs_file_dio_aio_read
  
  	file_accessed(iocb->ki_filp);
  
++<<<<<<< HEAD
 +	if (iocb->ki_flags & IOCB_NOWAIT) {
 +		if (!xfs_ilock_nowait(ip, XFS_IOLOCK_SHARED))
 +			return -EAGAIN;
 +	} else {
 +		xfs_ilock(ip, XFS_IOLOCK_SHARED);
 +	}
 +	ret = iomap_dio_rw(iocb, to, &xfs_read_iomap_ops, NULL,
 +			is_sync_kiocb(iocb));
++=======
+ 	ret = xfs_ilock_iocb(iocb, XFS_IOLOCK_SHARED);
+ 	if (ret)
+ 		return ret;
+ 	ret = iomap_dio_rw(iocb, to, &xfs_read_iomap_ops, NULL, 0);
++>>>>>>> f50b8f475a2c (xfs: factor out a xfs_ilock_iocb helper)
  	xfs_iunlock(ip, XFS_IOLOCK_SHARED);
  
  	return ret;
* Unmerged path fs/xfs/xfs_file.c
