net/mlx5e: Destroy page pool after XDP SQ to fix use-after-free

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-372.9.1.el8
commit-author Maxim Mikityanskiy <maximmi@nvidia.com>
commit 8ba3e4c85825c8801a2c298dcadac650a40d7137
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-372.9.1.el8/8ba3e4c8.failed

mlx5e_close_xdpsq does the cleanup: it calls mlx5e_free_xdpsq_descs to
free the outstanding descriptors, which relies on
mlx5e_page_release_dynamic and page_pool_release_page. However,
page_pool_destroy is already called by this point, because
mlx5e_close_rq runs before mlx5e_close_xdpsq.

This commit fixes the use-after-free by swapping mlx5e_close_xdpsq and
mlx5e_close_rq.

The commit cited below started calling page_pool_destroy directly from
the driver. Previously, the page pool was destroyed under a call_rcu
from xdp_rxq_info_unreg_mem_model, which would defer the deallocation
until after the XDPSQ is cleaned up.

Fixes: 1da4bbeffe41 ("net: core: page_pool: add user refcnt and reintroduce page_pool_destroy")
	Signed-off-by: Maxim Mikityanskiy <maximmi@nvidia.com>
	Reviewed-by: Tariq Toukan <tariqt@nvidia.com>
	Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
(cherry picked from commit 8ba3e4c85825c8801a2c298dcadac650a40d7137)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/en_main.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_main.c
index b71f4682ed53,fd250f7bcd88..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
@@@ -1888,16 -1899,12 +1892,19 @@@ static int mlx5e_open_queues(struct mlx
  		err = mlx5e_open_xdpsq(c, params, &cparam->xdp_sq, NULL,
  				       &c->rq_xdpsq, false);
  		if (err)
- 			goto err_close_sqs;
+ 			goto err_close_rq;
  	}
  
++<<<<<<< HEAD
 +	err = mlx5e_open_rq(c, params, &cparam->rq, NULL, NULL, &c->rq);
 +	if (err)
 +		goto err_close_xdp_sq;
 +
++=======
++>>>>>>> 8ba3e4c85825 (net/mlx5e: Destroy page pool after XDP SQ to fix use-after-free)
  	err = mlx5e_open_xdpsq(c, params, &cparam->xdp_sq, NULL, &c->xdpsq, true);
  	if (err)
- 		goto err_close_rq;
+ 		goto err_close_xdp_sq;
  
  	return 0;
  
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_main.c
