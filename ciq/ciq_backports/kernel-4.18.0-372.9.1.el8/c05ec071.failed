ASoC: SOF: debug: Print out the fw_state along with the DSP dump

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-372.9.1.el8
commit-author Peter Ujfalusi <peter.ujfalusi@linux.intel.com>
commit c05ec07143998d8505a054378f8d5b287648c9bf
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-372.9.1.el8/c05ec071.failed

The fw state can be an important information along with the DSP dump.
Print it out before the dump.

	Signed-off-by: Peter Ujfalusi <peter.ujfalusi@linux.intel.com>
	Reviewed-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
	Reviewed-by: Kai Vehmanen <kai.vehmanen@linux.intel.com>
Link: https://lore.kernel.org/r/20211006110645.26679-12-peter.ujfalusi@linux.intel.com
	Signed-off-by: Mark Brown <broonie@kernel.org>
(cherry picked from commit c05ec07143998d8505a054378f8d5b287648c9bf)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/soc/sof/debug.c
diff --cc sound/soc/sof/debug.c
index 00041313bde2,dc1df5fb7b4c..000000000000
--- a/sound/soc/sof/debug.c
+++ b/sound/soc/sof/debug.c
@@@ -833,6 -822,61 +833,64 @@@ void snd_sof_free_debug(struct snd_sof_
  }
  EXPORT_SYMBOL_GPL(snd_sof_free_debug);
  
++<<<<<<< HEAD
++=======
+ static const struct soc_fw_state_info {
+ 	enum snd_sof_fw_state state;
+ 	const char *name;
+ } fw_state_dbg[] = {
+ 	{SOF_FW_BOOT_NOT_STARTED, "SOF_FW_BOOT_NOT_STARTED"},
+ 	{SOF_FW_BOOT_PREPARE, "SOF_FW_BOOT_PREPARE"},
+ 	{SOF_FW_BOOT_IN_PROGRESS, "SOF_FW_BOOT_IN_PROGRESS"},
+ 	{SOF_FW_BOOT_FAILED, "SOF_FW_BOOT_FAILED"},
+ 	{SOF_FW_BOOT_READY_FAILED, "SOF_FW_BOOT_READY_FAILED"},
+ 	{SOF_FW_BOOT_COMPLETE, "SOF_FW_BOOT_COMPLETE"},
+ };
+ 
+ static void snd_sof_dbg_print_fw_state(struct snd_sof_dev *sdev)
+ {
+ 	int i;
+ 
+ 	for (i = 0; i < ARRAY_SIZE(fw_state_dbg); i++) {
+ 		if (sdev->fw_state == fw_state_dbg[i].state) {
+ 			dev_err(sdev->dev, "fw_state: %s (%d)\n", fw_state_dbg[i].name, i);
+ 			return;
+ 		}
+ 	}
+ 
+ 	dev_err(sdev->dev, "fw_state: UNKNOWN (%d)\n", sdev->fw_state);
+ }
+ 
+ void snd_sof_dsp_dbg_dump(struct snd_sof_dev *sdev, u32 flags)
+ {
+ 	bool print_all = !!(sof_core_debug & SOF_DBG_PRINT_ALL_DUMPS);
+ 
+ 	if (flags & SOF_DBG_DUMP_OPTIONAL && !print_all)
+ 		return;
+ 
+ 	if (sof_ops(sdev)->dbg_dump && !sdev->dbg_dump_printed) {
+ 		dev_err(sdev->dev, "------------[ DSP dump start ]------------\n");
+ 		snd_sof_dbg_print_fw_state(sdev);
+ 		sof_ops(sdev)->dbg_dump(sdev, flags);
+ 		dev_err(sdev->dev, "------------[ DSP dump end ]------------\n");
+ 		if (!print_all)
+ 			sdev->dbg_dump_printed = true;
+ 	}
+ }
+ EXPORT_SYMBOL(snd_sof_dsp_dbg_dump);
+ 
+ static void snd_sof_ipc_dump(struct snd_sof_dev *sdev)
+ {
+ 	if (sof_ops(sdev)->ipc_dump  && !sdev->ipc_dump_printed) {
+ 		dev_err(sdev->dev, "------------[ IPC dump start ]------------\n");
+ 		sof_ops(sdev)->ipc_dump(sdev);
+ 		dev_err(sdev->dev, "------------[ IPC dump end ]------------\n");
+ 		if (!(sof_core_debug & SOF_DBG_PRINT_ALL_DUMPS))
+ 			sdev->ipc_dump_printed = true;
+ 	}
+ }
+ 
++>>>>>>> c05ec0714399 (ASoC: SOF: debug: Print out the fw_state along with the DSP dump)
  void snd_sof_handle_fw_exception(struct snd_sof_dev *sdev)
  {
  	if (IS_ENABLED(CONFIG_SND_SOC_SOF_DEBUG_RETAIN_DSP_CONTEXT) ||
* Unmerged path sound/soc/sof/debug.c
