optee: Fix memory leak when failing to register shm pages

jira LE-1907
cve CVE-2021-44733
Rebuild_History Non-Buildable kernel-4.18.0-372.9.1.el8
commit-author Tyler Hicks <tyhicks@linux.microsoft.com>
commit ec185dd3ab257dc2a60953fdf1b6622f524cc5b7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-372.9.1.el8/ec185dd3.failed

Free the previously allocated pages when we encounter an error condition
while attempting to register the pages with the secure world.

Fixes: a249dd200d03 ("tee: optee: Fix dynamic shm pool allocations")
Fixes: 5a769f6ff439 ("optee: Fix multi page dynamic shm pool alloc")
	Cc: stable@vger.kernel.org
	Signed-off-by: Tyler Hicks <tyhicks@linux.microsoft.com>
	Reviewed-by: Jens Wiklander <jens.wiklander@linaro.org>
	Reviewed-by: Sumit Garg <sumit.garg@linaro.org>
	Signed-off-by: Jens Wiklander <jens.wiklander@linaro.org>
(cherry picked from commit ec185dd3ab257dc2a60953fdf1b6622f524cc5b7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/tee/optee/shm_pool.c
diff --cc drivers/tee/optee/shm_pool.c
index 49397813fff1,da06ce9b9313..000000000000
--- a/drivers/tee/optee/shm_pool.c
+++ b/drivers/tee/optee/shm_pool.c
@@@ -35,7 -27,34 +35,38 @@@ static int pool_op_alloc(struct tee_shm
  	shm->paddr = page_to_phys(page);
  	shm->size = PAGE_SIZE << order;
  
++<<<<<<< HEAD
 +	return 0;
++=======
+ 	if (shm->flags & TEE_SHM_DMA_BUF) {
+ 		unsigned int nr_pages = 1 << order, i;
+ 		struct page **pages;
+ 
+ 		pages = kcalloc(nr_pages, sizeof(pages), GFP_KERNEL);
+ 		if (!pages) {
+ 			rc = -ENOMEM;
+ 			goto err;
+ 		}
+ 
+ 		for (i = 0; i < nr_pages; i++) {
+ 			pages[i] = page;
+ 			page++;
+ 		}
+ 
+ 		shm->flags |= TEE_SHM_REGISTER;
+ 		rc = optee_shm_register(shm->ctx, shm, pages, nr_pages,
+ 					(unsigned long)shm->kaddr);
+ 		kfree(pages);
+ 		if (rc)
+ 			goto err;
+ 	}
+ 
+ 	return 0;
+ 
+ err:
+ 	__free_pages(page, order);
+ 	return rc;
++>>>>>>> ec185dd3ab25 (optee: Fix memory leak when failing to register shm pages)
  }
  
  static void pool_op_free(struct tee_shm_pool_mgr *poolm,
* Unmerged path drivers/tee/optee/shm_pool.c
