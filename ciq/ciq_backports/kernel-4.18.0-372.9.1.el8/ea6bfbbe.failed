ASoC: SOF: topology: allow for dynamic pipelines override for debug

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-372.9.1.el8
commit-author Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
commit ea6bfbbe3ea83861bab034538e36becb16eef20b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-372.9.1.el8/ea6bfbbe.failed

For debug and community support, it's useful to expose a kernel
parameter to prevent the use of dynamic pipelines exposed in a
topology file, or conversely to force an existing topology to use
dynamic pipelines.

Add an override bit and an enable bit which is valid only when the
override is set.

For products, the intent is that the topology file defines the
behavior, these two bits are only intended for diagnosis and
performance checks.

	Signed-off-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
	Reviewed-by: Bard Liao <bard.liao@intel.com>
	Reviewed-by: Kai Vehmanen <kai.vehmanen@linux.intel.com>
	Reviewed-by: Ranjani Sridharan <ranjani.sridharan@linux.intel.com>
Link: https://lore.kernel.org/r/20211004212729.199550-3-pierre-louis.bossart@linux.intel.com
	Signed-off-by: Mark Brown <broonie@kernel.org>
(cherry picked from commit ea6bfbbe3ea83861bab034538e36becb16eef20b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/soc/sof/sof-priv.h
diff --cc sound/soc/sof/sof-priv.h
index 94632a45d6b0,4e5bab838cbf..000000000000
--- a/sound/soc/sof/sof-priv.h
+++ b/sound/soc/sof/sof-priv.h
@@@ -23,6 -23,13 +23,16 @@@
  /* debug flags */
  #define SOF_DBG_ENABLE_TRACE	BIT(0)
  #define SOF_DBG_RETAIN_CTX	BIT(1)	/* prevent DSP D3 on FW exception */
++<<<<<<< HEAD
++=======
+ #define SOF_DBG_VERIFY_TPLG	BIT(2) /* verify topology during load */
+ #define SOF_DBG_DYNAMIC_PIPELINES_OVERRIDE	BIT(3) /* 0: use topology token
+ 							* 1: override topology
+ 							*/
+ #define SOF_DBG_DYNAMIC_PIPELINES_ENABLE	BIT(4) /* 0: use static pipelines
+ 							* 1: use dynamic pipelines
+ 							*/
++>>>>>>> ea6bfbbe3ea8 (ASoC: SOF: topology: allow for dynamic pipelines override for debug)
  
  #define SOF_DBG_DUMP_REGS		BIT(0)
  #define SOF_DBG_DUMP_MBOX		BIT(1)
* Unmerged path sound/soc/sof/sof-priv.h
diff --git a/sound/soc/sof/topology.c b/sound/soc/sof/topology.c
index ec8414a21a1e..fea94752b074 100644
--- a/sound/soc/sof/topology.c
+++ b/sound/soc/sof/topology.c
@@ -1757,9 +1757,14 @@ static int sof_widget_load_pipeline(struct snd_soc_component *scomp, int index,
 		goto err;
 	}
 
-	dev_dbg(scomp->dev, "pipeline %s: period %d pri %d mips %d core %d frames %d\n",
+	if (sof_core_debug & SOF_DBG_DYNAMIC_PIPELINES_OVERRIDE)
+		swidget->dynamic_pipeline_widget = sof_core_debug &
+			SOF_DBG_DYNAMIC_PIPELINES_ENABLE;
+
+	dev_dbg(scomp->dev, "pipeline %s: period %d pri %d mips %d core %d frames %d dynamic %d\n",
 		swidget->widget->name, pipeline->period, pipeline->priority,
-		pipeline->period_mips, pipeline->core, pipeline->frames_per_sched);
+		pipeline->period_mips, pipeline->core, pipeline->frames_per_sched,
+		swidget->dynamic_pipeline_widget);
 
 	swidget->private = pipeline;
 
