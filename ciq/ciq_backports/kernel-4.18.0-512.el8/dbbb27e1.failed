cfg80211: support RNR for EMA AP

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-512.el8
commit-author Aloka Dixit <quic_alokad@quicinc.com>
commit dbbb27e183b1568d5a907ace1cd144b0709ea52a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-512.el8/dbbb27e1.failed

As per IEEE Std 802.11ax-2021, 11.1.3.8.3 Discovery of a nontransmitted
BSSID profile, an EMA AP that transmits a Beacon frame carrying a partial
list of nontransmitted BSSID profiles should include in the frame
a Reduced Neighbor Report element carrying information for at least the
nontransmitted BSSIDs that are not present in the Multiple BSSID element
carried in that frame.
Add new nested attribute NL80211_ATTR_EMA_RNR_ELEMS to support the above.
Number of RNR elements must be more than or equal to the number of
MBSSID elements. This attribute can be used only when EMA is enabled.
Userspace is responsible for splitting the RNR into multiple elements such
that each element excludes the non-transmitting profiles already included
in the MBSSID element (%NL80211_ATTR_MBSSID_ELEMS) at the same index.
Each EMA beacon will be generated by adding MBSSID and RNR elements
at the same index. If the userspace provides more RNR elements than the
number of MBSSID elements then these will be added in every EMA beacon.

	Signed-off-by: Aloka Dixit <quic_alokad@quicinc.com>
Link: https://lore.kernel.org/r/20230323113801.6903-2-quic_alokad@quicinc.com
[Johannes: validate elements]
	Signed-off-by: Johannes Berg <johannes.berg@intel.com>
(cherry picked from commit dbbb27e183b1568d5a907ace1cd144b0709ea52a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/uapi/linux/nl80211.h
#	net/wireless/nl80211.c
diff --cc include/uapi/linux/nl80211.h
index 51f604aab474,cf4fb981e131..000000000000
--- a/include/uapi/linux/nl80211.h
+++ b/include/uapi/linux/nl80211.h
@@@ -2767,6 -2787,24 +2767,27 @@@ enum nl80211_commands 
   *	indicates that the sub-channel is punctured. Higher 16 bits are
   *	reserved.
   *
++<<<<<<< HEAD
++=======
+  * @NL80211_ATTR_MAX_HW_TIMESTAMP_PEERS: Maximum number of peers that HW
+  *	timestamping can be enabled for concurrently (u16), a wiphy attribute.
+  *	A value of 0xffff indicates setting for all peers (i.e. not specifying
+  *	an address with %NL80211_CMD_SET_HW_TIMESTAMP) is supported.
+  * @NL80211_ATTR_HW_TIMESTAMP_ENABLED: Indicates whether HW timestamping should
+  *	be enabled or not (flag attribute).
+  *
+  * @NL80211_ATTR_EMA_RNR_ELEMS: Optional nested attribute for
+  *	reduced neighbor report (RNR) elements. This attribute can be used
+  *	only when NL80211_MBSSID_CONFIG_ATTR_EMA is enabled.
+  *	Userspace is responsible for splitting the RNR into multiple
+  *	elements such that each element excludes the non-transmitting
+  *	profiles already included in the MBSSID element
+  *	(%NL80211_ATTR_MBSSID_ELEMS) at the same index. Each EMA beacon
+  *	will be generated by adding MBSSID and RNR elements at the same
+  *	index. If the userspace includes more RNR elements than number of
+  *	MBSSID elements then these will be added in every EMA beacon.
+  *
++>>>>>>> dbbb27e183b1 (cfg80211: support RNR for EMA AP)
   * @NUM_NL80211_ATTR: total number of nl80211_attrs available
   * @NL80211_ATTR_MAX: highest attribute number currently defined
   * @__NL80211_ATTR_AFTER_LAST: internal use
@@@ -3298,6 -3336,11 +3319,14 @@@ enum nl80211_attrs 
  
  	NL80211_ATTR_PUNCT_BITMAP,
  
++<<<<<<< HEAD
++=======
+ 	NL80211_ATTR_MAX_HW_TIMESTAMP_PEERS,
+ 	NL80211_ATTR_HW_TIMESTAMP_ENABLED,
+ 
+ 	NL80211_ATTR_EMA_RNR_ELEMS,
+ 
++>>>>>>> dbbb27e183b1 (cfg80211: support RNR for EMA AP)
  	/* add attributes here, update the policy in nl80211.c */
  
  	__NL80211_ATTR_AFTER_LAST,
diff --cc net/wireless/nl80211.c
index 5e9f1d442cb1,80a20d69f285..000000000000
--- a/net/wireless/nl80211.c
+++ b/net/wireless/nl80211.c
@@@ -810,8 -805,11 +810,16 @@@ static const struct nla_policy nl80211_
  	[NL80211_ATTR_MLD_ADDR] = NLA_POLICY_EXACT_LEN(ETH_ALEN),
  	[NL80211_ATTR_MLO_SUPPORT] = { .type = NLA_FLAG },
  	[NL80211_ATTR_MAX_NUM_AKM_SUITES] = { .type = NLA_REJECT },
++<<<<<<< HEAD
 +	[NL80211_ATTR_PUNCT_BITMAP] =
 +		NLA_POLICY_FULL_RANGE(NLA_U32, &nl80211_punct_bitmap_range),
++=======
+ 	[NL80211_ATTR_PUNCT_BITMAP] = NLA_POLICY_RANGE(NLA_U8, 0, 0xffff),
+ 
+ 	[NL80211_ATTR_MAX_HW_TIMESTAMP_PEERS] = { .type = NLA_U16 },
+ 	[NL80211_ATTR_HW_TIMESTAMP_ENABLED] = { .type = NLA_FLAG },
+ 	[NL80211_ATTR_EMA_RNR_ELEMS] = { .type = NLA_NESTED },
++>>>>>>> dbbb27e183b1 (cfg80211: support RNR for EMA AP)
  };
  
  /* policy for the key attributes */
diff --git a/include/net/cfg80211.h b/include/net/cfg80211.h
index 21e4d082fc7d..849f28a71068 100644
--- a/include/net/cfg80211.h
+++ b/include/net/cfg80211.h
@@ -1165,6 +1165,23 @@ struct cfg80211_mbssid_elems {
 	} elem[];
 };
 
+/**
+ * struct cfg80211_rnr_elems - Reduced neighbor report (RNR) elements
+ *
+ * @cnt: Number of elements in array %elems.
+ *
+ * @elem: Array of RNR element(s) to be added into Beacon frames.
+ * @elem.data: Data for RNR elements.
+ * @elem.len: Length of data.
+ */
+struct cfg80211_rnr_elems {
+	u8 cnt;
+	struct {
+		const u8 *data;
+		size_t len;
+	} elem[];
+};
+
 /**
  * struct cfg80211_beacon_data - beacon data
  * @link_id: the link ID for the AP MLD link sending this beacon
@@ -1185,6 +1202,7 @@ struct cfg80211_mbssid_elems {
  * @probe_resp_len: length of probe response template (@probe_resp)
  * @probe_resp: probe response template (AP mode only)
  * @mbssid_ies: multiple BSSID elements
+ * @rnr_ies: reduced neighbor report elements
  * @ftm_responder: enable FTM responder functionality; -1 for no change
  *	(which also implies no change in LCI/civic location data)
  * @lci: Measurement Report element content, starting with Measurement Token
@@ -1208,6 +1226,7 @@ struct cfg80211_beacon_data {
 	const u8 *lci;
 	const u8 *civicloc;
 	struct cfg80211_mbssid_elems *mbssid_ies;
+	struct cfg80211_rnr_elems *rnr_ies;
 	s8 ftm_responder;
 
 	size_t head_len, tail_len;
* Unmerged path include/uapi/linux/nl80211.h
* Unmerged path net/wireless/nl80211.c
