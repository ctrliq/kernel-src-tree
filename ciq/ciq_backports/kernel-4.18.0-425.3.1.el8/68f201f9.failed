platform/x86: serial-multi-instantiate: Add SPI support

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-425.3.1.el8
commit-author Stefan Binding <sbinding@opensource.cirrus.com>
commit 68f201f9061c000d7a4a9f359f021b1cd535d62b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-425.3.1.el8/68f201f9.failed

Add support for spi bus in serial-multi-instantiate driver

Some peripherals can have either a I2C or a SPI connection
to the host (but not both) but use the same HID for both
types. So it is not possible to use the HID to determine
whether it is I2C or SPI. The driver must check the node
to see if it contains I2cSerialBus or SpiSerialBus entries.

For backwards-compatibility with the existing nodes I2C is
checked first and if such entries are found ONLY I2C devices
are created. Since some existing nodes that were already
handled by this driver could also contain unrelated
SpiSerialBus nodes that were previously ignored, and this
preserves that behavior. If there is ever a need to handle
a node where both I2C and SPI devices must be instantiated
this can be added in future.

	Signed-off-by: Stefan Binding <sbinding@opensource.cirrus.com>
Link: https://lore.kernel.org/r/20220121172431.6876-8-sbinding@opensource.cirrus.com
	Reviewed-by: Hans de Goede <hdegoede@redhat.com>
	Signed-off-by: Hans de Goede <hdegoede@redhat.com>
(cherry picked from commit 68f201f9061c000d7a4a9f359f021b1cd535d62b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/platform/x86/Kconfig
#	drivers/platform/x86/serial-multi-instantiate.c
diff --cc drivers/platform/x86/Kconfig
index 2d2f25961e5d,8d1eec208854..000000000000
--- a/drivers/platform/x86/Kconfig
+++ b/drivers/platform/x86/Kconfig
@@@ -922,108 -897,150 +922,114 @@@ config ACPI_CMP
  	  keys as input device, backlight device, tablet and accelerometer
  	  devices.
  
 -config COMPAL_LAPTOP
 -	tristate "Compal (and others) Laptop Extras"
 -	depends on ACPI
 -	depends on BACKLIGHT_CLASS_DEVICE
 -	depends on ACPI_VIDEO || ACPI_VIDEO = n
 -	depends on RFKILL
 -	depends on HWMON
 -	depends on POWER_SUPPLY
 -	help
 -	  This is a driver for laptops built by Compal, and some models by
 -	  other brands (e.g. Dell, Toshiba).
 +config INTEL_CHT_INT33FE
 +	tristate "Intel Cherry Trail ACPI INT33FE Driver"
 +	depends on X86 && ACPI && I2C && REGULATOR
 +	depends on CHARGER_BQ24190=y || (CHARGER_BQ24190=m && m)
 +	---help---
 +	  This driver add support for the INT33FE ACPI device found on
 +	  some Intel Cherry Trail devices.
 +
 +	  The INT33FE ACPI device has a CRS table with I2cSerialBusV2
 +	  resources for 3 devices: Maxim MAX17047 Fuel Gauge Controller,
 +	  FUSB302 USB Type-C Controller and PI3USB30532 USB switch.
 +	  This driver instantiates i2c-clients for these, so that standard
 +	  i2c drivers for these chips can bind to the them.
 +
 +	  If you enable this driver it is advised to also select
 +	  CONFIG_TYPEC_FUSB302=m and CONFIG_BATTERY_MAX17042=m.
 +
 +config INTEL_INT0002_VGPIO
 +	tristate "Intel ACPI INT0002 Virtual GPIO driver"
 +	depends on GPIOLIB && ACPI
 +	select GPIOLIB_IRQCHIP
 +	---help---
 +	  Some peripherals on Bay Trail and Cherry Trail platforms signal a
 +	  Power Management Event (PME) to the Power Management Controller (PMC)
 +	  to wakeup the system. When this happens software needs to explicitly
 +	  clear the PME bus 0 status bit in the GPE0a_STS register to avoid an
 +	  IRQ storm on IRQ 9.
 +
 +	  This is modelled in ACPI through the INT0002 ACPI device, which is
 +	  called a "Virtual GPIO controller" in ACPI because it defines the
 +	  event handler to call when the PME triggers through _AEI and _L02
 +	  methods as would be done for a real GPIO interrupt in ACPI.
  
 -	  It adds support for rfkill, Bluetooth, WLAN, LCD brightness, hwmon
 -	  and battery charging level control.
 +	  To compile this driver as a module, choose M here: the module will
 +	  be called intel_int0002_vgpio.
  
 -config LG_LAPTOP
 -	tristate "LG Laptop Extras"
 +config INTEL_HID_EVENT
 +	tristate "INTEL HID Event"
  	depends on ACPI
 -	depends on ACPI_WMI
  	depends on INPUT
  	select INPUT_SPARSEKMAP
 -	select NEW_LEDS
 -	select LEDS_CLASS
 -	help
 -	 This driver adds support for hotkeys as well as control of keyboard
 -	 backlight, battery maximum charge level and various other ACPI
 -	 features.
 -
 -	 If you have an LG Gram laptop, say Y or M here.
 -
 -config PANASONIC_LAPTOP
 -	tristate "Panasonic Laptop Extras"
 -	depends on INPUT && ACPI
 -	depends on BACKLIGHT_CLASS_DEVICE
 -	select INPUT_SPARSEKMAP
 -	help
 -	  This driver adds support for access to backlight control and hotkeys
 -	  on Panasonic Let's Note laptops.
 -
 -	  If you have a Panasonic Let's note laptop (such as the R1(N variant),
 -	  R2, R3, R5, T2, W2 and Y2 series), say Y.
 -
 -config SONY_LAPTOP
 -	tristate "Sony Laptop Extras"
 -	depends on ACPI
 -	depends on ACPI_VIDEO || ACPI_VIDEO = n
 -	depends on BACKLIGHT_CLASS_DEVICE
 -	depends on INPUT
 -	depends on RFKILL
  	help
 -	  This mini-driver drives the SNC and SPIC devices present in the ACPI
 -	  BIOS of the Sony Vaio laptops.
 -
 -	  It gives access to some extra laptop functionalities like Bluetooth,
 -	  screen brightness control, Fn keys and allows powering on/off some
 -	  devices.
 -
 -	  Read <file:Documentation/admin-guide/laptops/sony-laptop.rst> for more information.
 -
 -config SONYPI_COMPAT
 -	bool "Sonypi compatibility"
 -	depends on SONY_LAPTOP
 -	help
 -	  Build the sonypi driver compatibility code into the sony-laptop driver.
 -
 -config SYSTEM76_ACPI
 -	tristate "System76 ACPI Driver"
 -	depends on ACPI
 -	depends on ACPI_BATTERY
 -	depends on HWMON
 -	depends on INPUT
 -	select NEW_LEDS
 -	select LEDS_CLASS
 -	select LEDS_TRIGGERS
 -	help
 -	  This is a driver for System76 laptops running open firmware. It adds
 -	  support for Fn-Fx key combinations, keyboard backlight, and airplane mode
 -	  LEDs.
 +	  This driver provides support for the Intel HID Event hotkey interface.
 +	  Some laptops require this driver for hotkey support.
  
 -	  If you have a System76 laptop running open firmware, say Y or M here.
 +	  To compile this driver as a module, choose M here: the module will
 +	  be called intel_hid.
  
 -config TOPSTAR_LAPTOP
 -	tristate "Topstar Laptop Extras"
++<<<<<<< HEAD
 +config INTEL_VBTN
 +	tristate "INTEL VIRTUAL BUTTON"
  	depends on ACPI
  	depends on INPUT
  	select INPUT_SPARSEKMAP
 -	select LEDS_CLASS
 -	select NEW_LEDS
 -	help
 -	  This driver adds support for hotkeys found on Topstar laptops.
 -
 -	  If you have a Topstar laptop, say Y or M here.
 -
++=======
+ config SERIAL_MULTI_INSTANTIATE
+ 	tristate "Serial bus multi instantiate pseudo device driver"
+ 	depends on I2C && SPI && ACPI
++>>>>>>> 68f201f9061c (platform/x86: serial-multi-instantiate: Add SPI support)
  	help
 -	  Some ACPI-based systems list multiple devices in a single ACPI
 -	  firmware-node. This driver will instantiate separate clients
 -	  for each device in the firmware-node.
 +	  This driver provides support for the Intel Virtual Button interface.
 +	  Some laptops require this driver for power button support.
  
 -	  To compile this driver as a module, choose M here: the module
 -	  will be called serial-multi-instantiate.
 +	  To compile this driver as a module, choose M here: the module will
 +	  be called intel_vbtn.
  
 -config MLX_PLATFORM
 -	tristate "Mellanox Technologies platform support"
 -	depends on I2C && REGMAP
 -	help
 -	  This option enables system support for the Mellanox Technologies
 -	  platform. The Mellanox systems provide data center networking
 -	  solutions based on Virtual Protocol Interconnect (VPI) technology
 -	  enable seamless connectivity to 56/100Gb/s InfiniBand or 10/40/56GbE
 -	  connection.
 +config INTEL_SCU_IPC
 +	bool "Intel SCU IPC Support"
 +	depends on X86_INTEL_MID
 +	default y
 +	---help---
 +	  IPC is used to bridge the communications between kernel and SCU on
 +	  some embedded Intel x86 platforms. This is not needed for PC-type
 +	  machines.
  
 -	  If you have a Mellanox system, say Y or M here.
 +config INTEL_SCU_IPC_UTIL
 +	tristate "Intel SCU IPC utility driver"
 +	depends on INTEL_SCU_IPC
 +	default y
 +	---help---
 +	  The IPC Util driver provides an interface with the SCU enabling
 +	  low level access for debug work and updating the firmware. Say
 +	  N unless you will be doing this on an Intel MID platform.
  
 -config TOUCHSCREEN_DMI
 -	bool "DMI based touchscreen configuration info"
 -	depends on ACPI && DMI && I2C=y && TOUCHSCREEN_SILEAD
 -	select EFI_EMBEDDED_FIRMWARE if EFI
 +config INTEL_MID_POWER_BUTTON
 +	tristate "power button driver for Intel MID platforms"
 +	depends on INTEL_SCU_IPC && INPUT
  	help
 -	  Certain ACPI based tablets with e.g. Silead or Chipone touchscreens
 -	  do not have enough data in ACPI tables for the touchscreen driver to
 -	  handle the touchscreen properly, as OEMs expect the data to be baked
 -	  into the tablet model specific version of the driver shipped with the
 -	  the OS-image for the device. This option supplies the missing info.
 -	  Enable this for x86 tablets with Silead or Chipone touchscreens.
 -
 -config X86_ANDROID_TABLETS
 -	tristate "X86 Android tablet support"
 -	depends on I2C && SERIAL_DEV_BUS && ACPI && GPIOLIB
 -	help
 -	  X86 tablets which ship with Android as (part of) the factory image
 -	  typically have various problems with their DSDTs. The factory kernels
 -	  shipped on these devices typically have device addresses and GPIOs
 -	  hardcoded in the kernel, rather than specified in their DSDT.
 +	  This driver handles the power button on the Intel MID platforms.
 +
 +	  If unsure, say N.
  
 -	  With the DSDT containing a random collection of devices which may or
 -	  may not actually be present. This driver contains various fixes for
 -	  such tablets, including instantiating kernel devices for devices which
 -	  are missing from the DSDT.
 +config INTEL_MFLD_THERMAL
 +       tristate "Thermal driver for Intel Medfield platform"
 +       depends on MFD_INTEL_MSIC && THERMAL
 +       help
 +         Say Y here to enable thermal driver support for the  Intel Medfield
 +         platform.
  
 -	  If you have a x86 Android tablet say Y or M here, for a generic x86
 -	  distro config say M here.
 +config INTEL_IPS
 +	tristate "Intel Intelligent Power Sharing"
 +	depends on ACPI && PCI
 +	---help---
 +	  Intel Calpella platforms support dynamic power sharing between the
 +	  CPU and GPU, maximizing performance in a given TDP.  This driver,
 +	  along with the CPU frequency and i915 drivers, provides that
 +	  functionality.  If in doubt, say Y here; it will only load on
 +	  supported platforms.
  
  config FW_ATTR_CLASS
  	tristate
* Unmerged path drivers/platform/x86/serial-multi-instantiate.c
* Unmerged path drivers/platform/x86/Kconfig
* Unmerged path drivers/platform/x86/serial-multi-instantiate.c
