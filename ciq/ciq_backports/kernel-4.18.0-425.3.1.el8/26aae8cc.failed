x86/cpu/amd: Enumerate BTC_NO

jira LE-1907
cve CVE-2022-29901
cve CVE-2022-29900
cve CVE-2022-23825
cve CVE-2022-23816
Rebuild_History Non-Buildable kernel-4.18.0-425.3.1.el8
commit-author Andrew Cooper <andrew.cooper3@citrix.com>
commit 26aae8ccbc1972233afd08fb3f368947c0314265
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-425.3.1.el8/26aae8cc.failed

BTC_NO indicates that hardware is not susceptible to Branch Type Confusion.

Zen3 CPUs don't suffer BTC.

Hypervisors are expected to synthesise BTC_NO when it is appropriate
given the migration pool, to prevent kernels using heuristics.

  [ bp: Massage. ]

	Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
	Signed-off-by: Borislav Petkov <bp@suse.de>
(cherry picked from commit 26aae8ccbc1972233afd08fb3f368947c0314265)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/include/asm/cpufeatures.h
#	arch/x86/kernel/cpu/amd.c
#	arch/x86/kernel/cpu/common.c
diff --cc arch/x86/include/asm/cpufeatures.h
index 05564117439b,7e8099fd5ec1..000000000000
--- a/arch/x86/include/asm/cpufeatures.h
+++ b/arch/x86/include/asm/cpufeatures.h
@@@ -318,6 -322,8 +318,11 @@@
  #define X86_FEATURE_VIRT_SSBD		(13*32+25) /* Virtualized Speculative Store Bypass Disable */
  #define X86_FEATURE_AMD_SSB_NO		(13*32+26) /* "" Speculative Store Bypass is fixed in hardware. */
  #define X86_FEATURE_CPPC		(13*32+27) /* Collaborative Processor Performance Control */
++<<<<<<< HEAD
++=======
+ #define X86_FEATURE_BTC_NO		(13*32+29) /* "" Not vulnerable to Branch Type Confusion */
+ #define X86_FEATURE_BRS			(13*32+31) /* Branch Sampling available */
++>>>>>>> 26aae8ccbc19 (x86/cpu/amd: Enumerate BTC_NO)
  
  /* Thermal and Power Management Leaf, CPUID level 0x00000006 (EAX), word 14 */
  #define X86_FEATURE_DTHERM		(14*32+ 0) /* Digital Thermal Sensor */
diff --cc arch/x86/kernel/cpu/amd.c
index 45b1a646fe2e,9cfd11f7ba11..000000000000
--- a/arch/x86/kernel/cpu/amd.c
+++ b/arch/x86/kernel/cpu/amd.c
@@@ -856,12 -890,21 +856,30 @@@ static void init_amd_zn(struct cpuinfo_
  	node_reclaim_distance = 32;
  #endif
  
++<<<<<<< HEAD
 +	/*
 +	 * Fix erratum 1076: CPB feature bit not being set in CPUID. It affects
 +	 * all up to and including B1.
 +	 */
 +	if (c->x86_model <= 1 && c->x86_stepping <= 1)
 +		set_cpu_cap(c, X86_FEATURE_CPB);
++=======
+ 	/* Fix up CPUID bits, but only if not virtualised. */
+ 	if (!cpu_has(c, X86_FEATURE_HYPERVISOR)) {
+ 
+ 		/* Erratum 1076: CPB feature bit not being set in CPUID. */
+ 		if (!cpu_has(c, X86_FEATURE_CPB))
+ 			set_cpu_cap(c, X86_FEATURE_CPB);
+ 
+ 		/*
+ 		 * Zen3 (Fam19 model < 0x10) parts are not susceptible to
+ 		 * Branch Type Confusion, but predate the allocation of the
+ 		 * BTC_NO bit.
+ 		 */
+ 		if (c->x86 == 0x19 && !cpu_has(c, X86_FEATURE_BTC_NO))
+ 			set_cpu_cap(c, X86_FEATURE_BTC_NO);
+ 	}
++>>>>>>> 26aae8ccbc19 (x86/cpu/amd: Enumerate BTC_NO)
  }
  
  static void init_amd(struct cpuinfo_x86 *c)
diff --cc arch/x86/kernel/cpu/common.c
index 375d82321a80,02ba27355b04..000000000000
--- a/arch/x86/kernel/cpu/common.c
+++ b/arch/x86/kernel/cpu/common.c
@@@ -1175,9 -1341,29 +1175,28 @@@ static void __init cpu_set_bug_bits(str
  	 */
  	if ((cpu_has(c, X86_FEATURE_RDRAND) ||
  	     cpu_has(c, X86_FEATURE_RDSEED)) &&
 -	    cpu_matches(cpu_vuln_blacklist, SRBDS | MMIO_SBDS))
 +	    cpu_matches(cpu_vuln_blacklist, SRBDS))
  		    setup_force_cpu_bug(X86_BUG_SRBDS);
  
++<<<<<<< HEAD
++=======
+ 	/*
+ 	 * Processor MMIO Stale Data bug enumeration
+ 	 *
+ 	 * Affected CPU list is generally enough to enumerate the vulnerability,
+ 	 * but for virtualization case check for ARCH_CAP MSR bits also, VMM may
+ 	 * not want the guest to enumerate the bug.
+ 	 */
+ 	if (cpu_matches(cpu_vuln_blacklist, MMIO) &&
+ 	    !arch_cap_mmio_immune(ia32_cap))
+ 		setup_force_cpu_bug(X86_BUG_MMIO_STALE_DATA);
+ 
+ 	if (!cpu_has(c, X86_FEATURE_BTC_NO)) {
+ 		if (cpu_matches(cpu_vuln_blacklist, RETBLEED) || (ia32_cap & ARCH_CAP_RSBA))
+ 			setup_force_cpu_bug(X86_BUG_RETBLEED);
+ 	}
+ 
++>>>>>>> 26aae8ccbc19 (x86/cpu/amd: Enumerate BTC_NO)
  	if (cpu_matches(cpu_vuln_whitelist, NO_MELTDOWN))
  		return;
  
* Unmerged path arch/x86/include/asm/cpufeatures.h
* Unmerged path arch/x86/kernel/cpu/amd.c
* Unmerged path arch/x86/kernel/cpu/common.c
