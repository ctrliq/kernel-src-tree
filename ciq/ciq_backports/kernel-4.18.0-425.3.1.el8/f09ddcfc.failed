usb: dwc3: gadget: Prevent EP queuing while stopping transfers

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-425.3.1.el8
commit-author Wesley Cheng <wcheng@codeaurora.org>
commit f09ddcfcb8c569675066337adac2ac205113471f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-425.3.1.el8/f09ddcfc.failed

In the situations where the DWC3 gadget stops active transfers, once
calling the dwc3_gadget_giveback(), there is a chance where a function
driver can queue a new USB request in between the time where the dwc3
lock has been released and re-aquired.  This occurs after we've already
issued an ENDXFER command.  When the stop active transfers continues
to remove USB requests from all dep lists, the newly added request will
also be removed, while controller still has an active TRB for it.
This can lead to the controller accessing an unmapped memory address.

Fix this by ensuring parameters to prevent EP queuing are set before
calling the stop active transfers API.

Fixes: ae7e86108b12 ("usb: dwc3: Stop active transfers before halting the controller")
	Signed-off-by: Wesley Cheng <wcheng@codeaurora.org>
Link: https://lore.kernel.org/r/1615507142-23097-1-git-send-email-wcheng@codeaurora.org
	Cc: stable <stable@vger.kernel.org>
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit f09ddcfcb8c569675066337adac2ac205113471f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/usb/dwc3/gadget.c
diff --cc drivers/usb/dwc3/gadget.c
index 48b35cc07135,4a337f348651..000000000000
--- a/drivers/usb/dwc3/gadget.c
+++ b/drivers/usb/dwc3/gadget.c
@@@ -2301,7 -2272,8 +2302,12 @@@ static int dwc3_gadget_pullup(struct us
  			dwc->ev_buf->lpos = (dwc->ev_buf->lpos + count) %
  						dwc->ev_buf->length;
  		}
++<<<<<<< HEAD
 +		dwc->connected = false;
++=======
+ 	} else {
+ 		__dwc3_gadget_start(dwc);
++>>>>>>> f09ddcfcb8c5 (usb: dwc3: gadget: Prevent EP queuing while stopping transfers)
  	}
  
  	ret = dwc3_gadget_run_stop(dwc, is_on, false);
* Unmerged path drivers/usb/dwc3/gadget.c
