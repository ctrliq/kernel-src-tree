usb: dwc3: gadget: Restart DWC3 gadget when enabling pullup

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-425.3.1.el8
commit-author Wesley Cheng <wcheng@codeaurora.org>
commit a1383b3537a7bea1c213baa7878ccc4ecf4413b5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-425.3.1.el8/a1383b35.failed

usb_gadget_deactivate/usb_gadget_activate does not execute the UDC start
operation, which may leave EP0 disabled and event IRQs disabled when
re-activating the function. Move the enabling/disabling of USB EP0 and
device event IRQs to be performed in the pullup routine.

Fixes: ae7e86108b12 ("usb: dwc3: Stop active transfers before halting the controller")
	Tested-by: Michael Tretter <m.tretter@pengutronix.de>
	Cc: stable <stable@vger.kernel.org>
	Reported-by: Michael Tretter <m.tretter@pengutronix.de>
	Signed-off-by: Wesley Cheng <wcheng@codeaurora.org>
Link: https://lore.kernel.org/r/1609282837-21666-1-git-send-email-wcheng@codeaurora.org
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit a1383b3537a7bea1c213baa7878ccc4ecf4413b5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/usb/dwc3/gadget.c
diff --cc drivers/usb/dwc3/gadget.c
index 48b35cc07135,25f654b79e48..000000000000
--- a/drivers/usb/dwc3/gadget.c
+++ b/drivers/usb/dwc3/gadget.c
@@@ -2301,7 -2146,8 +2302,12 @@@ static int dwc3_gadget_pullup(struct us
  			dwc->ev_buf->lpos = (dwc->ev_buf->lpos + count) %
  						dwc->ev_buf->length;
  		}
++<<<<<<< HEAD
 +		dwc->connected = false;
++=======
+ 	} else {
+ 		__dwc3_gadget_start(dwc);
++>>>>>>> a1383b3537a7 (usb: dwc3: gadget: Restart DWC3 gadget when enabling pullup)
  	}
  
  	ret = dwc3_gadget_run_stop(dwc, is_on, false);
* Unmerged path drivers/usb/dwc3/gadget.c
