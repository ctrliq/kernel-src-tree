net/mlx5e: Move sample attr allocation to tc_action sample parse op

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-425.3.1.el8
commit-author Roi Dayan <roid@nvidia.com>
commit 6bcba1bdeda57cd36317f616253e387fb14e70ee
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-425.3.1.el8/6bcba1bd.failed

There is no reason to wait with the kmalloc to after parsing all
other actions. There could still be a failure later and before
offloading the rule. So alloc the mem when parsing.
The memory is being released on mlx5e_flow_put() which is called
also on error flow.

	Signed-off-by: Roi Dayan <roid@nvidia.com>
	Reviewed-by: Oz Shlomo <ozsh@nvidia.com>
	Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
(cherry picked from commit 6bcba1bdeda57cd36317f616253e387fb14e70ee)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/en/tc/act/act.h
#	drivers/net/ethernet/mellanox/mlx5/core/en/tc/act/sample.c
#	drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
index abcf89c03680,c6c6d20ecd09..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
@@@ -4309,16 -3425,6 +4309,19 @@@ static int parse_tc_fdb_actions(struct 
  		return -EOPNOTSUPP;
  	}
  
++<<<<<<< HEAD
 +	/* Allocate sample attribute only when there is a sample action and
 +	 * no errors after parsing.
 +	 */
 +	if (flow_flag_test(flow, SAMPLE)) {
 +		attr->sample_attr = kzalloc(sizeof(*attr->sample_attr), GFP_KERNEL);
 +		if (!attr->sample_attr)
 +			return -ENOMEM;
 +		*attr->sample_attr = sample_attr;
 +	}
 +
++=======
++>>>>>>> 6bcba1bdeda5 (net/mlx5e: Move sample attr allocation to tc_action sample parse op)
  	return 0;
  }
  
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en/tc/act/act.h
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en/tc/act/sample.c
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en/tc/act/act.h
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en/tc/act/sample.c
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_tc.c
