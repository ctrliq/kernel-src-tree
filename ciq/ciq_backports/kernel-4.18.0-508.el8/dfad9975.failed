net/mlx5: Use recovery timeout on sync reset flow

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-508.el8
commit-author Moshe Shemesh <moshe@nvidia.com>
commit dfad99750c0f83b0242572a573afa2c055f85b36
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-508.el8/dfad9975.failed

Use the same timeout for sync reset flow and health recovery flow, since
the former involves driver's recovery from firmware reset, which is
similar to health recovery. Otherwise, in some cases, such as a firmware
upgrade on the DPU, the firmware pre-init bit may not be ready within
current timeout and the driver will abort loading back after reset.

	Signed-off-by: Moshe Shemesh <moshe@nvidia.com>
Fixes: 37ca95e62ee2 ("net/mlx5: Increase FW pre-init timeout for health recovery")
	Reviewed-by: Maher Sanalla <msanalla@nvidia.com>
	Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
(cherry picked from commit dfad99750c0f83b0242572a573afa2c055f85b36)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/fw_reset.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/fw_reset.c
index 023b8ae77392,50022e7565f1..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/fw_reset.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/fw_reset.c
@@@ -485,8 -498,8 +485,13 @@@ int mlx5_fw_reset_wait_reset_done(struc
  	}
  	err = fw_reset->ret;
  	if (test_and_clear_bit(MLX5_FW_RESET_FLAGS_RELOAD_REQUIRED, &fw_reset->reset_flags)) {
++<<<<<<< HEAD
 +		mlx5_unload_one_devl_locked(dev);
 +		mlx5_load_one_devl_locked(dev, false);
++=======
+ 		mlx5_unload_one_devl_locked(dev, false);
+ 		mlx5_load_one_devl_locked(dev, true);
++>>>>>>> dfad99750c0f (net/mlx5: Use recovery timeout on sync reset flow)
  	}
  out:
  	clear_bit(MLX5_FW_RESET_FLAGS_PENDING_COMP, &fw_reset->reset_flags);
diff --git a/drivers/net/ethernet/mellanox/mlx5/core/devlink.c b/drivers/net/ethernet/mellanox/mlx5/core/devlink.c
index 18d679255fcc..d09631a37ba7 100644
--- a/drivers/net/ethernet/mellanox/mlx5/core/devlink.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/devlink.c
@@ -200,7 +200,7 @@ static int mlx5_devlink_reload_up(struct devlink *devlink, enum devlink_reload_a
 			break;
 		/* On fw_activate action, also driver is reloaded and reinit performed */
 		*actions_performed |= BIT(DEVLINK_RELOAD_ACTION_DRIVER_REINIT);
-		ret = mlx5_load_one_devl_locked(dev, false);
+		ret = mlx5_load_one_devl_locked(dev, true);
 		break;
 	default:
 		/* Unsupported action should not get to this function */
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/fw_reset.c
