x86/bpf: Call branch history clearing sequence on exit

jira LE-4018
Rebuild_History Non-Buildable kernel-5.14.0-570.37.1.el9_6
commit-author Daniel Sneddon <daniel.sneddon@linux.intel.com>
commit d4e89d212d401672e9cdfe825d947ee3a9fbe3f5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-5.14.0-570.37.1.el9_6/d4e89d21.failed

Classic BPF programs have been identified as potential vectors for
intra-mode Branch Target Injection (BTI) attacks. Classic BPF programs can
be run by unprivileged users. They allow unprivileged code to execute
inside the kernel. Attackers can use unprivileged cBPF to craft branch
history in kernel mode that can influence the target of indirect branches.

Introduce a branch history buffer (BHB) clearing sequence during the JIT
compilation of classic BPF programs. The clearing sequence is the same as
is used in previous mitigations to protect syscalls. Since eBPF programs
already have their own mitigations in place, only insert the call on
classic programs that aren't run by privileged users.

	Signed-off-by: Daniel Sneddon <daniel.sneddon@linux.intel.com>
	Signed-off-by: Pawan Gupta <pawan.kumar.gupta@linux.intel.com>
	Signed-off-by: Dave Hansen <dave.hansen@linux.intel.com>
	Acked-by: Daniel Borkmann <daniel@iogearbox.net>
	Reviewed-by: Alexandre Chartre <alexandre.chartre@oracle.com>
(cherry picked from commit d4e89d212d401672e9cdfe825d947ee3a9fbe3f5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/net/bpf_jit_comp.c
diff --cc arch/x86/net/bpf_jit_comp.c
index 55fc2ebbda0f,6fb786c8b2aa..000000000000
--- a/arch/x86/net/bpf_jit_comp.c
+++ b/arch/x86/net/bpf_jit_comp.c
@@@ -1412,6 -1498,34 +1412,37 @@@ static void emit_shiftx(u8 **pprog, u3
  #define LOAD_TAIL_CALL_CNT_PTR(stack)				\
  	__LOAD_TCC_PTR(BPF_TAIL_CALL_CNT_PTR_STACK_OFF(stack))
  
++<<<<<<< HEAD
++=======
+ /* Memory size/value to protect private stack overflow/underflow */
+ #define PRIV_STACK_GUARD_SZ    8
+ #define PRIV_STACK_GUARD_VAL   0xEB9F12345678eb9fULL
+ 
+ static int emit_spectre_bhb_barrier(u8 **pprog, u8 *ip,
+ 				    struct bpf_prog *bpf_prog)
+ {
+ 	u8 *prog = *pprog;
+ 	u8 *func;
+ 
+ 	if (cpu_feature_enabled(X86_FEATURE_CLEAR_BHB_LOOP)) {
+ 		/* The clearing sequence clobbers eax and ecx. */
+ 		EMIT1(0x50); /* push rax */
+ 		EMIT1(0x51); /* push rcx */
+ 		ip += 2;
+ 
+ 		func = (u8 *)clear_bhb_loop;
+ 		ip += x86_call_depth_emit_accounting(&prog, func, ip);
+ 
+ 		if (emit_call(&prog, func, ip))
+ 			return -EINVAL;
+ 		EMIT1(0x59); /* pop rcx */
+ 		EMIT1(0x58); /* pop rax */
+ 	}
+ 	*pprog = prog;
+ 	return 0;
+ }
+ 
++>>>>>>> d4e89d212d40 (x86/bpf: Call branch history clearing sequence on exit)
  static int do_jit(struct bpf_prog *bpf_prog, int *addrs, u8 *image, u8 *rw_image,
  		  int oldproglen, struct jit_context *ctx, bool jmp_padding)
  {
* Unmerged path arch/x86/net/bpf_jit_comp.c
