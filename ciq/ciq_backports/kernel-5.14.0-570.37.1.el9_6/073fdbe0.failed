x86/bhi: Do not set BHI_DIS_S in 32-bit mode

jira LE-4018
Rebuild_History Non-Buildable kernel-5.14.0-570.37.1.el9_6
commit-author Pawan Gupta <pawan.kumar.gupta@linux.intel.com>
commit 073fdbe02c69c43fb7c0d547ec265c7747d4a646
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-5.14.0-570.37.1.el9_6/073fdbe0.failed

With the possibility of intra-mode BHI via cBPF, complete mitigation for
BHI is to use IBHF (history fence) instruction with BHI_DIS_S set. Since
this new instruction is only available in 64-bit mode, setting BHI_DIS_S in
32-bit mode is only a partial mitigation.

Do not set BHI_DIS_S in 32-bit mode so as to avoid reporting misleading
mitigated status. With this change IBHF won't be used in 32-bit mode, also
remove the CONFIG_X86_64 check from emit_spectre_bhb_barrier().

	Suggested-by: Josh Poimboeuf <jpoimboe@kernel.org>
	Signed-off-by: Pawan Gupta <pawan.kumar.gupta@linux.intel.com>
	Signed-off-by: Dave Hansen <dave.hansen@linux.intel.com>
	Reviewed-by: Josh Poimboeuf <jpoimboe@kernel.org>
	Reviewed-by: Alexandre Chartre <alexandre.chartre@oracle.com>
(cherry picked from commit 073fdbe02c69c43fb7c0d547ec265c7747d4a646)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/net/bpf_jit_comp.c
diff --cc arch/x86/net/bpf_jit_comp.c
index 55fc2ebbda0f,8a0fabb850b7..000000000000
--- a/arch/x86/net/bpf_jit_comp.c
+++ b/arch/x86/net/bpf_jit_comp.c
@@@ -1412,6 -1500,52 +1412,55 @@@ static void emit_shiftx(u8 **pprog, u3
  #define LOAD_TAIL_CALL_CNT_PTR(stack)				\
  	__LOAD_TCC_PTR(BPF_TAIL_CALL_CNT_PTR_STACK_OFF(stack))
  
++<<<<<<< HEAD
++=======
+ /* Memory size/value to protect private stack overflow/underflow */
+ #define PRIV_STACK_GUARD_SZ    8
+ #define PRIV_STACK_GUARD_VAL   0xEB9F12345678eb9fULL
+ 
+ static int emit_spectre_bhb_barrier(u8 **pprog, u8 *ip,
+ 				    struct bpf_prog *bpf_prog)
+ {
+ 	u8 *prog = *pprog;
+ 	u8 *func;
+ 
+ 	if (cpu_feature_enabled(X86_FEATURE_CLEAR_BHB_LOOP)) {
+ 		/* The clearing sequence clobbers eax and ecx. */
+ 		EMIT1(0x50); /* push rax */
+ 		EMIT1(0x51); /* push rcx */
+ 		ip += 2;
+ 
+ 		func = (u8 *)clear_bhb_loop;
+ 		ip += x86_call_depth_emit_accounting(&prog, func, ip);
+ 
+ 		if (emit_call(&prog, func, ip))
+ 			return -EINVAL;
+ 		EMIT1(0x59); /* pop rcx */
+ 		EMIT1(0x58); /* pop rax */
+ 	}
+ 	/* Insert IBHF instruction */
+ 	if ((cpu_feature_enabled(X86_FEATURE_CLEAR_BHB_LOOP) &&
+ 	     cpu_feature_enabled(X86_FEATURE_HYPERVISOR)) ||
+ 	    cpu_feature_enabled(X86_FEATURE_CLEAR_BHB_HW)) {
+ 		/*
+ 		 * Add an Indirect Branch History Fence (IBHF). IBHF acts as a
+ 		 * fence preventing branch history from before the fence from
+ 		 * affecting indirect branches after the fence. This is
+ 		 * specifically used in cBPF jitted code to prevent Intra-mode
+ 		 * BHI attacks. The IBHF instruction is designed to be a NOP on
+ 		 * hardware that doesn't need or support it.  The REP and REX.W
+ 		 * prefixes are required by the microcode, and they also ensure
+ 		 * that the NOP is unlikely to be used in existing code.
+ 		 *
+ 		 * IBHF is not a valid instruction in 32-bit mode.
+ 		 */
+ 		EMIT5(0xF3, 0x48, 0x0F, 0x1E, 0xF8); /* ibhf */
+ 	}
+ 	*pprog = prog;
+ 	return 0;
+ }
+ 
++>>>>>>> 073fdbe02c69 (x86/bhi: Do not set BHI_DIS_S in 32-bit mode)
  static int do_jit(struct bpf_prog *bpf_prog, int *addrs, u8 *image, u8 *rw_image,
  		  int oldproglen, struct jit_context *ctx, bool jmp_padding)
  {
diff --git a/arch/x86/kernel/cpu/bugs.c b/arch/x86/kernel/cpu/bugs.c
index 5fa1289a5d2d..d0268b8c3f34 100644
--- a/arch/x86/kernel/cpu/bugs.c
+++ b/arch/x86/kernel/cpu/bugs.c
@@ -1669,11 +1669,11 @@ static void __init bhi_select_mitigation(void)
 			return;
 	}
 
-	/* Mitigate in hardware if supported */
-	if (spec_ctrl_bhi_dis())
+	if (!IS_ENABLED(CONFIG_X86_64))
 		return;
 
-	if (!IS_ENABLED(CONFIG_X86_64))
+	/* Mitigate in hardware if supported */
+	if (spec_ctrl_bhi_dis())
 		return;
 
 	if (bhi_mitigation == BHI_MITIGATION_VMEXIT_ONLY) {
* Unmerged path arch/x86/net/bpf_jit_comp.c
