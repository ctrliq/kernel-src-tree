x86/ibt: Keep IBT disabled during alternative patching

jira LE-4018
cve CVE-2024-28956
Rebuild_History Non-Buildable kernel-5.14.0-570.37.1.el9_6
commit-author Pawan Gupta <pawan.kumar.gupta@linux.intel.com>
commit ebebe30794d38c51f71fe4951ba6af4159d9837d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-5.14.0-570.37.1.el9_6/ebebe307.failed

cfi_rewrite_callers() updates the fineIBT hash matching at the caller side,
but except for paranoid-mode it relies on apply_retpoline() and friends for
any ENDBR relocation. This could temporarily cause an indirect branch to
land on a poisoned ENDBR.

For instance, with para-virtualization enabled, a simple wrmsrl() could
have an indirect branch pointing to native_write_msr() who's ENDBR has been
relocated due to fineIBT:

<wrmsrl>:
       push   %rbp
       mov    %rsp,%rbp
       mov    %esi,%eax
       mov    %rsi,%rdx
       shr    $0x20,%rdx
       mov    %edi,%edi
       mov    %rax,%rsi
       call   *0x21e65d0(%rip)        # <pv_ops+0xb8>
       ^^^^^^^^^^^^^^^^^^^^^^^

Such an indirect call during the alternative patching could #CP if the
caller is not *yet* adjusted for the new target ENDBR. To prevent a false
 #CP, keep CET-IBT disabled until all callers are patched.

Patching during the module load does not need to be guarded by IBT-disable
because the module code is not executed until the patching is complete.

	Signed-off-by: Pawan Gupta <pawan.kumar.gupta@linux.intel.com>
	Signed-off-by: Dave Hansen <dave.hansen@linux.intel.com>
	Reviewed-by: Alexandre Chartre <alexandre.chartre@oracle.com>
(cherry picked from commit ebebe30794d38c51f71fe4951ba6af4159d9837d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/alternative.c
diff --cc arch/x86/kernel/alternative.c
index 4fad1e17e3ce,6e0b09b2c972..000000000000
--- a/arch/x86/kernel/alternative.c
+++ b/arch/x86/kernel/alternative.c
@@@ -1685,11 -2114,8 +1688,16 @@@ void __init alternative_instructions(vo
  	 */
  	paravirt_set_cap();
  
++<<<<<<< HEAD
 +	/*
 +	 * First patch paravirt functions, such that we overwrite the indirect
 +	 * call with the direct call.
 +	 */
 +	apply_paravirt(__parainstructions, __parainstructions_end);
++=======
+ 	/* Keep CET-IBT disabled until caller/callee are patched */
+ 	ibt = ibt_save(/*disable*/ true);
++>>>>>>> ebebe30794d3 (x86/ibt: Keep IBT disabled during alternative patching)
  
  	__apply_fineibt(__retpoline_sites, __retpoline_sites_end,
  			__cfi_sites, __cfi_sites_end, true);
* Unmerged path arch/x86/kernel/alternative.c
