ibmveth: Reduce default tx queues to 8

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-530.el8
commit-author Nick Child <nnac123@linux.ibm.com>
commit 742c60e1285ca40642e988f7e3db92232171b27d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-530.el8/742c60e1.failed

Previously, the default number of transmit queues was 16. Due to
resource concerns, set to 8 queues instead. Still allow the user
to set more queues (max 16) if they like.

Since the driver is virtualized away from the physical NIC, the purpose
of multiple queues is purely to allow for parallel calls to the
hypervisor. Therefore, there is no noticeable effect on performance by
reducing queue count to 8.

Fixes: d926793c1de9 ("ibmveth: Implement multi queue on xmit")
	Reported-by: Dave Taht <dave.taht@gmail.com>
	Signed-off-by: Nick Child <nnac123@linux.ibm.com>
Link: https://lore.kernel.org/r/20221107203215.58206-1-nnac123@linux.ibm.com
	Signed-off-by: Jakub Kicinski <kuba@kernel.org>
(cherry picked from commit 742c60e1285ca40642e988f7e3db92232171b27d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/ibm/ibmveth.c
diff --cc drivers/net/ethernet/ibm/ibmveth.c
index 4964de1079a5,5b96cd94dcd2..000000000000
--- a/drivers/net/ethernet/ibm/ibmveth.c
+++ b/drivers/net/ethernet/ibm/ibmveth.c
@@@ -1691,7 -1757,17 +1691,18 @@@ static int ibmveth_probe(struct vio_de
  			kobject_uevent(kobj, KOBJ_ADD);
  	}
  
++<<<<<<< HEAD
++=======
+ 	rc = netif_set_real_num_tx_queues(netdev, min(num_online_cpus(),
+ 						      IBMVETH_DEFAULT_QUEUES));
+ 	if (rc) {
+ 		netdev_dbg(netdev, "failed to set number of tx queues rc=%d\n",
+ 			   rc);
+ 		free_netdev(netdev);
+ 		return rc;
+ 	}
++>>>>>>> 742c60e1285c (ibmveth: Reduce default tx queues to 8)
  	adapter->tx_ltb_size = PAGE_ALIGN(IBMVETH_MAX_TX_BUF_SIZE);
 -	for (i = 0; i < IBMVETH_MAX_QUEUES; i++)
 -		adapter->tx_ltb_ptr[i] = NULL;
  
  	netdev_dbg(netdev, "adapter @ 0x%p\n", adapter);
  	netdev_dbg(netdev, "registering netdev...\n");
* Unmerged path drivers/net/ethernet/ibm/ibmveth.c
diff --git a/drivers/net/ethernet/ibm/ibmveth.h b/drivers/net/ethernet/ibm/ibmveth.h
index 515634d68a0f..ce0e3c959ebf 100644
--- a/drivers/net/ethernet/ibm/ibmveth.h
+++ b/drivers/net/ethernet/ibm/ibmveth.h
@@ -112,6 +112,7 @@ static inline long h_illan_attributes(unsigned long unit_address,
 #define IBMVETH_MAX_BUF_SIZE (1024 * 128)
 #define IBMVETH_MAX_TX_BUF_SIZE (1024 * 64)
 #define IBMVETH_MAX_QUEUES 16U
+#define IBMVETH_DEFAULT_QUEUES 8U
 
 static int pool_size[] = { 512, 1024 * 2, 1024 * 16, 1024 * 32, 1024 * 64 };
 static int pool_count[] = { 256, 512, 256, 256, 256 };
