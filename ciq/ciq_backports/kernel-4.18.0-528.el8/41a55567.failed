module: kunit: Load .kunit_test_suites section when CONFIG_KUNIT=m

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-528.el8
commit-author David Gow <davidgow@google.com>
commit 41a55567b9e31cb852670684404654ec4fd0d8d6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-528.el8/41a55567.failed

The new KUnit module handling has KUnit test suites listed in a
.kunit_test_suites section of each module. This should be loaded when
the module is, but at the moment this only happens if KUnit is built-in.

Also load this when KUnit is enabled as a module: it'll not be usable
unless KUnit is loaded, but such modules are likely to depend on KUnit
anyway, so it's unlikely to ever be loaded needlessly.

Fixes: 3d6e44623841 ("kunit: unify module and builtin suite definitions")
	Signed-off-by: David Gow <davidgow@google.com>
	Reviewed-by: Brendan Higgins <brendanhiggins@google.com>
	Tested-by: Geert Uytterhoeven <geert@linux-m68k.org>
	Signed-off-by: Shuah Khan <skhan@linuxfoundation.org>
(cherry picked from commit 41a55567b9e31cb852670684404654ec4fd0d8d6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	kernel/module.c
diff --cc kernel/module.c
index e06acf01f809,a4e4d84b6f4e..000000000000
--- a/kernel/module.c
+++ b/kernel/module.c
@@@ -3180,6 -2082,29 +3180,32 @@@ static int find_module_sections(struct 
  					    sizeof(*mod->ei_funcs),
  					    &mod->num_ei_funcs);
  #endif
++<<<<<<< HEAD:kernel/module.c
++=======
+ #ifdef CONFIG_KPROBES
+ 	mod->kprobes_text_start = section_objs(info, ".kprobes.text", 1,
+ 						&mod->kprobes_text_size);
+ 	mod->kprobe_blacklist = section_objs(info, "_kprobe_blacklist",
+ 						sizeof(unsigned long),
+ 						&mod->num_kprobe_blacklist);
+ #endif
+ #ifdef CONFIG_PRINTK_INDEX
+ 	mod->printk_index_start = section_objs(info, ".printk_index",
+ 					       sizeof(*mod->printk_index_start),
+ 					       &mod->printk_index_size);
+ #endif
+ #ifdef CONFIG_HAVE_STATIC_CALL_INLINE
+ 	mod->static_call_sites = section_objs(info, ".static_call_sites",
+ 					      sizeof(*mod->static_call_sites),
+ 					      &mod->num_static_call_sites);
+ #endif
+ #if IS_ENABLED(CONFIG_KUNIT)
+ 	mod->kunit_suites = section_objs(info, ".kunit_test_suites",
+ 					      sizeof(*mod->kunit_suites),
+ 					      &mod->num_kunit_suites);
+ #endif
+ 
++>>>>>>> 41a55567b9e3 (module: kunit: Load .kunit_test_suites section when CONFIG_KUNIT=m):kernel/module/main.c
  	mod->extable = section_objs(info, "__ex_table",
  				    sizeof(*mod->extable), &mod->num_exentries);
  
* Unmerged path kernel/module.c
