ASoC: SOF: Intel: hda-mlink: add helpers to suspend/resume links

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-499.el8
commit-author Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
commit f402a974aa0ae2b9abcccf49d5ac7c093e86a073
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-499.el8/f402a974.failed

No functionality change, just move the code in hda-mlink.

	Signed-off-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
	Reviewed-by: Rander Wang <rander.wang@intel.com>
	Reviewed-by: Bard Liao <yung-chuan.liao@linux.intel.com>
	Reviewed-by: PÃ©ter Ujfalusi <peter.ujfalusi@linux.intel.com>
	Reviewed-by: Ranjani Sridharan <ranjani.sridharan@linux.intel.com>
Link: https://lore.kernel.org/r/20221027193540.259520-18-pierre-louis.bossart@linux.intel.com
	Signed-off-by: Mark Brown <broonie@kernel.org>
(cherry picked from commit f402a974aa0ae2b9abcccf49d5ac7c093e86a073)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/soc/sof/intel/hda-dsp.c
diff --cc sound/soc/sof/intel/hda-dsp.c
index d325e82aff4c,c61bab1a5719..000000000000
--- a/sound/soc/sof/intel/hda-dsp.c
+++ b/sound/soc/sof/intel/hda-dsp.c
@@@ -858,13 -843,11 +845,18 @@@ int hda_dsp_suspend(struct snd_sof_dev 
  						HDA_VS_INTEL_EM2_L1SEN,
  						HDA_VS_INTEL_EM2_L1SEN);
  
++<<<<<<< HEAD
 +#if IS_ENABLED(CONFIG_SND_SOC_SOF_HDA)
 +		/* stop the CORB/RIRB DMA if it is On */
 +		if (bus->cmd_dma_state)
 +			snd_hdac_bus_stop_cmd_io(bus);
++=======
+ 		/* stop the CORB/RIRB DMA if it is On */
+ 		hda_codec_suspend_cmd_io(sdev);
++>>>>>>> f402a974aa0a (ASoC: SOF: Intel: hda-mlink: add helpers to suspend/resume links)
  
  		/* no link can be powered in s0ix state */
- 		ret = snd_hdac_ext_bus_link_power_down_all(bus);
+ 		ret = hda_bus_ml_suspend(bus);
  		if (ret < 0) {
  			dev_err(sdev->dev,
  				"error %d in %s: failed to power down links",
* Unmerged path sound/soc/sof/intel/hda-dsp.c
diff --git a/sound/soc/sof/intel/hda-mlink.c b/sound/soc/sof/intel/hda-mlink.c
index b5f922603187..2cdee03e4a47 100644
--- a/sound/soc/sof/intel/hda-mlink.c
+++ b/sound/soc/sof/intel/hda-mlink.c
@@ -51,4 +51,25 @@ void hda_bus_ml_reset_losidv(struct hdac_bus *bus)
 		writel(0, hlink->ml_addr + AZX_REG_ML_LOSIDV);
 }
 
+int hda_bus_ml_resume(struct hdac_bus *bus)
+{
+	struct hdac_ext_link *hlink;
+	int ret;
+
+	/* power up links that were active before suspend */
+	list_for_each_entry(hlink, &bus->hlink_list, list) {
+		if (hlink->ref_count) {
+			ret = snd_hdac_ext_bus_link_power_up(hlink);
+			if (ret < 0)
+				return ret;
+		}
+	}
+	return 0;
+}
+
+int hda_bus_ml_suspend(struct hdac_bus *bus)
+{
+	return snd_hdac_ext_bus_link_power_down_all(bus);
+}
+
 #endif
diff --git a/sound/soc/sof/intel/hda.h b/sound/soc/sof/intel/hda.h
index a0d8f8edad5c..20d7c8fc45f2 100644
--- a/sound/soc/sof/intel/hda.h
+++ b/sound/soc/sof/intel/hda.h
@@ -742,12 +742,16 @@ static inline int hda_codec_i915_exit(struct snd_sof_dev *sdev) { return 0; }
 void hda_bus_ml_get_capabilities(struct hdac_bus *bus);
 void hda_bus_ml_put_all(struct hdac_bus *bus);
 void hda_bus_ml_reset_losidv(struct hdac_bus *bus);
+int hda_bus_ml_resume(struct hdac_bus *bus);
+int hda_bus_ml_suspend(struct hdac_bus *bus);
 
 #else
 
 static inline void hda_bus_ml_get_capabilities(struct hdac_bus *bus) { }
 static inline void hda_bus_ml_put_all(struct hdac_bus *bus) { }
 static inline void hda_bus_ml_reset_losidv(struct hdac_bus *bus) { }
+static inline int hda_bus_ml_resume(struct hdac_bus *bus) { return 0; }
+static inline int hda_bus_ml_suspend(struct hdac_bus *bus) { return 0; }
 
 #endif /* CONFIG_SND_SOC_SOF_HDA */
 
