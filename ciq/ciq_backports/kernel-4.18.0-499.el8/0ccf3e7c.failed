KVM: SVM: Flush the "current" TLB when activating AVIC

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-499.el8
commit-author Sean Christopherson <seanjc@google.com>
commit 0ccf3e7cb95a2db8ddb2a44812037ffba8166dc9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-499.el8/0ccf3e7c.failed

Flush the TLB when activating AVIC as the CPU can insert into the TLB
while AVIC is "locally" disabled.  KVM doesn't treat "APIC hardware
disabled" as VM-wide AVIC inhibition, and so when a vCPU has its APIC
hardware disabled, AVIC is not guaranteed to be inhibited.  As a result,
KVM may create a valid NPT mapping for the APIC base, which the CPU can
cache as a non-AVIC translation.

Note, Intel handles this in vmx_set_virtual_apic_mode().

	Reviewed-by: Paolo Bonzini <pbonzini@redhat.com>
	Cc: stable@vger.kernel.org
	Signed-off-by: Sean Christopherson <seanjc@google.com>
	Reviewed-by: Maxim Levitsky <mlevitsk@redhat.com>
Message-Id: <20230106011306.85230-4-seanjc@google.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 0ccf3e7cb95a2db8ddb2a44812037ffba8166dc9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/svm/avic.c
diff --cc arch/x86/kvm/svm/avic.c
index 853ac5ed3234,712330b80891..000000000000
--- a/arch/x86/kvm/svm/avic.c
+++ b/arch/x86/kvm/svm/avic.c
@@@ -87,6 -86,13 +87,16 @@@ static void avic_activate_vmcb(struct v
  		/* Disabling MSR intercept for x2APIC registers */
  		svm_set_x2apic_msr_interception(svm, false);
  	} else {
++<<<<<<< HEAD
++=======
+ 		/*
+ 		 * Flush the TLB, the guest may have inserted a non-APIC
+ 		 * mapping into the TLB while AVIC was disabled.
+ 		 */
+ 		kvm_make_request(KVM_REQ_TLB_FLUSH_CURRENT, &svm->vcpu);
+ 
+ 		/* For xAVIC and hybrid-xAVIC modes */
++>>>>>>> 0ccf3e7cb95a (KVM: SVM: Flush the "current" TLB when activating AVIC)
  		vmcb->control.avic_physical_id |= AVIC_MAX_PHYSICAL_ID;
  		/* Enabling MSR intercept for x2APIC registers */
  		svm_set_x2apic_msr_interception(svm, true);
* Unmerged path arch/x86/kvm/svm/avic.c
