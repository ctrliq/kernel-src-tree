ASoC: SOF: Intel: hda-codec: simplify SND_SOC_SOF_HDA_AUDIO_CODEC handling

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-499.el8
commit-author Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
commit dc1d964a44dd9eb236f4e98b7b1eaa776093ca8b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-499.el8/dc1d964a.failed

Now that we have removed the dependency on SND_SOC_HDAC_HDMI, we can
simplify the code and make the code conditional on a single #ifdef.

	Signed-off-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
	Reviewed-by: Rander Wang <rander.wang@intel.com>
	Reviewed-by: Bard Liao <yung-chuan.liao@linux.intel.com>
	Reviewed-by: PÃ©ter Ujfalusi <peter.ujfalusi@linux.intel.com>
	Reviewed-by: Ranjani Sridharan <ranjani.sridharan@linux.intel.com>
Link: https://lore.kernel.org/r/20221027193540.259520-4-pierre-louis.bossart@linux.intel.com
	Signed-off-by: Mark Brown <broonie@kernel.org>
(cherry picked from commit dc1d964a44dd9eb236f4e98b7b1eaa776093ca8b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/soc/sof/intel/hda-codec.c
diff --cc sound/soc/sof/intel/hda-codec.c
index 054ae8172679,d74a429f09c5..000000000000
--- a/sound/soc/sof/intel/hda-codec.c
+++ b/sound/soc/sof/intel/hda-codec.c
@@@ -95,12 -95,7 +95,16 @@@ void hda_codec_jack_check(struct snd_so
  		if (codec->jacktbl.used)
  			pm_request_resume(&codec->core.dev);
  }
++<<<<<<< HEAD
 +#else
 +void hda_codec_jack_wake_enable(struct snd_sof_dev *sdev, bool enable) {}
 +void hda_codec_jack_check(struct snd_sof_dev *sdev) {}
 +#endif /* CONFIG_SND_SOC_SOF_HDA_AUDIO_CODEC */
 +EXPORT_SYMBOL(hda_codec_jack_wake_enable);
 +EXPORT_SYMBOL(hda_codec_jack_check);
++=======
+ EXPORT_SYMBOL_NS(hda_codec_jack_check, SND_SOC_SOF_HDA_AUDIO_CODEC);
++>>>>>>> dc1d964a44dd (ASoC: SOF: Intel: hda-codec: simplify SND_SOC_SOF_HDA_AUDIO_CODEC handling)
  
  #if IS_ENABLED(CONFIG_SND_HDA_GENERIC)
  #define is_generic_config(bus) \
@@@ -140,16 -134,11 +144,18 @@@ hda_codec_device_init(struct hdac_bus *
  }
  
  /* probe individual codec */
 -static int hda_codec_probe(struct snd_sof_dev *sdev, int address)
 +static int hda_codec_probe(struct snd_sof_dev *sdev, int address,
 +			   bool hda_codec_use_common_hdmi)
  {
- #if IS_ENABLED(CONFIG_SND_SOC_SOF_HDA_AUDIO_CODEC)
  	struct hdac_hda_priv *hda_priv;
 -	struct hda_bus *hbus = sof_to_hbus(sdev);
++<<<<<<< HEAD
  	struct hda_codec *codec;
 +	int type = HDA_DEV_LEGACY;
 +#endif
++=======
++>>>>>>> dc1d964a44dd (ASoC: SOF: Intel: hda-codec: simplify SND_SOC_SOF_HDA_AUDIO_CODEC handling)
 +	struct hda_bus *hbus = sof_to_hbus(sdev);
 +	struct hdac_device *hdev;
  	u32 hda_cmd = (address << 28) | (AC_NODE_ROOT << 20) |
  		(AC_VERB_PARAMETERS << 8) | AC_PAR_VENDOR_ID;
  	u32 resp = -1;
@@@ -172,15 -160,8 +177,20 @@@
  	if (!hda_priv)
  		return -ENOMEM;
  
++<<<<<<< HEAD
 +	hda_priv->codec.bus = hbus;
 +	hdev = &hda_priv->codec.core;
 +	codec = &hda_priv->codec;
 +
 +	/* only probe ASoC codec drivers for HDAC-HDMI */
 +	if (!hda_codec_use_common_hdmi && (resp & 0xFFFF0000) == IDISP_VID_INTEL)
 +		type = HDA_DEV_ASOC;
 +
 +	ret = snd_hdac_ext_bus_device_init(&hbus->core, address, hdev, type);
++=======
+ 	codec = hda_codec_device_init(&hbus->core, address, HDA_DEV_LEGACY);
+ 	ret = PTR_ERR_OR_ZERO(codec);
++>>>>>>> dc1d964a44dd (ASoC: SOF: Intel: hda-codec: simplify SND_SOC_SOF_HDA_AUDIO_CODEC handling)
  	if (ret < 0)
  		return ret;
  
@@@ -211,16 -193,9 +219,19 @@@
  
  out:
  	if (ret < 0) {
 -		snd_hdac_device_unregister(&codec->core);
 -		put_device(&codec->core.dev);
 +		snd_hdac_device_unregister(hdev);
 +		put_device(&hdev->dev);
  	}
++<<<<<<< HEAD
 +#else
 +	hdev = devm_kzalloc(sdev->dev, sizeof(*hdev), GFP_KERNEL);
 +	if (!hdev)
 +		return -ENOMEM;
 +
 +	ret = snd_hdac_ext_bus_device_init(&hbus->core, address, hdev, HDA_DEV_ASOC);
 +#endif
++=======
++>>>>>>> dc1d964a44dd (ASoC: SOF: Intel: hda-codec: simplify SND_SOC_SOF_HDA_AUDIO_CODEC handling)
  
  	return ret;
  }
@@@ -246,8 -220,10 +257,10 @@@ void hda_codec_probe_bus(struct snd_sof
  		}
  	}
  }
 -EXPORT_SYMBOL_NS(hda_codec_probe_bus, SND_SOC_SOF_HDA_AUDIO_CODEC);
 +EXPORT_SYMBOL(hda_codec_probe_bus);
  
+ #endif /* CONFIG_SND_SOC_SOF_HDA_AUDIO_CODEC */
+ 
  #if IS_ENABLED(CONFIG_SND_SOC_SOF_HDA_AUDIO_CODEC) && IS_ENABLED(CONFIG_SND_HDA_CODEC_HDMI)
  
  void hda_codec_i915_display_power(struct snd_sof_dev *sdev, bool enable)
* Unmerged path sound/soc/sof/intel/hda-codec.c
diff --git a/sound/soc/sof/intel/hda.h b/sound/soc/sof/intel/hda.h
index da2ef75dd520..a2bcf20d7031 100644
--- a/sound/soc/sof/intel/hda.h
+++ b/sound/soc/sof/intel/hda.h
@@ -710,7 +710,7 @@ void hda_dsp_ctrl_stop_chip(struct snd_sof_dev *sdev);
  */
 void sof_hda_bus_init(struct hdac_bus *bus, struct device *dev);
 
-#if IS_ENABLED(CONFIG_SND_SOC_SOF_HDA)
+#if IS_ENABLED(CONFIG_SND_SOC_SOF_HDA_AUDIO_CODEC)
 /*
  * HDA Codec operations.
  */
@@ -719,7 +719,13 @@ void hda_codec_probe_bus(struct snd_sof_dev *sdev,
 void hda_codec_jack_wake_enable(struct snd_sof_dev *sdev, bool enable);
 void hda_codec_jack_check(struct snd_sof_dev *sdev);
 
-#endif /* CONFIG_SND_SOC_SOF_HDA */
+#else
+
+static inline void hda_codec_probe_bus(struct snd_sof_dev *sdev) { }
+static inline void hda_codec_jack_wake_enable(struct snd_sof_dev *sdev, bool enable) { }
+static inline void hda_codec_jack_check(struct snd_sof_dev *sdev) { }
+
+#endif /* CONFIG_SND_SOC_SOF_HDA_AUDIO_CODEC */
 
 #if IS_ENABLED(CONFIG_SND_SOC_SOF_HDA_AUDIO_CODEC) && IS_ENABLED(CONFIG_SND_HDA_CODEC_HDMI)
 
