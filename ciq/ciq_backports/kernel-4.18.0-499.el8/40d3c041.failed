ASoC: SOF: amd: increase SRAM inbox and outbox size to 1024

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-499.el8
commit-author V sujith kumar Reddy <Vsujithkumar.Reddy@amd.com>
commit 40d3c041e2f871b3d2d78c8e360224f788ac17ab
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-499.el8/40d3c041.failed

Increase inbox and outbox mailbox size from 512 to 1024 to
support thirdparty DTS integration ipc tx/rx messages communication.
This is done through firmware window get info.

	Signed-off-by: V sujith kumar Reddy <Vsujithkumar.Reddy@amd.com>
	Reviewed-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
Link: https://lore.kernel.org/r/20220913144319.1055302-5-Vsujithkumar.Reddy@amd.com
	Signed-off-by: Mark Brown <broonie@kernel.org>
(cherry picked from commit 40d3c041e2f871b3d2d78c8e360224f788ac17ab)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/soc/sof/amd/acp-common.c
#	sound/soc/sof/amd/acp-ipc.c
#	sound/soc/sof/amd/acp-stream.c
#	sound/soc/sof/amd/acp.c
diff --cc sound/soc/sof/amd/acp-ipc.c
index 92f660afad80,dd030566e372..000000000000
--- a/sound/soc/sof/amd/acp-ipc.c
+++ b/sound/soc/sof/amd/acp-ipc.c
@@@ -61,10 -67,11 +64,15 @@@ static void acp_dsp_ipc_dsp_done(struc
  int acp_sof_ipc_send_msg(struct snd_sof_dev *sdev, struct snd_sof_ipc_msg *msg)
  {
  	struct acp_dev_data *adata = sdev->pdata->hw_pdata;
++<<<<<<< HEAD
 +	unsigned int offset = offsetof(struct scratch_ipc_conf, sof_in_box);
++=======
+ 	const struct sof_amd_acp_desc *desc = get_chip_info(sdev->pdata);
+ 	unsigned int offset = sdev->host_box.offset;
++>>>>>>> 40d3c041e2f8 (ASoC: SOF: amd: increase SRAM inbox and outbox size to 1024)
  	unsigned int count = ACP_HW_SEM_RETRY_COUNT;
  
 -	while (snd_sof_dsp_read(sdev, ACP_DSP_BAR, desc->hw_semaphore_offset)) {
 +	while (snd_sof_dsp_read(sdev, ACP_DSP_BAR, ACP_AXI2DAGB_SEM_0)) {
  		/* Wait until acquired HW Semaphore Lock or timeout*/
  		count--;
  		if (!count) {
@@@ -186,8 -201,16 +202,14 @@@ EXPORT_SYMBOL(acp_sof_ipc_msg_data)
  
  int acp_sof_ipc_get_mailbox_offset(struct snd_sof_dev *sdev)
  {
 -	const struct sof_amd_acp_desc *desc = get_chip_info(sdev->pdata);
 -
 -	return desc->sram_pte_offset;
 +	return ACP_SCRATCH_MEMORY_ADDRESS;
  }
 -EXPORT_SYMBOL_NS(acp_sof_ipc_get_mailbox_offset, SND_SOC_SOF_AMD_COMMON);
 +EXPORT_SYMBOL(acp_sof_ipc_get_mailbox_offset);
  
+ int acp_sof_ipc_get_window_offset(struct snd_sof_dev *sdev, u32 id)
+ {
+ 	return 0;
+ }
+ EXPORT_SYMBOL_NS(acp_sof_ipc_get_window_offset, SND_SOC_SOF_AMD_COMMON);
+ 
  MODULE_DESCRIPTION("AMD ACP sof-ipc driver");
diff --cc sound/soc/sof/amd/acp-stream.c
index 72eefdb8c3ed,6f40ef7ba85e..000000000000
--- a/sound/soc/sof/amd/acp-stream.c
+++ b/sound/soc/sof/amd/acp-stream.c
@@@ -96,7 -98,8 +97,12 @@@ int acp_dsp_stream_config(struct snd_so
  			  phy_addr_offset, stream->reg_offset);
  
  	/* Group Enable */
++<<<<<<< HEAD
 +	reg_val = ACP_SRAM_PTE_OFFSET + offset;
++=======
+ 	offset = offset + sdev->debug_box.offset;
+ 	reg_val = desc->sram_pte_offset + offset;
++>>>>>>> 40d3c041e2f8 (ASoC: SOF: amd: increase SRAM inbox and outbox size to 1024)
  	snd_sof_dsp_write(sdev, ACP_DSP_BAR, pte_reg, reg_val | BIT(31));
  	snd_sof_dsp_write(sdev, ACP_DSP_BAR, pte_size, PAGE_SIZE_4K_ENABLE);
  
diff --cc sound/soc/sof/amd/acp.c
index 02a7111a5733,36966643e36a..000000000000
--- a/sound/soc/sof/amd/acp.c
+++ b/sound/soc/sof/amd/acp.c
@@@ -39,9 -39,11 +39,14 @@@ static int smn_read(struct pci_dev *dev
  static void init_dma_descriptor(struct acp_dev_data *adata)
  {
  	struct snd_sof_dev *sdev = adata->dev;
 -	const struct sof_amd_acp_desc *desc = get_chip_info(sdev->pdata);
  	unsigned int addr;
  
++<<<<<<< HEAD
 +	addr = ACP_SRAM_PTE_OFFSET + offsetof(struct scratch_reg_conf, dma_desc);
++=======
+ 	addr = desc->sram_pte_offset + sdev->debug_box.offset +
+ 	       offsetof(struct scratch_reg_conf, dma_desc);
++>>>>>>> 40d3c041e2f8 (ASoC: SOF: amd: increase SRAM inbox and outbox size to 1024)
  
  	snd_sof_dsp_write(sdev, ACP_DSP_BAR, ACP_DMA_DESC_BASE_ADDR, addr);
  	snd_sof_dsp_write(sdev, ACP_DSP_BAR, ACP_DMA_DESC_MAX_NUM_DSCR, ACP_MAX_DESC_CNT);
* Unmerged path sound/soc/sof/amd/acp-common.c
* Unmerged path sound/soc/sof/amd/acp-common.c
* Unmerged path sound/soc/sof/amd/acp-ipc.c
diff --git a/sound/soc/sof/amd/acp-pcm.c b/sound/soc/sof/amd/acp-pcm.c
index 5392db39f701..26fe628433ab 100644
--- a/sound/soc/sof/amd/acp-pcm.c
+++ b/sound/soc/sof/amd/acp-pcm.c
@@ -42,7 +42,8 @@ int acp_pcm_hw_params(struct snd_sof_dev *sdev, struct snd_pcm_substream *substr
 
 	/* write buffer size of stream in scratch memory */
 
-	buf_offset = offsetof(struct scratch_reg_conf, buf_size);
+	buf_offset = sdev->debug_box.offset +
+		     offsetof(struct scratch_reg_conf, buf_size);
 	index = stream->stream_tag - 1;
 	buf_offset = buf_offset + index * 4;
 
* Unmerged path sound/soc/sof/amd/acp-stream.c
* Unmerged path sound/soc/sof/amd/acp.c
diff --git a/sound/soc/sof/amd/acp.h b/sound/soc/sof/amd/acp.h
index 4c42b8fd6abf..fa94d3861340 100644
--- a/sound/soc/sof/amd/acp.h
+++ b/sound/soc/sof/amd/acp.h
@@ -64,6 +64,9 @@
 #define MBOX_READY_MASK				0x80000000
 #define MBOX_STATUS_MASK			0xFFFF
 
+#define BOX_SIZE_512				0x200
+#define BOX_SIZE_1024				0x400
+
 struct  acp_atu_grp_pte {
 	u32 low;
 	u32 high;
@@ -88,10 +91,6 @@ struct dma_descriptor {
 
 /* Scratch memory structure for communication b/w host and dsp */
 struct  scratch_ipc_conf {
-	/* DSP mailbox */
-	u8 sof_out_box[512];
-	/* Host mailbox */
-	u8 sof_in_box[512];
 	/* Debug memory */
 	u8 sof_debug_box[1024];
 	/* Exception memory*/
