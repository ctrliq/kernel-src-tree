ASoC : SOF: amd: Add support for IPC and DSP dumps

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-499.el8
commit-author V sujith kumar Reddy <Vsujithkumar.Reddy@amd.com>
commit 41cfad23b5ebef2dbddecff2ddeb27ca973f98a8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-499.el8/41cfad23.failed

Add support for IPC and DSP dumps for AMD platforms.

	Signed-off-by: V sujith kumar Reddy <Vsujithkumar.Reddy@amd.com>
Link: https://lore.kernel.org/r/20221205120649.1950576-3-Vsujithkumar.Reddy@amd.com
	Signed-off-by: Mark Brown <broonie@kernel.org>
(cherry picked from commit 41cfad23b5ebef2dbddecff2ddeb27ca973f98a8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/soc/sof/amd/acp-common.c
#	sound/soc/sof/amd/acp-ipc.c
#	sound/soc/sof/amd/acp.h
diff --cc sound/soc/sof/amd/acp-ipc.c
index 92f660afad80,5a02753c4610..000000000000
--- a/sound/soc/sof/amd/acp-ipc.c
+++ b/sound/soc/sof/amd/acp-ipc.c
@@@ -141,11 -148,26 +141,27 @@@ out
  irqreturn_t acp_sof_ipc_irq_thread(int irq, void *context)
  {
  	struct snd_sof_dev *sdev = context;
 -	unsigned int dsp_msg_write = sdev->debug_box.offset +
 -				     offsetof(struct scratch_ipc_conf, sof_dsp_msg_write);
 -	unsigned int dsp_ack_write = sdev->debug_box.offset +
 -				     offsetof(struct scratch_ipc_conf, sof_dsp_ack_write);
 +	unsigned int dsp_msg_write = offsetof(struct scratch_ipc_conf, sof_dsp_msg_write);
 +	unsigned int dsp_ack_write = offsetof(struct scratch_ipc_conf, sof_dsp_ack_write);
  	bool ipc_irq = false;
  	int dsp_msg, dsp_ack;
+ 	unsigned int status;
+ 
++<<<<<<< HEAD
++=======
+ 	if (sdev->first_boot && sdev->fw_state != SOF_FW_BOOT_COMPLETE) {
+ 		acp_mailbox_read(sdev, sdev->dsp_box.offset, &status, sizeof(status));
+ 		if ((status & SOF_IPC_PANIC_MAGIC_MASK) == SOF_IPC_PANIC_MAGIC) {
+ 			snd_sof_dsp_panic(sdev, sdev->dsp_box.offset + sizeof(status),
+ 					  true);
+ 			return IRQ_HANDLED;
+ 		}
+ 		snd_sof_ipc_msgs_rx(sdev);
+ 		acp_dsp_ipc_host_done(sdev);
+ 		return IRQ_HANDLED;
+ 	}
  
++>>>>>>> 41cfad23b5eb (ASoC : SOF: amd: Add support for IPC and DSP dumps)
  	dsp_msg = snd_sof_dsp_read(sdev, ACP_DSP_BAR, ACP_SCRATCH_REG_0 + dsp_msg_write);
  	if (dsp_msg) {
  		snd_sof_ipc_msgs_rx(sdev);
diff --cc sound/soc/sof/amd/acp.h
index 4c42b8fd6abf,09e16ef8afa0..000000000000
--- a/sound/soc/sof/amd/acp.h
+++ b/sound/soc/sof/amd/acp.h
@@@ -64,6 -66,20 +64,23 @@@
  #define MBOX_READY_MASK				0x80000000
  #define MBOX_STATUS_MASK			0xFFFF
  
++<<<<<<< HEAD
++=======
+ #define BOX_SIZE_512				0x200
+ #define BOX_SIZE_1024				0x400
+ 
+ #define EXCEPT_MAX_HDR_SIZE			0x400
+ #define AMD_STACK_DUMP_SIZE			32
+ 
+ enum clock_source {
+ 	ACP_CLOCK_96M = 0,
+ 	ACP_CLOCK_48M,
+ 	ACP_CLOCK_24M,
+ 	ACP_CLOCK_ACLK,
+ 	ACP_CLOCK_MCLK,
+ };
+ 
++>>>>>>> 41cfad23b5eb (ASoC : SOF: amd: Add support for IPC and DSP dumps)
  struct  acp_atu_grp_pte {
  	u32 low;
  	u32 high;
@@@ -220,9 -257,8 +237,14 @@@ int acp_sof_trace_release(struct snd_so
  int amd_sof_acp_suspend(struct snd_sof_dev *sdev, u32 target_state);
  int amd_sof_acp_resume(struct snd_sof_dev *sdev);
  
++<<<<<<< HEAD
 +struct sof_amd_acp_desc {
 +	unsigned int host_bridge_id;
 +};
++=======
+ void amd_sof_ipc_dump(struct snd_sof_dev *sdev);
+ void amd_sof_dump(struct snd_sof_dev *sdev, u32 flags);
++>>>>>>> 41cfad23b5eb (ASoC : SOF: amd: Add support for IPC and DSP dumps)
  
  static inline const struct sof_amd_acp_desc *get_chip_info(struct snd_sof_pdata *pdata)
  {
* Unmerged path sound/soc/sof/amd/acp-common.c
diff --git a/sound/soc/sof/amd/Kconfig b/sound/soc/sof/amd/Kconfig
index 190c85d57047..1757fc5e65ac 100644
--- a/sound/soc/sof/amd/Kconfig
+++ b/sound/soc/sof/amd/Kconfig
@@ -20,6 +20,7 @@ config SND_SOC_SOF_AMD_COMMON
 	select SND_SOC_SOF_IPC3
 	select SND_SOC_SOF_PCI_DEV
 	select SND_AMD_ACP_CONFIG
+	select SND_SOC_SOF_XTENSA
 	select SND_SOC_ACPI if ACPI
 	help
 	  This option is not user-selectable but automatically handled by
* Unmerged path sound/soc/sof/amd/acp-common.c
* Unmerged path sound/soc/sof/amd/acp-ipc.c
* Unmerged path sound/soc/sof/amd/acp.h
