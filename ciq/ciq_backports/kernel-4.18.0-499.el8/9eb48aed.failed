ASoC: SOF: amd: remove acp_dai_probe() function

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-499.el8
commit-author Vijendar Mukunda <Vijendar.Mukunda@amd.com>
commit 9eb48aeddd8dcf2defd94a837a65e052576cf42b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-499.el8/9eb48aed.failed

ACP SOF driver supports different audio configurations.
Explicit condition check for I2S configuration will break
other audio endpoint configurations.

acp_dai_probe() function is not required as we have
machine select logic to select the exact machine.

Remove acp_dai_probe() from existing AMD PCI driver code base.

	Signed-off-by: Vijendar Mukunda <Vijendar.Mukunda@amd.com>
Link: https://lore.kernel.org/r/20230403071651.919027-2-Vijendar.Mukunda@amd.com
	Signed-off-by: Mark Brown <broonie@kernel.org>
(cherry picked from commit 9eb48aeddd8dcf2defd94a837a65e052576cf42b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/soc/sof/amd/acp-common.c
#	sound/soc/sof/amd/acp.h
#	sound/soc/sof/amd/rembrandt.c
#	sound/soc/sof/amd/renoir.c
diff --cc sound/soc/sof/amd/acp.h
index 4c42b8fd6abf,d7fc24917b3c..000000000000
--- a/sound/soc/sof/amd/acp.h
+++ b/sound/soc/sof/amd/acp.h
@@@ -205,9 -238,17 +205,13 @@@ int acp_pcm_close(struct snd_sof_dev *s
  int acp_pcm_hw_params(struct snd_sof_dev *sdev, struct snd_pcm_substream *substream,
  		      struct snd_pcm_hw_params *params,
  		      struct snd_sof_platform_stream_params *platform_params);
 -snd_pcm_uframes_t acp_pcm_pointer(struct snd_sof_dev *sdev,
 -				  struct snd_pcm_substream *substream);
 -
 -extern struct snd_sof_dsp_ops sof_acp_common_ops;
  
  extern struct snd_sof_dsp_ops sof_renoir_ops;
 -int sof_renoir_ops_init(struct snd_sof_dev *sdev);
 -extern struct snd_sof_dsp_ops sof_rembrandt_ops;
 -int sof_rembrandt_ops_init(struct snd_sof_dev *sdev);
  
++<<<<<<< HEAD
++=======
+ struct snd_soc_acpi_mach *amd_sof_machine_select(struct snd_sof_dev *sdev);
++>>>>>>> 9eb48aeddd8d (ASoC: SOF: amd: remove acp_dai_probe() function)
  /* Machine configuration */
  int snd_amd_acp_find_config(struct pci_dev *pci);
  
diff --cc sound/soc/sof/amd/renoir.c
index acd702d0cfca,47b863f6258c..000000000000
--- a/sound/soc/sof/amd/renoir.c
+++ b/sound/soc/sof/amd/renoir.c
@@@ -62,7 -47,6 +62,10 @@@ static struct snd_soc_dai_driver renoir
  			.rate_min = 8000,
  			.rate_max = 48000,
  		},
++<<<<<<< HEAD
 +		.probe = &renoir_dai_probe,
++=======
++>>>>>>> 9eb48aeddd8d (ASoC: SOF: amd: remove acp_dai_probe() function)
  	},
  
  	[I2S_SP_INSTANCE] = {
@@@ -87,7 -71,6 +90,10 @@@
  			.rate_min = 8000,
  			.rate_max = 48000,
  		},
++<<<<<<< HEAD
 +		.probe = &renoir_dai_probe,
++=======
++>>>>>>> 9eb48aeddd8d (ASoC: SOF: amd: remove acp_dai_probe() function)
  	},
  
  	[PDM_DMIC_INSTANCE] = {
@@@ -102,83 -85,37 +108,100 @@@
  			.rate_max = 48000,
  		},
  	},
++<<<<<<< HEAD
++=======
+ 
+ 	[I2S_SP_VIRTUAL_INSTANCE] = {
+ 		.id = I2S_SP_VIRTUAL_INSTANCE,
+ 		.name = "acp-sof-sp-virtual",
+ 		.playback = {
+ 			.rates = SNDRV_PCM_RATE_8000_96000,
+ 			.formats = SNDRV_PCM_FMTBIT_S16_LE | SNDRV_PCM_FMTBIT_S8 |
+ 				   SNDRV_PCM_FMTBIT_U8 | SNDRV_PCM_FMTBIT_S32_LE,
+ 			.channels_min = 2,
+ 			.channels_max = 8,
+ 			.rate_min = 8000,
+ 			.rate_max = 96000,
+ 		},
+ 	},
++>>>>>>> 9eb48aeddd8d (ASoC: SOF: amd: remove acp_dai_probe() function)
  };
  
 -/* Renoir ops */
 -struct snd_sof_dsp_ops sof_renoir_ops;
 -EXPORT_SYMBOL_NS(sof_renoir_ops, SND_SOC_SOF_AMD_COMMON);
 -
 -int sof_renoir_ops_init(struct snd_sof_dev *sdev)
 +static struct snd_soc_acpi_mach *amd_sof_machine_select(struct snd_sof_dev *sdev)
  {
 -	/* common defaults */
 -	memcpy(&sof_renoir_ops, &sof_acp_common_ops, sizeof(struct snd_sof_dsp_ops));
 +	struct snd_sof_pdata *sof_pdata = sdev->pdata;
 +	const struct sof_dev_desc *desc = sof_pdata->desc;
 +	struct snd_soc_acpi_mach *mach;
  
 -	sof_renoir_ops.drv = renoir_sof_dai;
 -	sof_renoir_ops.num_drv = ARRAY_SIZE(renoir_sof_dai);
 +	mach = snd_soc_acpi_find_machine(desc->machines);
 +	if (!mach) {
 +		dev_warn(sdev->dev, "No matching ASoC machine driver found\n");
 +		return NULL;
 +	}
  
 -	return 0;
 +	sof_pdata->tplg_filename = mach->sof_tplg_filename;
 +	sof_pdata->fw_filename = mach->fw_filename;
 +
 +	return mach;
  }
  
 -MODULE_IMPORT_NS(SND_SOC_SOF_AMD_COMMON);
 +/* AMD Renoir DSP ops */
 +struct snd_sof_dsp_ops sof_renoir_ops = {
 +	/* probe and remove */
 +	.probe			= amd_sof_acp_probe,
 +	.remove			= amd_sof_acp_remove,
 +
 +	/* Register IO */
 +	.write			= sof_io_write,
 +	.read			= sof_io_read,
 +
 +	/* Block IO */
 +	.block_read		= acp_dsp_block_read,
 +	.block_write		= acp_dsp_block_write,
 +
 +	/*Firmware loading */
 +	.load_firmware		= snd_sof_load_firmware_memcpy,
 +	.pre_fw_run		= acp_dsp_pre_fw_run,
 +	.get_bar_index		= acp_get_bar_index,
 +
 +	/* DSP core boot */
 +	.run			= acp_sof_dsp_run,
 +
 +	/*IPC */
 +	.send_msg		= acp_sof_ipc_send_msg,
 +	.ipc_msg_data		= acp_sof_ipc_msg_data,
 +	.get_mailbox_offset	= acp_sof_ipc_get_mailbox_offset,
 +	.irq_thread		= acp_sof_ipc_irq_thread,
 +
 +	/* DAI drivers */
 +	.drv			= renoir_sof_dai,
 +	.num_drv		= ARRAY_SIZE(renoir_sof_dai),
 +
 +	/* stream callbacks */
 +	.pcm_open		= acp_pcm_open,
 +	.pcm_close		= acp_pcm_close,
 +	.pcm_hw_params		= acp_pcm_hw_params,
 +
 +	.hw_info		= SNDRV_PCM_INFO_MMAP |
 +				  SNDRV_PCM_INFO_MMAP_VALID |
 +				  SNDRV_PCM_INFO_INTERLEAVED |
 +				  SNDRV_PCM_INFO_PAUSE |
 +				  SNDRV_PCM_INFO_NO_PERIOD_WAKEUP,
 +
 +	/* Machine driver callbacks */
 +	.machine_select		= amd_sof_machine_select,
 +	.machine_register	= sof_machine_register,
 +	.machine_unregister	= sof_machine_unregister,
 +
 +	/* Trace Logger */
 +	.trace_init		= acp_sof_trace_init,
 +	.trace_release		= acp_sof_trace_release,
 +
 +	/* PM */
 +	.suspend                = amd_sof_acp_suspend,
 +	.resume                 = amd_sof_acp_resume,
 +};
 +EXPORT_SYMBOL(sof_renoir_ops);
 +
  MODULE_DESCRIPTION("RENOIR SOF Driver");
  MODULE_LICENSE("Dual BSD/GPL");
* Unmerged path sound/soc/sof/amd/acp-common.c
* Unmerged path sound/soc/sof/amd/rembrandt.c
* Unmerged path sound/soc/sof/amd/acp-common.c
* Unmerged path sound/soc/sof/amd/acp.h
* Unmerged path sound/soc/sof/amd/rembrandt.c
* Unmerged path sound/soc/sof/amd/renoir.c
