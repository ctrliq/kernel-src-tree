KVM: SVM: Do not virtualize MSR accesses for APIC LVTT register

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-499.el8
commit-author Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
commit 0a8735a6acf36ac35499563dc44f3e3d5034a2ce
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-499.el8/0a8735a6.failed

AMD does not support APIC TSC-deadline timer mode. AVIC hardware
will generate GP fault when guest kernel writes 1 to bits [18]
of the APIC LVTT register (offset 0x32) to set the timer mode.
(Note: bit 18 is reserved on AMD system).

Therefore, always intercept and let KVM emulate the MSR accesses.

Fixes: f3d7c8aa6882 ("KVM: SVM: Fix x2APIC MSRs interception")
	Signed-off-by: Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
Message-Id: <20220725033428.3699-1-suravee.suthikulpanit@amd.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 0a8735a6acf36ac35499563dc44f3e3d5034a2ce)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/svm/svm.c
diff --cc arch/x86/kvm/svm/svm.c
index 511235200d8c,3e0639a68385..000000000000
--- a/arch/x86/kvm/svm/svm.c
+++ b/arch/x86/kvm/svm/svm.c
@@@ -100,6 -101,39 +100,42 @@@ static const struct svm_direct_access_m
  	{ .index = MSR_EFER,				.always = false },
  	{ .index = MSR_IA32_CR_PAT,			.always = false },
  	{ .index = MSR_AMD64_SEV_ES_GHCB,		.always = true  },
++<<<<<<< HEAD
++=======
+ 	{ .index = MSR_TSC_AUX,				.always = false },
+ 	{ .index = X2APIC_MSR(APIC_ID),			.always = false },
+ 	{ .index = X2APIC_MSR(APIC_LVR),		.always = false },
+ 	{ .index = X2APIC_MSR(APIC_TASKPRI),		.always = false },
+ 	{ .index = X2APIC_MSR(APIC_ARBPRI),		.always = false },
+ 	{ .index = X2APIC_MSR(APIC_PROCPRI),		.always = false },
+ 	{ .index = X2APIC_MSR(APIC_EOI),		.always = false },
+ 	{ .index = X2APIC_MSR(APIC_RRR),		.always = false },
+ 	{ .index = X2APIC_MSR(APIC_LDR),		.always = false },
+ 	{ .index = X2APIC_MSR(APIC_DFR),		.always = false },
+ 	{ .index = X2APIC_MSR(APIC_SPIV),		.always = false },
+ 	{ .index = X2APIC_MSR(APIC_ISR),		.always = false },
+ 	{ .index = X2APIC_MSR(APIC_TMR),		.always = false },
+ 	{ .index = X2APIC_MSR(APIC_IRR),		.always = false },
+ 	{ .index = X2APIC_MSR(APIC_ESR),		.always = false },
+ 	{ .index = X2APIC_MSR(APIC_ICR),		.always = false },
+ 	{ .index = X2APIC_MSR(APIC_ICR2),		.always = false },
+ 
+ 	/*
+ 	 * Note:
+ 	 * AMD does not virtualize APIC TSC-deadline timer mode, but it is
+ 	 * emulated by KVM. When setting APIC LVTT (0x832) register bit 18,
+ 	 * the AVIC hardware would generate GP fault. Therefore, always
+ 	 * intercept the MSR 0x832, and do not setup direct_access_msr.
+ 	 */
+ 	{ .index = X2APIC_MSR(APIC_LVTTHMR),		.always = false },
+ 	{ .index = X2APIC_MSR(APIC_LVTPC),		.always = false },
+ 	{ .index = X2APIC_MSR(APIC_LVT0),		.always = false },
+ 	{ .index = X2APIC_MSR(APIC_LVT1),		.always = false },
+ 	{ .index = X2APIC_MSR(APIC_LVTERR),		.always = false },
+ 	{ .index = X2APIC_MSR(APIC_TMICT),		.always = false },
+ 	{ .index = X2APIC_MSR(APIC_TMCCT),		.always = false },
+ 	{ .index = X2APIC_MSR(APIC_TDCR),		.always = false },
++>>>>>>> 0a8735a6acf3 (KVM: SVM: Do not virtualize MSR accesses for APIC LVTT register)
  	{ .index = MSR_INVALID,				.always = false },
  };
  
* Unmerged path arch/x86/kvm/svm/svm.c
