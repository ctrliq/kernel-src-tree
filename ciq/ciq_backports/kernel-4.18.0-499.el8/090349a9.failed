ASoC: SOF: Add support for compress API for stream data/offset

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-499.el8
commit-author Daniel Baluta <daniel.baluta@nxp.com>
commit 090349a9feba3ceee3997d31d68ffe54e5b57acb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-499.el8/090349a9.failed

snd_sof_pcm_stream keeps information about both PCM (snd_pcm_substream)
and Compress (snd_compr_stream) streams.

When PCM substream pointer is NULL this means we are dealing with a
compress stream.

	Reviewed-by: Paul Olaru <paul.olaru@nxp.com>
	Reviewed-by: Iuliana Prodan <iuliana.prodan@nxp.com>
	Reviewed-by: Ranjani Sridharan <ranjani.sridharan@linux.intel.com>
	Reviewed-by: Peter Ujfalusi <peter.ujfalusi@linux.intel.com>
	Signed-off-by: Daniel Baluta <daniel.baluta@nxp.com>
Link: https://lore.kernel.org/r/20230117122533.201708-4-daniel.baluta@oss.nxp.com
	Signed-off-by: Mark Brown <broonie@kernel.org>
(cherry picked from commit 090349a9feba3ceee3997d31d68ffe54e5b57acb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/soc/sof/stream-ipc.c
diff --cc sound/soc/sof/stream-ipc.c
index 5f1ceeea893a,216b454f6b94..000000000000
--- a/sound/soc/sof/stream-ipc.c
+++ b/sound/soc/sof/stream-ipc.c
@@@ -26,19 -27,33 +26,37 @@@ struct sof_stream 
  
  /* Mailbox-based Generic IPC implementation */
  int sof_ipc_msg_data(struct snd_sof_dev *sdev,
 -		     struct snd_sof_pcm_stream *sps,
 +		     struct snd_pcm_substream *substream,
  		     void *p, size_t sz)
  {
 -	if (!sps || !sdev->stream_box.size) {
 +	if (!substream || !sdev->stream_box.size) {
  		snd_sof_dsp_mailbox_read(sdev, sdev->dsp_box.offset, p, sz);
  	} else {
++<<<<<<< HEAD
 +		struct sof_stream *stream = substream->runtime->private_data;
++=======
+ 		size_t posn_offset;
++>>>>>>> 090349a9feba (ASoC: SOF: Add support for compress API for stream data/offset)
  
- 		/* The stream might already be closed */
- 		if (!stream)
- 			return -ESTRPIPE;
+ 		if (sps->substream) {
+ 			struct sof_stream *stream = sps->substream->runtime->private_data;
  
- 		snd_sof_dsp_mailbox_read(sdev, stream->posn_offset, p, sz);
+ 			/* The stream might already be closed */
+ 			if (!stream)
+ 				return -ESTRPIPE;
+ 
+ 			posn_offset = stream->posn_offset;
+ 		} else {
+ 
+ 			struct sof_compr_stream *sstream = sps->cstream->runtime->private_data;
+ 
+ 			if (!sstream)
+ 				return -ESTRPIPE;
+ 
+ 			posn_offset = sstream->posn_offset;
+ 		}
+ 
+ 		snd_sof_dsp_mailbox_read(sdev, posn_offset, p, sz);
  	}
  
  	return 0;
@@@ -46,11 -61,9 +64,14 @@@
  EXPORT_SYMBOL(sof_ipc_msg_data);
  
  int sof_set_stream_data_offset(struct snd_sof_dev *sdev,
 -			       struct snd_sof_pcm_stream *sps,
 +			       struct snd_pcm_substream *substream,
  			       size_t posn_offset)
  {
++<<<<<<< HEAD
 +	struct sof_stream *stream = substream->runtime->private_data;
 +
++=======
++>>>>>>> 090349a9feba (ASoC: SOF: Add support for compress API for stream data/offset)
  	/* check if offset is overflow or it is not aligned */
  	if (posn_offset > sdev->stream_box.size ||
  	    posn_offset % sizeof(struct sof_ipc_stream_posn) != 0)
diff --git a/sound/soc/sof/sof-priv.h b/sound/soc/sof/sof-priv.h
index 59d12da58646..2f9df77d1945 100644
--- a/sound/soc/sof/sof-priv.h
+++ b/sound/soc/sof/sof-priv.h
@@ -110,6 +110,7 @@ struct sof_compr_stream {
 	u32 sampling_rate;
 	u16 channels;
 	u16 sample_container_bytes;
+	size_t posn_offset;
 };
 
 struct snd_sof_dev;
* Unmerged path sound/soc/sof/stream-ipc.c
