net/mlx5: Reduce kconfig complexity while building crypto support

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-477.10.1.el8_8
commit-author Leon Romanovsky <leonro@nvidia.com>
commit f03c7b183ef93032582131cd25940245fbee433a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-477.10.1.el8_8/f03c7b18.failed

Both IPsec and kTLS need two functions declared in the lib/crypto.c
file. These functions are advertised through general mlx5.h file and
don't have any protection from attempts to call them without proper
config option.

Instead of creating stubs just for two functions, simply build that *.c
file as part of regular mlx5_eth build and rely on compiler to throw
them away if no callers exist in produced code.

Link: https://lore.kernel.org/r/37f02171da06886c1b403d44dd18b2a56b19219d.1649232994.git.leonro@nvidia.com
	Reviewed-by: Raed Salem <raeds@nvidia.com>
	Signed-off-by: Leon Romanovsky <leonro@nvidia.com>
(cherry picked from commit f03c7b183ef93032582131cd25940245fbee433a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/Kconfig
#	drivers/net/ethernet/mellanox/mlx5/core/Makefile
diff --cc drivers/net/ethernet/mellanox/mlx5/core/Kconfig
index ebe13db50593,bfc0cd5ec423..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/Kconfig
+++ b/drivers/net/ethernet/mellanox/mlx5/core/Kconfig
@@@ -158,55 -144,16 +155,57 @@@ config MLX5_IPSE
  	depends on MLX5_CORE_EN
  	depends on XFRM_OFFLOAD
  	depends on INET_ESP_OFFLOAD || INET6_ESP_OFFLOAD
- 	select MLX5_ACCEL
 +	help
 +	Build IPsec support for the Connect-X family of network cards by Mellanox
 +	Technologies.
 +	Note: If you select this option, the mlx5_core driver will include
 +	IPsec support for the Connect-X family.
 +
 +config MLX5_EN_IPSEC
 +	bool "IPSec XFRM cryptography-offload acceleration"
 +	depends on MLX5_CORE_EN
 +	depends on XFRM_OFFLOAD
 +	depends on INET_ESP_OFFLOAD || INET6_ESP_OFFLOAD
 +	depends on MLX5_FPGA_IPSEC || MLX5_IPSEC
  	help
  	  Build support for IPsec cryptography-offload acceleration in the NIC.
 +	  Note: Support for hardware with this capability needs to be selected
 +	  for this option to become available.
  
 -config MLX5_EN_TLS
 +config MLX5_FPGA_TLS
 +	bool "Mellanox Technologies TLS Innova support"
 +	depends on TLS_DEVICE
 +	depends on TLS=y || MLX5_CORE=m
 +	depends on MLX5_CORE_EN
 +	depends on MLX5_FPGA
 +	select MLX5_EN_TLS
 +	help
 +	Build TLS support for the Innova family of network cards by Mellanox
 +	Technologies. Innova network cards are comprised of a ConnectX chip
 +	and an FPGA chip on one board. If you select this option, the
 +	mlx5_core driver will include the Innova FPGA core and allow building
 +	sandbox-specific client drivers.
 +
 +config MLX5_TLS
  	bool "Mellanox Technologies TLS Connect-X support"
  	depends on TLS_DEVICE
  	depends on TLS=y || MLX5_CORE=m
  	depends on MLX5_CORE_EN
++<<<<<<< HEAD
 +	select MLX5_ACCEL
 +	select MLX5_EN_TLS
 +	help
 +	Build TLS support for the Connect-X family of network cards by Mellanox
 +	Technologies.
 +
 +config MLX5_EN_TLS
 +	bool
++=======
++>>>>>>> f03c7b183ef9 (net/mlx5: Reduce kconfig complexity while building crypto support)
  	help
  	Build support for TLS cryptography-offload acceleration in the NIC.
 +	Note: Support for hardware with this capability needs to be selected
 +	for this option to become available.
  
  config MLX5_SW_STEERING
  	bool "Mellanox Technologies software-managed steering"
diff --cc drivers/net/ethernet/mellanox/mlx5/core/Makefile
index 4bc666714a35,81620c25c77e..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/Makefile
+++ b/drivers/net/ethernet/mellanox/mlx5/core/Makefile
@@@ -88,11 -88,6 +88,14 @@@ mlx5_core-$(CONFIG_MLX5_CORE_IPOIB) += 
  #
  # Accelerations & FPGA
  #
++<<<<<<< HEAD
 +mlx5_core-$(CONFIG_MLX5_IPSEC) += accel/ipsec_offload.o
 +mlx5_core-$(CONFIG_MLX5_FPGA_IPSEC) += fpga/ipsec.o
 +mlx5_core-$(CONFIG_MLX5_FPGA_TLS)   += fpga/tls.o
 +mlx5_core-$(CONFIG_MLX5_ACCEL)      += lib/crypto.o accel/tls.o accel/ipsec.o
 +
++=======
++>>>>>>> f03c7b183ef9 (net/mlx5: Reduce kconfig complexity while building crypto support)
  mlx5_core-$(CONFIG_MLX5_FPGA) += fpga/cmd.o fpga/core.o fpga/conn.o fpga/sdk.o
  
  mlx5_core-$(CONFIG_MLX5_EN_IPSEC) += en_accel/ipsec.o en_accel/ipsec_rxtx.o \
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/Kconfig
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/Makefile
