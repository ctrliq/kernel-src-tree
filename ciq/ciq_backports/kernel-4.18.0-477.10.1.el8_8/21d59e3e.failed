perf/x86/amd/core: Detect PerfMonV2 support

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-477.10.1.el8_8
commit-author Sandipan Das <sandipan.das@amd.com>
commit 21d59e3e2c403c83ba196a5857d517054124168e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-477.10.1.el8_8/21d59e3e.failed

AMD Performance Monitoring Version 2 (PerfMonV2) introduces
some new Core PMU features such as detection of the number
of available PMCs and managing PMCs using global registers
namely, PerfCntrGlobalCtl and PerfCntrGlobalStatus.

Clearing PerfCntrGlobalCtl and PerfCntrGlobalStatus ensures
that all PMCs are inactive and have no pending overflows
when CPUs are onlined or offlined.

The PMU version (x86_pmu.version) now indicates PerfMonV2
support and will be used to bypass the new features on
unsupported processors.

	Signed-off-by: Sandipan Das <sandipan.das@amd.com>
	Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
Link: https://lkml.kernel.org/r/dc8672ecbddff394e088ca8abf94b089b8ecc2e7.1650515382.git.sandipan.das@amd.com
(cherry picked from commit 21d59e3e2c403c83ba196a5857d517054124168e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/events/amd/core.c
diff --cc arch/x86/events/amd/core.c
index fc84e3f05348,b70dfa028ba5..000000000000
--- a/arch/x86/events/amd/core.c
+++ b/arch/x86/events/amd/core.c
@@@ -554,6 -638,9 +569,12 @@@ static void amd_pmu_cpu_starting(int cp
  
  	cpuc->amd_nb->nb_id = nb_id;
  	cpuc->amd_nb->refcnt++;
++<<<<<<< HEAD
++=======
+ 
+ 	amd_brs_reset();
+ 	amd_pmu_cpu_reset(cpu);
++>>>>>>> 21d59e3e2c40 (perf/x86/amd/core: Detect PerfMonV2 support)
  }
  
  static void amd_pmu_cpu_dead(int cpu)
* Unmerged path arch/x86/events/amd/core.c
