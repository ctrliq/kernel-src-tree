mm: writeback: ratelimit stat flush from mem_cgroup_wb_stats

jira LE-4623
Rebuild_History Non-Buildable kernel-4.18.0-553.81.1.el8_10
commit-author Shakeel Butt <shakeelb@google.com>
commit d9b3ce8769e371554a669f262bbc61c02a40efcc
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.81.1.el8_10/d9b3ce87.failed

One of our workloads (Postgres 14) has regressed when migrated from 5.10
to 6.1 upstream kernel.  The regression can be reproduced by sysbench's
oltp_write_only benchmark.  It seems like the always on rstat flush in
mem_cgroup_wb_stats() is causing the regression.  So, rate limit that
specific rstat flush.  One potential consequence would be the dirty
throttling might be decided on stale memcg stats.  However from our
benchmarks and production traffic we have not observed any change in the
dirty throttling behavior of the application.

Link: https://lkml.kernel.org/r/20240118184235.618164-1-shakeelb@google.com
Fixes: 2d146aa3aa84 ("mm: memcontrol: switch to rstat")
	Signed-off-by: Shakeel Butt <shakeelb@google.com>
	Acked-by: Johannes Weiner <hannes@cmpxchg.org>
	Acked-by: Roman Gushchin <roman.gushchin@linux.dev>
	Cc: Jan Kara <jack@suse.cz>
	Cc: Jens Axboe <axboe@kernel.dk>
	Cc: Michal Hocko <mhocko@kernel.org>
	Cc: Muchun Song <muchun.song@linux.dev>
	Cc: Tejun Heo <tj@kernel.org>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
(cherry picked from commit d9b3ce8769e371554a669f262bbc61c02a40efcc)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	mm/memcontrol.c
diff --cc mm/memcontrol.c
index e60a67b83e0e,df11d6d19ee3..000000000000
--- a/mm/memcontrol.c
+++ b/mm/memcontrol.c
@@@ -4677,7 -4800,7 +4677,11 @@@ void mem_cgroup_wb_stats(struct bdi_wri
  	struct mem_cgroup *memcg = mem_cgroup_from_css(wb->memcg_css);
  	struct mem_cgroup *parent;
  
++<<<<<<< HEAD
 +	mem_cgroup_flush_stats();
++=======
+ 	mem_cgroup_flush_stats_ratelimited(memcg);
++>>>>>>> d9b3ce8769e3 (mm: writeback: ratelimit stat flush from mem_cgroup_wb_stats)
  
  	*pdirty = memcg_page_state(memcg, NR_FILE_DIRTY);
  	*pwriteback = memcg_page_state(memcg, NR_WRITEBACK);
* Unmerged path mm/memcontrol.c
