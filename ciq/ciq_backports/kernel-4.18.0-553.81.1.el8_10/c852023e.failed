huge tmpfs: move shmem_huge_enabled() upwards

jira LE-4623
Rebuild_History Non-Buildable kernel-4.18.0-553.81.1.el8_10
commit-author Hugh Dickins <hughd@google.com>
commit c852023e6fd4fa5f75175729e0b55abb062ca799
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.81.1.el8_10/c852023e.failed

shmem_huge_enabled() is about to be enhanced into shmem_is_huge(), so that
it can be used more widely throughout: before making functional changes,
shift it to its final position (to avoid forward declaration).

Link: https://lkml.kernel.org/r/16fec7b7-5c84-415a-8586-69d8bf6a6685@google.com
	Signed-off-by: Hugh Dickins <hughd@google.com>
	Reviewed-by: Yang Shi <shy828301@gmail.com>
	Cc: "Kirill A. Shutemov" <kirill.shutemov@linux.intel.com>
	Cc: Matthew Wilcox <willy@infradead.org>
	Cc: Miaohe Lin <linmiaohe@huawei.com>
	Cc: Michal Hocko <mhocko@suse.com>
	Cc: Mike Kravetz <mike.kravetz@oracle.com>
	Cc: Rik van Riel <riel@surriel.com>
	Cc: Shakeel Butt <shakeelb@google.com>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit c852023e6fd4fa5f75175729e0b55abb062ca799)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	mm/shmem.c
diff --cc mm/shmem.c
index 0d2e39bd82a0,2df6a5370cd7..000000000000
--- a/mm/shmem.c
+++ b/mm/shmem.c
@@@ -415,7 -473,42 +415,46 @@@ static bool shmem_confirm_swap(struct a
  
  static int shmem_huge __read_mostly;
  
++<<<<<<< HEAD
 +#if defined(CONFIG_SYSFS) || defined(CONFIG_TMPFS)
++=======
+ bool shmem_huge_enabled(struct vm_area_struct *vma)
+ {
+ 	struct inode *inode = file_inode(vma->vm_file);
+ 	struct shmem_sb_info *sbinfo = SHMEM_SB(inode->i_sb);
+ 	loff_t i_size;
+ 	pgoff_t off;
+ 
+ 	if ((vma->vm_flags & VM_NOHUGEPAGE) ||
+ 	    test_bit(MMF_DISABLE_THP, &vma->vm_mm->flags))
+ 		return false;
+ 	if (shmem_huge == SHMEM_HUGE_FORCE)
+ 		return true;
+ 	if (shmem_huge == SHMEM_HUGE_DENY)
+ 		return false;
+ 	switch (sbinfo->huge) {
+ 	case SHMEM_HUGE_NEVER:
+ 		return false;
+ 	case SHMEM_HUGE_ALWAYS:
+ 		return true;
+ 	case SHMEM_HUGE_WITHIN_SIZE:
+ 		off = round_up(vma->vm_pgoff, HPAGE_PMD_NR);
+ 		i_size = round_up(i_size_read(inode), PAGE_SIZE);
+ 		if (i_size >= HPAGE_PMD_SIZE &&
+ 				i_size >> PAGE_SHIFT >= off)
+ 			return true;
+ 		fallthrough;
+ 	case SHMEM_HUGE_ADVISE:
+ 		/* TODO: implement fadvise() hints */
+ 		return (vma->vm_flags & VM_HUGEPAGE);
+ 	default:
+ 		VM_BUG_ON(1);
+ 		return false;
+ 	}
+ }
+ 
+ #if defined(CONFIG_SYSFS)
++>>>>>>> c852023e6fd4 (huge tmpfs: move shmem_huge_enabled() upwards)
  static int shmem_parse_huge(const char *str)
  {
  	if (!strcmp(str, "never"))
@@@ -4007,43 -4014,6 +4046,46 @@@ struct kobj_attribute shmem_enabled_att
  	__ATTR(shmem_enabled, 0644, shmem_enabled_show, shmem_enabled_store);
  #endif /* CONFIG_TRANSPARENT_HUGEPAGE && CONFIG_SYSFS */
  
++<<<<<<< HEAD
 +#ifdef CONFIG_TRANSPARENT_HUGEPAGE
 +bool shmem_huge_enabled(struct vm_area_struct *vma)
 +{
 +	struct inode *inode = file_inode(vma->vm_file);
 +	struct shmem_sb_info *sbinfo = SHMEM_SB(inode->i_sb);
 +	loff_t i_size;
 +	pgoff_t off;
 +
 +	if ((vma->vm_flags & VM_NOHUGEPAGE) ||
 +	    test_bit(MMF_DISABLE_THP, &vma->vm_mm->flags))
 +		return false;
 +	if (shmem_huge == SHMEM_HUGE_FORCE)
 +		return true;
 +	if (shmem_huge == SHMEM_HUGE_DENY)
 +		return false;
 +	switch (sbinfo->huge) {
 +		case SHMEM_HUGE_NEVER:
 +			return false;
 +		case SHMEM_HUGE_ALWAYS:
 +			return true;
 +		case SHMEM_HUGE_WITHIN_SIZE:
 +			off = round_up(vma->vm_pgoff, HPAGE_PMD_NR);
 +			i_size = round_up(i_size_read(inode), PAGE_SIZE);
 +			if (i_size >= HPAGE_PMD_SIZE &&
 +					i_size >> PAGE_SHIFT >= off)
 +				return true;
 +			/* fall through */
 +		case SHMEM_HUGE_ADVISE:
 +			/* TODO: implement fadvise() hints */
 +			return (vma->vm_flags & VM_HUGEPAGE);
 +		default:
 +			VM_BUG_ON(1);
 +			return false;
 +	}
 +}
 +#endif /* CONFIG_TRANSPARENT_HUGEPAGE */
 +
++=======
++>>>>>>> c852023e6fd4 (huge tmpfs: move shmem_huge_enabled() upwards)
  #else /* !CONFIG_SHMEM */
  
  /*
* Unmerged path mm/shmem.c
