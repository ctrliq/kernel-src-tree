mm: memcg: fix NULL pointer in mem_cgroup_track_foreign_dirty_slowpath()

jira LE-4623
Rebuild_History Non-Buildable kernel-4.18.0-553.81.1.el8_10
commit-author Kefeng Wang <wangkefeng.wang@huawei.com>
commit ac86f547ca1002aec2ef66b9e64d03f45bbbfbb9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.81.1.el8_10/ac86f547.failed

As commit 18365225f044 ("hwpoison, memcg: forcibly uncharge LRU pages"),
hwpoison will forcibly uncharg a LRU hwpoisoned page, the folio_memcg
could be NULl, then, mem_cgroup_track_foreign_dirty_slowpath() could
occurs a NULL pointer dereference, let's do not record the foreign
writebacks for folio memcg is null in mem_cgroup_track_foreign_dirty() to
fix it.

Link: https://lkml.kernel.org/r/20230129040945.180629-1-wangkefeng.wang@huawei.com
Fixes: 97b27821b485 ("writeback, memcg: Implement foreign dirty flushing")
	Signed-off-by: Kefeng Wang <wangkefeng.wang@huawei.com>
	Reported-by: Ma Wupeng <mawupeng1@huawei.com>
	Tested-by: Miko Larsson <mikoxyzzz@gmail.com>
	Acked-by: Michal Hocko <mhocko@suse.com>
	Cc: Jan Kara <jack@suse.cz>
	Cc: Jens Axboe <axboe@kernel.dk>
	Cc: Kefeng Wang <wangkefeng.wang@huawei.com>
	Cc: Ma Wupeng <mawupeng1@huawei.com>
	Cc: Naoya Horiguchi <naoya.horiguchi@nec.com>
	Cc: Shakeel Butt <shakeelb@google.com>
	Cc: Tejun Heo <tj@kernel.org>
	Cc: <stable@vger.kernel.org>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
(cherry picked from commit ac86f547ca1002aec2ef66b9e64d03f45bbbfbb9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/linux/memcontrol.h
diff --cc include/linux/memcontrol.h
index 2b9c6b1b713c,85dc9b88ea37..000000000000
--- a/include/linux/memcontrol.h
+++ b/include/linux/memcontrol.h
@@@ -1609,17 -1660,20 +1609,25 @@@ void mem_cgroup_wb_stats(struct bdi_wri
  			 unsigned long *pheadroom, unsigned long *pdirty,
  			 unsigned long *pwriteback);
  
 -void mem_cgroup_track_foreign_dirty_slowpath(struct folio *folio,
 +void mem_cgroup_track_foreign_dirty_slowpath(struct page *page,
  					     struct bdi_writeback *wb);
  
 -static inline void mem_cgroup_track_foreign_dirty(struct folio *folio,
 +static inline void mem_cgroup_track_foreign_dirty(struct page *page,
  						  struct bdi_writeback *wb)
  {
+ 	struct mem_cgroup *memcg;
+ 
  	if (mem_cgroup_disabled())
  		return;
  
++<<<<<<< HEAD
 +	if (unlikely(&page_memcg(page)->css != wb->memcg_css))
 +		mem_cgroup_track_foreign_dirty_slowpath(page, wb);
++=======
+ 	memcg = folio_memcg(folio);
+ 	if (unlikely(memcg && &memcg->css != wb->memcg_css))
+ 		mem_cgroup_track_foreign_dirty_slowpath(folio, wb);
++>>>>>>> ac86f547ca10 (mm: memcg: fix NULL pointer in mem_cgroup_track_foreign_dirty_slowpath())
  }
  
  void mem_cgroup_flush_foreign(struct bdi_writeback *wb);
* Unmerged path include/linux/memcontrol.h
