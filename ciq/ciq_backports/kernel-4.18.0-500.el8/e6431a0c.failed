media: dvb-frontends: a8293: fix LNB powerup failure in PCTV 461e

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-500.el8
commit-author Chuck Ritola <cjritola@gmail.com>
commit e6431a0c0d711af71a0628689463af4ec19c82f8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-500.el8/e6431a0c.failed

Fixes a8293 failure to raise LNB voltage in PCTV 461e DVB-S2 Stick
affecting multiple users over several years as found here:

http://www.linuxquestions.org/questions/linux-hardware-18/pctv-dvb-s2-stick-461e-not-feeding-lnb-4175529374/
https://www.linuxtv.org/wiki/index.php/Pinnacle_PCTV_DVB-S2_Stick_(461e)
https://github.com/OpenELEC/OpenELEC.tv/issues/3731

Caused by vIN undervoltage lockout (status register bit 7) when raising LNB to 18V.
Addressed by using the higher-precision voltages available on the a8293 to gradually
increase (slew) the voltage when voltage increases are requested.

Adds volt_slew_nanos_per_mv to a8293_platform_data struct for specifying slew rate.
If value is <1 or non-sane (>1600), the original no-slew version for a8293_set_voltage is used.

Link: https://lore.kernel.org/linux-media/20211231035326.6759-1-cjritola@gmail.com
[mchehab: fixed some coding style issues]
	Signed-off-by: Chuck Ritola <cjritola@gmail.com>
	Signed-off-by: Mauro Carvalho Chehab <mchehab@kernel.org>
(cherry picked from commit e6431a0c0d711af71a0628689463af4ec19c82f8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/media/dvb-frontends/a8293.c
diff --cc drivers/media/dvb-frontends/a8293.c
index e1e9bddcf516,cca7cbdd4c7c..000000000000
--- a/drivers/media/dvb-frontends/a8293.c
+++ b/drivers/media/dvb-frontends/a8293.c
@@@ -71,8 -190,27 +199,32 @@@ err
  	return ret;
  }
  
++<<<<<<< HEAD
 +static int a8293_probe(struct i2c_client *client,
 +		       const struct i2c_device_id *id)
++=======
+ static int a8293_set_voltage(struct dvb_frontend *fe,
+ 			     enum fe_sec_voltage fe_sec_voltage)
+ {
+ 	struct a8293_dev *dev = fe->sec_priv;
+ 	struct i2c_client *client = dev->client;
+ 	int volt_slew_nanos_per_mv = dev->volt_slew_nanos_per_mv;
+ 
+ 	dev_dbg(&client->dev, "set_voltage volt_slew_nanos_per_mv=%d\n",
+ 		volt_slew_nanos_per_mv);
+ 
+ 	/* Use slew version if slew rate is set to a sane value */
+ 	if (volt_slew_nanos_per_mv > 0 && volt_slew_nanos_per_mv < 1600)
+ 		a8293_set_voltage_slew(dev, client, fe_sec_voltage,
+ 				       volt_slew_nanos_per_mv);
+ 	else
+ 		a8293_set_voltage_noslew(fe, fe_sec_voltage);
+ 
+ 	return 0;
+ }
+ 
+ static int a8293_probe(struct i2c_client *client)
++>>>>>>> e6431a0c0d71 (media: dvb-frontends: a8293: fix LNB powerup failure in PCTV 461e)
  {
  	struct a8293_dev *dev;
  	struct a8293_platform_data *pdata = client->dev.platform_data;
* Unmerged path drivers/media/dvb-frontends/a8293.c
diff --git a/drivers/media/dvb-frontends/a8293.h b/drivers/media/dvb-frontends/a8293.h
index bc6f74f10f32..e455ebcd0d9c 100644
--- a/drivers/media/dvb-frontends/a8293.h
+++ b/drivers/media/dvb-frontends/a8293.h
@@ -27,9 +27,12 @@
 /**
  * struct a8293_platform_data - Platform data for the a8293 driver
  * @dvb_frontend: DVB frontend.
+ * @volt_slew_nanos_per_mv: Slew rate when increasing LNB voltage,
+ *	 in nanoseconds per millivolt.
  */
 struct a8293_platform_data {
 	struct dvb_frontend *dvb_frontend;
+	int volt_slew_nanos_per_mv;
 };
 
 #endif /* A8293_H */
diff --git a/drivers/media/usb/em28xx/em28xx-dvb.c b/drivers/media/usb/em28xx/em28xx-dvb.c
index 431d26fe704c..b289a1af5540 100644
--- a/drivers/media/usb/em28xx/em28xx-dvb.c
+++ b/drivers/media/usb/em28xx/em28xx-dvb.c
@@ -1203,6 +1203,12 @@ static int em28178_dvb_init_pctv_461e(struct em28xx *dev)
 
 	/* attach SEC */
 	a8293_pdata.dvb_frontend = dvb->fe[0];
+	/*
+	 * 461e has a tendency to have vIN undervoltage troubles.
+	 * Slew mitigates this.
+	 */
+	a8293_pdata.volt_slew_nanos_per_mv = 20;
+
 	dvb->i2c_client_sec = dvb_module_probe("a8293", NULL,
 					       &dev->i2c_adap[dev->def_i2c_bus],
 					       0x08, &a8293_pdata);
