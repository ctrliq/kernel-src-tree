usb: typec: tipd: Fix initialization sequence for cd321x

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-500.el8
commit-author Hector Martin <marcan@marcan.st>
commit 113972d2e111304553d4d3226f49d18ea4b7f2f7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-500.el8/113972d2.failed

The power state switch needs to happen first, as that
kickstarts the firmware into normal mode.

Fixes: c9c14be664cf ("usb: typec: tipd: Switch CD321X power state to S0")
	Reviewed-by: Heikki Krogerus <heikki.krogerus@linux.intel.com>
	Reviewed-by: Sven Peter <sven@svenpeter.dev>
	Signed-off-by: Hector Martin <marcan@marcan.st>
Link: https://lore.kernel.org/r/20211120030717.84287-3-marcan@marcan.st
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 113972d2e111304553d4d3226f49d18ea4b7f2f7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/usb/typec/tipd/core.c
diff --cc drivers/usb/typec/tipd/core.c
index 7c364e1f355e,6d27a5b5e3ca..000000000000
--- a/drivers/usb/typec/tipd/core.c
+++ b/drivers/usb/typec/tipd/core.c
@@@ -611,11 -731,34 +612,40 @@@ static int tps6598x_probe(struct i2c_cl
  	if (i2c_check_functionality(client->adapter, I2C_FUNC_I2C))
  		tps->i2c_protocol = true;
  
++<<<<<<< HEAD
++=======
+ 	if (np && of_device_is_compatible(np, "apple,cd321x")) {
+ 		/* Switch CD321X chips to the correct system power state */
+ 		ret = cd321x_switch_power_state(tps, TPS_SYSTEM_POWER_STATE_S0);
+ 		if (ret)
+ 			return ret;
+ 
+ 		/* CD321X chips have all interrupts masked initially */
+ 		mask1 = APPLE_CD_REG_INT_POWER_STATUS_UPDATE |
+ 			APPLE_CD_REG_INT_DATA_STATUS_UPDATE |
+ 			APPLE_CD_REG_INT_PLUG_EVENT;
+ 
+ 		irq_handler = cd321x_interrupt;
+ 	} else {
+ 		/* Enable power status, data status and plug event interrupts */
+ 		mask1 = TPS_REG_INT_POWER_STATUS_UPDATE |
+ 			TPS_REG_INT_DATA_STATUS_UPDATE |
+ 			TPS_REG_INT_PLUG_EVENT;
+ 	}
+ 
++>>>>>>> 113972d2e111 (usb: typec: tipd: Fix initialization sequence for cd321x)
  	/* Make sure the controller has application firmware running */
  	ret = tps6598x_check_mode(tps);
  	if (ret)
  		return ret;
  
++<<<<<<< HEAD
++=======
+ 	ret = tps6598x_write64(tps, TPS_REG_INT_MASK1, mask1);
+ 	if (ret)
+ 		return ret;
+ 
++>>>>>>> 113972d2e111 (usb: typec: tipd: Fix initialization sequence for cd321x)
  	ret = tps6598x_read32(tps, TPS_REG_STATUS, &status);
  	if (ret < 0)
  		return ret;
* Unmerged path drivers/usb/typec/tipd/core.c
