usb: core: Unregister device on component_add() failure

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-500.el8
commit-author Fabio M. De Francesco <fmdefrancesco@gmail.com>
commit c853685d11c09da35cb49bbf8f0c001abdc0d0a9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-500.el8/c853685d.failed

Commit 8c67d06f3fd9 ("usb: Link the ports to the connectors they are
attached to") creates a link to the USB Type-C connector for every new
port that is added when possible. If component_add() fails,
usb_hub_create_port_device() prints a warning but does not unregister
the device and does not return errors to the callers.

Syzbot reported a "WARNING in component_del()".

Fix this issue in usb_hub_create_port_device by calling device_unregister()
and returning the errors from component_add().

Fixes: 8c67d06f3fd9 ("usb: Link the ports to the connectors they are attached to")
Reported-and-tested-by: syzbot+60df062e1c41940cae0f@syzkaller.appspotmail.com
	Reviewed-by: Heikki Krogerus <heikki.krogerus@linux.intel.com>
	Signed-off-by: Fabio M. De Francesco <fmdefrancesco@gmail.com>
Link: https://lore.kernel.org/r/20220209164500.8769-1-fmdefrancesco@gmail.com
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit c853685d11c09da35cb49bbf8f0c001abdc0d0a9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/usb/core/port.c
diff --cc drivers/usb/core/port.c
index d375eb4a9b45,d5bc36ca5b1f..000000000000
--- a/drivers/usb/core/port.c
+++ b/drivers/usb/core/port.c
@@@ -659,6 -602,13 +659,16 @@@ int usb_hub_create_port_device(struct u
  		return retval;
  	}
  
++<<<<<<< HEAD
++=======
+ 	retval = component_add(&port_dev->dev, &connector_ops);
+ 	if (retval) {
+ 		dev_warn(&port_dev->dev, "failed to add component\n");
+ 		device_unregister(&port_dev->dev);
+ 		return retval;
+ 	}
+ 
++>>>>>>> c853685d11c0 (usb: core: Unregister device on component_add() failure)
  	find_and_link_peer(hub, port1);
  
  	/*
* Unmerged path drivers/usb/core/port.c
