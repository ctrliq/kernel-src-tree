usb: typec: tipd: Switch CD321X power state to S0

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-500.el8
commit-author Sven Peter <sven@svenpeter.dev>
commit c9c14be664cfda991f65240e669b07b68265765b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-500.el8/c9c14be6.failed

The Apple CD321x comes up in a low-power state after boot. Usually, the
bootloader will already power it up to S0 but let's do it here as well
in case that didn't happen.

	Suggested-by: Stan Skowronek <stan@corellium.com>
	Reviewed-by: Alyssa Rosenzweig <alyssa@rosenzweig.io>
	Reviewed-by: Heikki Krogerus <heikki.krogerus@linux.intel.com>
	Signed-off-by: Sven Peter <sven@svenpeter.dev>
Link: https://lore.kernel.org/r/20210928155502.71372-6-sven@svenpeter.dev
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit c9c14be664cfda991f65240e669b07b68265765b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/usb/typec/tipd/core.c
#	drivers/usb/typec/tipd/tps6598x.h
diff --cc drivers/usb/typec/tipd/core.c
index 6e64a81907c2,c74fc9ae1686..000000000000
--- a/drivers/usb/typec/tipd/core.c
+++ b/drivers/usb/typec/tipd/core.c
@@@ -619,6 -738,23 +651,26 @@@ static int tps6598x_probe(struct i2c_cl
  	if (ret)
  		return ret;
  
++<<<<<<< HEAD
++=======
+ 	if (np && of_device_is_compatible(np, "apple,cd321x")) {
+ 		/* Switch CD321X chips to the correct system power state */
+ 		ret = cd321x_switch_power_state(tps, TPS_SYSTEM_POWER_STATE_S0);
+ 		if (ret)
+ 			return ret;
+ 
+ 		/* CD321X chips have all interrupts masked initially */
+ 		ret = tps6598x_write64(tps, TPS_REG_INT_MASK1,
+ 					APPLE_CD_REG_INT_POWER_STATUS_UPDATE |
+ 					APPLE_CD_REG_INT_DATA_STATUS_UPDATE |
+ 					APPLE_CD_REG_INT_PLUG_EVENT);
+ 		if (ret)
+ 			return ret;
+ 
+ 		irq_handler = cd321x_interrupt;
+ 	}
+ 
++>>>>>>> c9c14be664cf (usb: typec: tipd: Switch CD321X power state to S0)
  	ret = tps6598x_read32(tps, TPS_REG_STATUS, &status);
  	if (ret < 0)
  		return ret;
diff --cc drivers/usb/typec/tipd/tps6598x.h
index 003a577be216,3dae84c524fb..000000000000
--- a/drivers/usb/typec/tipd/tps6598x.h
+++ b/drivers/usb/typec/tipd/tps6598x.h
@@@ -129,6 -129,18 +129,21 @@@
  #define TPS_REG_INT_HARD_RESET				BIT(1)
  #define TPS_REG_INT_PD_SOFT_RESET			BIT(0)
  
++<<<<<<< HEAD
++=======
+ /* Apple-specific TPS_REG_INT_* bits */
+ #define APPLE_CD_REG_INT_DATA_STATUS_UPDATE		BIT(10)
+ #define APPLE_CD_REG_INT_POWER_STATUS_UPDATE		BIT(9)
+ #define APPLE_CD_REG_INT_STATUS_UPDATE			BIT(8)
+ #define APPLE_CD_REG_INT_PLUG_EVENT			BIT(1)
+ 
+ /* TPS_REG_SYSTEM_POWER_STATE states */
+ #define TPS_SYSTEM_POWER_STATE_S0	0x00
+ #define TPS_SYSTEM_POWER_STATE_S3	0x03
+ #define TPS_SYSTEM_POWER_STATE_S4	0x04
+ #define TPS_SYSTEM_POWER_STATE_S5	0x05
+ 
++>>>>>>> c9c14be664cf (usb: typec: tipd: Switch CD321X power state to S0)
  /* TPS_REG_POWER_STATUS bits */
  #define TPS_POWER_STATUS_CONNECTION(x)  TPS_FIELD_GET(BIT(0), (x))
  #define TPS_POWER_STATUS_SOURCESINK(x)	TPS_FIELD_GET(BIT(1), (x))
* Unmerged path drivers/usb/typec/tipd/core.c
* Unmerged path drivers/usb/typec/tipd/tps6598x.h
