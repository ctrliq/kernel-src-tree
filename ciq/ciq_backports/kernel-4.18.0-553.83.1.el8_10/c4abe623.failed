s390/pci: Fix __pcilg_mio_inuser() inline assembly

jira LE-4704
Rebuild_History Non-Buildable kernel-4.18.0-553.83.1.el8_10
commit-author Heiko Carstens <hca@linux.ibm.com>
commit c4abe6234246c75cdc43326415d9cff88b7cf06c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.83.1.el8_10/c4abe623.failed

Use "a" constraint for the shift operand of the __pcilg_mio_inuser() inline
assembly. The used "d" constraint allows the compiler to use any general
purpose register for the shift operand, including register zero.

If register zero is used this my result in incorrect code generation:

 8f6:   a7 0a ff f8             ahi     %r0,-8
 8fa:   eb 32 00 00 00 0c       srlg    %r3,%r2,0  <----

If register zero is selected to contain the shift value, the srlg
instruction ignores the contents of the register and always shifts zero
bits. Therefore use the "a" constraint which does not permit to select
register zero.

Fixes: f058599e22d5 ("s390/pci: Fix s390_mmio_read/write with MIO")
	Cc: stable@vger.kernel.org
	Reported-by: Niklas Schnelle <schnelle@linux.ibm.com>
	Reviewed-by: Niklas Schnelle <schnelle@linux.ibm.com>
	Signed-off-by: Heiko Carstens <hca@linux.ibm.com>
(cherry picked from commit c4abe6234246c75cdc43326415d9cff88b7cf06c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/s390/pci/pci_mmio.c
diff --cc arch/s390/pci/pci_mmio.c
index c3402f7971c7,51e7a28af899..000000000000
--- a/arch/s390/pci/pci_mmio.c
+++ b/arch/s390/pci/pci_mmio.c
@@@ -207,27 -221,34 +207,34 @@@ static inline int __pcilg_mio_inuser
  	 * user space) into a register using pcilg then store these bytes at
  	 * user address @dst
  	 */
 -	exception = 1;
 -	sacf_flag = enable_sacf_uaccess();
 -	asm_inline volatile (
 -		"	sacf	256\n"
 -		"0:	.insn	rre,0xb9d60000,%[val],%[ioaddr_len]\n"
 -		"1:	lhi	%[exc],0\n"
 -		"	jne	4f\n"
 -		"2:	ahi	%[shift],-8\n"
 -		"	srlg	%[tmp],%[val],0(%[shift])\n"
 -		"3:	stc	%[tmp],0(%[dst])\n"
 +	asm volatile (
 +		"       sacf    256\n"
 +		"0:     .insn   rre,0xb9d60000,%[val],%[ioaddr_len]\n"
 +		"1:     ipm     %[cc]\n"
 +		"       srl     %[cc],28\n"
 +		"       ltr     %[cc],%[cc]\n"
 +		"       jne     4f\n"
 +		"2:     ahi     %[shift],-8\n"
 +		"       srlg    %[tmp],%[val],0(%[shift])\n"
 +		"3:     stc     %[tmp],0(%[dst])\n"
  		"5:	aghi	%[dst],1\n"
 -		"	brctg	%[cnt],2b\n"
 -		/*
 -		 * Use xr to clear exc and set condition code to zero
 -		 * to ensure flag output is correct for this branch.
 -		 */
 -		"	xr	%[exc],%[exc]\n"
 -		"4:	sacf	768\n"
 -		CC_IPM(cc)
 +		"       brctg   %[cnt],2b\n"
 +		"4:     sacf    768\n"
  		EX_TABLE(0b, 4b) EX_TABLE(1b, 4b) EX_TABLE(3b, 4b) EX_TABLE(5b, 4b)
++<<<<<<< HEAD
++=======
+ 		: [ioaddr_len] "+&d" (ioaddr_len.pair), [exc] "+d" (exception),
+ 		  CC_OUT(cc, cc), [val] "=d" (val),
+ 		  [dst] "+a" (dst), [cnt] "+d" (cnt), [tmp] "=d" (tmp),
+ 		  [shift] "+a" (shift)
++>>>>>>> c4abe6234246 (s390/pci: Fix __pcilg_mio_inuser() inline assembly)
  		:
 -		: CC_CLOBBER_LIST("memory"));
 -	disable_sacf_uaccess(sacf_flag);
 -	cc = exception ? -ENXIO : CC_TRANSFORM(cc);
 +		[ioaddr_len] "+&d" (ioaddr_len.pair),
 +		[cc] "+d" (cc), [val] "=d" (val),
 +		[dst] "+a" (dst), [cnt] "+d" (cnt), [tmp] "=d" (tmp),
 +		[shift] "+d" (shift)
 +		:: "cc", "memory");
 +
  	/* did we write everything to the user space buffer? */
  	if (!cc && cnt != 0)
  		cc = -EFAULT;
* Unmerged path arch/s390/pci/pci_mmio.c
