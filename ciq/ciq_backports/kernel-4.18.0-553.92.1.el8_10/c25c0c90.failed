blk-mq: setup queue ->tag_set before initializing hctx

jira KERNEL-428
Rebuild_History Non-Buildable kernel-4.18.0-553.92.1.el8_10
commit-author Ming Lei <ming.lei@redhat.com>
commit c25c0c9035bb8b28c844dfddeda7b8bdbcfcae95
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.92.1.el8_10/c25c0c90.failed

Commit 7b815817aa58 ("blk-mq: add helper for checking if one CPU is mapped to specified hctx")
needs to check queue mapping via tag set in hctx's cpuhp handler.

However, q->tag_set may not be setup yet when the cpuhp handler is
enabled, then kernel oops is triggered.

Fix the issue by setup queue tag_set before initializing hctx.

	Cc: stable@vger.kernel.org
Reported-and-tested-by: Rick Koch <mr.rickkoch@gmail.com>
Closes: https://lore.kernel.org/linux-block/CANa58eeNDozLaBHKPLxSAhEy__FPfJT_F71W=sEQw49UCrC9PQ@mail.gmail.com
Fixes: 7b815817aa58 ("blk-mq: add helper for checking if one CPU is mapped to specified hctx")
	Signed-off-by: Ming Lei <ming.lei@redhat.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: John Garry <john.g.garry@oracle.com>
Link: https://lore.kernel.org/r/20241014005115.2699642-1-ming.lei@redhat.com
	Signed-off-by: Jens Axboe <axboe@kernel.dk>
(cherry picked from commit c25c0c9035bb8b28c844dfddeda7b8bdbcfcae95)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/blk-mq.c
diff --cc block/blk-mq.c
index 4a33ad4b2597,cf626e061dd7..000000000000
--- a/block/blk-mq.c
+++ b/block/blk-mq.c
@@@ -3402,11 -4310,11 +3402,19 @@@ struct request_queue *blk_mq_init_alloc
  	/* mark the queue as mq asap */
  	q->mq_ops = set->ops;
  
++<<<<<<< HEAD
 +	q->poll_cb = blk_stat_alloc_callback(blk_mq_poll_stats_fn,
 +					     blk_mq_poll_stats_bkt,
 +					     BLK_MQ_POLL_STATS_BKTS, q);
 +	if (!q->poll_cb)
 +		goto err_exit;
++=======
+ 	/*
+ 	 * ->tag_set has to be setup before initialize hctx, which cpuphp
+ 	 * handler needs it for checking queue mapping
+ 	 */
+ 	q->tag_set = set;
++>>>>>>> c25c0c9035bb (blk-mq: setup queue ->tag_set before initializing hctx)
  
  	if (blk_mq_alloc_ctxs(q))
  		goto err_exit;
@@@ -3424,16 -4334,10 +3432,14 @@@
  	INIT_WORK(&q->timeout_work, blk_mq_timeout_work);
  	blk_queue_rq_timeout(q, set->timeout ? set->timeout : 30 * HZ);
  
- 	q->tag_set = set;
- 
  	q->queue_flags |= QUEUE_FLAG_MQ_DEFAULT;
 +	if (set->nr_maps > HCTX_TYPE_POLL &&
 +	    set->map[HCTX_TYPE_POLL].nr_queues)
 +		blk_queue_flag_set(QUEUE_FLAG_POLL, q);
 +
 +	q->sg_reserved_size = INT_MAX;
  
  	INIT_DELAYED_WORK(&q->requeue_work, blk_mq_requeue_work);
 -	INIT_LIST_HEAD(&q->flush_list);
  	INIT_LIST_HEAD(&q->requeue_list);
  	spin_lock_init(&q->requeue_lock);
  
* Unmerged path block/blk-mq.c
