smb: client: Add tracepoint for krb5 auth

jira KERNEL-660
Rebuild_History Non-Buildable kernel-5.14.0-611.34.1.el9_7
commit-author Paulo Alcantara <pc@manguebit.org>
commit 7ad785927d9eb348adb381d168ed73d0dd3c7670
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-5.14.0-611.34.1.el9_7/7ad78592.failed

Add tracepoint to help debugging krb5 auth failures.

Example:

$ trace-cmd record -e smb3_kerberos_auth
$ mount.cifs ...
$ trace-cmd report
mount.cifs-1667 [003] .....  5810.668549: smb3_kerberos_auth: vers=2
host=w22-dc1.zelda.test ip=192.168.124.30:445 sec=krb5 uid=0 cruid=0
user=root pid=1667 upcall_target=app err=-126

	Signed-off-by: Paulo Alcantara (Red Hat) <pc@manguebit.org>
	Reviewed-by: David Howells <dhowells@redhat.com>
	Cc: Pierguido Lambri <plambri@redhat.com>
	Cc: linux-cifs@vger.kernel.org
	Signed-off-by: Steve French <stfrench@microsoft.com>
(cherry picked from commit 7ad785927d9eb348adb381d168ed73d0dd3c7670)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/smb/client/cifs_spnego.c
diff --cc fs/smb/client/cifs_spnego.c
index 08885ec1b407,3a41bbada04c..000000000000
--- a/fs/smb/client/cifs_spnego.c
+++ b/fs/smb/client/cifs_spnego.c
@@@ -136,48 -128,38 +136,54 @@@ cifs_get_spnego_key(struct cifs_ses *se
  	else
  		goto out;
  
 +	dp = description + strlen(description);
 +
  	/* for now, only sec=krb5 and sec=mskrb5 and iakerb are valid */
  	if (server->sec_kerberos)
 -		dp += sprintf(dp, ";sec=krb5");
 +		sprintf(dp, ";sec=krb5");
  	else if (server->sec_mskerberos)
 -		dp += sprintf(dp, ";sec=mskrb5");
 +		sprintf(dp, ";sec=mskrb5");
  	else if (server->sec_iakerb)
 -		dp += sprintf(dp, ";sec=iakerb");
 +		sprintf(dp, ";sec=iakerb");
  	else {
  		cifs_dbg(VFS, "unknown or missing server auth type, use krb5\n");
 -		dp += sprintf(dp, ";sec=krb5");
 +		sprintf(dp, ";sec=krb5");
  	}
  
 -	dp += sprintf(dp, ";uid=0x%x",
 -		      from_kuid_munged(&init_user_ns, sesInfo->linux_uid));
 +	dp = description + strlen(description);
 +	sprintf(dp, ";uid=0x%x",
 +		from_kuid_munged(&init_user_ns, sesInfo->linux_uid));
  
 -	dp += sprintf(dp, ";creduid=0x%x",
 +	dp = description + strlen(description);
 +	sprintf(dp, ";creduid=0x%x",
  		from_kuid_munged(&init_user_ns, sesInfo->cred_uid));
  
 -	if (sesInfo->user_name)
 -		dp += sprintf(dp, ";user=%s", sesInfo->user_name);
 +	if (sesInfo->user_name) {
 +		dp = description + strlen(description);
 +		sprintf(dp, ";user=%s", sesInfo->user_name);
 +	}
  
 -	dp += sprintf(dp, ";pid=0x%x", current->pid);
 +	dp = description + strlen(description);
 +	sprintf(dp, ";pid=0x%x", current->pid);
  
 -	if (sesInfo->upcall_target == UPTARGET_MOUNT)
 -		dp += sprintf(dp, ";upcall_target=mount");
 -	else
 -		dp += sprintf(dp, ";upcall_target=app");
 +	if (sesInfo->upcall_target == UPTARGET_MOUNT) {
 +		dp = description + strlen(description);
 +		sprintf(dp, ";upcall_target=mount");
 +	} else {
 +		dp = description + strlen(description);
 +		sprintf(dp, ";upcall_target=app");
 +	}
  
  	cifs_dbg(FYI, "key description = %s\n", description);
++<<<<<<< HEAD
 +	saved_cred = override_creds(spnego_cred);
 +	spnego_key = request_key(&cifs_spnego_key_type, description, "");
 +	revert_creds(saved_cred);
++=======
+ 	scoped_with_creds(spnego_cred)
+ 		spnego_key = request_key(&cifs_spnego_key_type, description, "");
+ 	trace_smb3_kerberos_auth(server, sesInfo, PTR_ERR_OR_ZERO(spnego_key));
++>>>>>>> 7ad785927d9e (smb: client: Add tracepoint for krb5 auth)
  
  #ifdef CONFIG_CIFS_DEBUG2
  	if (cifsFYI && !IS_ERR(spnego_key)) {
* Unmerged path fs/smb/client/cifs_spnego.c
diff --git a/fs/smb/client/smb2pdu.c b/fs/smb/client/smb2pdu.c
index 7310dc74adfc..1eef6c9b971e 100644
--- a/fs/smb/client/smb2pdu.c
+++ b/fs/smb/client/smb2pdu.c
@@ -1625,8 +1625,6 @@ SMB2_auth_kerberos(struct SMB2_sess_data *sess_data)
 	spnego_key = cifs_get_spnego_key(ses, server);
 	if (IS_ERR(spnego_key)) {
 		rc = PTR_ERR(spnego_key);
-		if (rc == -ENOKEY)
-			cifs_dbg(VFS, "Verify user has a krb5 ticket and keyutils is installed\n");
 		spnego_key = NULL;
 		goto out;
 	}
diff --git a/fs/smb/client/trace.c b/fs/smb/client/trace.c
index 16b0e719731f..8a99b68d0c71 100644
--- a/fs/smb/client/trace.c
+++ b/fs/smb/client/trace.c
@@ -5,5 +5,6 @@
  *   Author(s): Steve French <stfrench@microsoft.com>
  */
 #include "cifsglob.h"
+#include "cifs_spnego.h"
 #define CREATE_TRACE_POINTS
 #include "trace.h"
diff --git a/fs/smb/client/trace.h b/fs/smb/client/trace.h
index c1806b9ca6ef..fba1c2616368 100644
--- a/fs/smb/client/trace.h
+++ b/fs/smb/client/trace.h
@@ -1435,6 +1435,49 @@ DEFINE_SMB3_CREDIT_EVENT(waitff_credits);
 DEFINE_SMB3_CREDIT_EVENT(overflow_credits);
 DEFINE_SMB3_CREDIT_EVENT(set_credits);
 
+TRACE_EVENT(smb3_kerberos_auth,
+		TP_PROTO(struct TCP_Server_Info *server,
+			 struct cifs_ses *ses,
+			 int rc),
+		TP_ARGS(server, ses, rc),
+		TP_STRUCT__entry(
+			__field(pid_t, pid)
+			__field(uid_t, uid)
+			__field(uid_t, cruid)
+			__string(host, server->hostname)
+			__string(user, ses->user_name)
+			__array(__u8, addr, sizeof(struct sockaddr_storage))
+			__array(char, sec, sizeof("ntlmsspi"))
+			__array(char, upcall_target, sizeof("mount"))
+			__field(int, rc)
+		),
+		TP_fast_assign(
+			__entry->pid = current->pid;
+			__entry->uid = from_kuid_munged(&init_user_ns, ses->linux_uid);
+			__entry->cruid = from_kuid_munged(&init_user_ns, ses->cred_uid);
+			__assign_str(host);
+			__assign_str(user);
+			memcpy(__entry->addr, &server->dstaddr, sizeof(__entry->addr));
+
+			if (server->sec_kerberos)
+				memcpy(__entry->sec, "krb5", sizeof("krb5"));
+			else if (server->sec_mskerberos)
+				memcpy(__entry->sec, "mskrb5", sizeof("mskrb5"));
+			else if (server->sec_iakerb)
+				memcpy(__entry->sec, "iakerb", sizeof("iakerb"));
+			else
+				memcpy(__entry->sec, "krb5", sizeof("krb5"));
+
+			if (ses->upcall_target == UPTARGET_MOUNT)
+				memcpy(__entry->upcall_target, "mount", sizeof("mount"));
+			else
+				memcpy(__entry->upcall_target, "app", sizeof("app"));
+			__entry->rc = rc;
+		),
+		TP_printk("vers=%d host=%s ip=%pISpsfc sec=%s uid=%d cruid=%d user=%s pid=%d upcall_target=%s err=%d",
+			  CIFS_SPNEGO_UPCALL_VERSION, __get_str(host), __entry->addr,
+			  __entry->sec, __entry->uid, __entry->cruid, __get_str(user),
+			  __entry->pid, __entry->upcall_target, __entry->rc))
 
 TRACE_EVENT(smb3_tcon_ref,
 	    TP_PROTO(unsigned int tcon_debug_id, int ref,
