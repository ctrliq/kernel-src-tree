s390/vfio-ap: loop over the shadow APCB when filtering guest's AP configuration

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-537.el8
commit-author Tony Krowiak <akrowiak@linux.ibm.com>
commit 16fb78cbf56e42b8efb2682a4444ab59e32e7959
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-537.el8/16fb78cb.failed

While filtering the mdev matrix, it doesn't make sense - and will have
unexpected results - to filter an APID from the matrix if the APID or one
of the associated APQIs is not in the host's AP configuration. There are
two reasons for this:

1. An adapter or domain that is not in the host's AP configuration can be
   assigned to the matrix; this is known as over-provisioning. Queue
   devices, however, are only created for adapters and domains in the
   host's AP configuration, so there will be no queues associated with an
   over-provisioned adapter or domain to filter.

2. The adapter or domain may have been externally removed from the host's
   configuration via an SE or HMC attached to a DPM enabled LPAR. In this
   case, the vfio_ap device driver would have been notified by the AP bus
   via the on_config_changed callback and the adapter or domain would
   have already been filtered.

Since the matrix_mdev->shadow_apcb.apm and matrix_mdev->shadow_apcb.aqm are
copied from the mdev matrix sans the APIDs and APQIs not in the host's AP
configuration, let's loop over those bitmaps instead of those assigned to
the matrix.

	Signed-off-by: Tony Krowiak <akrowiak@linux.ibm.com>
	Reviewed-by: Halil Pasic <pasic@linux.ibm.com>
Fixes: 48cae940c31d ("s390/vfio-ap: refresh guest's APCB by filtering AP resources assigned to mdev")
	Cc: stable@vger.kernel.org
Link: https://lore.kernel.org/r/20240115185441.31526-3-akrowiak@linux.ibm.com
	Signed-off-by: Alexander Gordeev <agordeev@linux.ibm.com>
(cherry picked from commit 16fb78cbf56e42b8efb2682a4444ab59e32e7959)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/s390/crypto/vfio_ap_ops.c
diff --cc drivers/s390/crypto/vfio_ap_ops.c
index cc0a2dfafc79,e825e13847fe..000000000000
--- a/drivers/s390/crypto/vfio_ap_ops.c
+++ b/drivers/s390/crypto/vfio_ap_ops.c
@@@ -638,8 -695,9 +638,14 @@@ static bool vfio_ap_mdev_filter_matrix(
  	bitmap_and(matrix_mdev->shadow_apcb.aqm, matrix_mdev->matrix.aqm,
  		   (unsigned long *)matrix_dev->info.aqm, AP_DOMAINS);
  
++<<<<<<< HEAD
 +	for_each_set_bit_inv(apid, apm, AP_DEVICES) {
 +		for_each_set_bit_inv(apqi, aqm, AP_DOMAINS) {
++=======
+ 	for_each_set_bit_inv(apid, matrix_mdev->shadow_apcb.apm, AP_DEVICES) {
+ 		for_each_set_bit_inv(apqi, matrix_mdev->shadow_apcb.aqm,
+ 				     AP_DOMAINS) {
++>>>>>>> 16fb78cbf56e (s390/vfio-ap: loop over the shadow APCB when filtering guest's AP configuration)
  			/*
  			 * If the APQN is not bound to the vfio_ap device
  			 * driver, then we can't assign it to the guest's
* Unmerged path drivers/s390/crypto/vfio_ap_ops.c
