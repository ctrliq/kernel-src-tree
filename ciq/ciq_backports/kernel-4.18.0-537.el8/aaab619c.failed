net/mlx5e: XDP, Fix XDP_REDIRECT mpwqe page fragment leaks on shutdown

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-537.el8
commit-author Dragos Tatulea <dtatulea@nvidia.com>
commit aaab619ccd07a32e5b29aa7e59b20de1dcc7a29e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-537.el8/aaab619c.failed

When mlx5e_xdp_xmit is called without the XDP_XMIT_FLUSH set it is
possible that it leaves a mpwqe session open. That is ok during runtime:
the session will be closed on the next call to mlx5e_xdp_xmit. But
having a mpwqe session still open at XDP sq close time is problematic:
the pc counter is not updated before flushing the contents of the
xdpi_fifo. This results in leaking page fragments.

The fix is to always close the mpwqe session at the end of
mlx5e_xdp_xmit, regardless of the XDP_XMIT_FLUSH flag being set or not.

Fixes: 5e0d2eef771e ("net/mlx5e: XDP, Support Enhanced Multi-Packet TX WQE")
	Signed-off-by: Dragos Tatulea <dtatulea@nvidia.com>
	Reviewed-by: Tariq Toukan <tariqt@nvidia.com>
	Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
(cherry picked from commit aaab619ccd07a32e5b29aa7e59b20de1dcc7a29e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/en/xdp.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en/xdp.c
index 40776fb3341b,8bed17d8fe56..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en/xdp.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en/xdp.c
@@@ -527,11 -857,28 +527,18 @@@ int mlx5e_xdp_xmit(struct net_device *d
  		nxmit++;
  	}
  
++<<<<<<< HEAD
 +	if (flags & XDP_XMIT_FLUSH) {
 +		if (sq->mpwqe.wqe)
 +			mlx5e_xdp_mpwqe_complete(sq);
++=======
+ out:
+ 	if (sq->mpwqe.wqe)
+ 		mlx5e_xdp_mpwqe_complete(sq);
+ 
+ 	if (flags & XDP_XMIT_FLUSH)
++>>>>>>> aaab619ccd07 (net/mlx5e: XDP, Fix XDP_REDIRECT mpwqe page fragment leaks on shutdown)
  		mlx5e_xmit_xdp_doorbell(sq);
- 	}
  
  	return nxmit;
  }
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en/xdp.c
