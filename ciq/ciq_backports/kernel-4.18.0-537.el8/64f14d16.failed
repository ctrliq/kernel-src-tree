net/mlx5e: Avoid referencing skb after free-ing in drop path of mlx5e_sq_xmit_wqe

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-537.el8
commit-author Rahul Rameshbabu <rrameshbabu@nvidia.com>
commit 64f14d16eef1f939000f2617b50c7c996b5117d4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-537.el8/64f14d16.failed

When SQ is a port timestamping SQ for PTP, do not access tx flags of skb
after free-ing the skb. Free the skb only after all references that depend
on it have been handled in the dropped WQE path.

Fixes: 3178308ad4ca ("net/mlx5e: Make tx_port_ts logic resilient to out-of-order CQEs")
	Signed-off-by: Rahul Rameshbabu <rrameshbabu@nvidia.com>
	Reviewed-by: Tariq Toukan <tariqt@nvidia.com>
	Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
Link: https://lore.kernel.org/r/20231114215846.5902-10-saeed@kernel.org
	Signed-off-by: Jakub Kicinski <kuba@kernel.org>
(cherry picked from commit 64f14d16eef1f939000f2617b50c7c996b5117d4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/en_tx.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_tx.c
index 139ba567387f,19f2c25b05a0..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_tx.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_tx.c
@@@ -445,6 -494,9 +445,12 @@@ mlx5e_sq_xmit_wqe(struct mlx5e_txqsq *s
  
  err_drop:
  	stats->dropped++;
++<<<<<<< HEAD
++=======
+ 	if (unlikely(sq->ptpsq && (skb_shinfo(skb)->tx_flags & SKBTX_HW_TSTAMP)))
+ 		mlx5e_ptp_metadata_fifo_push(&sq->ptpsq->metadata_freelist,
+ 					     be32_to_cpu(eseg->flow_table_metadata));
++>>>>>>> 64f14d16eef1 (net/mlx5e: Avoid referencing skb after free-ing in drop path of mlx5e_sq_xmit_wqe)
  	dev_kfree_skb_any(skb);
  	mlx5e_tx_flush(sq);
  }
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_tx.c
