icmp: randomize the global rate limiter

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-294.el8
commit-author Eric Dumazet <edumazet@google.com>
commit b38e7819cae946e2edf869e604af1e65a5d241c5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-294.el8/b38e7819.failed

Keyu Man reported that the ICMP rate limiter could be used
by attackers to get useful signal. Details will be provided
in an upcoming academic publication.

Our solution is to add some noise, so that the attackers
no longer can get help from the predictable token bucket limiter.

Fixes: 4cdf507d5452 ("icmp: add a global rate limitation")
	Signed-off-by: Eric Dumazet <edumazet@google.com>
	Reported-by: Keyu Man <kman001@ucr.edu>
	Signed-off-by: Jakub Kicinski <kuba@kernel.org>
(cherry picked from commit b38e7819cae946e2edf869e604af1e65a5d241c5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	Documentation/networking/ip-sysctl.txt
diff --cc Documentation/networking/ip-sysctl.txt
index 98118a1fc60f,25e6673a085a..000000000000
--- a/Documentation/networking/ip-sysctl.txt
+++ b/Documentation/networking/ip-sysctl.txt
@@@ -934,12 -1142,16 +934,23 @@@ icmp_ratelimit - INTEGE
  icmp_msgs_per_sec - INTEGER
  	Limit maximal number of ICMP packets sent per second from this host.
  	Only messages whose type matches icmp_ratemask (see below) are
++<<<<<<< HEAD:Documentation/networking/ip-sysctl.txt
 +	controlled by this limit.
++=======
+ 	controlled by this limit. For security reasons, the precise count
+ 	of messages per second is randomized.
+ 
++>>>>>>> b38e7819cae9 (icmp: randomize the global rate limiter):Documentation/networking/ip-sysctl.rst
  	Default: 1000
  
  icmp_msgs_burst - INTEGER
  	icmp_msgs_per_sec controls number of ICMP packets sent per second,
  	while icmp_msgs_burst controls the burst size of these packets.
++<<<<<<< HEAD:Documentation/networking/ip-sysctl.txt
++=======
+ 	For security reasons, the precise burst size is randomized.
+ 
++>>>>>>> b38e7819cae9 (icmp: randomize the global rate limiter):Documentation/networking/ip-sysctl.rst
  	Default: 50
  
  icmp_ratemask - INTEGER
* Unmerged path Documentation/networking/ip-sysctl.txt
diff --git a/net/ipv4/icmp.c b/net/ipv4/icmp.c
index 3f6d5a422095..8f59b570a356 100644
--- a/net/ipv4/icmp.c
+++ b/net/ipv4/icmp.c
@@ -244,7 +244,7 @@ static struct {
 /**
  * icmp_global_allow - Are we allowed to send one more ICMP message ?
  *
- * Uses a token bucket to limit our ICMP messages to sysctl_icmp_msgs_per_sec.
+ * Uses a token bucket to limit our ICMP messages to ~sysctl_icmp_msgs_per_sec.
  * Returns false if we reached the limit and can not send another packet.
  * Note: called with BH disabled
  */
@@ -272,7 +272,10 @@ bool icmp_global_allow(void)
 	}
 	credit = min_t(u32, icmp_global.credit + incr, sysctl_icmp_msgs_burst);
 	if (credit) {
-		credit--;
+		/* We want to use a credit of one in average, but need to randomize
+		 * it for security reasons.
+		 */
+		credit = max_t(int, credit - prandom_u32_max(3), 0);
 		rc = true;
 	}
 	WRITE_ONCE(icmp_global.credit, credit);
