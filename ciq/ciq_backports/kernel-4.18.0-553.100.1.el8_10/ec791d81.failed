tcp: fix a signed-integer-overflow bug in tcp_add_backlog()

jira KERNEL-579
cve CVE-2022-50865
Rebuild_History Non-Buildable kernel-4.18.0-553.100.1.el8_10
commit-author Lu Wei <luwei32@huawei.com>
commit ec791d8149ff60c40ad2074af3b92a39c916a03f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.100.1.el8_10/ec791d81.failed

The type of sk_rcvbuf and sk_sndbuf in struct sock is int, and
in tcp_add_backlog(), the variable limit is caculated by adding
sk_rcvbuf, sk_sndbuf and 64 * 1024, it may exceed the max value
of int and overflow. This patch reduces the limit budget by
halving the sndbuf to solve this issue since ACK packets are much
smaller than the payload.

Fixes: c9c3321257e1 ("tcp: add tcp_add_backlog()")
	Signed-off-by: Lu Wei <luwei32@huawei.com>
	Reviewed-by: Eric Dumazet <edumazet@google.com>
	Acked-by: Kuniyuki Iwashima <kuniyu@amazon.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit ec791d8149ff60c40ad2074af3b92a39c916a03f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv4/tcp_ipv4.c
diff --cc net/ipv4/tcp_ipv4.c
index 6e5d755f14b4,87d440f47a70..000000000000
--- a/net/ipv4/tcp_ipv4.c
+++ b/net/ipv4/tcp_ipv4.c
@@@ -1766,7 -1880,7 +1768,11 @@@ no_coalesce
  	 * to reduce memory overhead, so add a little headroom here.
  	 * Few sockets backlog are possibly concurrently non empty.
  	 */
++<<<<<<< HEAD
 +	limit += 64*1024;
++=======
+ 	limit += 64 * 1024;
++>>>>>>> ec791d8149ff (tcp: fix a signed-integer-overflow bug in tcp_add_backlog())
  
  	if (unlikely(sk_add_backlog(sk, skb, limit))) {
  		bh_unlock_sock(sk);
* Unmerged path net/ipv4/tcp_ipv4.c
