smb3: fix incorrect session setup check for multiuser mounts

jira LE-4669
Rebuild_History Non-Buildable kernel-4.18.0-553.82.1.el8_10
commit-author Steve French <stfrench@microsoft.com>
commit e3ee9fb22652f228225c352bd4fabec330cac5f0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.82.1.el8_10/e3ee9fb2.failed

A recent change to how the SMB3 server (socket) and session status
is managed regressed multiuser mounts by changing the check
for whether session setup is needed to the socket (TCP_Server_info)
structure instead of the session struct (cifs_ses). Add additional
check in cifs_setup_sesion to fix this.

Fixes: 73f9bfbe3d81 ("cifs: maintain a state machine for tcp/smb/tcon sessions")
	Reported-by: Ronnie Sahlberg <lsahlber@redhat.com>
	Acked-by: Ronnie Sahlberg <lsahlber@redhat.com>
	Reviewed-by: Shyam Prasad N <sprasad@microsoft.com>
	Signed-off-by: Steve French <stfrench@microsoft.com>
(cherry picked from commit e3ee9fb22652f228225c352bd4fabec330cac5f0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/cifs/connect.c
diff --cc fs/cifs/connect.c
index 7aabd597027d,d3020abfe404..000000000000
--- a/fs/cifs/connect.c
+++ b/fs/cifs/connect.c
@@@ -3931,6 -3922,16 +3931,19 @@@ cifs_setup_session(const unsigned int x
  	int rc = -ENOSYS;
  	bool is_binding = false;
  
++<<<<<<< HEAD
++=======
+ 	/* only send once per connect */
+ 	spin_lock(&cifs_tcp_ses_lock);
+ 	if ((server->tcpStatus != CifsNeedSessSetup) &&
+ 	    (ses->status == CifsGood)) {
+ 		spin_unlock(&cifs_tcp_ses_lock);
+ 		return 0;
+ 	}
+ 	server->tcpStatus = CifsInSessSetup;
+ 	spin_unlock(&cifs_tcp_ses_lock);
+ 
++>>>>>>> e3ee9fb22652 (smb3: fix incorrect session setup check for multiuser mounts)
  	spin_lock(&ses->chan_lock);
  	is_binding = !CIFS_ALL_CHANS_NEED_RECONNECT(ses);
  	spin_unlock(&ses->chan_lock);
* Unmerged path fs/cifs/connect.c
