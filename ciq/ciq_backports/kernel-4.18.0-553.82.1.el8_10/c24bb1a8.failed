cifs: fix missing unload_nls() in smb2_reconnect()

jira LE-4669
Rebuild_History Non-Buildable kernel-4.18.0-553.82.1.el8_10
commit-author Paulo Alcantara <pc@manguebit.com>
commit c24bb1a87dc3f2d77d410eaac2c6a295961bf50e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.82.1.el8_10/c24bb1a8.failed

Make sure to unload_nls() @nls_codepage if we no longer need it.

Fixes: bc962159e8e3 ("cifs: avoid race conditions with parallel reconnects")
	Signed-off-by: Paulo Alcantara (SUSE) <pc@manguebit.com>
	Cc: Shyam Prasad N <sprasad@microsoft.com>
	Signed-off-by: Steve French <stfrench@microsoft.com>
(cherry picked from commit c24bb1a87dc3f2d77d410eaac2c6a295961bf50e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/cifs/smb2pdu.c
diff --cc fs/cifs/smb2pdu.c
index b72fbca5ee79,20af1af34fa5..000000000000
--- a/fs/cifs/smb2pdu.c
+++ b/fs/cifs/smb2pdu.c
@@@ -143,9 -144,8 +143,9 @@@ smb2_reconnect(__le16 smb2_command, str
  	       struct TCP_Server_Info *server)
  {
  	int rc = 0;
- 	struct nls_table *nls_codepage;
+ 	struct nls_table *nls_codepage = NULL;
  	struct cifs_ses *ses;
 +	int retries;
  
  	/*
  	 * SMB2s NegProt, SessSetup, Logoff do not have tcon yet so
@@@ -240,27 -218,29 +240,32 @@@
  	cifs_dbg(FYI, "sess reconnect mask: 0x%lx, tcon reconnect: %d",
  		 tcon->ses->chans_need_reconnect,
  		 tcon->need_reconnect);
 +	spin_unlock(&ses->chan_lock);
 +
++<<<<<<< HEAD
 +	nls_codepage = load_nls_default();
  
 +	/*
 +	 * need to prevent multiple threads trying to simultaneously reconnect
 +	 * the same SMB session
 +	 */
++=======
++>>>>>>> c24bb1a87dc3 (cifs: fix missing unload_nls() in smb2_reconnect())
  	mutex_lock(&ses->session_mutex);
 +
  	/*
  	 * Recheck after acquire mutex. If another thread is negotiating
  	 * and the server never sends an answer the socket will be closed
  	 * and tcpStatus set to reconnect.
  	 */
 -	spin_lock(&server->srv_lock);
  	if (server->tcpStatus == CifsNeedReconnect) {
 -		spin_unlock(&server->srv_lock);
 -		mutex_unlock(&ses->session_mutex);
 -
 -		if (tcon->retry)
 -			goto again;
 -
  		rc = -EHOSTDOWN;
 +		mutex_unlock(&ses->session_mutex);
  		goto out;
  	}
 -	spin_unlock(&server->srv_lock);
  
+ 	nls_codepage = load_nls_default();
+ 
  	/*
  	 * need to prevent multiple threads trying to simultaneously
  	 * reconnect the same SMB session
* Unmerged path fs/cifs/smb2pdu.c
