cifs: set correct status of tcon ipc when reconnecting

jira LE-4669
Rebuild_History Non-Buildable kernel-4.18.0-553.82.1.el8_10
commit-author Paulo Alcantara <pc@cjr.nz>
commit 25cf01b7c9200d6ace5a59125d8166435dd9dea7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.82.1.el8_10/25cf01b7.failed

The status of tcon ipcs were not being set to TID_NEED_RECO when
marking sessions and tcons to be reconnected, therefore not sending
tree connect to those ipcs in cifs_tree_connect() and leaving them
disconnected.

	Cc: stable@vger.kernel.org
	Signed-off-by: Paulo Alcantara (SUSE) <pc@cjr.nz>
	Signed-off-by: Steve French <stfrench@microsoft.com>
(cherry picked from commit 25cf01b7c9200d6ace5a59125d8166435dd9dea7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/cifs/connect.c
diff --cc fs/cifs/connect.c
index d3b2aca80944,16da583536a4..000000000000
--- a/fs/cifs/connect.c
+++ b/fs/cifs/connect.c
@@@ -219,21 -244,28 +219,29 @@@ static void cifs_mark_tcp_ses_conns_for
  			cifs_chan_update_iface(ses, server);
  
  		spin_lock(&ses->chan_lock);
 -		if (!mark_smb_session && cifs_chan_needs_reconnect(ses, server))
 +		if (cifs_chan_needs_reconnect(ses, server))
  			goto next_session;
  
 -		if (mark_smb_session)
 -			CIFS_SET_ALL_CHANS_NEED_RECONNECT(ses);
 -		else
 -			cifs_chan_set_need_reconnect(ses, server);
 +		cifs_chan_set_need_reconnect(ses, server);
  
  		/* If all channels need reconnect, then tcon needs reconnect */
 -		if (!mark_smb_session && !CIFS_ALL_CHANS_NEED_RECONNECT(ses))
 +		if (!CIFS_ALL_CHANS_NEED_RECONNECT(ses))
  			goto next_session;
  
 -		ses->ses_status = SES_NEED_RECON;
 +		num_sessions++;
  
 -		list_for_each_entry(tcon, &ses->tcon_list, tcon_list) {
 +		list_for_each_entry(tcon, &ses->tcon_list, tcon_list)
  			tcon->need_reconnect = true;
++<<<<<<< HEAD
 +		if (ses->tcon_ipc)
++=======
+ 			tcon->status = TID_NEED_RECON;
+ 		}
+ 		if (ses->tcon_ipc) {
++>>>>>>> 25cf01b7c920 (cifs: set correct status of tcon ipc when reconnecting)
  			ses->tcon_ipc->need_reconnect = true;
+ 			ses->tcon_ipc->status = TID_NEED_RECON;
+ 		}
  
  next_session:
  		spin_unlock(&ses->chan_lock);
* Unmerged path fs/cifs/connect.c
