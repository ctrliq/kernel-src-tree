cifs: protect access of TCP_Server_Info::{dstaddr,hostname}

jira LE-4669
Rebuild_History Non-Buildable kernel-4.18.0-553.82.1.el8_10
commit-author Paulo Alcantara <pc@cjr.nz>
commit 39a154fc2d172a3a5865e5a9fa2a2983eb7a99ac
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.82.1.el8_10/39a154fc.failed

Use the appropriate locks to protect access of hostname and dstaddr
fields in cifs_tree_connect() as they might get changed by other
tasks.

	Signed-off-by: Paulo Alcantara (SUSE) <pc@cjr.nz>
	Reviewed-by: Enzo Matsumiya <ematsumiya@suse.de>
	Signed-off-by: Steve French <stfrench@microsoft.com>
(cherry picked from commit 39a154fc2d172a3a5865e5a9fa2a2983eb7a99ac)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/cifs/dfs.c
#	fs/cifs/misc.c
diff --cc fs/cifs/misc.c
index 8fdd91a0addb,2a19c7987c5b..000000000000
--- a/fs/cifs/misc.c
+++ b/fs/cifs/misc.c
@@@ -1117,29 -1271,17 +1117,35 @@@ int match_target_ip(struct TCP_Server_I
  
  	cifs_dbg(FYI, "%s: target name: %s\n", __func__, target + 2);
  
 -	rc = dns_resolve_server_name_to_ip(target, (struct sockaddr *)&ss, NULL);
 -	kfree(target);
 -
 +	rc = dns_resolve_server_name_to_ip(target, &tip, NULL);
  	if (rc < 0)
 -		return rc;
 +		goto out;
 +
++<<<<<<< HEAD
 +	cifs_dbg(FYI, "%s: target ip: %s\n", __func__, tip);
 +
 +	if (!cifs_convert_address(&tipaddr, tip, strlen(tip))) {
 +		cifs_dbg(VFS, "%s: failed to convert target ip address\n",
 +			 __func__);
 +		rc = -EINVAL;
 +		goto out;
 +	}
  
 +	*result = cifs_match_ipaddr((struct sockaddr *)&server->dstaddr,
 +				    &tipaddr);
++=======
+ 	spin_lock(&server->srv_lock);
+ 	*result = cifs_match_ipaddr((struct sockaddr *)&server->dstaddr, (struct sockaddr *)&ss);
+ 	spin_unlock(&server->srv_lock);
++>>>>>>> 39a154fc2d17 (cifs: protect access of TCP_Server_Info::{dstaddr,hostname})
  	cifs_dbg(FYI, "%s: ip addresses match: %u\n", __func__, *result);
 -	return 0;
 +	rc = 0;
 +
 +out:
 +	kfree(target);
 +	kfree(tip);
 +
 +	return rc;
  }
  
  int cifs_update_super_prepath(struct cifs_sb_info *cifs_sb, char *prefix)
* Unmerged path fs/cifs/dfs.c
* Unmerged path fs/cifs/dfs.c
* Unmerged path fs/cifs/misc.c
