ext4: factor out a common helper to query extent map

jira LE-4669
Rebuild_History Non-Buildable kernel-4.18.0-553.82.1.el8_10
commit-author Zhang Yi <yi.zhang@huawei.com>
commit 8e4e5cdf2fdeb99445a468b6b6436ad79b9ecb30
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.82.1.el8_10/8e4e5cdf.failed

Factor out a new common helper ext4_map_query_blocks() from the
ext4_da_map_blocks(), it query and return the extent map status on the
inode's extent path, no logic changes.

	Signed-off-by: Zhang Yi <yi.zhang@huawei.com>
	Reviewed-by: Jan Kara <jack@suse.cz>
	Reviewed-by: Ritesh Harjani (IBM) <ritesh.list@gmail.com>
Link: https://patch.msgid.link/20240517124005.347221-2-yi.zhang@huaweicloud.com
	Signed-off-by: Theodore Ts'o <tytso@mit.edu>
(cherry picked from commit 8e4e5cdf2fdeb99445a468b6b6436ad79b9ecb30)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/ext4/inode.c
diff --cc fs/ext4/inode.c
index 49ebe49ee7e4,168819b4db01..000000000000
--- a/fs/ext4/inode.c
+++ b/fs/ext4/inode.c
@@@ -1921,52 -1773,22 +1950,57 @@@ static int ext4_da_map_blocks(struct in
  	down_read(&EXT4_I(inode)->i_data_sem);
  	if (ext4_has_inline_data(inode))
  		retval = 0;
- 	else if (ext4_test_inode_flag(inode, EXT4_INODE_EXTENTS))
- 		retval = ext4_ext_map_blocks(NULL, inode, map, 0);
  	else
++<<<<<<< HEAD
 +		retval = ext4_ind_map_blocks(NULL, inode, map, 0);
 +
 +add_delayed:
 +	if (retval == 0) {
 +		int ret;
 +
 +		/*
 +		 * XXX: __block_prepare_write() unmaps passed block,
 +		 * is it OK?
 +		 */
 +
 +		ret = ext4_insert_delayed_block(inode, map->m_lblk);
 +		if (ret != 0) {
 +			retval = ret;
 +			goto out_unlock;
 +		}
 +
 +		map_bh(bh, inode->i_sb, invalid_block);
 +		set_buffer_new(bh);
 +		set_buffer_delay(bh);
 +	} else if (retval > 0) {
 +		int ret;
 +		unsigned int status;
 +
 +		if (unlikely(retval != map->m_len)) {
 +			ext4_warning(inode->i_sb,
 +				     "ES len assertion failed for inode "
 +				     "%lu: retval %d != map->m_len %d",
 +				     inode->i_ino, retval, map->m_len);
 +			WARN_ON(1);
 +		}
 +
 +		status = map->m_flags & EXT4_MAP_UNWRITTEN ?
 +				EXTENT_STATUS_UNWRITTEN : EXTENT_STATUS_WRITTEN;
 +		ret = ext4_es_insert_extent(inode, map->m_lblk, map->m_len,
 +					    map->m_pblk, status);
 +		if (ret != 0)
 +			retval = ret;
 +	}
++=======
+ 		retval = ext4_map_query_blocks(NULL, inode, map);
+ 	up_read(&EXT4_I(inode)->i_data_sem);
+ 	if (retval)
+ 		return retval;
++>>>>>>> 8e4e5cdf2fde (ext4: factor out a common helper to query extent map)
  
 -add_delayed:
 -	down_write(&EXT4_I(inode)->i_data_sem);
 -	retval = ext4_insert_delayed_block(inode, map->m_lblk);
 -	up_write(&EXT4_I(inode)->i_data_sem);
 -	if (retval)
 -		return retval;
 +out_unlock:
 +	up_read((&EXT4_I(inode)->i_data_sem));
  
 -	map_bh(bh, inode->i_sb, invalid_block);
 -	set_buffer_new(bh);
 -	set_buffer_delay(bh);
  	return retval;
  }
  
* Unmerged path fs/ext4/inode.c
