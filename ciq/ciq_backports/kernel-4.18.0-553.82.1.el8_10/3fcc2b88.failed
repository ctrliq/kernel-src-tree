ext4: refactor ext4_da_map_blocks()

jira LE-4669
Rebuild_History Non-Buildable kernel-4.18.0-553.82.1.el8_10
commit-author Zhang Yi <yi.zhang@huawei.com>
commit 3fcc2b887a1ba4c1f45319cd8c54daa263ecbc36
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.82.1.el8_10/3fcc2b88.failed

Refactor and cleanup ext4_da_map_blocks(), reduce some unnecessary
parameters and branches, no logic changes.

	Signed-off-by: Zhang Yi <yi.zhang@huawei.com>
	Reviewed-by: Jan Kara <jack@suse.cz>
Link: https://lore.kernel.org/r/20240127015825.1608160-2-yi.zhang@huaweicloud.com
	Signed-off-by: Theodore Ts'o <tytso@mit.edu>
(cherry picked from commit 3fcc2b887a1ba4c1f45319cd8c54daa263ecbc36)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/ext4/inode.c
diff --cc fs/ext4/inode.c
index 49ebe49ee7e4,bbd5ee6dd3f3..000000000000
--- a/fs/ext4/inode.c
+++ b/fs/ext4/inode.c
@@@ -1878,9 -1702,8 +1878,8 @@@ static int ext4_da_map_blocks(struct in
  		  (unsigned long) map->m_lblk);
  
  	/* Lookup extent status tree firstly */
 -	if (ext4_es_lookup_extent(inode, iblock, NULL, &es)) {
 +	if (ext4_es_lookup_extent(inode, iblock, &es)) {
  		if (ext4_es_is_hole(&es)) {
- 			retval = 0;
  			down_read(&EXT4_I(inode)->i_data_sem);
  			goto add_delayed;
  		}
@@@ -1925,27 -1748,9 +1924,33 @@@
  		retval = ext4_ext_map_blocks(NULL, inode, map, 0);
  	else
  		retval = ext4_ind_map_blocks(NULL, inode, map, 0);
++<<<<<<< HEAD
 +
 +add_delayed:
 +	if (retval == 0) {
 +		int ret;
 +
 +		/*
 +		 * XXX: __block_prepare_write() unmaps passed block,
 +		 * is it OK?
 +		 */
 +
 +		ret = ext4_insert_delayed_block(inode, map->m_lblk);
 +		if (ret != 0) {
 +			retval = ret;
 +			goto out_unlock;
 +		}
 +
 +		map_bh(bh, inode->i_sb, invalid_block);
 +		set_buffer_new(bh);
 +		set_buffer_delay(bh);
 +	} else if (retval > 0) {
 +		int ret;
++=======
+ 	if (retval < 0)
+ 		goto out_unlock;
+ 	if (retval > 0) {
++>>>>>>> 3fcc2b887a1b (ext4: refactor ext4_da_map_blocks())
  		unsigned int status;
  
  		if (unlikely(retval != map->m_len)) {
@@@ -1958,15 -1763,26 +1963,33 @@@
  
  		status = map->m_flags & EXT4_MAP_UNWRITTEN ?
  				EXTENT_STATUS_UNWRITTEN : EXTENT_STATUS_WRITTEN;
++<<<<<<< HEAD
 +		ret = ext4_es_insert_extent(inode, map->m_lblk, map->m_len,
 +					    map->m_pblk, status);
 +		if (ret != 0)
 +			retval = ret;
++=======
+ 		ext4_es_insert_extent(inode, map->m_lblk, map->m_len,
+ 				      map->m_pblk, status);
+ 		goto out_unlock;
++>>>>>>> 3fcc2b887a1b (ext4: refactor ext4_da_map_blocks())
  	}
  
+ add_delayed:
+ 	/*
+ 	 * XXX: __block_prepare_write() unmaps passed block,
+ 	 * is it OK?
+ 	 */
+ 	retval = ext4_insert_delayed_block(inode, map->m_lblk);
+ 	if (retval)
+ 		goto out_unlock;
+ 
+ 	map_bh(bh, inode->i_sb, invalid_block);
+ 	set_buffer_new(bh);
+ 	set_buffer_delay(bh);
+ 
  out_unlock:
  	up_read((&EXT4_I(inode)->i_data_sem));
- 
  	return retval;
  }
  
* Unmerged path fs/ext4/inode.c
