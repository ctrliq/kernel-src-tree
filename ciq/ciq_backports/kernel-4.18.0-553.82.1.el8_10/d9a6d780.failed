cifs: force interface update before a fresh session setup

jira LE-4669
Rebuild_History Non-Buildable kernel-4.18.0-553.82.1.el8_10
commit-author Shyam Prasad N <sprasad@microsoft.com>
commit d9a6d78096056a3cb5c5f07a730ab92f2f9ac4e6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.82.1.el8_10/d9a6d780.failed

During a session reconnect, it is possible that the
server moved to another physical server (happens in case
of Azure files). So at this time, force a query of server
interfaces again (in case of multichannel session), such
that the secondary channels connect to the right
IP addresses (possibly updated now).

	Cc: stable@vger.kernel.org
	Signed-off-by: Shyam Prasad N <sprasad@microsoft.com>
	Signed-off-by: Steve French <stfrench@microsoft.com>
(cherry picked from commit d9a6d78096056a3cb5c5f07a730ab92f2f9ac4e6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/cifs/connect.c
diff --cc fs/cifs/connect.c
index ca2926c7b59e,1a137b33858a..000000000000
--- a/fs/cifs/connect.c
+++ b/fs/cifs/connect.c
@@@ -3965,6 -3840,31 +3965,25 @@@ cifs_setup_session(const unsigned int x
  	is_binding = !CIFS_ALL_CHANS_NEED_RECONNECT(ses);
  	spin_unlock(&ses->chan_lock);
  
++<<<<<<< HEAD:fs/cifs/connect.c
++=======
+ 	if (!is_binding) {
+ 		ses->ses_status = SES_IN_SETUP;
+ 
+ 		/* force iface_list refresh */
+ 		ses->iface_last_update = 0;
+ 	}
+ 	spin_unlock(&ses->ses_lock);
+ 
+ 	/* update ses ip_addr only for primary chan */
+ 	if (server == pserver) {
+ 		if (server->dstaddr.ss_family == AF_INET6)
+ 			scnprintf(ses->ip_addr, sizeof(ses->ip_addr), "%pI6", &addr6->sin6_addr);
+ 		else
+ 			scnprintf(ses->ip_addr, sizeof(ses->ip_addr), "%pI4", &addr->sin_addr);
+ 	}
+ 
++>>>>>>> d9a6d7809605 (cifs: force interface update before a fresh session setup):fs/smb/client/connect.c
  	if (!is_binding) {
  		ses->capabilities = server->capabilities;
  		if (!linuxExtEnabled)
* Unmerged path fs/cifs/connect.c
