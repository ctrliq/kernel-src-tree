block: don't call rq_qos_ops->done_bio if the bio isn't tracked

jira LE-1907
cve CVE-2021-47412
Rebuild_History Non-Buildable kernel-4.18.0-553.22.1.el8_10
commit-author Ming Lei <ming.lei@redhat.com>
commit a647a524a46736786c95cdb553a070322ca096e3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.22.1.el8_10/a647a524.failed

rq_qos framework is only applied on request based driver, so:

1) rq_qos_done_bio() needn't to be called for bio based driver

2) rq_qos_done_bio() needn't to be called for bio which isn't tracked,
such as bios ended from error handling code.

Especially in bio_endio():

1) request queue is referred via bio->bi_bdev->bd_disk->queue, which
may be gone since request queue refcount may not be held in above two
cases

2) q->rq_qos may be freed in blk_cleanup_queue() when calling into
__rq_qos_done_bio()

Fix the potential kernel panic by not calling rq_qos_ops->done_bio if
the bio isn't tracked. This way is safe because both ioc_rqos_done_bio()
and blkcg_iolatency_done_bio() are nop if the bio isn't tracked.

	Reported-by: Yu Kuai <yukuai3@huawei.com>
	Cc: tj@kernel.org
	Signed-off-by: Ming Lei <ming.lei@redhat.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Acked-by: Tejun Heo <tj@kernel.org>
Link: https://lore.kernel.org/r/20210924110704.1541818-1-ming.lei@redhat.com
	Signed-off-by: Jens Axboe <axboe@kernel.dk>
(cherry picked from commit a647a524a46736786c95cdb553a070322ca096e3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	block/bio.c
diff --cc block/bio.c
index aec841965f66,a6fb6a0b4295..000000000000
--- a/block/bio.c
+++ b/block/bio.c
@@@ -2002,11 -1466,11 +2002,16 @@@ again
  	if (!bio_integrity_endio(bio))
  		return;
  
++<<<<<<< HEAD
 +	if (bio->bi_disk)
 +		rq_qos_done_bio(bio->bi_disk->queue, bio);
++=======
+ 	if (bio->bi_bdev && bio_flagged(bio, BIO_TRACKED))
+ 		rq_qos_done_bio(bio->bi_bdev->bd_disk->queue, bio);
++>>>>>>> a647a524a467 (block: don't call rq_qos_ops->done_bio if the bio isn't tracked)
  
 -	if (bio->bi_bdev && bio_flagged(bio, BIO_TRACE_COMPLETION)) {
 -		trace_block_bio_complete(bio->bi_bdev->bd_disk->queue, bio);
 +	if (bio->bi_disk && bio_flagged(bio, BIO_TRACE_COMPLETION)) {
 +		trace_block_bio_complete(bio->bi_disk->queue, bio);
  		bio_clear_flag(bio, BIO_TRACE_COMPLETION);
  	}
  
* Unmerged path block/bio.c
