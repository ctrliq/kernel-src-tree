x86/mce/therm_throt: Undo thermal polling properly on CPU offline

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-553.22.1.el8_10
commit-author Thomas Gleixner <tglx@linutronix.de>
commit d364847eed890211444ad74496bb549f838c6018
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.22.1.el8_10/d364847e.failed

Chris Wilson reported splats from running the thermal throttling
workqueue callback on offlined CPUs. The problem is that that callback
should not even run on offlined CPUs but it happens nevertheless because
the offlining callback thermal_throttle_offline() does not symmetrically
undo the setup work done in its onlining counterpart. IOW,

 1. The thermal interrupt vector should be masked out before ...

 2. ... cancelling any pending work synchronously so that no new work is
 enqueued anymore.

Do those things and fix the issue properly.

 [ bp: Write commit message. ]

Fixes: f6656208f04e ("x86/mce/therm_throt: Optimize notifications of thermal throttle")
	Reported-by: Chris Wilson <chris@chris-wilson.co.uk>
	Tested-by: Pandruvada, Srinivas <srinivas.pandruvada@linux.intel.com>
	Signed-off-by: Thomas Gleixner <tglx@linutronix.de>
	Signed-off-by: Borislav Petkov <bp@suse.de>
Link: https://lkml.kernel.org/r/158120068234.18291.7938335950259651295@skylake-alporthouse-com
(cherry picked from commit d364847eed890211444ad74496bb549f838c6018)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/thermal/intel/therm_throt.c
diff --cc drivers/thermal/intel/therm_throt.c
index 4845b553feb3,f36dc0742085..000000000000
--- a/drivers/thermal/intel/therm_throt.c
+++ b/drivers/thermal/intel/therm_throt.c
@@@ -287,9 -484,19 +287,22 @@@ static int thermal_throttle_online(unsi
  
  static int thermal_throttle_offline(unsigned int cpu)
  {
 -	struct thermal_state *state = &per_cpu(thermal_state, cpu);
  	struct device *dev = get_cpu_device(cpu);
+ 	u32 l;
  
++<<<<<<< HEAD:drivers/thermal/intel/therm_throt.c
 +	intel_hfi_offline(cpu);
++=======
+ 	/* Mask the thermal vector before draining evtl. pending work */
+ 	l = apic_read(APIC_LVTTHMR);
+ 	apic_write(APIC_LVTTHMR, l | APIC_LVT_MASKED);
+ 
+ 	cancel_delayed_work_sync(&state->package_throttle.therm_work);
+ 	cancel_delayed_work_sync(&state->core_throttle.therm_work);
+ 
+ 	state->package_throttle.rate_control_active = false;
+ 	state->core_throttle.rate_control_active = false;
++>>>>>>> d364847eed89 (x86/mce/therm_throt: Undo thermal polling properly on CPU offline):arch/x86/kernel/cpu/mce/therm_throt.c
  
  	thermal_throttle_remove_dev(dev);
  	return 0;
* Unmerged path drivers/thermal/intel/therm_throt.c
