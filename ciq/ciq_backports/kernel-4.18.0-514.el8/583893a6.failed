thunderbolt: Fix Thunderbolt 3 display flickering issue on 2nd hot plug onwards

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-514.el8
commit-author Sanjay R Mehta <sanju.mehta@amd.com>
commit 583893a66d731f5da010a3fa38a0460e05f0149b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-514.el8/583893a6.failed

Previously, on unplug events, the TMU mode was disabled first
followed by the Time Synchronization Handshake, irrespective of
whether the tb_switch_tmu_rate_write() API was successful or not.

However, this caused a problem with Thunderbolt 3 (TBT3)
devices, as the TSPacketInterval bits were always enabled by default,
leading the host router to assume that the device router's TMU was
already enabled and preventing it from initiating the Time
Synchronization Handshake. As a result, TBT3 monitors experienced
display flickering from the second hot plug onwards.

To address this issue, we have modified the code to only disable the
Time Synchronization Handshake during TMU disable if the
tb_switch_tmu_rate_write() function is successful. This ensures that
the TBT3 devices function correctly and eliminates the display
flickering issue.

Co-developed-by: Sanath S <Sanath.S@amd.com>
	Signed-off-by: Sanath S <Sanath.S@amd.com>
	Signed-off-by: Sanjay R Mehta <sanju.mehta@amd.com>
	Cc: stable@vger.kernel.org
	Signed-off-by: Mika Westerberg <mika.westerberg@linux.intel.com>
(cherry picked from commit 583893a66d731f5da010a3fa38a0460e05f0149b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/thunderbolt/tmu.c
diff --cc drivers/thunderbolt/tmu.c
index 626aca3124b1,0dfd1e083994..000000000000
--- a/drivers/thunderbolt/tmu.c
+++ b/drivers/thunderbolt/tmu.c
@@@ -415,7 -579,9 +415,13 @@@ int tb_switch_tmu_disable(struct tb_swi
  		 * uni-directional mode and we don't want to change it's TMU
  		 * mode.
  		 */
++<<<<<<< HEAD
 +		tb_switch_tmu_rate_write(sw, TB_SWITCH_TMU_RATE_OFF);
++=======
+ 		ret = tb_switch_tmu_rate_write(sw, tmu_rates[TB_SWITCH_TMU_MODE_OFF]);
+ 		if (ret)
+ 			return ret;
++>>>>>>> 583893a66d73 (thunderbolt: Fix Thunderbolt 3 display flickering issue on 2nd hot plug onwards)
  
  		tb_port_tmu_time_sync_disable(up);
  		ret = tb_port_tmu_time_sync_disable(down);
* Unmerged path drivers/thunderbolt/tmu.c
