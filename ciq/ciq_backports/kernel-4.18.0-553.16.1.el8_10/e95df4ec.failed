x86/mmio: Disable KVM mitigation when X86_FEATURE_CLEAR_CPU_BUF is set

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-553.16.1.el8_10
commit-author Pawan Gupta <pawan.kumar.gupta@linux.intel.com>
commit e95df4ec0c0c9791941f112db699fae794b9862a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.16.1.el8_10/e95df4ec.failed

Currently MMIO Stale Data mitigation for CPUs not affected by MDS/TAA is
to only deploy VERW at VMentry by enabling mmio_stale_data_clear static
branch. No mitigation is needed for kernel->user transitions. If such
CPUs are also affected by RFDS, its mitigation may set
X86_FEATURE_CLEAR_CPU_BUF to deploy VERW at kernel->user and VMentry.
This could result in duplicate VERW at VMentry.

Fix this by disabling mmio_stale_data_clear static branch when
X86_FEATURE_CLEAR_CPU_BUF is enabled.

	Signed-off-by: Pawan Gupta <pawan.kumar.gupta@linux.intel.com>
	Signed-off-by: Dave Hansen <dave.hansen@linux.intel.com>
	Reviewed-by: Dave Hansen <dave.hansen@linux.intel.com>
(cherry picked from commit e95df4ec0c0c9791941f112db699fae794b9862a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/cpu/bugs.c
diff --cc arch/x86/kernel/cpu/bugs.c
index 67d8c595487c,cd6ac89c1a0d..000000000000
--- a/arch/x86/kernel/cpu/bugs.c
+++ b/arch/x86/kernel/cpu/bugs.c
@@@ -465,7 -421,14 +465,18 @@@ static void __init mmio_select_mitigati
  	 */
  	if (boot_cpu_has_bug(X86_BUG_MDS) || (boot_cpu_has_bug(X86_BUG_TAA) &&
  					      boot_cpu_has(X86_FEATURE_RTM)))
++<<<<<<< HEAD
 +		static_branch_enable(&mds_user_clear);
++=======
+ 		setup_force_cpu_cap(X86_FEATURE_CLEAR_CPU_BUF);
+ 
+ 	/*
+ 	 * X86_FEATURE_CLEAR_CPU_BUF could be enabled by other VERW based
+ 	 * mitigations, disable KVM-only mitigation in that case.
+ 	 */
+ 	if (boot_cpu_has(X86_FEATURE_CLEAR_CPU_BUF))
+ 		static_branch_disable(&mmio_stale_data_clear);
++>>>>>>> e95df4ec0c0c (x86/mmio: Disable KVM mitigation when X86_FEATURE_CLEAR_CPU_BUF is set)
  	else
  		static_branch_enable(&mmio_stale_data_clear);
  
* Unmerged path arch/x86/kernel/cpu/bugs.c
