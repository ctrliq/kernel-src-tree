wifi: mac80211: refactor adding rates to assoc request

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Johannes Berg <johannes.berg@intel.com>
commit c1690b66ba7016a5c25dc1fb77133cbf64622fcc
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/c1690b66.failed

There's some awkward code that really only exists
because we want to optimize the allocation size,
but that's not really all that necessary.

Refactor the code that adds rates to the association
request frame to have a separate function, removing
the goto.

	Signed-off-by: Johannes Berg <johannes.berg@intel.com>
(cherry picked from commit c1690b66ba7016a5c25dc1fb77133cbf64622fcc)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/mac80211/mlme.c
diff --cc net/mac80211/mlme.c
index 38beaaa3d3f9,c1904acf7c4e..000000000000
--- a/net/mac80211/mlme.c
+++ b/net/mac80211/mlme.c
@@@ -806,31 -878,6 +874,34 @@@ static int ieee80211_send_assoc(struct 
  	chan = chanctx_conf->def.chan;
  	rcu_read_unlock();
  	sband = local->hw.wiphy->bands[chan->band];
++<<<<<<< HEAD
 +	shift = ieee80211_vif_get_shift(&sdata->vif);
 +
 +	if (assoc_data->supp_rates_len) {
 +		/*
 +		 * Get all rates supported by the device and the AP as
 +		 * some APs don't like getting a superset of their rates
 +		 * in the association request (e.g. D-Link DAP 1353 in
 +		 * b-only mode)...
 +		 */
 +		rates_len = ieee80211_parse_bitrates(&chanctx_conf->def, sband,
 +						     assoc_data->supp_rates,
 +						     assoc_data->supp_rates_len,
 +						     &rates);
 +	} else {
 +		/*
 +		 * In case AP not provide any supported rates information
 +		 * before association, we send information element(s) with
 +		 * all rates that we support.
 +		 */
 +		rates_len = 0;
 +		for (i = 0; i < sband->n_bitrates; i++) {
 +			rates |= BIT(i);
 +			rates_len++;
 +		}
 +	}
++=======
++>>>>>>> c1690b66ba70 (wifi: mac80211: refactor adding rates to assoc request)
  
  	iftd = ieee80211_get_sband_iftype_data(sband, iftype);
  
* Unmerged path net/mac80211/mlme.c
