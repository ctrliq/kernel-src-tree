ceph: don't truncate file in atomic_open

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Hu Weiwen <sehuww@mail.scut.edu.cn>
commit 7cb9994754f8a36ae9e5ec4597c5c4c2d6c03832
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/7cb99947.failed

Clear O_TRUNC from the flags sent in the MDS create request.

`atomic_open' is called before permission check. We should not do any
modification to the file here. The caller will do the truncation
afterward.

Fixes: 124e68e74099 ("ceph: file operations")
	Signed-off-by: Hu Weiwen <sehuww@mail.scut.edu.cn>
	Reviewed-by: Xiubo Li <xiubli@redhat.com>
	Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
(cherry picked from commit 7cb9994754f8a36ae9e5ec4597c5c4c2d6c03832)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/ceph/file.c
diff --cc fs/ceph/file.c
index 11352195bf50,b4e978420802..000000000000
--- a/fs/ceph/file.c
+++ b/fs/ceph/file.c
@@@ -701,6 -746,15 +701,18 @@@ int ceph_atomic_open(struct inode *dir
  	if (dentry->d_name.len > NAME_MAX)
  		return -ENAMETOOLONG;
  
++<<<<<<< HEAD
++=======
+ 	err = ceph_wait_on_conflict_unlink(dentry);
+ 	if (err)
+ 		return err;
+ 	/*
+ 	 * Do not truncate the file, since atomic_open is called before the
+ 	 * permission check. The caller will do the truncation afterward.
+ 	 */
+ 	flags &= ~O_TRUNC;
+ 
++>>>>>>> 7cb9994754f8 (ceph: don't truncate file in atomic_open)
  	if (flags & O_CREAT) {
  		if (ceph_quota_is_max_files_exceeded(dir))
  			return -EDQUOT;
* Unmerged path fs/ceph/file.c
