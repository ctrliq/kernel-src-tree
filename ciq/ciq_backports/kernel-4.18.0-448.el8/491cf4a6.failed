ACPI/IORT: Add support to retrieve IORT RMR reserved regions

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Shameer Kolothum <shameerali.kolothum.thodi@huawei.com>
commit 491cf4a6735a957cd0733365f8d17e0f4308f5a4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/491cf4a6.failed

Parse through the IORT RMR nodes and populate the reserve region list
corresponding to a given IOMMU and device(optional). Also, go through
the ID mappings of the RMR node and retrieve all the SIDs associated
with it.

	Reviewed-by: Lorenzo Pieralisi <lorenzo.pieralisi@arm.com>
	Tested-by: Steven Price <steven.price@arm.com>
	Tested-by: Laurentiu Tudor <laurentiu.tudor@nxp.com>
	Tested-by: Hanjun Guo <guohanjun@huawei.com>
	Reviewed-by: Hanjun Guo <guohanjun@huawei.com>
	Signed-off-by: Shameer Kolothum <shameerali.kolothum.thodi@huawei.com>
	Acked-by: Robin Murphy <robin.murphy@arm.com>
Link: https://lore.kernel.org/r/20220615101044.1972-5-shameerali.kolothum.thodi@huawei.com
	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit 491cf4a6735a957cd0733365f8d17e0f4308f5a4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/acpi/arm64/iort.c
diff --cc drivers/acpi/arm64/iort.c
index 387675a639bf,b6273af316c6..000000000000
--- a/drivers/acpi/arm64/iort.c
+++ b/drivers/acpi/arm64/iort.c
@@@ -885,14 -1143,23 +1173,28 @@@ int iort_iommu_msi_get_resv_regions(str
  
  			region = iommu_alloc_resv_region(base + SZ_64K, SZ_64K,
  							 prot, IOMMU_RESV_MSI);
 -			if (region)
 +			if (region) {
  				list_add_tail(&region->list, head);
 +				resv++;
 +			}
  		}
  	}
 -}
  
++<<<<<<< HEAD
 +	return (resv == its->its_count) ? resv : -ENODEV;
++=======
+ /**
+  * iort_iommu_get_resv_regions - Generic helper to retrieve reserved regions.
+  * @dev: Device from iommu_get_resv_regions()
+  * @head: Reserved region list from iommu_get_resv_regions()
+  */
+ void iort_iommu_get_resv_regions(struct device *dev, struct list_head *head)
+ {
+ 	struct iommu_fwspec *fwspec = dev_iommu_fwspec_get(dev);
+ 
+ 	iort_iommu_msi_get_resv_regions(dev, head);
+ 	iort_iommu_rmr_get_resv_regions(fwspec->iommu_fwnode, dev, head);
++>>>>>>> 491cf4a6735a (ACPI/IORT: Add support to retrieve IORT RMR reserved regions)
  }
  
  static inline bool iort_iommu_driver_enabled(u8 type)
* Unmerged path drivers/acpi/arm64/iort.c
diff --git a/include/linux/iommu.h b/include/linux/iommu.h
index 3d8eac931f9c..d78b10968037 100644
--- a/include/linux/iommu.h
+++ b/include/linux/iommu.h
@@ -160,6 +160,14 @@ struct iommu_resv_region {
 	void (*free)(struct device *dev, struct iommu_resv_region *region);
 };
 
+struct iommu_iort_rmr_data {
+	struct iommu_resv_region rr;
+
+	/* Stream IDs associated with IORT RMR entry */
+	const u32 *sids;
+	u32 num_sids;
+};
+
 /**
  * enum iommu_dev_features - Per device IOMMU features
  * @IOMMU_DEV_FEAT_AUX: Auxiliary domain feature
