wifi: mac80211: expect powersave handling in driver for MLO

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Johannes Berg <johannes.berg@intel.com>
commit 8c7c6b581987dda035c73661cf83973a02a055d8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/8c7c6b58.failed

In MLO, expect the driver fully handles powersave handling,
including tracking whether or not a beacon was received,
the DTIM period, etc.

	Signed-off-by: Johannes Berg <johannes.berg@intel.com>
(cherry picked from commit 8c7c6b581987dda035c73661cf83973a02a055d8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/mac80211/mlme.c
diff --cc net/mac80211/mlme.c
index 6cd411ed25d6,5400b3e567fa..000000000000
--- a/net/mac80211/mlme.c
+++ b/net/mac80211/mlme.c
@@@ -1801,7 -1803,8 +1802,12 @@@ static bool ieee80211_powersave_allowed
  	if (mgd->flags & IEEE80211_STA_CONNECTION_POLL)
  		return false;
  
++<<<<<<< HEAD
 +	if (!mgd->have_beacon)
++=======
+ 	if (!(local->hw.wiphy->flags & WIPHY_FLAG_SUPPORTS_MLO) &&
+ 	    !sdata->deflink.u.mgd.have_beacon)
++>>>>>>> 8c7c6b581987 (wifi: mac80211: expect powersave handling in driver for MLO)
  		return false;
  
  	rcu_read_lock();
diff --git a/net/mac80211/main.c b/net/mac80211/main.c
index ae06e4025b16..5e26268ee562 100644
--- a/net/mac80211/main.c
+++ b/net/mac80211/main.c
@@ -907,7 +907,8 @@ int ieee80211_register_hw(struct ieee80211_hw *hw)
 			return -EINVAL;
 
 		if (WARN_ON(ieee80211_hw_check(hw, SUPPORTS_PS) &&
-			    !ieee80211_hw_check(hw, SUPPORTS_DYNAMIC_PS)))
+			    (!ieee80211_hw_check(hw, SUPPORTS_DYNAMIC_PS) ||
+			     ieee80211_hw_check(hw, PS_NULLFUNC_STACK))))
 			return -EINVAL;
 
 		if (WARN_ON(!ieee80211_hw_check(hw, MFP_CAPABLE)))
* Unmerged path net/mac80211/mlme.c
