ASoC: wm_adsp: Move sys_config_size to wm_adsp

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Charles Keepax <ckeepax@opensource.cirrus.com>
commit 6092be2d93b3b28dfeca4e5944052a1a21f51ca3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/6092be2d.failed

sys_config_size is part of the compressed stream support, move it from
what will become generic DSP code so that it remains in ASoC.

	Signed-off-by: Charles Keepax <ckeepax@opensource.cirrus.com>
	Signed-off-by: Simon Trimmer <simont@opensource.cirrus.com>
Link: https://lore.kernel.org/r/20210913160057.103842-10-simont@opensource.cirrus.com
	Signed-off-by: Mark Brown <broonie@kernel.org>
(cherry picked from commit 6092be2d93b3b28dfeca4e5944052a1a21f51ca3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/soc/codecs/wm_adsp.c
#	sound/soc/codecs/wm_adsp.h
diff --cc sound/soc/codecs/wm_adsp.c
index c1b5ea3b5718,82038cac4286..000000000000
--- a/sound/soc/codecs/wm_adsp.c
+++ b/sound/soc/codecs/wm_adsp.c
@@@ -3390,25 -3460,37 +3390,41 @@@ int wm_adsp2_init(struct wm_adsp *dsp
  		break;
  	}
  
 -	return cs_dsp_common_init(dsp);
 -}
 -
 -int wm_adsp2_init(struct wm_adsp *dsp)
 -{
  	INIT_WORK(&dsp->boot_work, wm_adsp_boot_work);
  
++<<<<<<< HEAD
 +	return 0;
++=======
+ 	dsp->sys_config_size = sizeof(struct wm_adsp_system_config_xm_hdr);
+ 
+ 	wm_adsp_common_init(dsp);
+ 
+ 	return cs_dsp_adsp2_init(dsp);
++>>>>>>> 6092be2d93b3 (ASoC: wm_adsp: Move sys_config_size to wm_adsp)
  }
  EXPORT_SYMBOL_GPL(wm_adsp2_init);
  
 -static int cs_dsp_halo_init(struct wm_adsp *dsp)
 +int wm_halo_init(struct wm_adsp *dsp)
  {
 -	dsp->ops = &cs_dsp_halo_ops;
 +	int ret;
  
 -	return cs_dsp_common_init(dsp);
 -}
 +	ret = wm_adsp_common_init(dsp);
 +	if (ret)
 +		return ret;
 +
 +	dsp->ops = &wm_halo_ops;
  
 -int wm_halo_init(struct wm_adsp *dsp)
 -{
  	INIT_WORK(&dsp->boot_work, wm_adsp_boot_work);
  
++<<<<<<< HEAD
 +	return 0;
++=======
+ 	dsp->sys_config_size = sizeof(struct wm_halo_system_config_xm_hdr);
+ 
+ 	wm_adsp_common_init(dsp);
+ 
+ 	return cs_dsp_halo_init(dsp);
++>>>>>>> 6092be2d93b3 (ASoC: wm_adsp: Move sys_config_size to wm_adsp)
  }
  EXPORT_SYMBOL_GPL(wm_halo_init);
  
@@@ -3812,10 -3899,10 +3828,10 @@@ static int wm_adsp_buffer_parse_legacy(
  	if (!buf)
  		return -ENOMEM;
  
- 	xmalg = dsp->ops->sys_config_size / sizeof(__be32);
+ 	xmalg = dsp->sys_config_size / sizeof(__be32);
  
  	addr = alg_region->base + xmalg + ALG_XM_FIELD(magic);
 -	ret = cs_dsp_read_data_word(dsp, WMFW_ADSP2_XM, addr, &magic);
 +	ret = wm_adsp_read_data_word(dsp, WMFW_ADSP2_XM, addr, &magic);
  	if (ret < 0)
  		return ret;
  
@@@ -4479,87 -4584,83 +4495,116 @@@ irqreturn_t wm_halo_wdt_expire(int irq
  }
  EXPORT_SYMBOL_GPL(wm_halo_wdt_expire);
  
 -static const struct cs_dsp_ops cs_dsp_adsp1_ops = {
 -	.validate_version = cs_dsp_validate_version,
 -	.parse_sizes = cs_dsp_adsp1_parse_sizes,
 -	.region_to_reg = cs_dsp_region_to_reg,
 +static const struct wm_adsp_ops wm_adsp1_ops = {
 +	.validate_version = wm_adsp_validate_version,
 +	.parse_sizes = wm_adsp1_parse_sizes,
 +	.region_to_reg = wm_adsp_region_to_reg,
  };
  
 -static const struct cs_dsp_ops cs_dsp_adsp2_ops[] = {
 +static const struct wm_adsp_ops wm_adsp2_ops[] = {
  	{
++<<<<<<< HEAD
 +		.sys_config_size = sizeof(struct wm_adsp_system_config_xm_hdr),
 +		.parse_sizes = wm_adsp2_parse_sizes,
 +		.validate_version = wm_adsp_validate_version,
 +		.setup_algs = wm_adsp2_setup_algs,
 +		.region_to_reg = wm_adsp_region_to_reg,
++=======
+ 		.parse_sizes = cs_dsp_adsp2_parse_sizes,
+ 		.validate_version = cs_dsp_validate_version,
+ 		.setup_algs = cs_dsp_adsp2_setup_algs,
+ 		.region_to_reg = cs_dsp_region_to_reg,
++>>>>>>> 6092be2d93b3 (ASoC: wm_adsp: Move sys_config_size to wm_adsp)
  
 -		.show_fw_status = cs_dsp_adsp2_show_fw_status,
 +		.show_fw_status = wm_adsp2_show_fw_status,
  
 -		.enable_memory = cs_dsp_adsp2_enable_memory,
 -		.disable_memory = cs_dsp_adsp2_disable_memory,
 +		.enable_memory = wm_adsp2_enable_memory,
 +		.disable_memory = wm_adsp2_disable_memory,
  
 -		.enable_core = cs_dsp_adsp2_enable_core,
 -		.disable_core = cs_dsp_adsp2_disable_core,
 +		.enable_core = wm_adsp2_enable_core,
 +		.disable_core = wm_adsp2_disable_core,
  
 -		.start_core = cs_dsp_adsp2_start_core,
 -		.stop_core = cs_dsp_adsp2_stop_core,
 +		.start_core = wm_adsp2_start_core,
 +		.stop_core = wm_adsp2_stop_core,
  
  	},
  	{
++<<<<<<< HEAD
 +		.sys_config_size = sizeof(struct wm_adsp_system_config_xm_hdr),
 +		.parse_sizes = wm_adsp2_parse_sizes,
 +		.validate_version = wm_adsp_validate_version,
 +		.setup_algs = wm_adsp2_setup_algs,
 +		.region_to_reg = wm_adsp_region_to_reg,
++=======
+ 		.parse_sizes = cs_dsp_adsp2_parse_sizes,
+ 		.validate_version = cs_dsp_validate_version,
+ 		.setup_algs = cs_dsp_adsp2_setup_algs,
+ 		.region_to_reg = cs_dsp_region_to_reg,
++>>>>>>> 6092be2d93b3 (ASoC: wm_adsp: Move sys_config_size to wm_adsp)
  
 -		.show_fw_status = cs_dsp_adsp2v2_show_fw_status,
 +		.show_fw_status = wm_adsp2v2_show_fw_status,
  
 -		.enable_memory = cs_dsp_adsp2_enable_memory,
 -		.disable_memory = cs_dsp_adsp2_disable_memory,
 -		.lock_memory = cs_dsp_adsp2_lock,
 +		.enable_memory = wm_adsp2_enable_memory,
 +		.disable_memory = wm_adsp2_disable_memory,
 +		.lock_memory = wm_adsp2_lock,
  
 -		.enable_core = cs_dsp_adsp2v2_enable_core,
 -		.disable_core = cs_dsp_adsp2v2_disable_core,
 +		.enable_core = wm_adsp2v2_enable_core,
 +		.disable_core = wm_adsp2v2_disable_core,
  
 -		.start_core = cs_dsp_adsp2_start_core,
 -		.stop_core = cs_dsp_adsp2_stop_core,
 +		.start_core = wm_adsp2_start_core,
 +		.stop_core = wm_adsp2_stop_core,
  	},
  	{
++<<<<<<< HEAD
 +		.sys_config_size = sizeof(struct wm_adsp_system_config_xm_hdr),
 +		.parse_sizes = wm_adsp2_parse_sizes,
 +		.validate_version = wm_adsp_validate_version,
 +		.setup_algs = wm_adsp2_setup_algs,
 +		.region_to_reg = wm_adsp_region_to_reg,
++=======
+ 		.parse_sizes = cs_dsp_adsp2_parse_sizes,
+ 		.validate_version = cs_dsp_validate_version,
+ 		.setup_algs = cs_dsp_adsp2_setup_algs,
+ 		.region_to_reg = cs_dsp_region_to_reg,
++>>>>>>> 6092be2d93b3 (ASoC: wm_adsp: Move sys_config_size to wm_adsp)
  
 -		.show_fw_status = cs_dsp_adsp2v2_show_fw_status,
 -		.stop_watchdog = cs_dsp_stop_watchdog,
 +		.show_fw_status = wm_adsp2v2_show_fw_status,
 +		.stop_watchdog = wm_adsp_stop_watchdog,
  
 -		.enable_memory = cs_dsp_adsp2_enable_memory,
 -		.disable_memory = cs_dsp_adsp2_disable_memory,
 -		.lock_memory = cs_dsp_adsp2_lock,
 +		.enable_memory = wm_adsp2_enable_memory,
 +		.disable_memory = wm_adsp2_disable_memory,
 +		.lock_memory = wm_adsp2_lock,
  
 -		.enable_core = cs_dsp_adsp2v2_enable_core,
 -		.disable_core = cs_dsp_adsp2v2_disable_core,
 +		.enable_core = wm_adsp2v2_enable_core,
 +		.disable_core = wm_adsp2v2_disable_core,
  
 -		.start_core = cs_dsp_adsp2_start_core,
 -		.stop_core = cs_dsp_adsp2_stop_core,
 +		.start_core = wm_adsp2_start_core,
 +		.stop_core = wm_adsp2_stop_core,
  	},
  };
  
++<<<<<<< HEAD
 +static const struct wm_adsp_ops wm_halo_ops = {
 +	.sys_config_size = sizeof(struct wm_halo_system_config_xm_hdr),
 +	.parse_sizes = wm_adsp2_parse_sizes,
 +	.validate_version = wm_halo_validate_version,
 +	.setup_algs = wm_halo_setup_algs,
 +	.region_to_reg = wm_halo_region_to_reg,
++=======
+ static const struct cs_dsp_ops cs_dsp_halo_ops = {
+ 	.parse_sizes = cs_dsp_adsp2_parse_sizes,
+ 	.validate_version = cs_dsp_halo_validate_version,
+ 	.setup_algs = cs_dsp_halo_setup_algs,
+ 	.region_to_reg = cs_dsp_halo_region_to_reg,
++>>>>>>> 6092be2d93b3 (ASoC: wm_adsp: Move sys_config_size to wm_adsp)
  
 -	.show_fw_status = cs_dsp_halo_show_fw_status,
 -	.stop_watchdog = cs_dsp_halo_stop_watchdog,
 +	.show_fw_status = wm_halo_show_fw_status,
 +	.stop_watchdog = wm_halo_stop_watchdog,
  
 -	.lock_memory = cs_dsp_halo_configure_mpu,
 +	.lock_memory = wm_halo_configure_mpu,
  
 -	.start_core = cs_dsp_halo_start_core,
 -	.stop_core = cs_dsp_halo_stop_core,
 +	.start_core = wm_halo_start_core,
 +	.stop_core = wm_halo_stop_core,
  };
  
  MODULE_LICENSE("GPL v2");
diff --cc sound/soc/codecs/wm_adsp.h
index f22131d9cc29,98b12b485916..000000000000
--- a/sound/soc/codecs/wm_adsp.h
+++ b/sound/soc/codecs/wm_adsp.h
@@@ -78,9 -78,11 +78,11 @@@ struct wm_adsp 
  	unsigned int fw_id_version;
  	unsigned int fw_vendor_id;
  
 -	const struct cs_dsp_region *mem;
 +	const struct wm_adsp_region *mem;
  	int num_mems;
  
+ 	unsigned int sys_config_size;
+ 
  	int fw;
  	int fw_ver;
  
@@@ -108,9 -110,7 +110,13 @@@
  
  };
  
++<<<<<<< HEAD
 +struct wm_adsp_ops {
 +	unsigned int sys_config_size;
 +
++=======
+ struct cs_dsp_ops {
++>>>>>>> 6092be2d93b3 (ASoC: wm_adsp: Move sys_config_size to wm_adsp)
  	bool (*validate_version)(struct wm_adsp *dsp, unsigned int version);
  	unsigned int (*parse_sizes)(struct wm_adsp *dsp,
  				    const char * const file,
* Unmerged path sound/soc/codecs/wm_adsp.c
* Unmerged path sound/soc/codecs/wm_adsp.h
