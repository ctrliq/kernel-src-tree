PCI: Extend isolated function probing to s390

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Niklas Schnelle <schnelle@linux.ibm.com>
commit 189c6c33ff421def040b904fb14ef76c5bf5af4c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/189c6c33.failed

Like the jailhouse hypervisor, s390's PCI architecture allows passing
isolated PCI functions to a guest OS instance. As of now this is was not
utilized even with multi-function support as the s390 PCI code makes sure
that only virtual PCI busses including a function with devfn 0 are
presented to the PCI subsystem. A subsequent change will remove this
restriction.

Allow probing such functions by replacing the existing check for
jailhouse_paravirt() with a new hypervisor_isolated_pci_functions() helper.

Link: https://lore.kernel.org/r/20220628143100.3228092-5-schnelle@linux.ibm.com
	Signed-off-by: Niklas Schnelle <schnelle@linux.ibm.com>
	Signed-off-by: Bjorn Helgaas <bhelgaas@google.com>
	Reviewed-by: Pierre Morel <pmorel@linux.ibm.com>
	Cc: Jan Kiszka <jan.kiszka@siemens.com>
(cherry picked from commit 189c6c33ff421def040b904fb14ef76c5bf5af4c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/pci/probe.c
diff --cc drivers/pci/probe.c
index 29fcfa96d49b,4948531481d1..000000000000
--- a/drivers/pci/probe.c
+++ b/drivers/pci/probe.c
@@@ -2599,9 -2660,19 +2599,22 @@@ int pci_scan_slot(struct pci_bus *bus, 
  		if (dev) {
  			if (!pci_dev_is_added(dev))
  				nr++;
++<<<<<<< HEAD
 +			dev->multifunction = 1;
++=======
+ 			if (fn > 0)
+ 				dev->multifunction = 1;
+ 		} else if (fn == 0) {
+ 			/*
+ 			 * Function 0 is required unless we are running on
+ 			 * a hypervisor that passes through individual PCI
+ 			 * functions.
+ 			 */
+ 			if (!hypervisor_isolated_pci_functions())
+ 				break;
++>>>>>>> 189c6c33ff42 (PCI: Extend isolated function probing to s390)
  		}
 -		fn = next_fn(bus, dev, fn);
 -	} while (fn >= 0);
 +	}
  
  	/* Only one slot has PCIe device */
  	if (bus->self && nr)
* Unmerged path drivers/pci/probe.c
diff --git a/include/linux/hypervisor.h b/include/linux/hypervisor.h
index fc08b433c856..9efbc54e35e5 100644
--- a/include/linux/hypervisor.h
+++ b/include/linux/hypervisor.h
@@ -32,4 +32,12 @@ static inline bool jailhouse_paravirt(void)
 
 #endif /* !CONFIG_X86 */
 
+static inline bool hypervisor_isolated_pci_functions(void)
+{
+	if (IS_ENABLED(CONFIG_S390))
+		return true;
+
+	return jailhouse_paravirt();
+}
+
 #endif /* __LINUX_HYPEVISOR_H */
