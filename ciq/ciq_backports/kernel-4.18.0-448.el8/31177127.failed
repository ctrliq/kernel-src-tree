wifi: nl80211: relax wdev mutex check in wdev_chandef()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Johannes Berg <johannes.berg@intel.com>
commit 31177127e067eb73d5ca46ce32a410e41333d42f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/31177127.failed

In many cases we might get here from driver code that's
not really set up to care about the locking, and for the
non-MLO cases we really don't care so much about it. So
relax the checking here for now, perhaps we should even
remove it completely since we might not really care if
we point to an invalid link's chandef and can require
the caller to check the link validity first.

Fixes: 7b0a0e3c3a88 ("wifi: cfg80211: do some rework towards MLO link APIs")
	Signed-off-by: Johannes Berg <johannes.berg@intel.com>
(cherry picked from commit 31177127e067eb73d5ca46ce32a410e41333d42f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/wireless/chan.c
diff --cc net/wireless/chan.c
index f74f176e0d9d,0e5835cd8c61..000000000000
--- a/net/wireless/chan.c
+++ b/net/wireless/chan.c
@@@ -1374,3 -1429,34 +1374,37 @@@ bool cfg80211_any_usable_channels(struc
  	return false;
  }
  EXPORT_SYMBOL(cfg80211_any_usable_channels);
++<<<<<<< HEAD
++=======
+ 
+ struct cfg80211_chan_def *wdev_chandef(struct wireless_dev *wdev,
+ 				       unsigned int link_id)
+ {
+ 	/*
+ 	 * We need to sort out the locking here - in some cases
+ 	 * where we get here we really just don't care (yet)
+ 	 * about the valid links, but in others we do. But we
+ 	 * get here with various driver cases, so we cannot
+ 	 * easily require the wdev mutex.
+ 	 */
+ 	if (link_id || wdev->valid_links & BIT(0)) {
+ 		ASSERT_WDEV_LOCK(wdev);
+ 		WARN_ON(!(wdev->valid_links & BIT(link_id)));
+ 	}
+ 
+ 	switch (wdev->iftype) {
+ 	case NL80211_IFTYPE_MESH_POINT:
+ 		return &wdev->u.mesh.chandef;
+ 	case NL80211_IFTYPE_ADHOC:
+ 		return &wdev->u.ibss.chandef;
+ 	case NL80211_IFTYPE_OCB:
+ 		return &wdev->u.ocb.chandef;
+ 	case NL80211_IFTYPE_AP:
+ 	case NL80211_IFTYPE_P2P_GO:
+ 		return &wdev->links[link_id].ap.chandef;
+ 	default:
+ 		return NULL;
+ 	}
+ }
+ EXPORT_SYMBOL(wdev_chandef);
++>>>>>>> 31177127e067 (wifi: nl80211: relax wdev mutex check in wdev_chandef())
* Unmerged path net/wireless/chan.c
