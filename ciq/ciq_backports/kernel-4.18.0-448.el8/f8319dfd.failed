net: tcp: reset 'drop_reason' to NOT_SPCIFIED in tcp_v{4,6}_rcv()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Menglong Dong <imagedong@tencent.com>
commit f8319dfd1b3b3be6c08795017fc30f880f8bc861
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/f8319dfd.failed

The 'drop_reason' that passed to kfree_skb_reason() in tcp_v4_rcv()
and tcp_v6_rcv() can be SKB_NOT_DROPPED_YET(0), as it is used as the
return value of tcp_inbound_md5_hash().

And it can panic the kernel with NULL pointer in
net_dm_packet_report_size() if the reason is 0, as drop_reasons[0]
is NULL.

Fixes: 1330b6ef3313 ("skb: make drop reason booleanable")
	Reviewed-by: Jiang Biao <benbjiang@tencent.com>
	Reviewed-by: Hao Peng <flyingpeng@tencent.com>
	Signed-off-by: Menglong Dong <imagedong@tencent.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit f8319dfd1b3b3be6c08795017fc30f880f8bc861)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv6/tcp_ipv6.c
diff --cc net/ipv6/tcp_ipv6.c
index 8cdff0ded837,636ed23d9af0..000000000000
--- a/net/ipv6/tcp_ipv6.c
+++ b/net/ipv6/tcp_ipv6.c
@@@ -1441,9 -1509,12 +1441,14 @@@ reset
  discard:
  	if (opt_skb)
  		__kfree_skb(opt_skb);
++<<<<<<< HEAD
 +	kfree_skb(skb);
++=======
+ 	SKB_DR_OR(reason, NOT_SPECIFIED);
+ 	kfree_skb_reason(skb, reason);
++>>>>>>> f8319dfd1b3b (net: tcp: reset 'drop_reason' to NOT_SPCIFIED in tcp_v{4,6}_rcv())
  	return 0;
  csum_err:
 -	reason = SKB_DROP_REASON_TCP_CSUM;
 -	trace_tcp_bad_csum(skb);
  	TCP_INC_STATS(sock_net(sk), TCP_MIB_CSUMERRORS);
  	TCP_INC_STATS(sock_net(sk), TCP_MIB_INERRS);
  	goto discard;
diff --git a/net/ipv4/tcp_ipv4.c b/net/ipv4/tcp_ipv4.c
index 95c80d8a7e12..a98d6437d6b9 100644
--- a/net/ipv4/tcp_ipv4.c
+++ b/net/ipv4/tcp_ipv4.c
@@ -2027,6 +2027,7 @@ int tcp_v4_rcv(struct sk_buff *skb)
 	}
 
 discard_it:
+	SKB_DR_OR(drop_reason, NOT_SPECIFIED);
 	/* Discard frame. */
 	kfree_skb(skb);
 	return 0;
* Unmerged path net/ipv6/tcp_ipv6.c
