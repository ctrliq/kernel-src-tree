x86/CPU/AMD: Set the CPB bit unconditionally on F17h

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Jiaxun Yang <jiaxun.yang@flygoat.com>
commit 0237199186e7a4aa5310741f0a6498a20c820fd7
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/02371991.failed

Some F17h models do not have CPB set in CPUID even though the CPU
supports it. Set the feature bit unconditionally on all F17h.

 [ bp: Rewrite commit message and patch. ]

	Signed-off-by: Jiaxun Yang <jiaxun.yang@flygoat.com>
	Signed-off-by: Borislav Petkov <bp@suse.de>
	Acked-by: Tom Lendacky <thomas.lendacky@amd.com>
	Cc: "H. Peter Anvin" <hpa@zytor.com>
	Cc: Ingo Molnar <mingo@redhat.com>
	Cc: Sherry Hurwitz <sherry.hurwitz@amd.com>
	Cc: Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
	Cc: Thomas Gleixner <tglx@linutronix.de>
	Cc: x86-ml <x86@kernel.org>
Link: https://lkml.kernel.org/r/20181120030018.5185-1-jiaxun.yang@flygoat.com
(cherry picked from commit 0237199186e7a4aa5310741f0a6498a20c820fd7)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/cpu/amd.c
diff --cc arch/x86/kernel/cpu/amd.c
index 42cab669db36,01004bfb1a1b..000000000000
--- a/arch/x86/kernel/cpu/amd.c
+++ b/arch/x86/kernel/cpu/amd.c
@@@ -849,15 -820,8 +849,20 @@@ static void init_amd_zn(struct cpuinfo_
  {
  	set_cpu_cap(c, X86_FEATURE_ZEN);
  
++<<<<<<< HEAD
 +#ifdef CONFIG_NUMA
 +	node_reclaim_distance = 32;
 +#endif
 +
 +	/*
 +	 * Fix erratum 1076: CPB feature bit not being set in CPUID. It affects
 +	 * all up to and including B1.
 +	 */
 +	if (c->x86_model <= 1 && c->x86_stepping <= 1)
++=======
+ 	/* Fix erratum 1076: CPB feature bit not being set in CPUID. */
+ 	if (!cpu_has(c, X86_FEATURE_CPB))
++>>>>>>> 0237199186e7 (x86/CPU/AMD: Set the CPB bit unconditionally on F17h)
  		set_cpu_cap(c, X86_FEATURE_CPB);
  }
  
* Unmerged path arch/x86/kernel/cpu/amd.c
