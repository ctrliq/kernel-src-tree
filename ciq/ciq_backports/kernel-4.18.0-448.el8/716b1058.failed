tty: extract tty_flip_buffer_commit() from tty_flip_buffer_push()

jira LE-1907
cve CVE-2022-1462
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Jiri Slaby <jslaby@suse.cz>
commit 716b10580283fda66f2b88140e3964f8a7f9da89
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/716b1058.failed

We will need this new helper in the next patch.

	Cc: Hillf Danton <hdanton@sina.com>
	Cc: 一只狗 <chennbnbnb@gmail.com>
	Cc: Dan Carpenter <dan.carpenter@oracle.com>
	Signed-off-by: Jiri Slaby <jslaby@suse.cz>
Link: https://lore.kernel.org/r/20220707082558.9250-1-jslaby@suse.cz
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 716b10580283fda66f2b88140e3964f8a7f9da89)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/tty/tty_buffer.c
diff --cc drivers/tty/tty_buffer.c
index ae3ce330200e,303a26c1b821..000000000000
--- a/drivers/tty/tty_buffer.c
+++ b/drivers/tty/tty_buffer.c
@@@ -535,20 -532,31 +535,36 @@@ static void flush_to_ldisc(struct work_
  
  }
  
+ static inline void tty_flip_buffer_commit(struct tty_buffer *tail)
+ {
+ 	/*
+ 	 * Paired w/ acquire in flush_to_ldisc(); ensures flush_to_ldisc() sees
+ 	 * buffer data.
+ 	 */
+ 	smp_store_release(&tail->commit, tail->used);
+ }
+ 
  /**
 - * tty_flip_buffer_push		-	push terminal buffers
 - * @port: tty port to push
 + *	tty_flip_buffer_push	-	terminal
 + *	@port: tty port to push
   *
 - * Queue a push of the terminal flip buffers to the line discipline. Can be
 - * called from IRQ/atomic context.
 + *	Queue a push of the terminal flip buffers to the line discipline.
 + *	Can be called from IRQ/atomic context.
   *
 - * In the event of the queue being busy for flipping the work will be held off
 - * and retried later.
 + *	In the event of the queue being busy for flipping the work will be
 + *	held off and retried later.
   */
 +
  void tty_flip_buffer_push(struct tty_port *port)
  {
++<<<<<<< HEAD
 +	tty_schedule_flip(port);
++=======
+ 	struct tty_bufhead *buf = &port->buf;
+ 
+ 	tty_flip_buffer_commit(buf->tail);
+ 	queue_work(system_unbound_wq, &buf->work);
++>>>>>>> 716b10580283 (tty: extract tty_flip_buffer_commit() from tty_flip_buffer_push())
  }
  EXPORT_SYMBOL(tty_flip_buffer_push);
  
* Unmerged path drivers/tty/tty_buffer.c
