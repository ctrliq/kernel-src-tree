ceph: choose auth MDS for getxattr with the Xs caps

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Xiubo Li <xiubli@redhat.com>
commit 8266c4d7a7469c3fd45ee2b4ebc01aac311c6c48
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/8266c4d7.failed

And for the 'Xs' caps for getxattr we will also choose the auth MDS,
because the MDS side code is buggy due to setxattr won't notify the
replica MDSes when the values changed and the replica MDS will return
the old values. Though we will fix it in MDS code, but this still
makes sense for old ceph.

Link: https://tracker.ceph.com/issues/55331
	Signed-off-by: Xiubo Li <xiubli@redhat.com>
	Reviewed-by: Ilya Dryomov <idryomov@gmail.com>
	Signed-off-by: Ilya Dryomov <idryomov@gmail.com>
(cherry picked from commit 8266c4d7a7469c3fd45ee2b4ebc01aac311c6c48)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/ceph/inode.c
diff --cc fs/ceph/inode.c
index d34f1af0d147,1834d6529f25..000000000000
--- a/fs/ceph/inode.c
+++ b/fs/ceph/inode.c
@@@ -2244,6 -2259,36 +2244,39 @@@ int ceph_setattr(struct dentry *dentry
  	return err;
  }
  
++<<<<<<< HEAD
++=======
+ int ceph_try_to_choose_auth_mds(struct inode *inode, int mask)
+ {
+ 	int issued = ceph_caps_issued(ceph_inode(inode));
+ 
+ 	/*
+ 	 * If any 'x' caps is issued we can just choose the auth MDS
+ 	 * instead of the random replica MDSes. Because only when the
+ 	 * Locker is in LOCK_EXEC state will the loner client could
+ 	 * get the 'x' caps. And if we send the getattr requests to
+ 	 * any replica MDS it must auth pin and tries to rdlock from
+ 	 * the auth MDS, and then the auth MDS need to do the Locker
+ 	 * state transition to LOCK_SYNC. And after that the lock state
+ 	 * will change back.
+ 	 *
+ 	 * This cost much when doing the Locker state transition and
+ 	 * usually will need to revoke caps from clients.
+ 	 *
+ 	 * And for the 'Xs' caps for getxattr we will also choose the
+ 	 * auth MDS, because the MDS side code is buggy due to setxattr
+ 	 * won't notify the replica MDSes when the values changed and
+ 	 * the replica MDS will return the old values. Though we will
+ 	 * fix it in MDS code, but this still makes sense for old ceph.
+ 	 */
+ 	if (((mask & CEPH_CAP_ANY_SHARED) && (issued & CEPH_CAP_ANY_EXCL))
+ 	    || (mask & (CEPH_STAT_RSTAT | CEPH_STAT_CAP_XATTR)))
+ 		return USE_AUTH_MDS;
+ 	else
+ 		return USE_ANY_MDS;
+ }
+ 
++>>>>>>> 8266c4d7a746 (ceph: choose auth MDS for getxattr with the Xs caps)
  /*
   * Verify that we have a lease on the given mask.  If not,
   * do a getattr against an mds.
* Unmerged path fs/ceph/inode.c
