scsi: lpfc: Resolve NULL ptr dereference after an ELS LOGO is aborted

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author James Smart <jsmart2021@gmail.com>
commit b1b3440f437b75fb2a9b0cfe58df461e40eca474
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/b1b3440f.failed

A use-after-free crash can occur after an ELS LOGO is aborted.

Specifically, a nodelist structure is freed and then
ndlp->vport->cfg_log_verbose is dereferenced in lpfc_nlp_get() when the
discovery state machine is mistakenly called a second time with
NLP_EVT_DEVICE_RM argument.

Rework lpfc_cmpl_els_logo() to prevent the duplicate calls to release a
nodelist structure.

Link: https://lore.kernel.org/r/20220603174329.63777-6-jsmart2021@gmail.com
Co-developed-by: Justin Tee <justin.tee@broadcom.com>
	Signed-off-by: Justin Tee <justin.tee@broadcom.com>
	Signed-off-by: James Smart <jsmart2021@gmail.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit b1b3440f437b75fb2a9b0cfe58df461e40eca474)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/lpfc/lpfc_els.c
diff --cc drivers/scsi/lpfc/lpfc_els.c
index cb6c4a536261,3fababb7c181..000000000000
--- a/drivers/scsi/lpfc/lpfc_els.c
+++ b/drivers/scsi/lpfc/lpfc_els.c
@@@ -2967,16 -2990,15 +2967,25 @@@ lpfc_cmpl_els_logo(struct lpfc_hba *phb
  	 * all acceptable.  Note the failure and move forward with
  	 * discovery.  The PLOGI will retry.
  	 */
 -	if (ulp_status) {
 +	if (irsp->ulpStatus) {
  		/* LOGO failed */
  		lpfc_printf_vlog(vport, KERN_ERR, LOG_TRACE_EVENT,
++<<<<<<< HEAD
 +				 "2756 LOGO failure, No Retry DID:%06X Status:x%x/x%x\n",
 +				 ndlp->nlp_DID, irsp->ulpStatus,
 +				 irsp->un.ulpWord[4]);
 +		/* Call NLP_EVT_DEVICE_RM if link is down or LOGO is aborted */
 +		if (lpfc_error_lost_link(irsp)) {
 +			lpfc_disc_state_machine(vport, ndlp, cmdiocb,
 +						NLP_EVT_DEVICE_RM);
++=======
+ 				 "2756 LOGO failure, No Retry DID:%06X "
+ 				 "Status:x%x/x%x\n",
+ 				 ndlp->nlp_DID, ulp_status,
+ 				 ulp_word4);
+ 
+ 		if (lpfc_error_lost_link(ulp_status, ulp_word4)) {
++>>>>>>> b1b3440f437b (scsi: lpfc: Resolve NULL ptr dereference after an ELS LOGO is aborted)
  			skip_recovery = 1;
  			goto out;
  		}
@@@ -3031,9 -3045,13 +3032,13 @@@ out
  		lpfc_printf_vlog(vport, KERN_INFO, LOG_ELS,
  				 "3187 LOGO completes to NPort x%x: Start "
  				 "Recovery Data: x%x x%x x%x x%x\n",
 -				 ndlp->nlp_DID, ulp_status,
 -				 ulp_word4, tmo,
 +				 ndlp->nlp_DID, irsp->ulpStatus,
 +				 irsp->un.ulpWord[4], irsp->ulpTimeout,
  				 vport->num_disc_nodes);
+ 
+ 		lpfc_els_free_iocb(phba, cmdiocb);
+ 		lpfc_nlp_put(ndlp);
+ 
  		lpfc_disc_start(vport);
  		return;
  	}
* Unmerged path drivers/scsi/lpfc/lpfc_els.c
