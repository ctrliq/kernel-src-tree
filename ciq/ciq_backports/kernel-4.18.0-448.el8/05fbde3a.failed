scsi: sd: Fix potential NULL pointer dereference

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Damien Le Moal <damien.lemoal@opensource.wdc.com>
commit 05fbde3a77a4f1d62e4c4428f384288c1f1a0be5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/05fbde3a.failed

If sd_probe() sees an early error before sdkp->device is initialized,
sd_zbc_release_disk() is called. This causes a NULL pointer dereference
when sd_is_zoned() is called inside that function. Avoid this by removing
the call to sd_zbc_release_disk() in sd_probe() error path.

This change is safe and does not result in zone information memory leakage
because the zone information for a zoned disk is allocated only when
sd_revalidate_disk() is called, at which point sdkp->disk_dev is fully set,
resulting in sd_disk_release() being called when needed to cleanup a disk
zone information using sd_zbc_release_disk().

Link: https://lore.kernel.org/r/20220601062544.905141-2-damien.lemoal@opensource.wdc.com
Fixes: 89d947561077 ("sd: Implement support for ZBC devices")
	Reported-by: Dongliang Mu <mudongliangabcd@gmail.com>
	Suggested-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Signed-off-by: Damien Le Moal <damien.lemoal@opensource.wdc.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 05fbde3a77a4f1d62e4c4428f384288c1f1a0be5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/sd.c
diff --cc drivers/scsi/sd.c
index 01b1084ffb50,856024c6852c..000000000000
--- a/drivers/scsi/sd.c
+++ b/drivers/scsi/sd.c
@@@ -3495,8 -3544,6 +3495,11 @@@ static int sd_probe(struct device *dev
   out_put:
  	put_disk(gd);
   out_free:
++<<<<<<< HEAD
 +	sd_zbc_release_disk(sdkp);
 +	kfree(sdkp->aux);
++=======
++>>>>>>> 05fbde3a77a4 (scsi: sd: Fix potential NULL pointer dereference)
  	kfree(sdkp);
   out:
  	scsi_autopm_put_device(sdp);
* Unmerged path drivers/scsi/sd.c
