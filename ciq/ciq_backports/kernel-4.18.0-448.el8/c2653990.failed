wifi: nl80211: acquire wdev mutex earlier in start_ap

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Johannes Berg <johannes.berg@intel.com>
commit c2653990d5729a445296d6d04395be5dea8e282e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/c2653990.failed

We need to hold the wdev mutex already in order to call
nl80211_parse_tx_bitrate_mask(), so acquire it earlier.

Fixes: 7b0a0e3c3a88 ("wifi: cfg80211: do some rework towards MLO link APIs")
	Signed-off-by: Johannes Berg <johannes.berg@intel.com>
(cherry picked from commit c2653990d5729a445296d6d04395be5dea8e282e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/wireless/nl80211.c
diff --cc net/wireless/nl80211.c
index 1c8f0d4587fd,b583a76ef492..000000000000
--- a/net/wireless/nl80211.c
+++ b/net/wireless/nl80211.c
@@@ -5701,9 -5777,9 +5703,9 @@@ static int nl80211_start_ap(struct sk_b
  		err = nl80211_parse_tx_bitrate_mask(info, info->attrs,
  						    NL80211_ATTR_TX_RATES,
  						    &params->beacon_rate,
 -						    dev, false, link_id);
 +						    dev, false);
  		if (err)
- 			goto out;
+ 			goto out_unlock;
  
  		err = validate_beacon_tx_rate(rdev, params->chandef.chan->band,
  					      &params->beacon_rate);
@@@ -5800,14 -5876,22 +5802,26 @@@
  	else if (info->attrs[NL80211_ATTR_EXTERNAL_AUTH_SUPPORT])
  		params->flags |= NL80211_AP_SETTINGS_EXTERNAL_AUTH_SUPPORT;
  
++<<<<<<< HEAD
 +	wdev_lock(wdev);
++=======
+ 	if (wdev->conn_owner_nlportid &&
+ 	    info->attrs[NL80211_ATTR_SOCKET_OWNER] &&
+ 	    wdev->conn_owner_nlportid != info->snd_portid) {
+ 		err = -EINVAL;
+ 		goto out_unlock;
+ 	}
+ 
+ 	/* FIXME: validate MLO/link-id against driver capabilities */
+ 
++>>>>>>> c2653990d572 (wifi: nl80211: acquire wdev mutex earlier in start_ap)
  	err = rdev_start_ap(rdev, dev, params);
  	if (!err) {
 -		wdev->links[link_id].ap.beacon_interval = params->beacon_interval;
 -		wdev->links[link_id].ap.chandef = params->chandef;
 -		wdev->u.ap.ssid_len = params->ssid_len;
 -		memcpy(wdev->u.ap.ssid, params->ssid,
 -		       params->ssid_len);
 +		wdev->preset_chandef = params->chandef;
 +		wdev->beacon_interval = params->beacon_interval;
 +		wdev->chandef = params->chandef;
 +		wdev->ssid_len = params->ssid_len;
 +		memcpy(wdev->ssid, params->ssid, wdev->ssid_len);
  
  		if (info->attrs[NL80211_ATTR_SOCKET_OWNER])
  			wdev->conn_owner_nlportid = info->snd_portid;
* Unmerged path net/wireless/nl80211.c
