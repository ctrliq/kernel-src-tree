s390/vfio-ap: introduce shadow APCB

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Tony Krowiak <akrowiak@linux.ibm.com>
commit 49b0109fb399b78a424d76485194202f290bdece
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/49b0109f.failed

The APCB is a field within the CRYCB that provides the AP configuration
to a KVM guest. Let's introduce a shadow copy of the KVM guest's APCB and
maintain it for the lifespan of the guest.

The shadow APCB serves the following purposes:

1. The shadow APCB can be maintained even when the mediated device is not
   currently in use by a KVM guest. Since the mediated device's AP
   configuration is filtered to ensure that no AP queues are passed through
   to the KVM guest that are not bound to the vfio_ap device driver or
   available to the host, the mediated device's AP configuration may differ
   from the guest's. Having a shadow of a guest's APCB allows us to provide
   a sysfs interface to view the guest's APCB even if the mediated device
   is not currently passed through to a KVM guest. This can aid in
   problem determination when the guest is unexpectedly missing AP
   resources.

2. If filtering was done in-place for the real APCB, the guest could pick
   up a transient state. Doing the filtering on a shadow and transferring
   the AP configuration to the real APCB after the guest is started or when
   AP resources are assigned to or unassigned from the mediated device, or
   when the host configuration changes, the guest's AP configuration will
   never be in a transient state.

	Signed-off-by: Tony Krowiak <akrowiak@linux.ibm.com>
	Reviewed-by: Halil Pasic <pasic@linux.ibm.com>
	Signed-off-by: Alexander Gordeev <agordeev@linux.ibm.com>
(cherry picked from commit 49b0109fb399b78a424d76485194202f290bdece)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/s390/crypto/vfio_ap_ops.c
#	drivers/s390/crypto/vfio_ap_private.h
diff --cc drivers/s390/crypto/vfio_ap_ops.c
index 69b05ef08538,5cc4e1c31aae..000000000000
--- a/drivers/s390/crypto/vfio_ap_ops.c
+++ b/drivers/s390/crypto/vfio_ap_ops.c
@@@ -337,8 -463,12 +337,14 @@@ static int vfio_ap_mdev_create(struct k
  
  	matrix_mdev->mdev = mdev;
  	vfio_ap_matrix_init(&matrix_dev->info, &matrix_mdev->matrix);
 +	mdev_set_drvdata(mdev, matrix_mdev);
  	matrix_mdev->pqap_hook = handle_pqap;
++<<<<<<< HEAD
++=======
+ 	vfio_ap_matrix_init(&matrix_dev->info, &matrix_mdev->shadow_apcb);
+ 	hash_init(matrix_mdev->qtable.queues);
+ 	dev_set_drvdata(&mdev->dev, matrix_mdev);
++>>>>>>> 49b0109fb399 (s390/vfio-ap: introduce shadow APCB)
  	mutex_lock(&matrix_dev->lock);
  	list_add(&matrix_mdev->node, &matrix_dev->mdev_list);
  	mutex_unlock(&matrix_dev->lock);
diff --cc drivers/s390/crypto/vfio_ap_private.h
index 2b06b4ffd2fd,acb3f9d22025..000000000000
--- a/drivers/s390/crypto/vfio_ap_private.h
+++ b/drivers/s390/crypto/vfio_ap_private.h
@@@ -80,19 -91,20 +80,27 @@@ struct ap_matrix 
   * @node:	allows the ap_matrix_mdev struct to be added to a list
   * @matrix:	the adapters, usage domains and control domains assigned to the
   *		mediated matrix device.
++<<<<<<< HEAD
 + * @group_notifier: notifier block used for specifying callback function for
 + *		    handling the VFIO_GROUP_NOTIFY_SET_KVM event
++=======
+  * @shadow_apcb:    the shadow copy of the APCB field of the KVM guest's CRYCB
++>>>>>>> 49b0109fb399 (s390/vfio-ap: introduce shadow APCB)
   * @iommu_notifier: notifier block used for specifying callback function for
   *		    handling the VFIO_IOMMU_NOTIFY_DMA_UNMAP even
   * @kvm:	the struct holding guest's state
   * @pqap_hook:	the function pointer to the interception handler for the
   *		PQAP(AQIC) instruction.
   * @mdev:	the mediated device
 - * @qtable:	table of queues (struct vfio_ap_queue) assigned to the mdev
   */
  struct ap_matrix_mdev {
 -	struct vfio_device vdev;
  	struct list_head node;
  	struct ap_matrix matrix;
++<<<<<<< HEAD
 +	struct notifier_block group_notifier;
++=======
+ 	struct ap_matrix shadow_apcb;
++>>>>>>> 49b0109fb399 (s390/vfio-ap: introduce shadow APCB)
  	struct notifier_block iommu_notifier;
  	struct kvm *kvm;
  	crypto_hook pqap_hook;
* Unmerged path drivers/s390/crypto/vfio_ap_ops.c
* Unmerged path drivers/s390/crypto/vfio_ap_private.h
