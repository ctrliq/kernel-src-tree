fbdev/sysfs: Fix locking

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Daniel Vetter <daniel.vetter@ffwll.ch>
commit 9ad5cc9bcfd62b0f39e7f85992d2a371ff369324
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/9ad5cc9b.failed

fb_set_var requires we hold the fb_info lock. Or at least this now
matches what the ioctl does ...

Note that ps3fb and sh_mobile_lcdcfb are busted in different ways here,
but I will not fix them up.

Also in practice this isn't a big deal, because really variable fbdev
state is actually protected by console_lock (because fbcon just
doesn't bother with lock_fb_info() at all), and lock_fb_info
protecting anything is really just a neat lie. But that's a much
bigger fish to fry.

	Acked-by: Thomas Zimmermann <tzimmermann@suse.de>
	Acked-by: Sam Ravnborg <sam@ravnborg.org>
	Signed-off-by: Daniel Vetter <daniel.vetter@intel.com>
	Cc: Helge Deller <deller@gmx.de>
	Cc: Daniel Vetter <daniel@ffwll.ch>
	Cc: Qing Wang <wangqing@vivo.com>
	Cc: Sam Ravnborg <sam@ravnborg.org>
Link: https://patchwork.freedesktop.org/patch/msgid/20220405210335.3434130-6-daniel.vetter@ffwll.ch
(cherry picked from commit 9ad5cc9bcfd62b0f39e7f85992d2a371ff369324)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/video/fbdev/core/fbsysfs.c
diff --cc drivers/video/fbdev/core/fbsysfs.c
index 882b471d619e,8c1ee9ecec3d..000000000000
--- a/drivers/video/fbdev/core/fbsysfs.c
+++ b/drivers/video/fbdev/core/fbsysfs.c
@@@ -95,9 -91,11 +95,17 @@@ static int activate(struct fb_info *fb_
  
  	var->activate |= FB_ACTIVATE_FORCE;
  	console_lock();
++<<<<<<< HEAD
 +	fb_info->flags |= FBINFO_MISC_USEREVENT;
 +	err = fb_set_var(fb_info, var);
 +	fb_info->flags &= ~FBINFO_MISC_USEREVENT;
++=======
+ 	lock_fb_info(fb_info);
+ 	err = fb_set_var(fb_info, var);
+ 	if (!err)
+ 		fbcon_update_vcs(fb_info, var->activate & FB_ACTIVATE_ALL);
+ 	unlock_fb_info(fb_info);
++>>>>>>> 9ad5cc9bcfd6 (fbdev/sysfs: Fix locking)
  	console_unlock();
  	if (err)
  		return err;
* Unmerged path drivers/video/fbdev/core/fbsysfs.c
