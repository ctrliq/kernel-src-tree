xhci: Don't defer primary roothub registration if there is only one roothub

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Mathias Nyman <mathias.nyman@linux.intel.com>
commit 1bd8bb7d2dfc44509acf729e636523c3c2b729df
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/1bd8bb7d.failed

The support for xHCI controllers with only one roothub, and the code
to defer primary roothub registation until second roothub got merged
to usb-next for 5.19 at the same time.

commit 873f323618c2 ("xhci: prepare for operation w/o shared hcd")
commit b7a4f9b5d0e4 ("xhci: Set HCD flag to defer primary roothub
registration")

These got merged in such a way that the flag to defer primary roothub
registration is set even for xHC controllers with just one roothub.

Fix this by setting the defer flag in a codepath taken only if we have
two roothubs

Fixes: 873f323618c2 ("xhci: prepare for operation w/o shared hcd")
	Signed-off-by: Mathias Nyman <mathias.nyman@linux.intel.com>
Link: https://lore.kernel.org/r/20220516094850.19788-2-mathias.nyman@linux.intel.com
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 1bd8bb7d2dfc44509acf729e636523c3c2b729df)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/usb/host/xhci.c
diff --cc drivers/usb/host/xhci.c
index d881c1d1ae8f,f0ab63138016..000000000000
--- a/drivers/usb/host/xhci.c
+++ b/drivers/usb/host/xhci.c
@@@ -693,14 -693,18 +693,27 @@@ int xhci_run(struct usb_hcd *hcd
  		if (ret)
  			xhci_free_command(xhci, command);
  	}
++<<<<<<< HEAD
 +	set_bit(HCD_FLAG_DEFER_RH_REGISTER, &hcd->flags);
 +	xhci_dbg_trace(xhci, trace_xhci_dbg_init,
 +			"Finished xhci_run for USB2 roothub");
++=======
+ 	xhci_dbg_trace(xhci, trace_xhci_dbg_init,
+ 			"Finished %s for main hcd", __func__);
++>>>>>>> 1bd8bb7d2dfc (xhci: Don't defer primary roothub registration if there is only one roothub)
  
  	xhci_create_dbc_dev(xhci);
  
  	xhci_debugfs_init(xhci);
  
++<<<<<<< HEAD
++=======
+ 	if (xhci_has_one_roothub(xhci))
+ 		return xhci_run_finished(xhci);
+ 
+ 	set_bit(HCD_FLAG_DEFER_RH_REGISTER, &hcd->flags);
+ 
++>>>>>>> 1bd8bb7d2dfc (xhci: Don't defer primary roothub registration if there is only one roothub)
  	return 0;
  }
  EXPORT_SYMBOL_GPL(xhci_run);
* Unmerged path drivers/usb/host/xhci.c
