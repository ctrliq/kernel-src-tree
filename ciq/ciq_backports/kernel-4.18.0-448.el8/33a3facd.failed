ASoC: SOF: sof-audio: reset route status before freeing widget

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Ranjani Sridharan <ranjani.sridharan@linux.intel.com>
commit 33a3facdf8ccf1b777ef0c39841425ca8d8d4a40
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/33a3facd.failed

This is in preparation for IPC4 which requires that the route be reset
before the widget is freed. For IPC3, there is nothing more to be done
other than setting the route status. So it is OK to be moved before the
widget is freed.

	Signed-off-by: Ranjani Sridharan <ranjani.sridharan@linux.intel.com>
	Reviewed-by: PÃ©ter Ujfalusi <peter.ujfalusi@linux.intel.com>
	Reviewed-by: Bard Liao <yung-chuan.liao@linux.intel.com>
	Reviewed-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
Link: https://lore.kernel.org/r/20220426171743.171061-3-ranjani.sridharan@linux.intel.com
	Signed-off-by: Mark Brown <broonie@kernel.org>
(cherry picked from commit 33a3facdf8ccf1b777ef0c39841425ca8d8d4a40)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/soc/sof/sof-audio.c
diff --cc sound/soc/sof/sof-audio.c
index 32b0a6fa550f,453e1edab121..000000000000
--- a/sound/soc/sof/sof-audio.c
+++ b/sound/soc/sof/sof-audio.c
@@@ -113,33 -34,12 +113,38 @@@ int sof_widget_free(struct snd_sof_dev 
  	if (--swidget->use_count)
  		return 0;
  
++<<<<<<< HEAD
 +	switch (swidget->id) {
 +	case snd_soc_dapm_scheduler:
 +	{
 +		ipc_free.hdr.cmd |= SOF_IPC_TPLG_PIPE_FREE;
 +		break;
 +	}
 +	case snd_soc_dapm_buffer:
 +		ipc_free.hdr.cmd |= SOF_IPC_TPLG_BUFFER_FREE;
 +		break;
 +	case snd_soc_dapm_dai_in:
 +	case snd_soc_dapm_dai_out:
 +	{
 +		struct snd_sof_dai *dai = swidget->private;
 +
 +		dai->configured = false;
 +		fallthrough;
 +	}
 +	default:
 +		ipc_free.hdr.cmd |= SOF_IPC_TPLG_COMP_FREE;
 +		break;
 +	}
++=======
+ 	/* reset route setup status for all routes that contain this widget */
+ 	sof_reset_route_setup_status(sdev, swidget);
++>>>>>>> 33a3facdf8cc (ASoC: SOF: sof-audio: reset route status before freeing widget)
  
  	/* continue to disable core even if IPC fails */
 -	if (tplg_ops->widget_free)
 -		err = tplg_ops->widget_free(sdev, swidget);
 +	err = sof_ipc_tx_message(sdev->ipc, ipc_free.hdr.cmd, &ipc_free, sizeof(ipc_free),
 +				 &reply, sizeof(reply));
 +	if (err < 0)
 +		dev_err(sdev->dev, "error: failed to free widget %s\n", swidget->widget->name);
  
  	/*
  	 * disable widget core. continue to route setup status and complete flag
* Unmerged path sound/soc/sof/sof-audio.c
