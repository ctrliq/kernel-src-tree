wifi: nl80211: hold wdev mutex for channel switch APIs

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Johannes Berg <johannes.berg@intel.com>
commit 4e2f3d67e3afef751e1ad81c6b156f2aafa25dcf
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/4e2f3d67.failed

Since we deal with links in an MLD here, hold the wdev
mutex now.

	Signed-off-by: Johannes Berg <johannes.berg@intel.com>
(cherry picked from commit 4e2f3d67e3afef751e1ad81c6b156f2aafa25dcf)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/wireless/nl80211.c
diff --cc net/wireless/nl80211.c
index 1ee5ef214b30,59ea1157969e..000000000000
--- a/net/wireless/nl80211.c
+++ b/net/wireless/nl80211.c
@@@ -3294,9 -3346,15 +3294,18 @@@ static int __nl80211_set_channel(struc
  static int nl80211_set_channel(struct sk_buff *skb, struct genl_info *info)
  {
  	struct cfg80211_registered_device *rdev = info->user_ptr[0];
 -	int link_id = nl80211_link_id_or_invalid(info->attrs);
  	struct net_device *netdev = info->user_ptr[1];
+ 	int ret;
  
++<<<<<<< HEAD
 +	return __nl80211_set_channel(rdev, netdev, info);
++=======
+ 	wdev_lock(netdev->ieee80211_ptr);
+ 	ret = __nl80211_set_channel(rdev, netdev, info, link_id);
+ 	wdev_unlock(netdev->ieee80211_ptr);
+ 
+ 	return ret;
++>>>>>>> 4e2f3d67e3af (wifi: nl80211: hold wdev mutex for channel switch APIs)
  }
  
  static int nl80211_set_wiphy(struct sk_buff *skb, struct genl_info *info)
@@@ -3408,10 -3466,16 +3417,23 @@@
  	}
  
  	if (info->attrs[NL80211_ATTR_WIPHY_FREQ]) {
++<<<<<<< HEAD
 +		result = __nl80211_set_channel(
 +			rdev,
 +			nl80211_can_set_dev_channel(wdev) ? netdev : NULL,
 +			info);
++=======
+ 		if (wdev) {
+ 			wdev_lock(wdev);
+ 			result = __nl80211_set_channel(
+ 				rdev,
+ 				nl80211_can_set_dev_channel(wdev) ? netdev : NULL,
+ 				info, -1);
+ 			wdev_unlock(wdev);
+ 		} else {
+ 			result = __nl80211_set_channel(rdev, netdev, info, -1);
+ 		}
++>>>>>>> 4e2f3d67e3af (wifi: nl80211: hold wdev mutex for channel switch APIs)
  		if (result)
  			goto out;
  	}
* Unmerged path net/wireless/nl80211.c
