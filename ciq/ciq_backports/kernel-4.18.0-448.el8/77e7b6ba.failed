wifi: cfg80211: handle IBSS in channel switch

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Johannes Berg <johannes.berg@intel.com>
commit 77e7b6ba78edf817bddfa97fadb15a971992b1ee
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/77e7b6ba.failed

Prior to commit 7b0a0e3c3a88 ("wifi: cfg80211: do some
rework towards MLO link APIs") the interface type didn't
really matter here, but now we need to handle all of the
possible cases. Add IBSS ("ADHOC") and handle it.

Fixes: 7b0a0e3c3a88 ("wifi: cfg80211: do some rework towards MLO link APIs")
	Reported-by: syzbot+90d912872157e63589e4@syzkaller.appspotmail.com
	Signed-off-by: Johannes Berg <johannes.berg@intel.com>
(cherry picked from commit 77e7b6ba78edf817bddfa97fadb15a971992b1ee)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/wireless/nl80211.c
diff --cc net/wireless/nl80211.c
index 718221cdc6c2,efdf0148a8fa..000000000000
--- a/net/wireless/nl80211.c
+++ b/net/wireless/nl80211.c
@@@ -18039,16 -18539,32 +18039,41 @@@ void cfg80211_ch_switch_notify(struct n
  	struct cfg80211_registered_device *rdev = wiphy_to_rdev(wiphy);
  
  	ASSERT_WDEV_LOCK(wdev);
 -	WARN_INVALID_LINK_ID(wdev, link_id);
  
 -	trace_cfg80211_ch_switch_notify(dev, chandef, link_id);
 +	trace_cfg80211_ch_switch_notify(dev, chandef);
 +
++<<<<<<< HEAD
 +	wdev->chandef = *chandef;
 +	wdev->preset_chandef = *chandef;
  
 +	if ((wdev->iftype == NL80211_IFTYPE_STATION ||
 +	     wdev->iftype == NL80211_IFTYPE_P2P_CLIENT) &&
 +	    !WARN_ON(!wdev->current_bss))
 +		cfg80211_update_assoc_bss_entry(wdev, chandef->chan);
++=======
+ 	switch (wdev->iftype) {
+ 	case NL80211_IFTYPE_STATION:
+ 	case NL80211_IFTYPE_P2P_CLIENT:
+ 		if (!WARN_ON(!wdev->links[link_id].client.current_bss))
+ 			cfg80211_update_assoc_bss_entry(wdev, link_id,
+ 							chandef->chan);
+ 		break;
+ 	case NL80211_IFTYPE_MESH_POINT:
+ 		wdev->u.mesh.chandef = *chandef;
+ 		wdev->u.mesh.preset_chandef = *chandef;
+ 		break;
+ 	case NL80211_IFTYPE_AP:
+ 	case NL80211_IFTYPE_P2P_GO:
+ 		wdev->links[link_id].ap.chandef = *chandef;
+ 		break;
+ 	case NL80211_IFTYPE_ADHOC:
+ 		wdev->u.ibss.chandef = *chandef;
+ 		break;
+ 	default:
+ 		WARN_ON(1);
+ 		break;
+ 	}
++>>>>>>> 77e7b6ba78ed (wifi: cfg80211: handle IBSS in channel switch)
  
  	cfg80211_sched_dfs_chan_update(rdev);
  
* Unmerged path net/wireless/nl80211.c
