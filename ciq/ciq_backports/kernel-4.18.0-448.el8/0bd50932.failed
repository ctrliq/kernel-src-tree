wifi: mac80211: fix mesh airtime link metric estimating

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Aditya Kumar Singh <quic_adisi@quicinc.com>
commit 0bd509325508aad1bf01967d618ada7d8da14d4d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/0bd50932.failed

ieee80211s_update_metric function uses sta_set_rate_info_tx
function to get struct rate_info data from ieee80211_tx_rate
struct, present in ieee80211_sta->deflink.tx_stats. However,
drivers can skip tx rate calculation by setting rate idx as
-1. Such drivers provides rate_info directly and hence
ieee80211s metric is updated incorrectly since ieee80211_tx_rate
has inconsistent data.

Add fix to use rate_info directly if present instead of
sta_set_rate_info_tx for updating ieee80211s metric.

	Signed-off-by: Aditya Kumar Singh <quic_adisi@quicinc.com>
Link: https://lore.kernel.org/r/20220701133611.544-1-quic_adisi@quicinc.com
	Signed-off-by: Johannes Berg <johannes.berg@intel.com>
(cherry picked from commit 0bd509325508aad1bf01967d618ada7d8da14d4d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/mac80211/mesh_hwmp.c
diff --cc net/mac80211/mesh_hwmp.c
index 75944da8140c,7fd269cbb01a..000000000000
--- a/net/mac80211/mesh_hwmp.c
+++ b/net/mac80211/mesh_hwmp.c
@@@ -310,7 -310,12 +310,16 @@@ void ieee80211s_update_metric(struct ie
  			LINK_FAIL_THRESH)
  		mesh_plink_broken(sta);
  
++<<<<<<< HEAD
 +	sta_set_rate_info_tx(sta, &sta->tx_stats.last_rate, &rinfo);
++=======
+ 	/* use rate info set by the driver directly if present */
+ 	if (st->n_rates)
+ 		rinfo = sta->deflink.tx_stats.last_rate_info;
+ 	else
+ 		sta_set_rate_info_tx(sta, &sta->deflink.tx_stats.last_rate, &rinfo);
+ 
++>>>>>>> 0bd509325508 (wifi: mac80211: fix mesh airtime link metric estimating)
  	ewma_mesh_tx_rate_avg_add(&sta->mesh->tx_rate_avg,
  				  cfg80211_calculate_bitrate(&rinfo));
  }
* Unmerged path net/mac80211/mesh_hwmp.c
