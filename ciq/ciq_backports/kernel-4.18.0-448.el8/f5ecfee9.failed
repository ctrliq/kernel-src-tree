KVM: s390: resetting the Topology-Change-Report

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Pierre Morel <pmorel@linux.ibm.com>
commit f5ecfee94493475783074e86ded10a0499d779fc
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/f5ecfee9.failed

During a subsystem reset the Topology-Change-Report is cleared.

Let's give userland the possibility to clear the MTCR in the case
of a subsystem reset.

To migrate the MTCR, we give userland the possibility to
query the MTCR state.

We indicate KVM support for the CPU topology facility with a new
KVM capability: KVM_CAP_S390_CPU_TOPOLOGY.

	Signed-off-by: Pierre Morel <pmorel@linux.ibm.com>
	Reviewed-by: Janis Schoetterl-Glausch <scgl@linux.ibm.com>
	Reviewed-by: Janosch Frank <frankja@linux.ibm.com>
Message-Id: <20220714194334.127812-1-pmorel@linux.ibm.com>
Link: https://lore.kernel.org/all/20220714194334.127812-1-pmorel@linux.ibm.com/
[frankja@linux.ibm.com: Simple conflict resolution in Documentation/virt/kvm/api.rst]
	Signed-off-by: Janosch Frank <frankja@linux.ibm.com>
(cherry picked from commit f5ecfee94493475783074e86ded10a0499d779fc)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	Documentation/virt/kvm/api.rst
#	arch/s390/kvm/kvm-s390.c
#	include/uapi/linux/kvm.h
diff --cc Documentation/virt/kvm/api.rst
index 30da84ac28c5,3c4551a2f6d0..000000000000
--- a/Documentation/virt/kvm/api.rst
+++ b/Documentation/virt/kvm/api.rst
@@@ -7339,6 -8229,71 +7339,74 @@@ At this time, KVM_PMU_CAP_DISABLE is th
  this capability will disable PMU virtualization for that VM.  Usermode
  should adjust CPUID leaf 0xA to reflect that the PMU is disabled.
  
++<<<<<<< HEAD
++=======
+ 8.36 KVM_CAP_ARM_SYSTEM_SUSPEND
+ -------------------------------
+ 
+ :Capability: KVM_CAP_ARM_SYSTEM_SUSPEND
+ :Architectures: arm64
+ :Type: vm
+ 
+ When enabled, KVM will exit to userspace with KVM_EXIT_SYSTEM_EVENT of
+ type KVM_SYSTEM_EVENT_SUSPEND to process the guest suspend request.
+ 
+ 8.37 KVM_CAP_S390_PROTECTED_DUMP
+ --------------------------------
+ 
+ :Capability: KVM_CAP_S390_PROTECTED_DUMP
+ :Architectures: s390
+ :Type: vm
+ 
+ This capability indicates that KVM and the Ultravisor support dumping
+ PV guests. The `KVM_PV_DUMP` command is available for the
+ `KVM_S390_PV_COMMAND` ioctl and the `KVM_PV_INFO` command provides
+ dump related UV data. Also the vcpu ioctl `KVM_S390_PV_CPU_COMMAND` is
+ available and supports the `KVM_PV_DUMP_CPU` subcommand.
+ 
+ 8.38 KVM_CAP_VM_DISABLE_NX_HUGE_PAGES
+ ---------------------------
+ 
+ :Capability KVM_CAP_VM_DISABLE_NX_HUGE_PAGES
+ :Architectures: x86
+ :Type: vm
+ :Parameters: arg[0] must be 0.
+ :Returns 0 on success, -EPERM if the userspace process does not
+ 	 have CAP_SYS_BOOT, -EINVAL if args[0] is not 0 or any vCPUs have been
+ 	 created.
+ 
+ This capability disables the NX huge pages mitigation for iTLB MULTIHIT.
+ 
+ The capability has no effect if the nx_huge_pages module parameter is not set.
+ 
+ This capability may only be set before any vCPUs are created.
+ 
+ 8.39 KVM_CAP_S390_CPU_TOPOLOGY
+ ------------------------------
+ 
+ :Capability: KVM_CAP_S390_CPU_TOPOLOGY
+ :Architectures: s390
+ :Type: vm
+ 
+ This capability indicates that KVM will provide the S390 CPU Topology
+ facility which consist of the interpretation of the PTF instruction for
+ the function code 2 along with interception and forwarding of both the
+ PTF instruction with function codes 0 or 1 and the STSI(15,1,x)
+ instruction to the userland hypervisor.
+ 
+ The stfle facility 11, CPU Topology facility, should not be indicated
+ to the guest without this capability.
+ 
+ When this capability is present, KVM provides a new attribute group
+ on vm fd, KVM_S390_VM_CPU_TOPOLOGY.
+ This new attribute allows to get, set or clear the Modified Change
+ Topology Report (MTCR) bit of the SCA through the kvm_device_attr
+ structure.
+ 
+ When getting the Modified Change Topology Report value, the attr->addr
+ must point to a byte where the value will be stored or retrieved from.
+ 
++>>>>>>> f5ecfee94493 (KVM: s390: resetting the Topology-Change-Report)
  9. Known KVM API problems
  =========================
  
diff --cc arch/s390/kvm/kvm-s390.c
index 06fde9734b51,edfd4bbd0cba..000000000000
--- a/arch/s390/kvm/kvm-s390.c
+++ b/arch/s390/kvm/kvm-s390.c
@@@ -604,6 -619,32 +604,35 @@@ int kvm_vm_ioctl_check_extension(struc
  	case KVM_CAP_S390_PROTECTED:
  		r = is_prot_virt_host();
  		break;
++<<<<<<< HEAD
++=======
+ 	case KVM_CAP_S390_PROTECTED_DUMP: {
+ 		u64 pv_cmds_dump[] = {
+ 			BIT_UVC_CMD_DUMP_INIT,
+ 			BIT_UVC_CMD_DUMP_CONFIG_STOR_STATE,
+ 			BIT_UVC_CMD_DUMP_CPU,
+ 			BIT_UVC_CMD_DUMP_COMPLETE,
+ 		};
+ 		int i;
+ 
+ 		r = is_prot_virt_host();
+ 
+ 		for (i = 0; i < ARRAY_SIZE(pv_cmds_dump); i++) {
+ 			if (!test_bit_inv(pv_cmds_dump[i],
+ 					  (unsigned long *)&uv_info.inst_calls_list)) {
+ 				r = 0;
+ 				break;
+ 			}
+ 		}
+ 		break;
+ 	}
+ 	case KVM_CAP_S390_ZPCI_OP:
+ 		r = kvm_s390_pci_interp_allowed();
+ 		break;
+ 	case KVM_CAP_S390_CPU_TOPOLOGY:
+ 		r = test_facility(11);
+ 		break;
++>>>>>>> f5ecfee94493 (KVM: s390: resetting the Topology-Change-Report)
  	default:
  		r = 0;
  	}
diff --cc include/uapi/linux/kvm.h
index e287c95f13ed,7e06194129e3..000000000000
--- a/include/uapi/linux/kvm.h
+++ b/include/uapi/linux/kvm.h
@@@ -1129,6 -1159,16 +1129,18 @@@ struct kvm_ppc_resize_hpt 
  #define KVM_CAP_S390_MEM_OP_EXTENSION 211
  #define KVM_CAP_PMU_CAPABILITY 212
  #define KVM_CAP_DISABLE_QUIRKS2 213
++<<<<<<< HEAD
++=======
+ #define KVM_CAP_VM_TSC_CONTROL 214
+ #define KVM_CAP_SYSTEM_EVENT_DATA 215
+ #define KVM_CAP_ARM_SYSTEM_SUSPEND 216
+ #define KVM_CAP_S390_PROTECTED_DUMP 217
+ #define KVM_CAP_X86_TRIPLE_FAULT_EVENT 218
+ #define KVM_CAP_X86_NOTIFY_VMEXIT 219
+ #define KVM_CAP_VM_DISABLE_NX_HUGE_PAGES 220
+ #define KVM_CAP_S390_ZPCI_OP 221
+ #define KVM_CAP_S390_CPU_TOPOLOGY 222
++>>>>>>> f5ecfee94493 (KVM: s390: resetting the Topology-Change-Report)
  
  #ifdef KVM_CAP_IRQ_ROUTING
  
* Unmerged path Documentation/virt/kvm/api.rst
diff --git a/arch/s390/include/uapi/asm/kvm.h b/arch/s390/include/uapi/asm/kvm.h
index 7a6b14874d65..a73cf01a1606 100644
--- a/arch/s390/include/uapi/asm/kvm.h
+++ b/arch/s390/include/uapi/asm/kvm.h
@@ -74,6 +74,7 @@ struct kvm_s390_io_adapter_req {
 #define KVM_S390_VM_CRYPTO		2
 #define KVM_S390_VM_CPU_MODEL		3
 #define KVM_S390_VM_MIGRATION		4
+#define KVM_S390_VM_CPU_TOPOLOGY	5
 
 /* kvm attributes for mem_ctrl */
 #define KVM_S390_VM_MEM_ENABLE_CMMA	0
* Unmerged path arch/s390/kvm/kvm-s390.c
* Unmerged path include/uapi/linux/kvm.h
