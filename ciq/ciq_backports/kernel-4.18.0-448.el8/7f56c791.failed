scsi: mpi3mr: Add SAS SATA end devices to STL

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Sreekanth Reddy <sreekanth.reddy@broadcom.com>
commit 7f56c791969e0c19b8b5ee12058b636bf173eb90
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/7f56c791.failed

Register/unregister the SAS, SATA devices to SCSI Transport Layer(STL)
whenever the corresponding device is added/removed from topology.

Link: https://lore.kernel.org/r/20220804131226.16653-12-sreekanth.reddy@broadcom.com
	Reported-by: kernel test robot <lkp@intel.com>
	Reviewed-by: Himanshu Madhani <himanshu.madhani@oracle.com>
	Signed-off-by: Sreekanth Reddy <sreekanth.reddy@broadcom.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 7f56c791969e0c19b8b5ee12058b636bf173eb90)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/mpi3mr/mpi3mr.h
#	drivers/scsi/mpi3mr/mpi3mr_os.c
#	drivers/scsi/mpi3mr/mpi3mr_transport.c
diff --cc drivers/scsi/mpi3mr/mpi3mr.h
index 8de3e5650c79,21ea02147c46..000000000000
--- a/drivers/scsi/mpi3mr/mpi3mr.h
+++ b/drivers/scsi/mpi3mr/mpi3mr.h
@@@ -429,11 -569,25 +429,31 @@@ struct mpi3mr_intr_info 
   * information cached from firmware given data
   *
   * @sas_address: World wide unique SAS address
+  * @sas_address_parent: Sas address of parent expander or host
   * @dev_info: Device information bits
++<<<<<<< HEAD
++=======
+  * @phy_id: Phy identifier provided in device page 0
+  * @attached_phy_id: Attached phy identifier provided in device page 0
+  * @sas_transport_attached: Is this device exposed to transport
+  * @pend_sas_rphy_add: Flag to check device is in process of add
+  * @hba_port: HBA port entry
+  * @rphy: SAS transport layer rphy object
++>>>>>>> 7f56c791969e (scsi: mpi3mr: Add SAS SATA end devices to STL)
   */
  struct tgt_dev_sas_sata {
  	u64 sas_address;
+ 	u64 sas_address_parent;
  	u16 dev_info;
++<<<<<<< HEAD
++=======
+ 	u8 phy_id;
+ 	u8 attached_phy_id;
+ 	u8 sas_transport_attached;
+ 	u8 pend_sas_rphy_add;
+ 	struct mpi3mr_hba_port *hba_port;
+ 	struct sas_rphy *rphy;
++>>>>>>> 7f56c791969e (scsi: mpi3mr: Add SAS SATA end devices to STL)
  };
  
  /**
@@@ -1084,6 -1317,58 +1104,59 @@@ int mpi3mr_pel_get_seqnum_post(struct m
  	struct mpi3mr_drv_cmd *drv_cmd);
  void mpi3mr_app_save_logdata(struct mpi3mr_ioc *mrioc, char *event_data,
  	u16 event_data_size);
 -struct mpi3mr_enclosure_node *mpi3mr_enclosure_find_by_handle(
 -	struct mpi3mr_ioc *mrioc, u16 handle);
 -extern const struct attribute_group *mpi3mr_host_groups[];
 +extern struct device_attribute *mpi3mr_host_attrs[];
  extern const struct attribute_group *mpi3mr_dev_groups[];
++<<<<<<< HEAD
++=======
+ 
+ int mpi3mr_cfg_get_dev_pg0(struct mpi3mr_ioc *mrioc, u16 *ioc_status,
+ 	struct mpi3_device_page0 *dev_pg0, u16 pg_sz, u32 form, u32 form_spec);
+ int mpi3mr_cfg_get_sas_phy_pg0(struct mpi3mr_ioc *mrioc, u16 *ioc_status,
+ 	struct mpi3_sas_phy_page0 *phy_pg0, u16 pg_sz, u32 form,
+ 	u32 form_spec);
+ int mpi3mr_cfg_get_sas_phy_pg1(struct mpi3mr_ioc *mrioc, u16 *ioc_status,
+ 	struct mpi3_sas_phy_page1 *phy_pg1, u16 pg_sz, u32 form,
+ 	u32 form_spec);
+ int mpi3mr_cfg_get_sas_exp_pg0(struct mpi3mr_ioc *mrioc, u16 *ioc_status,
+ 	struct mpi3_sas_expander_page0 *exp_pg0, u16 pg_sz, u32 form,
+ 	u32 form_spec);
+ int mpi3mr_cfg_get_sas_exp_pg1(struct mpi3mr_ioc *mrioc, u16 *ioc_status,
+ 	struct mpi3_sas_expander_page1 *exp_pg1, u16 pg_sz, u32 form,
+ 	u32 form_spec);
+ int mpi3mr_cfg_get_enclosure_pg0(struct mpi3mr_ioc *mrioc, u16 *ioc_status,
+ 	struct mpi3_enclosure_page0 *encl_pg0, u16 pg_sz, u32 form,
+ 	u32 form_spec);
+ int mpi3mr_cfg_get_sas_io_unit_pg0(struct mpi3mr_ioc *mrioc,
+ 	struct mpi3_sas_io_unit_page0 *sas_io_unit_pg0, u16 pg_sz);
+ int mpi3mr_cfg_get_sas_io_unit_pg1(struct mpi3mr_ioc *mrioc,
+ 	struct mpi3_sas_io_unit_page1 *sas_io_unit_pg1, u16 pg_sz);
+ int mpi3mr_cfg_set_sas_io_unit_pg1(struct mpi3mr_ioc *mrioc,
+ 	struct mpi3_sas_io_unit_page1 *sas_io_unit_pg1, u16 pg_sz);
+ int mpi3mr_cfg_get_driver_pg1(struct mpi3mr_ioc *mrioc,
+ 	struct mpi3_driver_page1 *driver_pg1, u16 pg_sz);
+ 
+ u8 mpi3mr_is_expander_device(u16 device_info);
+ int mpi3mr_expander_add(struct mpi3mr_ioc *mrioc, u16 handle);
+ void mpi3mr_expander_remove(struct mpi3mr_ioc *mrioc, u64 sas_address,
+ 	struct mpi3mr_hba_port *hba_port);
+ struct mpi3mr_sas_node *__mpi3mr_expander_find_by_handle(struct mpi3mr_ioc
+ 	*mrioc, u16 handle);
+ struct mpi3mr_hba_port *mpi3mr_get_hba_port_by_id(struct mpi3mr_ioc *mrioc,
+ 	u8 port_id);
+ void mpi3mr_sas_host_refresh(struct mpi3mr_ioc *mrioc);
+ void mpi3mr_sas_host_add(struct mpi3mr_ioc *mrioc);
+ void mpi3mr_update_links(struct mpi3mr_ioc *mrioc,
+ 	u64 sas_address_parent, u16 handle, u8 phy_number, u8 link_rate,
+ 	struct mpi3mr_hba_port *hba_port);
+ void mpi3mr_remove_tgtdev_from_host(struct mpi3mr_ioc *mrioc,
+ 	struct mpi3mr_tgt_dev *tgtdev);
+ int mpi3mr_report_tgtdev_to_sas_transport(struct mpi3mr_ioc *mrioc,
+ 	struct mpi3mr_tgt_dev *tgtdev);
+ void mpi3mr_remove_tgtdev_from_sas_transport(struct mpi3mr_ioc *mrioc,
+ 	struct mpi3mr_tgt_dev *tgtdev);
+ struct mpi3mr_tgt_dev *__mpi3mr_get_tgtdev_by_addr_and_rphy(
+ 	struct mpi3mr_ioc *mrioc, u64 sas_address, struct sas_rphy *rphy);
+ void mpi3mr_print_device_event_notice(struct mpi3mr_ioc *mrioc,
+ 	bool device_add);
++>>>>>>> 7f56c791969e (scsi: mpi3mr: Add SAS SATA end devices to STL)
  #endif /*MPI3MR_H_INCLUDED*/
diff --cc drivers/scsi/mpi3mr/mpi3mr_os.c
index c851b53cb9f5,f5c3e9ad4a54..000000000000
--- a/drivers/scsi/mpi3mr/mpi3mr_os.c
+++ b/drivers/scsi/mpi3mr/mpi3mr_os.c
@@@ -1253,9 -1500,30 +1267,34 @@@ static void mpi3mr_sastopochg_evt_bh(st
  	int i;
  	u16 handle;
  	u8 reason_code;
++<<<<<<< HEAD
 +	struct mpi3mr_tgt_dev *tgtdev = NULL;
++=======
+ 	u64 exp_sas_address = 0, parent_sas_address = 0;
+ 	struct mpi3mr_hba_port *hba_port = NULL;
+ 	struct mpi3mr_tgt_dev *tgtdev = NULL;
+ 	struct mpi3mr_sas_node *sas_expander = NULL;
+ 	unsigned long flags;
+ 	u8 link_rate, prev_link_rate, parent_phy_number;
++>>>>>>> 7f56c791969e (scsi: mpi3mr: Add SAS SATA end devices to STL)
  
  	mpi3mr_sastopochg_evt_debug(mrioc, event_data);
+ 	if (mrioc->sas_transport_enabled) {
+ 		hba_port = mpi3mr_get_hba_port_by_id(mrioc,
+ 		    event_data->io_unit_port);
+ 		if (le16_to_cpu(event_data->expander_dev_handle)) {
+ 			spin_lock_irqsave(&mrioc->sas_node_lock, flags);
+ 			sas_expander = __mpi3mr_expander_find_by_handle(mrioc,
+ 			    le16_to_cpu(event_data->expander_dev_handle));
+ 			if (sas_expander) {
+ 				exp_sas_address = sas_expander->sas_address;
+ 				hba_port = sas_expander->hba_port;
+ 			}
+ 			spin_unlock_irqrestore(&mrioc->sas_node_lock, flags);
+ 			parent_sas_address = exp_sas_address;
+ 		} else
+ 			parent_sas_address = mrioc->sas_hba.sas_address;
+ 	}
  
  	for (i = 0; i < event_data->num_entries; i++) {
  		if (fwevt->discard)
* Unmerged path drivers/scsi/mpi3mr/mpi3mr_transport.c
* Unmerged path drivers/scsi/mpi3mr/mpi3mr.h
* Unmerged path drivers/scsi/mpi3mr/mpi3mr_os.c
* Unmerged path drivers/scsi/mpi3mr/mpi3mr_transport.c
