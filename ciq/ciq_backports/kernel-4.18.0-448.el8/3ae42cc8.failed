net: ipv6: add skb drop reasons to ip6_pkt_drop()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Menglong Dong <imagedong@tencent.com>
commit 3ae42cc8092be3201093f277ac3b3d62c97a3767
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/3ae42cc8.failed

Replace kfree_skb() used in ip6_pkt_drop() with kfree_skb_reason().
No new reason is added.

	Signed-off-by: Menglong Dong <imagedong@tencent.com>
	Reviewed-by: Jiang Biao <benbjiang@tencent.com>
	Reviewed-by: Hao Peng <flyingpeng@tencent.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 3ae42cc8092be3201093f277ac3b3d62c97a3767)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/ipv6/route.c
diff --cc net/ipv6/route.c
index 360871a0d347,9471ab4421c8..000000000000
--- a/net/ipv6/route.c
+++ b/net/ipv6/route.c
@@@ -3776,25 -4479,40 +3776,44 @@@ int ipv6_route_ioctl(struct net *net, u
  
  static int ip6_pkt_drop(struct sk_buff *skb, u8 code, int ipstats_mib_noroutes)
  {
++<<<<<<< HEAD
++=======
+ 	struct dst_entry *dst = skb_dst(skb);
+ 	struct net *net = dev_net(dst->dev);
+ 	struct inet6_dev *idev;
+ 	SKB_DR(reason);
++>>>>>>> 3ae42cc8092b (net: ipv6: add skb drop reasons to ip6_pkt_drop())
  	int type;
 -
 -	if (netif_is_l3_master(skb->dev) ||
 -	    dst->dev == net->loopback_dev)
 -		idev = __in6_dev_get_safely(dev_get_by_index_rcu(net, IP6CB(skb)->iif));
 -	else
 -		idev = ip6_dst_idev(dst);
 -
 +	struct dst_entry *dst = skb_dst(skb);
  	switch (ipstats_mib_noroutes) {
  	case IPSTATS_MIB_INNOROUTES:
  		type = ipv6_addr_type(&ipv6_hdr(skb)->daddr);
  		if (type == IPV6_ADDR_ANY) {
++<<<<<<< HEAD
 +			IP6_INC_STATS(dev_net(dst->dev),
 +				      __in6_dev_get_safely(skb->dev),
 +				      IPSTATS_MIB_INADDRERRORS);
 +			break;
 +		}
 +		/* FALLTHROUGH */
 +	case IPSTATS_MIB_OUTNOROUTES:
 +		IP6_INC_STATS(dev_net(dst->dev), ip6_dst_idev(dst),
 +			      ipstats_mib_noroutes);
++=======
+ 			SKB_DR_SET(reason, IP_INADDRERRORS);
+ 			IP6_INC_STATS(net, idev, IPSTATS_MIB_INADDRERRORS);
+ 			break;
+ 		}
+ 		SKB_DR_SET(reason, IP_INNOROUTES);
+ 		fallthrough;
+ 	case IPSTATS_MIB_OUTNOROUTES:
+ 		SKB_DR_OR(reason, IP_OUTNOROUTES);
+ 		IP6_INC_STATS(net, idev, ipstats_mib_noroutes);
++>>>>>>> 3ae42cc8092b (net: ipv6: add skb drop reasons to ip6_pkt_drop())
  		break;
  	}
 -
 -	/* Start over by dropping the dst for l3mdev case */
 -	if (netif_is_l3_master(skb->dev))
 -		skb_dst_drop(skb);
 -
  	icmpv6_send(skb, ICMPV6_DEST_UNREACH, code, 0);
- 	kfree_skb(skb);
+ 	kfree_skb_reason(skb, reason);
  	return 0;
  }
  
* Unmerged path net/ipv6/route.c
