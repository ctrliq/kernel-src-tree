scsi: mpi3mr: Block I/Os while refreshing target dev objects

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Sreekanth Reddy <sreekanth.reddy@broadcom.com>
commit 7f90bc70d1a6ab024cfe2512f5ba8e93ed45a35d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/7f90bc70.failed

Block the I/Os on the target devices until corresponding target device's
target dev objects are refreshed as part of post controller reset
operation.

Link: https://lore.kernel.org/r/20220804131226.16653-16-sreekanth.reddy@broadcom.com
	Reviewed-by: Himanshu Madhani <himanshu.madhani@oracle.com>
	Signed-off-by: Sreekanth Reddy <sreekanth.reddy@broadcom.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 7f90bc70d1a6ab024cfe2512f5ba8e93ed45a35d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/mpi3mr/mpi3mr_os.c
diff --cc drivers/scsi/mpi3mr/mpi3mr_os.c
index c851b53cb9f5,22f1a06b748e..000000000000
--- a/drivers/scsi/mpi3mr/mpi3mr_os.c
+++ b/drivers/scsi/mpi3mr/mpi3mr_os.c
@@@ -373,6 -421,11 +373,14 @@@ void mpi3mr_invalidate_devhandles(struc
  		if (tgtdev->starget && tgtdev->starget->hostdata) {
  			tgt_priv = tgtdev->starget->hostdata;
  			tgt_priv->dev_handle = MPI3MR_INVALID_DEV_HANDLE;
++<<<<<<< HEAD
++=======
+ 			tgt_priv->io_throttle_enabled = 0;
+ 			tgt_priv->io_divert = 0;
+ 			tgt_priv->throttle_group = NULL;
+ 			if (tgtdev->host_exposed)
+ 				atomic_set(&tgt_priv->block_io, 1);
++>>>>>>> 7f90bc70d1a6 (scsi: mpi3mr: Block I/Os while refreshing target dev objects)
  		}
  	}
  }
@@@ -965,6 -1070,10 +974,13 @@@ static void mpi3mr_update_tgtdev(struc
  		scsi_tgt_priv_data->perst_id = tgtdev->perst_id;
  		scsi_tgt_priv_data->dev_handle = tgtdev->dev_handle;
  		scsi_tgt_priv_data->dev_type = tgtdev->dev_type;
++<<<<<<< HEAD
++=======
+ 		scsi_tgt_priv_data->io_throttle_enabled =
+ 		    tgtdev->io_throttle_enabled;
+ 		if (is_added == true)
+ 			atomic_set(&scsi_tgt_priv_data->block_io, 0);
++>>>>>>> 7f90bc70d1a6 (scsi: mpi3mr: Block I/Os while refreshing target dev objects)
  	}
  
  	switch (dev_pg0->access_status) {
@@@ -4061,20 -4592,10 +4087,23 @@@ static int mpi3mr_qcmd(struct Scsi_Hos
  	}
  	if (stgt_priv_data->dev_removed) {
  		scmd->result = DID_NO_CONNECT << 16;
 -		scsi_done(scmd);
 +		scmd->scsi_done(scmd);
 +		goto out;
 +	}
 +
++<<<<<<< HEAD
 +	if (atomic_read(&stgt_priv_data->block_io)) {
 +		if (mrioc->stop_drv_processing) {
 +			scmd->result = DID_NO_CONNECT << 16;
 +			scmd->scsi_done(scmd);
 +			goto out;
 +		}
 +		retval = SCSI_MLQUEUE_DEVICE_BUSY;
  		goto out;
  	}
  
++=======
++>>>>>>> 7f90bc70d1a6 (scsi: mpi3mr: Block I/Os while refreshing target dev objects)
  	if (stgt_priv_data->dev_type == MPI3_DEVICE_DEVFORM_PCIE)
  		is_pcie_dev = 1;
  	if ((scmd->cmnd[0] == UNMAP) && is_pcie_dev &&
* Unmerged path drivers/scsi/mpi3mr/mpi3mr_os.c
