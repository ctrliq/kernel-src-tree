net: skb: use auto-generation to convert skb drop reason to string

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Menglong Dong <imagedong@tencent.com>
commit ec43908dd556b2292f028c6e412261689405ba6e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/ec43908d.failed

It is annoying to add new skb drop reasons to 'enum skb_drop_reason'
and TRACE_SKB_DROP_REASON in trace/event/skb.h, and it's easy to forget
to add the new reasons we added to TRACE_SKB_DROP_REASON.

TRACE_SKB_DROP_REASON is used to convert drop reason of type number
to string. For now, the string we passed to user space is exactly the
same as the name in 'enum skb_drop_reason' with a 'SKB_DROP_REASON_'
prefix. Therefore, we can use 'auto-generation' to generate these
drop reasons to string at build time.

The new source 'dropreason_str.c' will be auto generated during build
time, which contains the string array
'const char * const drop_reasons[]'.

	Signed-off-by: Menglong Dong <imagedong@tencent.com>
	Signed-off-by: Paolo Abeni <pabeni@redhat.com>
(cherry picked from commit ec43908dd556b2292f028c6e412261689405ba6e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/net/dropreason.h
#	include/trace/events/skb.h
#	net/core/Makefile
diff --cc include/trace/events/skb.h
index 294c61bbe44b,45264e4bb254..000000000000
--- a/include/trace/events/skb.h
+++ b/include/trace/events/skb.h
@@@ -9,23 -9,6 +9,26 @@@
  #include <linux/netdevice.h>
  #include <linux/tracepoint.h>
  
++<<<<<<< HEAD
 +#define TRACE_SKB_DROP_REASON					\
 +	EM(SKB_DROP_REASON_NOT_SPECIFIED, NOT_SPECIFIED)	\
 +	EMe(SKB_DROP_REASON_MAX, MAX)
 +
 +#undef EM
 +#undef EMe
 +
 +#define EM(a, b)	TRACE_DEFINE_ENUM(a);
 +#define EMe(a, b)	TRACE_DEFINE_ENUM(a);
 +
 +TRACE_SKB_DROP_REASON
 +
 +#undef EM
 +#undef EMe
 +#define EM(a, b)	{ a, #b },
 +#define EMe(a, b)	{ a, #b }
 +
++=======
++>>>>>>> ec43908dd556 (net: skb: use auto-generation to convert skb drop reason to string)
  /*
   * Tracepoint for free an sk_buff:
   */
diff --cc net/core/Makefile
index 0c2233c826fd,e8ce3bd283a6..000000000000
--- a/net/core/Makefile
+++ b/net/core/Makefile
@@@ -32,8 -36,27 +33,32 @@@ obj-$(CONFIG_HWBM) += hwbm.
  obj-$(CONFIG_NET_DEVLINK) += devlink.o
  obj-$(CONFIG_GRO_CELLS) += gro_cells.o
  obj-$(CONFIG_FAILOVER) += failover.o
 +ifeq ($(CONFIG_INET),y)
  obj-$(CONFIG_NET_SOCK_MSG) += skmsg.o
  obj-$(CONFIG_BPF_SYSCALL) += sock_map.o
 +endif
  obj-$(CONFIG_BPF_SYSCALL) += bpf_sk_storage.o
++<<<<<<< HEAD
++=======
+ obj-$(CONFIG_OF)	+= of_net.o
+ 
+ clean-files := dropreason_str.c
+ 
+ quiet_cmd_dropreason_str = GEN     $@
+ cmd_dropreason_str = awk -F ',' 'BEGIN{ print "\#include <net/dropreason.h>\n"; \
+ 	print "const char * const drop_reasons[] = {" }\
+ 	/^enum skb_drop/ { dr=1; }\
+ 	/^\};/ { dr=0; }\
+ 	/^\tSKB_DROP_REASON_/ {\
+ 		if (dr) {\
+ 			sub(/\tSKB_DROP_REASON_/, "", $$1);\
+ 			printf "\t[SKB_DROP_REASON_%s] = \"%s\",\n", $$1, $$1;\
+ 		}\
+ 	}\
+ 	END{ print "};" }' $< > $@
+ 
+ $(obj)/dropreason_str.c: $(srctree)/include/net/dropreason.h
+ 	$(call cmd,dropreason_str)
+ 
+ $(obj)/dropreason_str.o: $(obj)/dropreason_str.c
++>>>>>>> ec43908dd556 (net: skb: use auto-generation to convert skb drop reason to string)
* Unmerged path include/net/dropreason.h
* Unmerged path include/net/dropreason.h
* Unmerged path include/trace/events/skb.h
diff --git a/net/core/.gitignore b/net/core/.gitignore
new file mode 100644
index 000000000000..df1e74372cce
--- /dev/null
+++ b/net/core/.gitignore
@@ -0,0 +1 @@
+dropreason_str.c
* Unmerged path net/core/Makefile
diff --git a/net/core/drop_monitor.c b/net/core/drop_monitor.c
index e2e977644182..51089c9607cd 100644
--- a/net/core/drop_monitor.c
+++ b/net/core/drop_monitor.c
@@ -47,19 +47,6 @@
 static int trace_state = TRACE_OFF;
 static bool monitor_hw;
 
-#undef EM
-#undef EMe
-
-#define EM(a, b)	[a] = #b,
-#define EMe(a, b)	[a] = #b
-
-/* drop_reasons is used to translate 'enum skb_drop_reason' to string,
- * which is reported to user space.
- */
-static const char * const drop_reasons[] = {
-	TRACE_SKB_DROP_REASON
-};
-
 /* net_dm_mutex
  *
  * An overall lock guarding every operation coming from userspace.
diff --git a/net/core/skbuff.c b/net/core/skbuff.c
index d7c555eb9bac..4d78b4f0719f 100644
--- a/net/core/skbuff.c
+++ b/net/core/skbuff.c
@@ -92,6 +92,9 @@ static struct kmem_cache *skbuff_ext_cache __ro_after_init;
 int sysctl_max_skb_frags __read_mostly = MAX_SKB_FRAGS;
 EXPORT_SYMBOL(sysctl_max_skb_frags);
 
+/* The array 'drop_reasons' is auto-generated in dropreason_str.c */
+EXPORT_SYMBOL(drop_reasons);
+
 /**
  *	skb_panic - private function for out-of-line support
  *	@skb:	buffer
