xhci: dbgtty: use IDR to support several dbc instances.

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Mathias Nyman <mathias.nyman@linux.intel.com>
commit e1ec140f273e1e30cea7e6d5f50934d877232121
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/e1ec140f.failed

To support systems with several xhci controllers with active
dbc on each xhci we need to use IDR to identify and give
an index to each port.

Avoid using global struct tty_driver.driver_state for storing
dbc port pointer as it won't work with several dbc ports

	Signed-off-by: Mathias Nyman <mathias.nyman@linux.intel.com>
Link: https://lore.kernel.org/r/20220216095153.1303105-6-mathias.nyman@linux.intel.com
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit e1ec140f273e1e30cea7e6d5f50934d877232121)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/usb/host/xhci-dbgtty.c
diff --cc drivers/usb/host/xhci-dbgtty.c
index 39f2b0c56e96,d3acc0829ee5..000000000000
--- a/drivers/usb/host/xhci-dbgtty.c
+++ b/drivers/usb/host/xhci-dbgtty.c
@@@ -535,8 -563,10 +563,14 @@@ int dbc_tty_init(void
  	ret = tty_register_driver(dbc_tty_driver);
  	if (ret) {
  		pr_err("Can't register dbc tty driver\n");
++<<<<<<< HEAD
 +		put_tty_driver(dbc_tty_driver);
++=======
+ 		tty_driver_kref_put(dbc_tty_driver);
+ 		idr_destroy(&dbc_tty_minors);
++>>>>>>> e1ec140f273e (xhci: dbgtty: use IDR to support several dbc instances.)
  	}
+ 
  	return ret;
  }
  
@@@ -544,7 -574,9 +578,9 @@@ void dbc_tty_exit(void
  {
  	if (dbc_tty_driver) {
  		tty_unregister_driver(dbc_tty_driver);
 -		tty_driver_kref_put(dbc_tty_driver);
 +		put_tty_driver(dbc_tty_driver);
  		dbc_tty_driver = NULL;
  	}
+ 
+ 	idr_destroy(&dbc_tty_minors);
  }
diff --git a/drivers/usb/host/xhci-dbgcap.h b/drivers/usb/host/xhci-dbgcap.h
index 5f3304a06591..ca04192fdab1 100644
--- a/drivers/usb/host/xhci-dbgcap.h
+++ b/drivers/usb/host/xhci-dbgcap.h
@@ -100,6 +100,7 @@ struct dbc_ep {
 struct dbc_port {
 	struct tty_port			port;
 	spinlock_t			port_lock;	/* port access */
+	int				minor;
 
 	struct list_head		read_pool;
 	struct list_head		read_queue;
* Unmerged path drivers/usb/host/xhci-dbgtty.c
