scsi: mpi3mr: Add framework to issue MPT transport cmds

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-448.el8
commit-author Sreekanth Reddy <sreekanth.reddy@broadcom.com>
commit 2bd37e28491401f772f8a8545ffbafb3f52e0e3e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-448.el8/2bd37e28.failed

Add framework to issue MPT transport commands to controllers.  Also issue
the MPT transport commands to get the manufacturing info of SAS expander
device.

Link: https://lore.kernel.org/r/20220804131226.16653-13-sreekanth.reddy@broadcom.com
	Reviewed-by: Himanshu Madhani <himanshu.madhani@oracle.com>
	Signed-off-by: Sreekanth Reddy <sreekanth.reddy@broadcom.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 2bd37e28491401f772f8a8545ffbafb3f52e0e3e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/mpi3mr/mpi3mr.h
#	drivers/scsi/mpi3mr/mpi3mr_fw.c
#	drivers/scsi/mpi3mr/mpi3mr_os.c
#	drivers/scsi/mpi3mr/mpi3mr_transport.c
diff --cc drivers/scsi/mpi3mr/mpi3mr.h
index 8de3e5650c79,a6c880c382c7..000000000000
--- a/drivers/scsi/mpi3mr/mpi3mr.h
+++ b/drivers/scsi/mpi3mr/mpi3mr.h
@@@ -95,9 -98,11 +95,14 @@@ extern atomic64_t event_counter
  #define MPI3MR_HOSTTAG_PEL_ABORT	3
  #define MPI3MR_HOSTTAG_PEL_WAIT		4
  #define MPI3MR_HOSTTAG_BLK_TMS		5
++<<<<<<< HEAD
++=======
+ #define MPI3MR_HOSTTAG_CFG_CMDS		6
+ #define MPI3MR_HOSTTAG_TRANSPORT_CMDS	7
++>>>>>>> 2bd37e284914 (scsi: mpi3mr: Add framework to issue MPT transport cmds)
  
  #define MPI3MR_NUM_DEVRMCMD		16
- #define MPI3MR_HOSTTAG_DEVRMCMD_MIN	(MPI3MR_HOSTTAG_BLK_TMS + 1)
+ #define MPI3MR_HOSTTAG_DEVRMCMD_MIN	(MPI3MR_HOSTTAG_TRANSPORT_CMDS + 1)
  #define MPI3MR_HOSTTAG_DEVRMCMD_MAX	(MPI3MR_HOSTTAG_DEVRMCMD_MIN + \
  						MPI3MR_NUM_DEVRMCMD - 1)
  
@@@ -272,6 -279,8 +277,11 @@@ enum mpi3mr_reset_reason 
  	MPI3MR_RESET_FROM_SYSFS = 23,
  	MPI3MR_RESET_FROM_SYSFS_TIMEOUT = 24,
  	MPI3MR_RESET_FROM_FIRMWARE = 27,
++<<<<<<< HEAD
++=======
+ 	MPI3MR_RESET_FROM_CFG_REQ_TIMEOUT = 29,
+ 	MPI3MR_RESET_FROM_SAS_TRANSPORT_TIMEOUT = 30,
++>>>>>>> 2bd37e284914 (scsi: mpi3mr: Add framework to issue MPT transport cmds)
  };
  
  /* Queue type definitions */
@@@ -796,6 -995,23 +806,26 @@@ struct scmd_priv 
   * @logdata_buf: Circular buffer to store log data entries
   * @logdata_buf_idx: Index of entry in buffer to store
   * @logdata_entry_sz: log data entry size
++<<<<<<< HEAD
++=======
+  * @pend_large_data_sz: Counter to track pending large data
+  * @io_throttle_data_length: I/O size to track in 512b blocks
+  * @io_throttle_high: I/O size to start throttle in 512b blocks
+  * @io_throttle_low: I/O size to stop throttle in 512b blocks
+  * @num_io_throttle_group: Maximum number of throttle groups
+  * @throttle_groups: Pointer to throttle group info structures
+  * @cfg_page: Default memory for configuration pages
+  * @cfg_page_dma: Configuration page DMA address
+  * @cfg_page_sz: Default configuration page memory size
+  * @sas_transport_enabled: SAS transport enabled or not
+  * @scsi_device_channel: Channel ID for SCSI devices
+  * @transport_cmds: Command tracker for SAS transport commands
+  * @sas_hba: SAS node for the controller
+  * @sas_expander_list: SAS node list of expanders
+  * @sas_node_lock: Lock to protect SAS node list
+  * @hba_port_table_list: List of HBA Ports
+  * @enclosure_list: List of Enclosure objects
++>>>>>>> 2bd37e284914 (scsi: mpi3mr: Add framework to issue MPT transport cmds)
   */
  struct mpi3mr_ioc {
  	struct list_head list;
@@@ -960,6 -1177,26 +990,29 @@@
  	u8 *logdata_buf;
  	u16 logdata_buf_idx;
  	u16 logdata_entry_sz;
++<<<<<<< HEAD
++=======
+ 
+ 	atomic_t pend_large_data_sz;
+ 	u32 io_throttle_data_length;
+ 	u32 io_throttle_high;
+ 	u32 io_throttle_low;
+ 	u16 num_io_throttle_group;
+ 	struct mpi3mr_throttle_group_info *throttle_groups;
+ 
+ 	void *cfg_page;
+ 	dma_addr_t cfg_page_dma;
+ 	u16 cfg_page_sz;
+ 
+ 	u8 sas_transport_enabled;
+ 	u8 scsi_device_channel;
+ 	struct mpi3mr_drv_cmd transport_cmds;
+ 	struct mpi3mr_sas_node sas_hba;
+ 	struct list_head sas_expander_list;
+ 	spinlock_t sas_node_lock;
+ 	struct list_head hba_port_table_list;
+ 	struct list_head enclosure_list;
++>>>>>>> 2bd37e284914 (scsi: mpi3mr: Add framework to issue MPT transport cmds)
  };
  
  /**
diff --cc drivers/scsi/mpi3mr/mpi3mr_fw.c
index a891e8c285f7,cbc346dc932e..000000000000
--- a/drivers/scsi/mpi3mr/mpi3mr_fw.c
+++ b/drivers/scsi/mpi3mr/mpi3mr_fw.c
@@@ -917,6 -914,8 +919,11 @@@ static const struct 
  	{ MPI3MR_RESET_FROM_SYSFS, "sysfs invocation" },
  	{ MPI3MR_RESET_FROM_SYSFS_TIMEOUT, "sysfs TM timeout" },
  	{ MPI3MR_RESET_FROM_FIRMWARE, "firmware asynchronous reset" },
++<<<<<<< HEAD
++=======
+ 	{ MPI3MR_RESET_FROM_CFG_REQ_TIMEOUT, "configuration request timeout"},
+ 	{ MPI3MR_RESET_FROM_SAS_TRANSPORT_TIMEOUT, "timeout of a SAS transport layer request" },
++>>>>>>> 2bd37e284914 (scsi: mpi3mr: Add framework to issue MPT transport cmds)
  };
  
  /**
diff --cc drivers/scsi/mpi3mr/mpi3mr_os.c
index c851b53cb9f5,094438cab6b2..000000000000
--- a/drivers/scsi/mpi3mr/mpi3mr_os.c
+++ b/drivers/scsi/mpi3mr/mpi3mr_os.c
@@@ -4322,6 -4832,9 +4322,12 @@@ mpi3mr_probe(struct pci_dev *pdev, cons
  	mpi3mr_init_drv_cmd(&mrioc->init_cmds, MPI3MR_HOSTTAG_INITCMDS);
  	mpi3mr_init_drv_cmd(&mrioc->host_tm_cmds, MPI3MR_HOSTTAG_BLK_TMS);
  	mpi3mr_init_drv_cmd(&mrioc->bsg_cmds, MPI3MR_HOSTTAG_BSG_CMDS);
++<<<<<<< HEAD
++=======
+ 	mpi3mr_init_drv_cmd(&mrioc->cfg_cmds, MPI3MR_HOSTTAG_CFG_CMDS);
+ 	mpi3mr_init_drv_cmd(&mrioc->transport_cmds,
+ 	    MPI3MR_HOSTTAG_TRANSPORT_CMDS);
++>>>>>>> 2bd37e284914 (scsi: mpi3mr: Add framework to issue MPT transport cmds)
  
  	for (i = 0; i < MPI3MR_NUM_DEVRMCMD; i++)
  		mpi3mr_init_drv_cmd(&mrioc->dev_rmhs_cmds[i],
* Unmerged path drivers/scsi/mpi3mr/mpi3mr_transport.c
* Unmerged path drivers/scsi/mpi3mr/mpi3mr.h
* Unmerged path drivers/scsi/mpi3mr/mpi3mr_fw.c
* Unmerged path drivers/scsi/mpi3mr/mpi3mr_os.c
* Unmerged path drivers/scsi/mpi3mr/mpi3mr_transport.c
