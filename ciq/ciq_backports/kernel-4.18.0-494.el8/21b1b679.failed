media: uvcvideo: Fix invalid pointer in uvc_ctrl_init_ctrl()

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-494.el8
commit-author Laurent Pinchart <laurent.pinchart@ideasonboard.com>
commit 21b1b6797fbe4fb5863c96f350359d0e982faddd
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-494.el8/21b1b679.failed

The handling of per-device mappings introduced in commit 86f7ef773156
("media: uvcvideo: Add support for per-device control mapping
overrides") overwrote the mapping variable after it was initialized and
before it was used, leading to usage of an invalid pointer for devices
with per-device mappings. Fix it.

Fixes: 86f7ef773156 ("media: uvcvideo: Add support for per-device control mapping overrides")
	Signed-off-by: Laurent Pinchart <laurent.pinchart@ideasonboard.com>
	Signed-off-by: Hans Verkuil <hverkuil-cisco@xs4all.nl>
	Signed-off-by: Mauro Carvalho Chehab <mchehab@kernel.org>
(cherry picked from commit 21b1b6797fbe4fb5863c96f350359d0e982faddd)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/media/usb/uvc/uvc_ctrl.c
diff --cc drivers/media/usb/uvc/uvc_ctrl.c
index 6b12dcdabf26,8c208db9600b..000000000000
--- a/drivers/media/usb/uvc/uvc_ctrl.c
+++ b/drivers/media/usb/uvc/uvc_ctrl.c
@@@ -2289,6 -2443,33 +2288,36 @@@ static void uvc_ctrl_init_ctrl(struct u
  	if (!ctrl->initialized)
  		return;
  
++<<<<<<< HEAD
++=======
+ 	/*
+ 	 * First check if the device provides a custom mapping for this control,
+ 	 * used to override standard mappings for non-conformant devices. Don't
+ 	 * process standard mappings if a custom mapping is found. This
+ 	 * mechanism doesn't support combining standard and custom mappings for
+ 	 * a single control.
+ 	 */
+ 	if (chain->dev->info->mappings) {
+ 		bool custom = false;
+ 		unsigned int i;
+ 
+ 		for (i = 0; (mapping = chain->dev->info->mappings[i]); ++i) {
+ 			if (uvc_entity_match_guid(ctrl->entity, mapping->entity) &&
+ 			    ctrl->info.selector == mapping->selector) {
+ 				__uvc_ctrl_add_mapping(chain, ctrl, mapping);
+ 				custom = true;
+ 			}
+ 		}
+ 
+ 		if (custom)
+ 			return;
+ 	}
+ 
+ 	/* Process common mappings next. */
+ 	mapping = uvc_ctrl_mappings;
+ 	mend = mapping + ARRAY_SIZE(uvc_ctrl_mappings);
+ 
++>>>>>>> 21b1b6797fbe (media: uvcvideo: Fix invalid pointer in uvc_ctrl_init_ctrl())
  	for (; mapping < mend; ++mapping) {
  		if (uvc_entity_match_guid(ctrl->entity, mapping->entity) &&
  		    ctrl->info.selector == mapping->selector)
* Unmerged path drivers/media/usb/uvc/uvc_ctrl.c
