isystem: ship and use stdarg.h

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-494.el8
commit-author Alexey Dobriyan <adobriyan@gmail.com>
commit c0891ac15f0428ffa81b2e818d416bdf3cb74ab6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-494.el8/c0891ac1.failed

Ship minimal stdarg.h (1 type, 4 macros) as <linux/stdarg.h>.
stdarg.h is the only userspace header commonly used in the kernel.

GPL 2 version of <stdarg.h> can be extracted from
http://archive.debian.org/debian/pool/main/g/gcc-4.2/gcc-4.2_4.2.4.orig.tar.gz

	Signed-off-by: Alexey Dobriyan <adobriyan@gmail.com>
	Acked-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
	Acked-by: Ard Biesheuvel <ardb@kernel.org>
	Signed-off-by: Masahiro Yamada <masahiroy@kernel.org>
(cherry picked from commit c0891ac15f0428ffa81b2e818d416bdf3cb74ab6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/s390/boot/pgm_check_info.c
#	drivers/firmware/efi/libstub/efi-stub-helper.c
#	drivers/firmware/efi/libstub/vsprintf.c
#	drivers/gpu/drm/amd/display/dc/dc_helper.c
#	drivers/isdn/capi/capiutil.c
#	drivers/staging/media/atomisp/pci/hive_isp_css_include/print_support.h
#	drivers/staging/media/atomisp/pci/ia_css_env.h
#	drivers/staging/media/atomisp/pci/runtime/debug/interface/ia_css_debug.h
#	drivers/staging/media/atomisp/pci/sh_css_internal.h
#	include/linux/kernel.h
#	mm/kfence/report.c
#	net/batman-adv/log.c
diff --cc drivers/firmware/efi/libstub/efi-stub-helper.c
index 6e2d10272add,d489bdc645fe..000000000000
--- a/drivers/firmware/efi/libstub/efi-stub-helper.c
+++ b/drivers/firmware/efi/libstub/efi-stub-helper.c
@@@ -4,14 -5,16 +4,20 @@@
   * implementation files.
   *
   * Copyright 2011 Intel Corporation; author Matt Fleming
 + *
 + * This file is part of the Linux kernel, and is made available
 + * under the terms of the GNU General Public License version 2.
 + *
   */
  
++<<<<<<< HEAD
++=======
+ #include <linux/stdarg.h>
+ 
+ #include <linux/ctype.h>
++>>>>>>> c0891ac15f04 (isystem: ship and use stdarg.h)
  #include <linux/efi.h>
 -#include <linux/kernel.h>
 -#include <linux/printk.h> /* For CONSOLE_LOGLEVEL_* */
  #include <asm/efi.h>
 -#include <asm/setup.h>
  
  #include "efistub.h"
  
diff --cc drivers/gpu/drm/amd/display/dc/dc_helper.c
index c04d11011325,ab6bc5d79012..000000000000
--- a/drivers/gpu/drm/amd/display/dc/dc_helper.c
+++ b/drivers/gpu/drm/amd/display/dc/dc_helper.c
@@@ -28,7 -28,7 +28,11 @@@
   */
  
  #include <linux/delay.h>
++<<<<<<< HEAD
 +#include <stdarg.h>
++=======
+ #include <linux/stdarg.h>
++>>>>>>> c0891ac15f04 (isystem: ship and use stdarg.h)
  
  #include "dm_services.h"
  
diff --cc drivers/isdn/capi/capiutil.c
index 9846d82eb097,d7ae42edc4a8..000000000000
--- a/drivers/isdn/capi/capiutil.c
+++ b/drivers/isdn/capi/capiutil.c
@@@ -561,9 -379,7 +561,13 @@@ static char *pnames[] 
  	/*2f */ "Useruserdata"
  };
  
++<<<<<<< HEAD
 +
 +
 +#include <stdarg.h>
++=======
+ #include <linux/stdarg.h>
++>>>>>>> c0891ac15f04 (isystem: ship and use stdarg.h)
  
  /*-------------------------------------------------------*/
  static _cdebbuf *bufprint(_cdebbuf *cdb, char *fmt, ...)
diff --cc include/linux/kernel.h
index 0755dfb67f83,2776423a587e..000000000000
--- a/include/linux/kernel.h
+++ b/include/linux/kernel.h
@@@ -2,8 -2,8 +2,13 @@@
  #ifndef _LINUX_KERNEL_H
  #define _LINUX_KERNEL_H
  
++<<<<<<< HEAD
 +
 +#include <stdarg.h>
++=======
+ #include <linux/stdarg.h>
+ #include <linux/align.h>
++>>>>>>> c0891ac15f04 (isystem: ship and use stdarg.h)
  #include <linux/limits.h>
  #include <linux/linkage.h>
  #include <linux/stddef.h>
diff --cc net/batman-adv/log.c
index 01508b254e46,7a93a1e94c40..000000000000
--- a/net/batman-adv/log.c
+++ b/net/batman-adv/log.c
@@@ -19,75 -7,9 +19,79 @@@
  #include "log.h"
  #include "main.h"
  
++<<<<<<< HEAD
 +#include <linux/compiler.h>
 +#include <linux/debugfs.h>
 +#include <linux/errno.h>
 +#include <linux/eventpoll.h>
 +#include <linux/export.h>
 +#include <linux/fcntl.h>
 +#include <linux/fs.h>
 +#include <linux/gfp.h>
 +#include <linux/jiffies.h>
 +#include <linux/kernel.h>
 +#include <linux/module.h>
 +#include <linux/poll.h>
 +#include <linux/sched.h> /* for linux/wait.h */
 +#include <linux/slab.h>
 +#include <linux/spinlock.h>
 +#include <linux/stddef.h>
 +#include <linux/types.h>
 +#include <linux/uaccess.h>
 +#include <linux/wait.h>
 +#include <stdarg.h>
++=======
+ #include <linux/stdarg.h>
++>>>>>>> c0891ac15f04 (isystem: ship and use stdarg.h)
 +
 +#define BATADV_LOG_BUFF_MASK (batadv_log_buff_len - 1)
 +
 +static const int batadv_log_buff_len = BATADV_LOG_BUF_LEN;
 +
 +static char *batadv_log_char_addr(struct batadv_priv_debug_log *debug_log,
 +				  size_t idx)
 +{
 +	return &debug_log->log_buff[idx & BATADV_LOG_BUFF_MASK];
 +}
 +
 +static void batadv_emit_log_char(struct batadv_priv_debug_log *debug_log,
 +				 char c)
 +{
 +	char *char_addr;
 +
 +	char_addr = batadv_log_char_addr(debug_log, debug_log->log_end);
 +	*char_addr = c;
 +	debug_log->log_end++;
 +
 +	if (debug_log->log_end - debug_log->log_start > batadv_log_buff_len)
 +		debug_log->log_start = debug_log->log_end - batadv_log_buff_len;
 +}
 +
 +__printf(2, 3)
 +static int batadv_fdebug_log(struct batadv_priv_debug_log *debug_log,
 +			     const char *fmt, ...)
 +{
 +	va_list args;
 +	static char debug_log_buf[256];
 +	char *p;
 +
 +	if (!debug_log)
 +		return 0;
 +
 +	spin_lock_bh(&debug_log->lock);
 +	va_start(args, fmt);
 +	vscnprintf(debug_log_buf, sizeof(debug_log_buf), fmt, args);
 +	va_end(args);
 +
 +	for (p = debug_log_buf; *p != 0; p++)
 +		batadv_emit_log_char(debug_log, *p);
  
 -#include "trace.h"
 +	spin_unlock_bh(&debug_log->lock);
 +
 +	wake_up(&debug_log->queue_wait);
 +
 +	return 0;
 +}
  
  /**
   * batadv_debug_log() - Add debug log entry
* Unmerged path arch/s390/boot/pgm_check_info.c
* Unmerged path drivers/firmware/efi/libstub/vsprintf.c
* Unmerged path drivers/staging/media/atomisp/pci/hive_isp_css_include/print_support.h
* Unmerged path drivers/staging/media/atomisp/pci/ia_css_env.h
* Unmerged path drivers/staging/media/atomisp/pci/runtime/debug/interface/ia_css_debug.h
* Unmerged path drivers/staging/media/atomisp/pci/sh_css_internal.h
* Unmerged path mm/kfence/report.c
diff --git a/arch/parisc/kernel/firmware.c b/arch/parisc/kernel/firmware.c
index 6d471c00c71a..e18419e0a9b9 100644
--- a/arch/parisc/kernel/firmware.c
+++ b/arch/parisc/kernel/firmware.c
@@ -55,7 +55,7 @@
  *					prumpf	991016	
  */
 
-#include <stdarg.h>
+#include <linux/stdarg.h>
 
 #include <linux/delay.h>
 #include <linux/init.h>
diff --git a/arch/powerpc/kernel/prom_init.c b/arch/powerpc/kernel/prom_init.c
index f34b9949ffdb..25029360a787 100644
--- a/arch/powerpc/kernel/prom_init.c
+++ b/arch/powerpc/kernel/prom_init.c
@@ -18,7 +18,7 @@
 /* we cannot use FORTIFY as it brings in new symbols */
 #define __NO_FORTIFY
 
-#include <stdarg.h>
+#include <linux/stdarg.h>
 #include <linux/kernel.h>
 #include <linux/string.h>
 #include <linux/init.h>
diff --git a/arch/powerpc/kernel/rtas.c b/arch/powerpc/kernel/rtas.c
index e4e726eeccec..7bd2d7f39ec8 100644
--- a/arch/powerpc/kernel/rtas.c
+++ b/arch/powerpc/kernel/rtas.c
@@ -11,7 +11,7 @@
  *      2 of the License, or (at your option) any later version.
  */
 
-#include <stdarg.h>
+#include <linux/stdarg.h>
 #include <linux/kernel.h>
 #include <linux/types.h>
 #include <linux/spinlock.h>
diff --git a/arch/powerpc/kernel/udbg.c b/arch/powerpc/kernel/udbg.c
index 7cc38b5b58bc..6a17289bad46 100644
--- a/arch/powerpc/kernel/udbg.c
+++ b/arch/powerpc/kernel/udbg.c
@@ -9,7 +9,7 @@
  *      2 of the License, or (at your option) any later version.
  */
 
-#include <stdarg.h>
+#include <linux/stdarg.h>
 #include <linux/types.h>
 #include <linux/sched.h>
 #include <linux/console.h>
* Unmerged path arch/s390/boot/pgm_check_info.c
diff --git a/arch/x86/boot/boot.h b/arch/x86/boot/boot.h
index fe76924521ac..e35681e12f10 100644
--- a/arch/x86/boot/boot.h
+++ b/arch/x86/boot/boot.h
@@ -20,7 +20,7 @@
 
 #ifndef __ASSEMBLY__
 
-#include <stdarg.h>
+#include <linux/stdarg.h>
 #include <linux/types.h>
 #include <linux/edd.h>
 #include <asm/setup.h>
* Unmerged path drivers/firmware/efi/libstub/efi-stub-helper.c
* Unmerged path drivers/firmware/efi/libstub/vsprintf.c
* Unmerged path drivers/gpu/drm/amd/display/dc/dc_helper.c
diff --git a/drivers/gpu/drm/drm_print.c b/drivers/gpu/drm/drm_print.c
index 111b932cf2a9..f783d4963d4b 100644
--- a/drivers/gpu/drm/drm_print.c
+++ b/drivers/gpu/drm/drm_print.c
@@ -25,7 +25,7 @@
 
 #define DEBUG /* for pr_debug() */
 
-#include <stdarg.h>
+#include <linux/stdarg.h>
 
 #include <linux/io.h>
 #include <linux/moduleparam.h>
* Unmerged path drivers/isdn/capi/capiutil.c
diff --git a/drivers/macintosh/via-cuda.c b/drivers/macintosh/via-cuda.c
index 98dd702eb867..507f69f3fbea 100644
--- a/drivers/macintosh/via-cuda.c
+++ b/drivers/macintosh/via-cuda.c
@@ -9,7 +9,7 @@
  *
  * Copyright (C) 1996 Paul Mackerras.
  */
-#include <stdarg.h>
+#include <linux/stdarg.h>
 #include <linux/types.h>
 #include <linux/errno.h>
 #include <linux/kernel.h>
diff --git a/drivers/macintosh/via-pmu.c b/drivers/macintosh/via-pmu.c
index ff8ccc217c68..4e062b2a4ebe 100644
--- a/drivers/macintosh/via-pmu.c
+++ b/drivers/macintosh/via-pmu.c
@@ -18,7 +18,7 @@
  *    a sleep or a freq. switch
  *
  */
-#include <stdarg.h>
+#include <linux/stdarg.h>
 #include <linux/mutex.h>
 #include <linux/types.h>
 #include <linux/errno.h>
* Unmerged path drivers/staging/media/atomisp/pci/hive_isp_css_include/print_support.h
* Unmerged path drivers/staging/media/atomisp/pci/ia_css_env.h
* Unmerged path drivers/staging/media/atomisp/pci/runtime/debug/interface/ia_css_debug.h
* Unmerged path drivers/staging/media/atomisp/pci/sh_css_internal.h
diff --git a/fs/befs/debug.c b/fs/befs/debug.c
index eb7bd6c692c7..02fa66fb82c2 100644
--- a/fs/befs/debug.c
+++ b/fs/befs/debug.c
@@ -14,7 +14,7 @@
 #define pr_fmt(fmt) KBUILD_MODNAME ": " fmt
 #ifdef __KERNEL__
 
-#include <stdarg.h>
+#include <linux/stdarg.h>
 #include <linux/string.h>
 #include <linux/spinlock.h>
 #include <linux/kernel.h>
diff --git a/fs/reiserfs/prints.c b/fs/reiserfs/prints.c
index 9fed1c05f1f4..aba1f9487a6f 100644
--- a/fs/reiserfs/prints.c
+++ b/fs/reiserfs/prints.c
@@ -8,7 +8,7 @@
 #include <linux/string.h>
 #include <linux/buffer_head.h>
 
-#include <stdarg.h>
+#include <linux/stdarg.h>
 
 static char error_buf[1024];
 static char fmt_buf[1024];
diff --git a/fs/ufs/super.c b/fs/ufs/super.c
index d61b1fa097c4..fa09a2f1bb85 100644
--- a/fs/ufs/super.c
+++ b/fs/ufs/super.c
@@ -69,7 +69,7 @@
 #include <linux/module.h>
 #include <linux/bitops.h>
 
-#include <stdarg.h>
+#include <linux/stdarg.h>
 
 #include <linux/uaccess.h>
 
diff --git a/include/acpi/platform/acgcc.h b/include/acpi/platform/acgcc.h
index aa698c82d2c9..787508d1e394 100644
--- a/include/acpi/platform/acgcc.h
+++ b/include/acpi/platform/acgcc.h
@@ -22,7 +22,7 @@ typedef __builtin_va_list va_list;
 #define va_arg(v, l)            __builtin_va_arg(v, l)
 #define va_copy(d, s)           __builtin_va_copy(d, s)
 #else
-#include <stdarg.h>
+#include <linux/stdarg.h>
 #endif
 #endif
 
* Unmerged path include/linux/kernel.h
diff --git a/include/linux/printk.h b/include/linux/printk.h
index 035c88ba88f8..24f184328e63 100644
--- a/include/linux/printk.h
+++ b/include/linux/printk.h
@@ -2,7 +2,7 @@
 #ifndef __KERNEL_PRINTK__
 #define __KERNEL_PRINTK__
 
-#include <stdarg.h>
+#include <linux/stdarg.h>
 #include <linux/init.h>
 #include <linux/kern_levels.h>
 #include <linux/linkage.h>
diff --git a/include/linux/stdarg.h b/include/linux/stdarg.h
new file mode 100644
index 000000000000..c8dc7f4f390c
--- /dev/null
+++ b/include/linux/stdarg.h
@@ -0,0 +1,11 @@
+// SPDX-License-Identifier: GPL-2.0-or-later
+#ifndef _LINUX_STDARG_H
+#define _LINUX_STDARG_H
+
+typedef __builtin_va_list va_list;
+#define va_start(v, l)	__builtin_va_start(v, l)
+#define va_end(v)	__builtin_va_end(v)
+#define va_arg(v, T)	__builtin_va_arg(v, T)
+#define va_copy(d, s)	__builtin_va_copy(d, s)
+
+#endif
diff --git a/include/linux/string.h b/include/linux/string.h
index 2a12ef1ba634..456ccadc1c38 100644
--- a/include/linux/string.h
+++ b/include/linux/string.h
@@ -7,7 +7,7 @@
 #include <linux/types.h>	/* for size_t */
 #include <linux/stddef.h>	/* for NULL */
 #include <linux/errno.h>	/* for E2BIG */
-#include <stdarg.h>
+#include <linux/stdarg.h>
 #include <uapi/linux/string.h>
 
 extern char *strndup_user(const char __user *, long);
diff --git a/lib/debug_info.c b/lib/debug_info.c
index 36daf753293c..cc4723c74af5 100644
--- a/lib/debug_info.c
+++ b/lib/debug_info.c
@@ -5,8 +5,6 @@
  * CONFIG_DEBUG_INFO_REDUCED. Please do not add actual code. However,
  * adding appropriate #includes is fine.
  */
-#include <stdarg.h>
-
 #include <linux/cred.h>
 #include <linux/crypto.h>
 #include <linux/dcache.h>
@@ -22,6 +20,7 @@
 #include <linux/net.h>
 #include <linux/sched.h>
 #include <linux/slab.h>
+#include <linux/stdarg.h>
 #include <linux/types.h>
 #include <net/addrconf.h>
 #include <net/sock.h>
diff --git a/lib/kasprintf.c b/lib/kasprintf.c
index bacf7b83ccf0..cd2f5974ed98 100644
--- a/lib/kasprintf.c
+++ b/lib/kasprintf.c
@@ -5,7 +5,7 @@
  *  Copyright (C) 1991, 1992  Linus Torvalds
  */
 
-#include <stdarg.h>
+#include <linux/stdarg.h>
 #include <linux/export.h>
 #include <linux/slab.h>
 #include <linux/types.h>
diff --git a/lib/kunit/string-stream.h b/lib/kunit/string-stream.h
index 5e94b623454f..43f9508a55b4 100644
--- a/lib/kunit/string-stream.h
+++ b/lib/kunit/string-stream.h
@@ -11,7 +11,7 @@
 
 #include <linux/spinlock.h>
 #include <linux/types.h>
-#include <stdarg.h>
+#include <linux/stdarg.h>
 
 struct string_stream_fragment {
 	struct kunit *test;
diff --git a/lib/vsprintf.c b/lib/vsprintf.c
index 380bb3ab35d3..e297675511ea 100644
--- a/lib/vsprintf.c
+++ b/lib/vsprintf.c
@@ -16,7 +16,7 @@
  * - scnprintf and vscnprintf
  */
 
-#include <stdarg.h>
+#include <linux/stdarg.h>
 #include <linux/build_bug.h>
 #include <linux/clk.h>
 #include <linux/clk-provider.h>
* Unmerged path mm/kfence/report.c
* Unmerged path net/batman-adv/log.c
