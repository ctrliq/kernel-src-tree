scsi: lpfc: Exit PRLI completion handling early if ndlp not in PRLI_ISSUE state

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-494.el8
commit-author Justin Tee <justin.tee@broadcom.com>
commit c051f1a424a15b73c493090a9f1c0273398b1637
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-494.el8/c051f1a4.failed

In a large SAN testing configuration, frequent target port toggle tests are
occasionally resulting in missing lun path rediscoveries.  An outstanding
PRLI can be inflight when a target RSCN dissappearance occurs, causing the
driver to retry PRLIs using invalid rpi contexts.

Fix by verifying that an ndlp's state was not restarted from PRLI_ISSUE
due to an intermediate RSCN.  If not in a valid state, early exit PRLI
completion handling.

The last follow up RSCN indicating target reappearance retriggers
PLOGI/PRLI with a valid rpi context and is expected to succeed in LUN path
rediscovery.

	Signed-off-by: Justin Tee <justin.tee@broadcom.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit c051f1a424a15b73c493090a9f1c0273398b1637)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/lpfc/lpfc_els.c
diff --cc drivers/scsi/lpfc/lpfc_els.c
index 0d1a14a3209e,4d3b8f2036d2..000000000000
--- a/drivers/scsi/lpfc/lpfc_els.c
+++ b/drivers/scsi/lpfc/lpfc_els.c
@@@ -2348,12 -2373,13 +2348,19 @@@ lpfc_cmpl_els_prli(struct lpfc_hba *phb
  		/* PRLI failed */
  		lpfc_printf_vlog(vport, mode, loglevel,
  				 "2754 PRLI failure DID:%06X Status:x%x/x%x, "
++<<<<<<< HEAD
 +				 "data: x%x\n",
 +				 ndlp->nlp_DID, irsp->ulpStatus,
 +				 irsp->un.ulpWord[4], ndlp->fc4_prli_sent);
++=======
+ 				 "data: x%x x%x\n",
+ 				 ndlp->nlp_DID, ulp_status,
+ 				 ulp_word4, ndlp->nlp_state,
+ 				 ndlp->fc4_prli_sent);
++>>>>>>> c051f1a424a1 (scsi: lpfc: Exit PRLI completion handling early if ndlp not in PRLI_ISSUE state)
  
  		/* Do not call DSM for lpfc_els_abort'ed ELS cmds */
 -		if (!lpfc_error_lost_link(ulp_status, ulp_word4))
 +		if (!lpfc_error_lost_link(irsp))
  			lpfc_disc_state_machine(vport, ndlp, cmdiocb,
  						NLP_EVT_CMPL_PRLI);
  
* Unmerged path drivers/scsi/lpfc/lpfc_els.c
