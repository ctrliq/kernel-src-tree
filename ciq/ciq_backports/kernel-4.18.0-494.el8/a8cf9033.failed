bitfield: build kunit tests without structleak plugin

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-494.el8
commit-author Arnd Bergmann <arnd@arndb.de>
commit a8cf90332ae3e2b53813a146a99261b6a5e16a73
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-494.el8/a8cf9033.failed

The structleak plugin causes the stack frame size to grow immensely:

lib/bitfield_kunit.c: In function 'test_bitfields_constants':
lib/bitfield_kunit.c:93:1: error: the frame size of 7440 bytes is larger than 2048 bytes [-Werror=frame-larger-than=]

Turn it off in this file.

	Signed-off-by: Arnd Bergmann <arnd@arndb.de>
	Signed-off-by: Brendan Higgins <brendanhiggins@google.com>
	Reviewed-by: Kees Cook <keescook@chromium.org>
	Signed-off-by: Shuah Khan <skhan@linuxfoundation.org>
(cherry picked from commit a8cf90332ae3e2b53813a146a99261b6a5e16a73)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	lib/Makefile
diff --cc lib/Makefile
index 4bed89508b24,a841be5244ac..000000000000
--- a/lib/Makefile
+++ b/lib/Makefile
@@@ -322,44 -351,12 +322,49 @@@ obj-$(CONFIG_OBJAGG) += objagg.
  obj-$(CONFIG_PLDMFW) += pldmfw/
  
  # KUnit tests
++<<<<<<< HEAD
 +obj-$(CONFIG_BITFIELD_KUNIT_TEST) += bitfield_kunit.o
++=======
+ CFLAGS_bitfield_kunit.o := $(DISABLE_STRUCTLEAK_PLUGIN)
+ obj-$(CONFIG_BITFIELD_KUNIT) += bitfield_kunit.o
++>>>>>>> a8cf90332ae3 (bitfield: build kunit tests without structleak plugin)
  obj-$(CONFIG_LIST_KUNIT_TEST) += list-test.o
 -obj-$(CONFIG_LINEAR_RANGES_TEST) += test_linear_ranges.o
 -obj-$(CONFIG_BITS_TEST) += test_bits.o
 +obj-$(CONFIG_LINEAR_RANGES_KUNIT_TEST) += test_linear_ranges.o
 +obj-$(CONFIG_BITS_KUNIT_TEST) += test_bits.o
  obj-$(CONFIG_CMDLINE_KUNIT_TEST) += cmdline_kunit.o
  obj-$(CONFIG_SLUB_KUNIT_TEST) += slub_kunit.o
 -
 -obj-$(CONFIG_GENERIC_LIB_DEVMEM_IS_ALLOWED) += devmem_is_allowed.o
 +obj-$(CONFIG_MEMCPY_KUNIT_TEST) += memcpy_kunit.o
 +
 +# FORTIFY_SOURCE compile-time behavior tests
 +TEST_FORTIFY_SRCS = $(wildcard $(srctree)/$(src)/test_fortify/*-*.c)
 +TEST_FORTIFY_LOGS = $(patsubst $(srctree)/$(src)/%.c, %.log, $(TEST_FORTIFY_SRCS))
 +TEST_FORTIFY_LOG = test_fortify.log
 +
 +quiet_cmd_test_fortify = TEST    $@
 +      cmd_test_fortify = $(CONFIG_SHELL) $(srctree)/scripts/test_fortify.sh \
 +			$< $@ "$(NM)" $(CC) $(c_flags) \
 +			$(call cc-disable-warning,fortify-source) \
 +			-DKBUILD_EXTRA_WARN1
 +
 +targets += $(TEST_FORTIFY_LOGS)
 +clean-files += $(TEST_FORTIFY_LOGS)
 +clean-files += $(addsuffix .o, $(TEST_FORTIFY_LOGS))
 +$(obj)/test_fortify/%.log: $(src)/test_fortify/%.c \
 +			   $(src)/test_fortify/test_fortify.h \
 +			   $(srctree)/include/linux/fortify-string.h \
 +			   $(srctree)/scripts/test_fortify.sh \
 +			   FORCE
 +	$(call if_changed,test_fortify)
 +
 +quiet_cmd_gen_fortify_log = GEN     $@
 +      cmd_gen_fortify_log = cat </dev/null $(filter-out FORCE,$^) 2>/dev/null > $@ || true
 +
 +targets += $(TEST_FORTIFY_LOG)
 +clean-files += $(TEST_FORTIFY_LOG)
 +$(obj)/$(TEST_FORTIFY_LOG): $(addprefix $(obj)/, $(TEST_FORTIFY_LOGS)) FORCE
 +	$(call if_changed,gen_fortify_log)
 +
 +# Fake dependency to trigger the fortify tests.
 +ifeq ($(CONFIG_FORTIFY_SOURCE),y)
 +$(obj)/string.o: $(obj)/$(TEST_FORTIFY_LOG)
 +endif
* Unmerged path lib/Makefile
