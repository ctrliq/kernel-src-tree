scsi: lpfc: Record LOGO state with discovery engine even if aborted

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-494.el8
commit-author Justin Tee <justin.tee@broadcom.com>
commit 06578ac65e2ae9e4288e42202f67d93bd52eef45
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-494.el8/06578ac6.failed

A target vendor array reboot in P2P topology can sometimes result in
unsuccessful rediscovery.

Rework the lpfc_cmpl_els_logo() routine such that when the LOGO completes
as a failure because of driver abort, the LOGO state is still recorded with
the discovery state machine.

This is a small rework to set LOGO completion without forcing a device
removal state change.

	Signed-off-by: Justin Tee <justin.tee@broadcom.com>
Link: https://lore.kernel.org/r/20230301231626.9621-5-justintee8345@gmail.com
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 06578ac65e2ae9e4288e42202f67d93bd52eef45)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/lpfc/lpfc_els.c
diff --cc drivers/scsi/lpfc/lpfc_els.c
index 0d1a14a3209e,459e50836853..000000000000
--- a/drivers/scsi/lpfc/lpfc_els.c
+++ b/drivers/scsi/lpfc/lpfc_els.c
@@@ -2964,16 -3029,16 +2964,23 @@@ lpfc_cmpl_els_logo(struct lpfc_hba *phb
  	 * all acceptable.  Note the failure and move forward with
  	 * discovery.  The PLOGI will retry.
  	 */
 -	if (ulp_status) {
 +	if (irsp->ulpStatus) {
  		/* LOGO failed */
  		lpfc_printf_vlog(vport, KERN_ERR, LOG_TRACE_EVENT,
++<<<<<<< HEAD
 +				 "2756 LOGO failure, No Retry DID:%06X Status:x%x/x%x\n",
 +				 ndlp->nlp_DID, irsp->ulpStatus,
 +				 irsp->un.ulpWord[4]);
 +		if (lpfc_error_lost_link(irsp)) {
++=======
+ 				 "2756 LOGO failure, No Retry DID:%06X "
+ 				 "Status:x%x/x%x\n",
+ 				 ndlp->nlp_DID, ulp_status,
+ 				 ulp_word4);
+ 
+ 		if (lpfc_error_lost_link(ulp_status, ulp_word4))
++>>>>>>> 06578ac65e2a (scsi: lpfc: Record LOGO state with discovery engine even if aborted)
  			skip_recovery = 1;
- 			goto out;
- 		}
  	}
  
  	/* Call state machine. This will unregister the rpi if needed. */
* Unmerged path drivers/scsi/lpfc/lpfc_els.c
