efi/efivars: Set generic ops before loading SSDT

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-504.el8
commit-author Amadeusz Sławiński <amadeuszx.slawinski@linux.intel.com>
commit 50bdcf047503e30126327d0be4f0ad7337106d68
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-504.el8/50bdcf04.failed

Efivars allows for overriding of SSDT tables, however starting with
commit

  bf67fad19e493b ("efi: Use more granular check for availability for variable services")

this use case is broken. When loading SSDT generic ops should be set
first, however mentioned commit reversed order of operations. Fix this
by restoring original order of operations.

Fixes: bf67fad19e493b ("efi: Use more granular check for availability for variable services")
	Signed-off-by: Amadeusz Sławiński <amadeuszx.slawinski@linux.intel.com>
Link: https://lore.kernel.org/r/20201123172817.124146-1-amadeuszx.slawinski@linux.intel.com
	Tested-by: Cezary Rojewski <cezary.rojewski@intel.com>
	Signed-off-by: Ard Biesheuvel <ardb@kernel.org>
(cherry picked from commit 50bdcf047503e30126327d0be4f0ad7337106d68)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/firmware/efi/efi.c
diff --cc drivers/firmware/efi/efi.c
index af2bcb2c0beb,6c6eec044a97..000000000000
--- a/drivers/firmware/efi/efi.c
+++ b/drivers/firmware/efi/efi.c
@@@ -369,12 -387,15 +369,23 @@@ static int __init efisubsys_init(void
  		return -ENOMEM;
  	}
  
++<<<<<<< HEAD
 +	error = generic_ops_register();
 +	if (error)
 +		goto err_put;
 +
 +	if (efi_enabled(EFI_RUNTIME_SERVICES))
 +		efivar_ssdt_load();
++=======
+ 	if (efi_rt_services_supported(EFI_RT_SUPPORTED_GET_VARIABLE |
+ 				      EFI_RT_SUPPORTED_GET_NEXT_VARIABLE_NAME)) {
+ 		error = generic_ops_register();
+ 		if (error)
+ 			goto err_put;
+ 		efivar_ssdt_load();
+ 		platform_device_register_simple("efivars", 0, NULL, 0);
+ 	}
++>>>>>>> 50bdcf047503 (efi/efivars: Set generic ops before loading SSDT)
  
  	error = sysfs_create_group(efi_kobj, &efi_subsys_attr_group);
  	if (error) {
* Unmerged path drivers/firmware/efi/efi.c
