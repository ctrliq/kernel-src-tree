usb: ucsi: Fix ucsi->connector race

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-504.el8
commit-author Hans de Goede <hdegoede@redhat.com>
commit 0482c34ec6f8557e06cd0f8e2d0e20e8ede6a22c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-504.el8/0482c34e.failed

ucsi_init() which runs from a workqueue sets ucsi->connector and
on an error will clear it again.

ucsi->connector gets dereferenced by ucsi_resume(), this checks for
ucsi->connector being NULL in case ucsi_init() has not finished yet;
or in case ucsi_init() has failed.

ucsi_init() setting ucsi->connector and then clearing it again on
an error creates a race where the check in ucsi_resume() may pass,
only to have ucsi->connector free-ed underneath it when ucsi_init()
hits an error.

Fix this race by making ucsi_init() store the connector array in
a local variable and only assign it to ucsi->connector on success.

Fixes: bdc62f2bae8f ("usb: typec: ucsi: Simplified registration and I/O API")
	Cc: stable@vger.kernel.org
	Reviewed-by: Heikki Krogerus <heikki.krogerus@linux.intel.com>
	Signed-off-by: Hans de Goede <hdegoede@redhat.com>
Link: https://lore.kernel.org/r/20230308154244.722337-3-hdegoede@redhat.com
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 0482c34ec6f8557e06cd0f8e2d0e20e8ede6a22c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/usb/typec/ucsi/ucsi.c
diff --cc drivers/usb/typec/ucsi/ucsi.c
index c3da5e528242,8d1baf28df55..000000000000
--- a/drivers/usb/typec/ucsi/ucsi.c
+++ b/drivers/usb/typec/ucsi/ucsi.c
@@@ -1027,9 -1125,11 +1027,15 @@@ static struct fwnode_handle *ucsi_find_
  	return NULL;
  }
  
- static int ucsi_register_port(struct ucsi *ucsi, int index)
+ static int ucsi_register_port(struct ucsi *ucsi, struct ucsi_connector *con)
  {
++<<<<<<< HEAD
 +	struct ucsi_connector *con = &ucsi->connector[index];
++=======
+ 	struct usb_power_delivery_desc desc = { ucsi->cap.pd_version};
+ 	struct usb_power_delivery_capabilities_desc pd_caps;
+ 	struct usb_power_delivery_capabilities *pd_cap;
++>>>>>>> 0482c34ec6f8 (usb: ucsi: Fix ucsi->connector race)
  	struct typec_capability *cap = &con->typec_cap;
  	enum typec_accessory *accessory = cap->accessory;
  	enum usb_role u_role = USB_ROLE_NONE;
* Unmerged path drivers/usb/typec/ucsi/ucsi.c
