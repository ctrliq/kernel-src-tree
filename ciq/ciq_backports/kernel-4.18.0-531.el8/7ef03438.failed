perf/x86/amd/uncore: Use rdmsr if rdpmc is unavailable

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-531.el8
commit-author Sandipan Das <sandipan.das@amd.com>
commit 7ef0343855dc23a979a53b3143540f93f3e5bef8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-531.el8/7ef03438.failed

Not all uncore PMUs may support the use of the RDPMC instruction for
reading counters. In such cases, read the count from the corresponding
PERF_CTR register using the RDMSR instruction.

	Signed-off-by: Sandipan Das <sandipan.das@amd.com>
	Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
Link: https://lore.kernel.org/r/e9d994e32a3fcb39fa59fcf43ab4260d11aba097.1696425185.git.sandipan.das@amd.com
(cherry picked from commit 7ef0343855dc23a979a53b3143540f93f3e5bef8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/events/amd/uncore.c
diff --cc arch/x86/events/amd/uncore.c
index 63fc97aecaf4,2fe623923034..000000000000
--- a/arch/x86/events/amd/uncore.c
+++ b/arch/x86/events/amd/uncore.c
@@@ -156,23 -168,16 +165,28 @@@ out
  	if (hwc->idx == -1)
  		return -EBUSY;
  
 -	hwc->config_base = pmu->msr_base + (2 * hwc->idx);
 -	hwc->event_base = pmu->msr_base + 1 + (2 * hwc->idx);
 -	hwc->event_base_rdpmc = pmu->rdpmc_base + hwc->idx;
 +	hwc->config_base = uncore->msr_base + (2 * hwc->idx);
 +	hwc->event_base = uncore->msr_base + 1 + (2 * hwc->idx);
 +	hwc->event_base_rdpmc = uncore->rdpmc_base + hwc->idx;
  	hwc->state = PERF_HES_UPTODATE | PERF_HES_STOPPED;
  
++<<<<<<< HEAD
 +	/*
 +	 * The first four DF counters are accessible via RDPMC index 6 to 9
 +	 * followed by the L3 counters from index 10 to 15. For processors
 +	 * with more than four DF counters, the DF RDPMC assignments become
 +	 * discontiguous as the additional counters are accessible starting
 +	 * from index 16.
 +	 */
 +	if (is_nb_event(event) && hwc->idx >= NUM_COUNTERS_NB)
 +		hwc->event_base_rdpmc += NUM_COUNTERS_L3;
++=======
+ 	if (pmu->rdpmc_base < 0)
+ 		hwc->event_base_rdpmc = -1;
++>>>>>>> 7ef0343855dc (perf/x86/amd/uncore: Use rdmsr if rdpmc is unavailable)
  
  	if (flags & PERF_EF_START)
 -		event->pmu->start(event, PERF_EF_RELOAD);
 +		amd_uncore_start(event, PERF_EF_RELOAD);
  
  	return 0;
  }
* Unmerged path arch/x86/events/amd/uncore.c
