netfilter: nf_tables: disallow updates of anonymous sets

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-534.el8
commit-author Pablo Neira Ayuso <pablo@netfilter.org>
commit b770283c98e0eee9133c47bc03b6cc625dc94723
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-534.el8/b770283c.failed

Disallow updates of set timeout and garbage collection parameters for
anonymous sets.

Fixes: 123b99619cca ("netfilter: nf_tables: honor set timeout and garbage collection updates")
	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
(cherry picked from commit b770283c98e0eee9133c47bc03b6cc625dc94723)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/netfilter/nf_tables_api.c
diff --cc net/netfilter/nf_tables_api.c
index 3cce3d33e39c,16995b88da2f..000000000000
--- a/net/netfilter/nf_tables_api.c
+++ b/net/netfilter/nf_tables_api.c
@@@ -4187,16 -4960,35 +4187,39 @@@ static int nf_tables_newset(struct net 
  			NL_SET_BAD_ATTR(extack, nla[NFTA_SET_NAME]);
  			return -EEXIST;
  		}
 -		if (info->nlh->nlmsg_flags & NLM_F_REPLACE)
 +		if (nlh->nlmsg_flags & NLM_F_REPLACE)
  			return -EOPNOTSUPP;
  
++<<<<<<< HEAD
 +		return 0;
++=======
+ 		if (nft_set_is_anonymous(set))
+ 			return -EOPNOTSUPP;
+ 
+ 		err = nft_set_expr_alloc(&ctx, set, nla, exprs, &num_exprs, flags);
+ 		if (err < 0)
+ 			return err;
+ 
+ 		err = 0;
+ 		if (!nft_set_is_same(set, &desc, exprs, num_exprs, flags)) {
+ 			NL_SET_BAD_ATTR(extack, nla[NFTA_SET_NAME]);
+ 			err = -EEXIST;
+ 		}
+ 
+ 		for (i = 0; i < num_exprs; i++)
+ 			nft_expr_destroy(&ctx, exprs[i]);
+ 
+ 		if (err < 0)
+ 			return err;
+ 
+ 		return __nft_trans_set_add(&ctx, NFT_MSG_NEWSET, set, &desc);
++>>>>>>> b770283c98e0 (netfilter: nf_tables: disallow updates of anonymous sets)
  	}
  
 -	if (!(info->nlh->nlmsg_flags & NLM_F_CREATE))
 +	if (!(nlh->nlmsg_flags & NLM_F_CREATE))
  		return -ENOENT;
  
 -	ops = nft_select_set_ops(&ctx, nla, &desc);
 +	ops = nft_select_set_ops(&ctx, nla, &desc, policy);
  	if (IS_ERR(ops))
  		return PTR_ERR(ops);
  
* Unmerged path net/netfilter/nf_tables_api.c
