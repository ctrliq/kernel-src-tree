fanotify: add API to attach/detach super block mark

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-534.el8
commit-author Amir Goldstein <amir73il@gmail.com>
commit d54f4fba889b205e9cd8239182ca5d27d0ac3bc2
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-534.el8/d54f4fba.failed

Add another mark type flag FAN_MARK_FILESYSTEM for add/remove/flush
of super block mark type.

A super block watch gets all events on the filesystem, regardless of
the mount from which the mark was added, unless an ignore mask exists
on either the inode or the mount where the event was generated.

Only one of FAN_MARK_MOUNT and FAN_MARK_FILESYSTEM mark type flags
may be provided to fanotify_mark() or no mark type flag for inode mark.

	Cc: <linux-api@vger.kernel.org>
	Signed-off-by: Amir Goldstein <amir73il@gmail.com>
	Signed-off-by: Jan Kara <jack@suse.cz>
(cherry picked from commit d54f4fba889b205e9cd8239182ca5d27d0ac3bc2)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/notify/fanotify/fanotify_user.c
diff --cc fs/notify/fanotify/fanotify_user.c
index a9d1f5d6cbfa,1347c588f778..000000000000
--- a/fs/notify/fanotify/fanotify_user.c
+++ b/fs/notify/fanotify/fanotify_user.c
@@@ -849,8 -820,8 +864,13 @@@ static int do_fanotify_mark(int fanotif
  	struct fsnotify_group *group;
  	struct fd f;
  	struct path path;
++<<<<<<< HEAD
 +	u32 valid_mask = FANOTIFY_EVENTS | FANOTIFY_EVENT_FLAGS;
 +	unsigned int mark_type = flags & FANOTIFY_MARK_TYPE_BITS;
++=======
+ 	u32 valid_mask = FAN_ALL_EVENTS | FAN_EVENT_ON_CHILD;
+ 	unsigned int mark_type = flags & FAN_MARK_TYPE_MASK;
++>>>>>>> d54f4fba889b (fanotify: add API to attach/detach super block mark)
  	int ret;
  
  	pr_debug("%s: fanotify_fd=%d flags=%x dfd=%d pathname=%p mask=%llx\n",
@@@ -866,6 -837,7 +886,10 @@@
  	switch (mark_type) {
  	case FAN_MARK_INODE:
  	case FAN_MARK_MOUNT:
++<<<<<<< HEAD
++=======
+ 	case FAN_MARK_FILESYSTEM:
++>>>>>>> d54f4fba889b (fanotify: add API to attach/detach super block mark)
  		break;
  	default:
  		return -EINVAL;
@@@ -878,7 -850,7 +902,11 @@@
  			return -EINVAL;
  		break;
  	case FAN_MARK_FLUSH:
++<<<<<<< HEAD
 +		if (flags & ~(FANOTIFY_MARK_TYPE_BITS | FAN_MARK_FLUSH))
++=======
+ 		if (flags & ~(FAN_MARK_TYPE_MASK | FAN_MARK_FLUSH))
++>>>>>>> d54f4fba889b (fanotify: add API to attach/detach super block mark)
  			return -EINVAL;
  		break;
  	default:
* Unmerged path fs/notify/fanotify/fanotify_user.c
diff --git a/include/uapi/linux/fanotify.h b/include/uapi/linux/fanotify.h
index a7b6ac29ff04..7ce80dc49a84 100644
--- a/include/uapi/linux/fanotify.h
+++ b/include/uapi/linux/fanotify.h
@@ -59,6 +59,14 @@
 #define FAN_MARK_IGNORED_MASK	0x00000020
 #define FAN_MARK_IGNORED_SURV_MODIFY	0x00000040
 #define FAN_MARK_FLUSH		0x00000080
+/* FAN_MARK_FILESYSTEM is	0x00000100 */
+
+/* These are NOT bitwise flags.  Both bits can be used togther.  */
+#define FAN_MARK_INODE		0x00000000
+#define FAN_MARK_MOUNT		0x00000010
+#define FAN_MARK_FILESYSTEM	0x00000100
+#define FAN_MARK_TYPE_MASK	(FAN_MARK_INODE | FAN_MARK_MOUNT | \
+				 FAN_MARK_FILESYSTEM)
 
 /* These are NOT bitwise flags.  Both bits can be used togther.  */
 #define FAN_MARK_INODE		0x00000000
@@ -69,10 +77,10 @@
 				 FAN_MARK_REMOVE |\
 				 FAN_MARK_DONT_FOLLOW |\
 				 FAN_MARK_ONLYDIR |\
-				 FAN_MARK_MOUNT |\
 				 FAN_MARK_IGNORED_MASK |\
 				 FAN_MARK_IGNORED_SURV_MODIFY |\
-				 FAN_MARK_FLUSH)
+				 FAN_MARK_FLUSH|\
+				 FAN_MARK_TYPE_MASK)
 
 /* Deprecated - do not use this in programs and do not add new flags here! */
 #define FAN_ALL_EVENTS (FAN_ACCESS |\
