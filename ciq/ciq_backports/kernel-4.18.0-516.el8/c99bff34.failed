s390/dasd: fix command reject error on ESE devices

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-516.el8
commit-author Stefan Haberland <sth@linux.ibm.com>
commit c99bff34290f1b994073557b754aff86e4c7b22e
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-516.el8/c99bff34.failed

Formatting a thin-provisioned (ESE) device that is part of a PPRC copy
relation might fail with the following error:

dasd-eckd 0.0.f500: An error occurred in the DASD device driver, reason=09
[...]
24 Byte: 0 MSG 4, no MSGb to SYSOP

During format of an ESE disk the Release Allocated Space command is used.
A bit in the payload of the command is set that is not allowed to be set
for devices in a copy relation. This bit is set to allow the partial
release of an extent.

Check for the existence of a copy relation before setting the respective
bit.

Fixes: 91dc4a197569 ("s390/dasd: Add new ioctl to release space")
	Cc: stable@kernel.org # 5.3+
	Signed-off-by: Stefan Haberland <sth@linux.ibm.com>
	Reviewed-by: Jan Hoeppner <hoeppner@linux.ibm.com>
Link: https://lore.kernel.org/r/20230519102340.3854819-2-sth@linux.ibm.com
	Signed-off-by: Jens Axboe <axboe@kernel.dk>
(cherry picked from commit c99bff34290f1b994073557b754aff86e4c7b22e)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/s390/block/dasd_eckd.c
diff --cc drivers/s390/block/dasd_eckd.c
index e8e29c6a7dde,113c509bf6d0..000000000000
--- a/drivers/s390/block/dasd_eckd.c
+++ b/drivers/s390/block/dasd_eckd.c
@@@ -3800,11 -3815,13 +3827,19 @@@ dasd_eckd_dso_ras(struct dasd_device *d
  	/*
  	 * This bit guarantees initialisation of tracks within an extent that is
  	 * not fully specified, but is only supported with a certain feature
- 	 * subset.
+ 	 * subset and for devices not in a copy relation.
  	 */
++<<<<<<< HEAD
 +	ras_data->op_flags.guarantee_init = !!(features->feature[56] & 0x01);
 +	ras_data->lss = private->ned->ID;
 +	ras_data->dev_addr = private->ned->unit_addr;
++=======
+ 	if (features->feature[56] & 0x01 && !copy_relation)
+ 		ras_data->op_flags.guarantee_init = 1;
+ 
+ 	ras_data->lss = private->conf.ned->ID;
+ 	ras_data->dev_addr = private->conf.ned->unit_addr;
++>>>>>>> c99bff34290f (s390/dasd: fix command reject error on ESE devices)
  	ras_data->nr_exts = nr_exts;
  
  	if (by_extent) {
* Unmerged path drivers/s390/block/dasd_eckd.c
