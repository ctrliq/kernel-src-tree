s390/zcrypt: fix reply buffer calculations for CCA replies

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-516.el8
commit-author Harald Freudenberger <freude@linux.ibm.com>
commit 4cfca532ddc3474b3fc42592d0e4237544344b1a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-516.el8/4cfca532.failed

The length information for available buffer space for CCA
replies is covered with two fields in the T6 header prepended
on each CCA reply: fromcardlen1 and fromcardlen2. The sum of
these both values must not exceed the AP bus limit for this
card (24KB for CEX8, 12KB CEX7 and older) minus the always
present headers.

The current code adjusted the fromcardlen2 value in case
of exceeding the AP bus limit when there was a non-zero
value given from userspace. Some tests now showed that this
was the wrong assumption. Instead the userspace value given for
this field should always be trusted and if the sum of the
two fields exceeds the AP bus limit for this card the first
field fromcardlen1 should be adjusted instead.

So now the calculation is done with this new insight in mind.
Also some additional checks for overflow have been introduced
and some comments to provide some documentation for future
maintainers of this complicated calculation code.

Furthermore the 128 bytes of fix overhead which is used
in the current code is not correct. Investigations showed
that for a reply always the same two header structs are
prepended before a possible payload. So this is also fixed
with this patch.

	Signed-off-by: Harald Freudenberger <freude@linux.ibm.com>
	Reviewed-by: Holger Dengler <dengler@linux.ibm.com>
	Cc: stable@vger.kernel.org
	Signed-off-by: Heiko Carstens <hca@linux.ibm.com>
(cherry picked from commit 4cfca532ddc3474b3fc42592d0e4237544344b1a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/s390/crypto/zcrypt_msgtype6.c
diff --cc drivers/s390/crypto/zcrypt_msgtype6.c
index c524216cfc77,e668ff5eb384..000000000000
--- a/drivers/s390/crypto/zcrypt_msgtype6.c
+++ b/drivers/s390/crypto/zcrypt_msgtype6.c
@@@ -1218,8 -1101,7 +1218,12 @@@ static long zcrypt_msgtype6_send_cprb(b
  				      struct ica_xcRB *xcrb,
  				      struct ap_message *ap_msg)
  {
++<<<<<<< HEAD
 +	int rc;
 +	struct response_type *rtype = (struct response_type *)(ap_msg->private);
++=======
+ 	struct response_type *rtype = ap_msg->private;
++>>>>>>> 4cfca532ddc3 (s390/zcrypt: fix reply buffer calculations for CCA replies)
  	struct {
  		struct type6_hdr hdr;
  		struct CPRBX cprbx;
* Unmerged path drivers/s390/crypto/zcrypt_msgtype6.c
