KVM: s390: interrupt: Fix single-stepping kernel-emulated instructions

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-527.el8
commit-author Ilya Leoshkevich <iii@linux.ibm.com>
commit ba853a4e1c7addc631df55535bf0b04c62dc79d8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-527.el8/ba853a4e.failed

Single-stepping a kernel-emulated instruction that generates an
interrupt causes GDB to land on the instruction following it instead of
the respective interrupt handler.

The reason is that kvm_handle_sie_intercept(), after injecting the
interrupt, also processes the PER event and arranges a KVM_SINGLESTEP
exit. The interrupt is not yet delivered, however, so the userspace
sees the next instruction.

Fix by avoiding the KVM_SINGLESTEP exit when there is a pending
interrupt. The next __vcpu_run() loop iteration will arrange a
KVM_SINGLESTEP exit after delivering the interrupt.

	Reviewed-by: David Hildenbrand <david@redhat.com>
	Reviewed-by: Claudio Imbrenda <imbrenda@linux.ibm.com>
	Signed-off-by: Ilya Leoshkevich <iii@linux.ibm.com>
Message-ID: <20230725143857.228626-4-iii@linux.ibm.com>
	Signed-off-by: Claudio Imbrenda <imbrenda@linux.ibm.com>
	Signed-off-by: Janosch Frank <frankja@linux.ibm.com>
(cherry picked from commit ba853a4e1c7addc631df55535bf0b04c62dc79d8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/s390/kvm/intercept.c
diff --cc arch/s390/kvm/intercept.c
index 97a2bc6db84d,db222c749e5e..000000000000
--- a/arch/s390/kvm/intercept.c
+++ b/arch/s390/kvm/intercept.c
@@@ -648,9 -658,7 +661,13 @@@ int kvm_handle_sie_intercept(struct kvm
  		return -EOPNOTSUPP;
  	}
  
++<<<<<<< HEAD
 +	/* process PER, also if the instrution is processed in user space */
 +	if (vcpu->arch.sie_block->icptstatus & 0x02 &&
 +	    (!rc || rc == -EOPNOTSUPP))
++=======
+ 	if (should_handle_per_ifetch(vcpu, rc))
++>>>>>>> ba853a4e1c7a (KVM: s390: interrupt: Fix single-stepping kernel-emulated instructions)
  		per_rc = kvm_s390_handle_per_ifetch_icpt(vcpu);
  	return per_rc ? per_rc : rc;
  }
* Unmerged path arch/s390/kvm/intercept.c
