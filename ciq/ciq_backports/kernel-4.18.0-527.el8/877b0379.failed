scsi: qla2xxx: Add option to disable FC2 Target support

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-527.el8
commit-author Daniel Wagner <dwagner@suse.de>
commit 877b03795fcf29ff2e2351f7e574ecc9b9c51732
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-527.el8/877b0379.failed

Commit 44c57f205876 ("scsi: qla2xxx: Changes to support FCP2 Target") added
support for FC2 Targets. Unfortunately, there are older setups which break
with this new feature enabled.

Allow to disable it via module option.

Link: https://lore.kernel.org/r/20230208152014.109214-1-dwagner@suse.de
	Signed-off-by: Daniel Wagner <dwagner@suse.de>
	Reviewed-by: Himanshu Madhani <himanshu.madhani@oracle.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 877b03795fcf29ff2e2351f7e574ecc9b9c51732)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_os.c
diff --cc drivers/scsi/qla2xxx/qla_os.c
index 1e1b06aae8cb,80c4ee9df2a4..000000000000
--- a/drivers/scsi/qla2xxx/qla_os.c
+++ b/drivers/scsi/qla2xxx/qla_os.c
@@@ -341,15 -360,12 +341,24 @@@ MODULE_PARM_DESC(ql2xnvme_queues
  	"1 - Minimum number of queues supported\n"
  	"8 - Default value");
  
++<<<<<<< HEAD
 +u32 ql2xdelay_before_pci_error_handling = 5;
 +module_param(ql2xdelay_before_pci_error_handling, uint, 0644);
 +MODULE_PARM_DESC(ql2xdelay_before_pci_error_handling,
 +	"Number of seconds delayed before qla begin PCI error self-handling (default: 5).\n");
 +
 +static void qla2x00_clear_drv_active(struct qla_hw_data *);
 +static void qla2x00_free_device(scsi_qla_host_t *);
 +static int qla2xxx_map_queues(struct Scsi_Host *shost);
 +static void qla2x00_destroy_deferred_work(struct qla_hw_data *);
++=======
+ int ql2xfc2target = 1;
+ module_param(ql2xfc2target, int, 0444);
+ MODULE_PARM_DESC(qla2xfc2target,
+ 		  "Enables FC2 Target support. "
+ 		  "0 - FC2 Target support is disabled. "
+ 		  "1 - FC2 Target support is enabled (default).");
++>>>>>>> 877b03795fcf (scsi: qla2xxx: Add option to disable FC2 Target support)
  
  static struct scsi_transport_template *qla2xxx_transport_template = NULL;
  struct scsi_transport_template *qla2xxx_transport_vport_template = NULL;
diff --git a/drivers/scsi/qla2xxx/qla_gbl.h b/drivers/scsi/qla2xxx/qla_gbl.h
index f43d9a956671..eef4a67b092c 100644
--- a/drivers/scsi/qla2xxx/qla_gbl.h
+++ b/drivers/scsi/qla2xxx/qla_gbl.h
@@ -192,6 +192,7 @@ extern int ql2xsecenable;
 extern int ql2xenforce_iocb_limit;
 extern int ql2xabts_wait_nvme;
 extern u32 ql2xnvme_queues;
+extern int ql2xfc2target;
 
 extern int qla2x00_loop_reset(scsi_qla_host_t *);
 extern void qla2x00_abort_all_cmds(scsi_qla_host_t *, int);
diff --git a/drivers/scsi/qla2xxx/qla_init.c b/drivers/scsi/qla2xxx/qla_init.c
index e44c3d54b27e..c3e582c5e75c 100644
--- a/drivers/scsi/qla2xxx/qla_init.c
+++ b/drivers/scsi/qla2xxx/qla_init.c
@@ -1841,7 +1841,8 @@ void qla2x00_handle_rscn(scsi_qla_host_t *vha, struct event_arg *ea)
 	case RSCN_PORT_ADDR:
 		fcport = qla2x00_find_fcport_by_nportid(vha, &ea->id, 1);
 		if (fcport) {
-			if (fcport->flags & FCF_FCP2_DEVICE &&
+			if (ql2xfc2target &&
+			    fcport->flags & FCF_FCP2_DEVICE &&
 			    atomic_read(&fcport->state) == FCS_ONLINE) {
 				ql_dbg(ql_dbg_disc, vha, 0x2115,
 				       "Delaying session delete for FCP2 portid=%06x %8phC ",
* Unmerged path drivers/scsi/qla2xxx/qla_os.c
