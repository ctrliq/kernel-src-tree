s390: vfio-ap: tighten the NIB validity check

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-527.el8
commit-author Halil Pasic <pasic@linux.ibm.com>
commit a64a6d23874c574d30a9816124b2dc37467f3811
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-527.el8/a64a6d23.failed

The NIB is architecturally invalid if the address designates a
storage location that is not installed or if it is zero.

	Signed-off-by: Halil Pasic <pasic@linux.ibm.com>
	Reported-by: Janosch Frank <frankja@linux.ibm.com>
Fixes: ec89b55e3bce ("s390: ap: implement PAPQ AQIC interception in kernel")
	Reviewed-by: Tony Krowiak <akrowiak@linux.ibm.com>
	Reviewed-by: Pierre Morel <pmorel@linux.ibm.com>
	Signed-off-by: Heiko Carstens <hca@linux.ibm.com>
(cherry picked from commit a64a6d23874c574d30a9816124b2dc37467f3811)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/s390/crypto/vfio_ap_ops.c
diff --cc drivers/s390/crypto/vfio_ap_ops.c
index 8c0d90c7a8ec,28a36e016ea9..000000000000
--- a/drivers/s390/crypto/vfio_ap_ops.c
+++ b/drivers/s390/crypto/vfio_ap_ops.c
@@@ -352,13 -348,13 +352,19 @@@ end_free
   * Return: returns zero if the nib address is a valid; otherwise, returns
   *	   -EINVAL.
   */
 -static int vfio_ap_validate_nib(struct kvm_vcpu *vcpu, dma_addr_t *nib)
 +static int vfio_ap_validate_nib(struct kvm_vcpu *vcpu, unsigned long *nib,
 +				unsigned long *g_pfn)
  {
  	*nib = vcpu->run->s.regs.gprs[2];
 +	*g_pfn = *nib >> PAGE_SHIFT;
  
++<<<<<<< HEAD
 +	if (kvm_is_error_hva(gfn_to_hva(vcpu->kvm, *g_pfn)))
++=======
+ 	if (!*nib)
+ 		return -EINVAL;
+ 	if (kvm_is_error_hva(gfn_to_hva(vcpu->kvm, *nib >> PAGE_SHIFT)))
++>>>>>>> a64a6d23874c (s390: vfio-ap: tighten the NIB validity check)
  		return -EINVAL;
  
  	return 0;
* Unmerged path drivers/s390/crypto/vfio_ap_ops.c
