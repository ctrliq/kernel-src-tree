blk-mq: Fix wrong wakeup batch configuration which will cause hang

jira LE-4066
Rebuild_History Non-Buildable kernel-4.18.0-553.72.1.el8_10
commit-author Laibin Qiu <qiulaibin@huawei.com>
commit 10825410b956dc1ed8c5fbc8bbedaffdadde7f20
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.72.1.el8_10/10825410.failed

Commit 180dccb0dba4f ("blk-mq: fix tag_get wait task can't be
awakened") will recalculate wake_batch when incrementing or decrementing
active_queues to avoid wake_batch > hctx_max_depth. At the same time, in
order to not affect performance as much as possible, the minimum wakeup
batch is set to 4. But when the QD is small (such as QD=1), if inc or dec
active_queues increases wakeup batch, that can lead to a hang:

Fix this problem with the following strategies:
QD          :  >= 32 | < 32
---------------------------------
wakeup batch:  8~4   | 3~1

Fixes: 180dccb0dba4f ("blk-mq: fix tag_get wait task can't be awakened")
Link: https://lore.kernel.org/linux-block/78cafe94-a787-e006-8851-69906f0c2128@huawei.com/T/#t
	Reported-by: Alex Xu (Hello71) <alex_y_xu@yahoo.ca>
	Signed-off-by: Laibin Qiu <qiulaibin@huawei.com>
	Tested-by: Alex Xu (Hello71) <alex_y_xu@yahoo.ca>
Link: https://lore.kernel.org/r/20220127100047.1763746-1-qiulaibin@huawei.com
	Signed-off-by: Jens Axboe <axboe@kernel.dk>
(cherry picked from commit 10825410b956dc1ed8c5fbc8bbedaffdadde7f20)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	lib/sbitmap.c
diff --cc lib/sbitmap.c
index 0956b5ca3935,09d293c30fd2..000000000000
--- a/lib/sbitmap.c
+++ b/lib/sbitmap.c
@@@ -498,6 -475,30 +498,33 @@@ static void sbitmap_queue_update_wake_b
  	}
  }
  
++<<<<<<< HEAD
++=======
+ static void sbitmap_queue_update_wake_batch(struct sbitmap_queue *sbq,
+ 					    unsigned int depth)
+ {
+ 	unsigned int wake_batch;
+ 
+ 	wake_batch = sbq_calc_wake_batch(sbq, depth);
+ 	__sbitmap_queue_update_wake_batch(sbq, wake_batch);
+ }
+ 
+ void sbitmap_queue_recalculate_wake_batch(struct sbitmap_queue *sbq,
+ 					    unsigned int users)
+ {
+ 	unsigned int wake_batch;
+ 	unsigned int min_batch;
+ 	unsigned int depth = (sbq->sb.depth + users - 1) / users;
+ 
+ 	min_batch = sbq->sb.depth >= (4 * SBQ_WAIT_QUEUES) ? 4 : 1;
+ 
+ 	wake_batch = clamp_val(depth / SBQ_WAIT_QUEUES,
+ 			min_batch, SBQ_WAKE_BATCH);
+ 	__sbitmap_queue_update_wake_batch(sbq, wake_batch);
+ }
+ EXPORT_SYMBOL_GPL(sbitmap_queue_recalculate_wake_batch);
+ 
++>>>>>>> 10825410b956 (blk-mq: Fix wrong wakeup batch configuration which will cause hang)
  void sbitmap_queue_resize(struct sbitmap_queue *sbq, unsigned int depth)
  {
  	sbitmap_queue_update_wake_batch(sbq, depth);
* Unmerged path lib/sbitmap.c
