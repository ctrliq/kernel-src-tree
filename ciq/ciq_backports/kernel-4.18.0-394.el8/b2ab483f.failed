mlxsw: core: Register devlink instance last

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-394.el8
commit-author Leon Romanovsky <leonro@nvidia.com>
commit b2ab483fcbc30484aecea2a143bf541f7e5a35d8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-394.el8/b2ab483f.failed

Make sure that devlink is open to receive user input when all
parameters are initialized.

	Signed-off-by: Leon Romanovsky <leonro@nvidia.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit b2ab483fcbc30484aecea2a143bf541f7e5a35d8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlxsw/core.c
diff --cc drivers/net/ethernet/mellanox/mlxsw/core.c
index 7e9a7cb31720,9e831e8b607a..000000000000
--- a/drivers/net/ethernet/mellanox/mlxsw/core.c
+++ b/drivers/net/ethernet/mellanox/mlxsw/core.c
@@@ -1969,12 -1973,6 +1969,15 @@@ __mlxsw_core_bus_device_register(const 
  	if (err)
  		goto err_emad_init;
  
++<<<<<<< HEAD
 +	if (!reload) {
 +		err = devlink_register(devlink, mlxsw_bus_info->dev);
 +		if (err)
 +			goto err_devlink_register;
 +	}
 +
++=======
++>>>>>>> b2ab483fcbc3 (mlxsw: core: Register devlink instance last)
  	if (!reload) {
  		err = mlxsw_core_params_register(mlxsw_core);
  		if (err)
@@@ -2009,11 -2001,16 +2012,23 @@@
  	if (err)
  		goto err_env_init;
  
++<<<<<<< HEAD
 +	mlxsw_core->is_initialized = true;
 +	devlink_params_publish(devlink);
 +
 +	if (!reload)
++=======
+ 	if (mlxsw_driver->init) {
+ 		err = mlxsw_driver->init(mlxsw_core, mlxsw_bus_info, extack);
+ 		if (err)
+ 			goto err_driver_init;
+ 	}
+ 
+ 	if (!reload) {
+ 		devlink_register(devlink);
++>>>>>>> b2ab483fcbc3 (mlxsw: core: Register devlink instance last)
  		devlink_reload_enable(devlink);
+ 	}
  
  	return 0;
  
@@@ -2031,9 -2027,6 +2046,12 @@@ err_fw_rev_validate
  	if (!reload)
  		mlxsw_core_params_unregister(mlxsw_core);
  err_register_params:
++<<<<<<< HEAD
 +	if (!reload)
 +		devlink_unregister(devlink);
 +err_devlink_register:
++=======
++>>>>>>> b2ab483fcbc3 (mlxsw: core: Register devlink instance last)
  	mlxsw_emad_fini(mlxsw_core);
  err_emad_init:
  	kfree(mlxsw_core->lag.mapping);
@@@ -2094,8 -2089,8 +2114,13 @@@ void mlxsw_core_bus_device_unregister(s
  			return;
  	}
  
++<<<<<<< HEAD
 +	devlink_params_unpublish(devlink);
 +	mlxsw_core->is_initialized = false;
++=======
+ 	if (mlxsw_core->driver->fini)
+ 		mlxsw_core->driver->fini(mlxsw_core);
++>>>>>>> b2ab483fcbc3 (mlxsw: core: Register devlink instance last)
  	mlxsw_env_fini(mlxsw_core->env);
  	mlxsw_thermal_fini(mlxsw_core->thermal);
  	mlxsw_hwmon_fini(mlxsw_core->hwmon);
* Unmerged path drivers/net/ethernet/mellanox/mlxsw/core.c
