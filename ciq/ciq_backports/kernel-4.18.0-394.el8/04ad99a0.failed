arm64: unwind: strip PAC from kernel addresses

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-394.el8
commit-author Mark Rutland <mark.rutland@arm.com>
commit 04ad99a0b160450ae615e41b839e444eccb5c99b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-394.el8/04ad99a0.failed

When we enable pointer authentication in the kernel, LR values saved to
the stack will have a PAC which we must strip in order to retrieve the
real return address.

Strip PACs when unwinding the stack in order to account for this.

When function graph tracer is used with patchable-function-entry then
return_to_handler will also have pac bits so strip it too.

	Reviewed-by: Kees Cook <keescook@chromium.org>
	Acked-by: Catalin Marinas <catalin.marinas@arm.com>
	Reviewed-by: James Morse <james.morse@arm.com>
	Signed-off-by: Mark Rutland <mark.rutland@arm.com>
	Signed-off-by: Kristina Martsenko <kristina.martsenko@arm.com>
[Amit: Re-position ptrauth_strip_insn_pac, comment]
	Signed-off-by: Amit Daniel Kachhap <amit.kachhap@arm.com>
	Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>
(cherry picked from commit 04ad99a0b160450ae615e41b839e444eccb5c99b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/arm64/kernel/stacktrace.c
diff --cc arch/arm64/kernel/stacktrace.c
index eaeed3f1b577,139679c745bf..000000000000
--- a/arch/arm64/kernel/stacktrace.c
+++ b/arch/arm64/kernel/stacktrace.c
@@@ -58,12 -85,10 +59,17 @@@ int notrace unwind_frame(struct task_st
  
  #ifdef CONFIG_FUNCTION_GRAPH_TRACER
  	if (tsk->ret_stack &&
++<<<<<<< HEAD
 +			(frame->pc == (unsigned long)return_to_handler)) {
 +		if (WARN_ON_ONCE(frame->graph == -1))
 +			return -EINVAL;
 +		if (frame->graph < -1)
 +			frame->graph += FTRACE_NOTRACE_DEPTH;
 +
++=======
+ 		(ptrauth_strip_insn_pac(frame->pc) == (unsigned long)return_to_handler)) {
+ 		struct ftrace_ret_stack *ret_stack;
++>>>>>>> 04ad99a0b160 (arm64: unwind: strip PAC from kernel addresses)
  		/*
  		 * This is a case where function graph tracer has
  		 * modified a return address (LR) in a stack frame
* Unmerged path arch/arm64/kernel/stacktrace.c
