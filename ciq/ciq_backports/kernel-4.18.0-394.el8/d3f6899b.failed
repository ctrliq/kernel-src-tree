RDMA/rxe: Remove qp->grp_lock and qp->grp_list

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-394.el8
commit-author Bob Pearson <rpearsonhpe@gmail.com>
commit d3f6899b0b5617e8900d6b1ae60414e611b1a0f1
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-394.el8/d3f6899b.failed

Since it is no longer required to cleanup attachments to multicast
groups when a QP is destroyed qp->grp_lock and qp->grp_list are
no longer needed and are removed.

Link: https://lore.kernel.org/r/20220127213755.31697-7-rpearsonhpe@gmail.com
	Signed-off-by: Bob Pearson <rpearsonhpe@gmail.com>
	Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
(cherry picked from commit d3f6899b0b5617e8900d6b1ae60414e611b1a0f1)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/sw/rxe/rxe_mcast.c
#	drivers/infiniband/sw/rxe/rxe_qp.c
#	drivers/infiniband/sw/rxe/rxe_verbs.h
diff --cc drivers/infiniband/sw/rxe/rxe_mcast.c
index 5f1c72c1473c,9336295c4ee2..000000000000
--- a/drivers/infiniband/sw/rxe/rxe_mcast.c
+++ b/drivers/infiniband/sw/rxe/rxe_mcast.c
@@@ -82,14 -81,13 +82,13 @@@ done
  	return 0;
  }
  
 -static int rxe_mcast_add_grp_elem(struct rxe_dev *rxe, struct rxe_qp *qp,
 -			   struct rxe_mcg *grp)
 +int rxe_mcast_add_grp_elem(struct rxe_dev *rxe, struct rxe_qp *qp,
 +			   struct rxe_mc_grp *grp)
  {
  	int err;
 -	struct rxe_mca *elem;
 +	struct rxe_mc_elem *elem;
  
  	/* check to see of the qp is already a member of the group */
- 	spin_lock_bh(&qp->grp_lock);
  	spin_lock_bh(&grp->mcg_lock);
  	list_for_each_entry(elem, &grp->qp_list, qp_list) {
  		if (elem->qp == qp) {
@@@ -114,10 -112,9 +113,13 @@@
  
  	grp->num_qp++;
  	elem->qp = qp;
++<<<<<<< HEAD
 +	elem->grp = grp;
++=======
+ 	atomic_inc(&qp->mcg_num);
++>>>>>>> d3f6899b0b56 (RDMA/rxe: Remove qp->grp_lock and qp->grp_list)
  
  	list_add(&elem->qp_list, &grp->qp_list);
- 	list_add(&elem->grp_list, &qp->grp_list);
  
  	err = 0;
  out:
@@@ -142,11 -137,10 +142,9 @@@ int rxe_mcast_drop_grp_elem(struct rxe_
  	list_for_each_entry_safe(elem, tmp, &grp->qp_list, qp_list) {
  		if (elem->qp == qp) {
  			list_del(&elem->qp_list);
- 			list_del(&elem->grp_list);
  			grp->num_qp--;
 -			atomic_dec(&qp->mcg_num);
  
  			spin_unlock_bh(&grp->mcg_lock);
- 			spin_unlock_bh(&qp->grp_lock);
  			rxe_drop_ref(elem);
  			rxe_drop_ref(grp);	/* ref held by QP */
  			rxe_drop_ref(grp);	/* ref from get_key */
diff --cc drivers/infiniband/sw/rxe/rxe_qp.c
index cab1b2bbcdf3,5f270cbf18c6..000000000000
--- a/drivers/infiniband/sw/rxe/rxe_qp.c
+++ b/drivers/infiniband/sw/rxe/rxe_qp.c
@@@ -188,11 -188,6 +188,14 @@@ static void rxe_qp_init_misc(struct rxe
  		break;
  	}
  
++<<<<<<< HEAD
 +	INIT_LIST_HEAD(&qp->grp_list);
 +
 +	skb_queue_head_init(&qp->send_pkts);
 +
 +	spin_lock_init(&qp->grp_lock);
++=======
++>>>>>>> d3f6899b0b56 (RDMA/rxe: Remove qp->grp_lock and qp->grp_list)
  	spin_lock_init(&qp->state_lock);
  
  	atomic_set(&qp->ssn, 0);
diff --cc drivers/infiniband/sw/rxe/rxe_verbs.h
index 2fd73c878e17,55f8ed2bc621..000000000000
--- a/drivers/infiniband/sw/rxe/rxe_verbs.h
+++ b/drivers/infiniband/sw/rxe/rxe_verbs.h
@@@ -232,9 -232,7 +232,13 @@@ struct rxe_qp 
  	struct rxe_av		pri_av;
  	struct rxe_av		alt_av;
  
++<<<<<<< HEAD
 +	/* list of mcast groups qp has joined (for cleanup) */
 +	struct list_head	grp_list;
 +	spinlock_t		grp_lock; /* guard grp_list */
++=======
+ 	atomic_t		mcg_num;
++>>>>>>> d3f6899b0b56 (RDMA/rxe: Remove qp->grp_lock and qp->grp_list)
  
  	struct sk_buff_head	req_pkts;
  	struct sk_buff_head	resp_pkts;
@@@ -365,12 -362,10 +369,14 @@@ struct rxe_mc_grp 
  	u16			pkey;
  };
  
 -struct rxe_mca {
 -	struct rxe_pool_elem	elem;
 +struct rxe_mc_elem {
 +	struct rxe_pool_entry	pelem;
  	struct list_head	qp_list;
- 	struct list_head	grp_list;
  	struct rxe_qp		*qp;
++<<<<<<< HEAD
 +	struct rxe_mc_grp	*grp;
++=======
++>>>>>>> d3f6899b0b56 (RDMA/rxe: Remove qp->grp_lock and qp->grp_list)
  };
  
  struct rxe_port {
* Unmerged path drivers/infiniband/sw/rxe/rxe_mcast.c
* Unmerged path drivers/infiniband/sw/rxe/rxe_qp.c
* Unmerged path drivers/infiniband/sw/rxe/rxe_verbs.h
