scsi: qla2xxx: Fix loss of NVMe namespaces after driver reload test

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-394.el8
commit-author Arun Easi <aeasi@marvell.com>
commit db212f2eb3fb7f546366777e93c8f54614d39269
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-394.el8/db212f2e.failed

Driver registration of localport can race when it happens at the remote
port discovery time. Fix this by calling the registration under a mutex.

Link: https://lore.kernel.org/r/20220310092604.22950-4-njavali@marvell.com
Fixes: e84067d74301 ("scsi: qla2xxx: Add FC-NVMe F/W initialization and transport registration")
	Cc: stable@vger.kernel.org
	Reported-by: Marco Patalano <mpatalan@redhat.com>
	Tested-by: Marco Patalano <mpatalan@redhat.com>
	Reviewed-by: Himanshu Madhani <himanshu.madhani@oracle.com>
	Signed-off-by: Arun Easi <aeasi@marvell.com>
	Signed-off-by: Nilesh Javali <njavali@marvell.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit db212f2eb3fb7f546366777e93c8f54614d39269)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_nvme.c
diff --cc drivers/scsi/qla2xxx/qla_nvme.c
index b8aada653648,3bf5cbd754a7..000000000000
--- a/drivers/scsi/qla2xxx/qla_nvme.c
+++ b/drivers/scsi/qla2xxx/qla_nvme.c
@@@ -778,12 -782,22 +778,29 @@@ int qla_nvme_register_hba(struct scsi_q
  	ha = vha->hw;
  	tmpl = &qla_nvme_fc_transport;
  
++<<<<<<< HEAD
 +	WARN_ON(vha->nvme_local_port);
++=======
+ 	if (ql2xnvme_queues < MIN_NVME_HW_QUEUES || ql2xnvme_queues > MAX_NVME_HW_QUEUES) {
+ 		ql_log(ql_log_warn, vha, 0xfffd,
+ 		    "ql2xnvme_queues=%d is out of range(MIN:%d - MAX:%d). Resetting ql2xnvme_queues to:%d\n",
+ 		    ql2xnvme_queues, MIN_NVME_HW_QUEUES, MAX_NVME_HW_QUEUES,
+ 		    DEF_NVME_HW_QUEUES);
+ 		ql2xnvme_queues = DEF_NVME_HW_QUEUES;
+ 	}
++>>>>>>> db212f2eb3fb (scsi: qla2xxx: Fix loss of NVMe namespaces after driver reload test)
  
  	qla_nvme_fc_transport.max_hw_queues =
 -	    min((uint8_t)(ql2xnvme_queues),
 +	    min((uint8_t)(qla_nvme_fc_transport.max_hw_queues),
  		(uint8_t)(ha->max_qpairs ? ha->max_qpairs : 1));
  
++<<<<<<< HEAD
++=======
+ 	ql_log(ql_log_info, vha, 0xfffb,
+ 	       "Number of NVME queues used for this port: %d\n",
+ 	    qla_nvme_fc_transport.max_hw_queues);
+ 
++>>>>>>> db212f2eb3fb (scsi: qla2xxx: Fix loss of NVMe namespaces after driver reload test)
  	pinfo.node_name = wwn_to_u64(vha->node_name);
  	pinfo.port_name = wwn_to_u64(vha->port_name);
  	pinfo.port_role = FC_PORT_ROLE_NVME_INITIATOR;
* Unmerged path drivers/scsi/qla2xxx/qla_nvme.c
