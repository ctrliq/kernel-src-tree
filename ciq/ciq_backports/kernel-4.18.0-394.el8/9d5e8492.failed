xfs: adjust rt allocation minlen when extszhint > rtextsize

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-394.el8
commit-author Darrick J. Wong <djwong@kernel.org>
commit 9d5e8492eee017ffdaa9f0957e91d39d83163197
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-394.el8/9d5e8492.failed

xfs_bmap_rtalloc doesn't handle realtime extent files with extent size
hints larger than the rt volume's extent size properly, because
xfs_bmap_extsize_align can adjust the offset/length parameters to try to
fit the extent size hint.

Under these conditions, minlen has to be large enough so that any
allocation returned by xfs_rtallocate_extent will be large enough to
cover at least one of the blocks that the caller asked for.  If the
allocation is too short, bmapi_write will return no mapping for the
requested range, which causes ENOSPC errors in other parts of the
filesystem.

Therefore, adjust minlen upwards to fix this.  This can be found by
running generic/263 (g/127 or g/522) with a realtime extent size hint
that's larger than the rt volume extent size.

	Signed-off-by: Darrick J. Wong <djwong@kernel.org>
	Reviewed-by: Allison Henderson <allison.henderson@oracle.com>
(cherry picked from commit 9d5e8492eee017ffdaa9f0957e91d39d83163197)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/xfs/xfs_bmap_util.c
diff --cc fs/xfs/xfs_bmap_util.c
index c240d29fdc85,c9381bf4f04b..000000000000
--- a/fs/xfs/xfs_bmap_util.c
+++ b/fs/xfs/xfs_bmap_util.c
@@@ -149,15 -167,13 +167,22 @@@ retry
  	if (error)
  		return error;
  
++<<<<<<< HEAD
 +	ap->blkno = rtb;
 +	if (ap->blkno != NULLFSBLOCK) {
 +		ap->blkno *= mp->m_sb.sb_rextsize;
 +		ralen *= mp->m_sb.sb_rextsize;
 +		ap->length = ralen;
 +		ap->ip->i_d.di_nblocks += ralen;
++=======
+ 	if (rtb != NULLRTBLOCK) {
+ 		ap->blkno = rtb * mp->m_sb.sb_rextsize;
+ 		ap->length = ralen * mp->m_sb.sb_rextsize;
+ 		ap->ip->i_nblocks += ap->length;
++>>>>>>> 9d5e8492eee0 (xfs: adjust rt allocation minlen when extszhint > rtextsize)
  		xfs_trans_log_inode(ap->tp, ap->ip, XFS_ILOG_CORE);
  		if (ap->wasdel)
- 			ap->ip->i_delayed_blks -= ralen;
+ 			ap->ip->i_delayed_blks -= ap->length;
  		/*
  		 * Adjust the disk quota also. This was reserved
  		 * earlier.
* Unmerged path fs/xfs/xfs_bmap_util.c
