NFSv4: link must update the inode nlink.

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-394.el8
commit-author Trond Myklebust <trond.myklebust@hammerspace.com>
commit 1301e421b75b90b1a6101961b3aca2d91a9a0599
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-394.el8/1301e421.failed

	Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
(cherry picked from commit 1301e421b75b90b1a6101961b3aca2d91a9a0599)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfs/dir.c
diff --cc fs/nfs/dir.c
index 5ac7490c4e59,5c25c8cc037a..000000000000
--- a/fs/nfs/dir.c
+++ b/fs/nfs/dir.c
@@@ -1710,7 -1711,7 +1710,11 @@@ static void nfs_drop_nlink(struct inod
  	NFS_I(inode)->attr_gencount = nfs_inc_attr_generation_counter();
  	nfs_set_cache_invalid(
  		inode, NFS_INO_INVALID_CHANGE | NFS_INO_INVALID_CTIME |
++<<<<<<< HEAD
 +			       NFS_INO_INVALID_OTHER | NFS_INO_REVAL_FORCED);
++=======
+ 			       NFS_INO_INVALID_NLINK);
++>>>>>>> 1301e421b75b (NFSv4: link must update the inode nlink.)
  	spin_unlock(&inode->i_lock);
  }
  
* Unmerged path fs/nfs/dir.c
diff --git a/fs/nfs/nfs4proc.c b/fs/nfs/nfs4proc.c
index 2b64b461b599..dfc1f830f091 100644
--- a/fs/nfs/nfs4proc.c
+++ b/fs/nfs/nfs4proc.c
@@ -1175,6 +1175,14 @@ nfs4_inc_nlink_locked(struct inode *inode)
 	inc_nlink(inode);
 }
 
+static void
+nfs4_inc_nlink(struct inode *inode)
+{
+	spin_lock(&inode->i_lock);
+	nfs4_inc_nlink_locked(inode);
+	spin_unlock(&inode->i_lock);
+}
+
 static void
 nfs4_dec_nlink_locked(struct inode *inode)
 {
@@ -4787,6 +4795,7 @@ static int _nfs4_proc_link(struct inode *inode, struct inode *dir, const struct
 	if (!status) {
 		nfs4_update_changeattr(dir, &res.cinfo, res.fattr->time_start,
 				       NFS_INO_INVALID_DATA);
+		nfs4_inc_nlink(inode);
 		status = nfs_post_op_update_inode(inode, res.fattr);
 		if (!status)
 			nfs_setsecurity(inode, res.fattr, res.label);
