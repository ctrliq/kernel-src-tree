nfp: Move delink_register to be last command

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-394.el8
commit-author Leon Romanovsky <leonro@nvidia.com>
commit 4f2a81c40c3c4260facdcde995b3441b2858c4eb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-394.el8/4f2a81c4.failed

Open user space access to the devlink after driver is probed.

	Signed-off-by: Leon Romanovsky <leonro@nvidia.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 4f2a81c40c3c4260facdcde995b3441b2858c4eb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/netronome/nfp/nfp_net_main.c
diff --cc drivers/net/ethernet/netronome/nfp/nfp_net_main.c
index 921db40047d7,5fbb7c613ff1..000000000000
--- a/drivers/net/ethernet/netronome/nfp/nfp_net_main.c
+++ b/drivers/net/ethernet/netronome/nfp/nfp_net_main.c
@@@ -701,10 -701,6 +701,13 @@@ int nfp_net_pci_probe(struct nfp_pf *pf
  	if (err)
  		goto err_unmap;
  
++<<<<<<< HEAD
 +	err = devlink_register(devlink, &pf->pdev->dev);
 +	if (err)
 +		goto err_app_clean;
 +
++=======
++>>>>>>> 4f2a81c40c3c (nfp: Move delink_register to be last command)
  	err = nfp_shared_buf_register(pf);
  	if (err)
  		goto err_devlink_unreg;
@@@ -751,8 -748,6 +755,11 @@@ err_shared_buf_unreg
  	nfp_shared_buf_unregister(pf);
  err_devlink_unreg:
  	cancel_work_sync(&pf->port_refresh_work);
++<<<<<<< HEAD
 +	devlink_unregister(devlink);
 +err_app_clean:
++=======
++>>>>>>> 4f2a81c40c3c (nfp: Move delink_register to be last command)
  	nfp_net_pf_app_clean(pf);
  err_unmap:
  	nfp_net_pci_unmap_mem(pf);
diff --git a/drivers/net/ethernet/netronome/nfp/devlink_param.c b/drivers/net/ethernet/netronome/nfp/devlink_param.c
index 36491835ac65..db297ee4d7ad 100644
--- a/drivers/net/ethernet/netronome/nfp/devlink_param.c
+++ b/drivers/net/ethernet/netronome/nfp/devlink_param.c
@@ -233,13 +233,8 @@ int nfp_devlink_params_register(struct nfp_pf *pf)
 	if (err <= 0)
 		return err;
 
-	err = devlink_params_register(devlink, nfp_devlink_params,
-				      ARRAY_SIZE(nfp_devlink_params));
-	if (err)
-		return err;
-
-	devlink_params_publish(devlink);
-	return 0;
+	return devlink_params_register(devlink, nfp_devlink_params,
+				       ARRAY_SIZE(nfp_devlink_params));
 }
 
 void nfp_devlink_params_unregister(struct nfp_pf *pf)
* Unmerged path drivers/net/ethernet/netronome/nfp/nfp_net_main.c
