rdma/qedr: Fix crash due to redundant release of device's qp memory

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-394.el8
commit-author Prabhakar Kushwaha <pkushwaha@marvell.com>
commit 60fab1076636493cfa2686e712446595fe43bc16
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-394.el8/60fab107.failed

Device's QP memory should only be allocated and released by IB layer.
This patch removes the redundant release of the device's qp memory and
uses completion APIs to make sure that .destroy_qp() only return, when qp
reference becomes 0.

Fixes: 514aee660df4 ("RDMA: Globally allocate and release QP memory")
Link: https://lore.kernel.org/r/20211019082212.7052-1-pkushwaha@marvell.com
	Acked-by: Michal Kalderon <michal.kalderon@marvell.com>
	Signed-off-by: Ariel Elior <aelior@marvell.com>
	Signed-off-by: Shai Malin <smalin@marvell.com>
	Signed-off-by: Alok Prasad <palok@marvell.com>
	Signed-off-by: Prabhakar Kushwaha <pkushwaha@marvell.com>
	Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
(cherry picked from commit 60fab1076636493cfa2686e712446595fe43bc16)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/hw/qedr/verbs.c
diff --cc drivers/infiniband/hw/qedr/verbs.c
index d9cb3db3696e,dcb3653db72d..000000000000
--- a/drivers/infiniband/hw/qedr/verbs.c
+++ b/drivers/infiniband/hw/qedr/verbs.c
@@@ -2878,10 -2858,10 +2879,15 @@@ int qedr_destroy_qp(struct ib_qp *ibqp
  
  	qedr_free_qp_resources(dev, qp, udata);
  
- 	if (rdma_protocol_iwarp(&dev->ibdev, 1))
+ 	if (rdma_protocol_iwarp(&dev->ibdev, 1)) {
  		qedr_iw_qp_rem_ref(&qp->ibqp);
++<<<<<<< HEAD
 +	else
 +		kfree(qp);
++=======
+ 		wait_for_completion(&qp->qp_rel_comp);
+ 	}
++>>>>>>> 60fab1076636 (rdma/qedr: Fix crash due to redundant release of device's qp memory)
  
  	return 0;
  }
diff --git a/drivers/infiniband/hw/qedr/qedr.h b/drivers/infiniband/hw/qedr/qedr.h
index 3cb4febaad0f..8def88cfa300 100644
--- a/drivers/infiniband/hw/qedr/qedr.h
+++ b/drivers/infiniband/hw/qedr/qedr.h
@@ -455,6 +455,7 @@ struct qedr_qp {
 	/* synchronization objects used with iwarp ep */
 	struct kref refcnt;
 	struct completion iwarp_cm_comp;
+	struct completion qp_rel_comp;
 	unsigned long iwarp_cm_flags; /* enum iwarp_cm_flags */
 };
 
diff --git a/drivers/infiniband/hw/qedr/qedr_iw_cm.c b/drivers/infiniband/hw/qedr/qedr_iw_cm.c
index 9e2403324732..2458a3d20711 100644
--- a/drivers/infiniband/hw/qedr/qedr_iw_cm.c
+++ b/drivers/infiniband/hw/qedr/qedr_iw_cm.c
@@ -83,7 +83,7 @@ static void qedr_iw_free_qp(struct kref *ref)
 {
 	struct qedr_qp *qp = container_of(ref, struct qedr_qp, refcnt);
 
-	kfree(qp);
+	complete(&qp->qp_rel_comp);
 }
 
 static void
* Unmerged path drivers/infiniband/hw/qedr/verbs.c
