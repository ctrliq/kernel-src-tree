scsi: qla2xxx: Stop using the SCSI pointer

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-394.el8
commit-author Bart Van Assche <bvanassche@acm.org>
commit 5597616333ea8a8d1327749176e70a4bb2e59c5c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-394.el8/55976163.failed

Instead of using the SCp.ptr field to track whether or not a command is
in flight, use the sp->type field to track this information. sp->type
must be set for proper operation of the qla2xxx driver. See e.g. the
switch (sp->type) statement in qla2x00_ct_entry().

This patch prepares for removal of the SCSI pointer from struct scsi_cmnd.

Link: https://lore.kernel.org/r/20220218195117.25689-43-bvanassche@acm.org
	Cc: Nilesh Javali <njavali@marvell.com>
	Cc: Ewan D. Milne <emilne@redhat.com>
	Reviewed-by: Himanshu Madhani <himanshu.madhani@oracle.com>
	Reviewed-by: Hannes Reinecke <hare@suse.de>
	Reviewed-by: Daniel Wagner <dwagner@suse.de>
	Signed-off-by: Bart Van Assche <bvanassche@acm.org>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 5597616333ea8a8d1327749176e70a4bb2e59c5c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/qla2xxx/qla_os.c
diff --cc drivers/scsi/qla2xxx/qla_os.c
index 0417a8d02c85,58c83525f006..000000000000
--- a/drivers/scsi/qla2xxx/qla_os.c
+++ b/drivers/scsi/qla2xxx/qla_os.c
@@@ -731,8 -739,8 +731,13 @@@ void qla2x00_sp_compl(srb_t *sp, int re
  	/* kref: INIT */
  	kref_put(&sp->cmd_kref, qla2x00_sp_release);
  	cmd->result = res;
++<<<<<<< HEAD
 +	CMD_SP(cmd) = NULL;
 +	cmd->scsi_done(cmd);
++=======
+ 	sp->type = 0;
+ 	scsi_done(cmd);
++>>>>>>> 5597616333ea (scsi: qla2xxx: Stop using the SCSI pointer)
  	if (comp)
  		complete(comp);
  }
@@@ -823,8 -831,8 +828,13 @@@ void qla2xxx_qpair_sp_compl(srb_t *sp, 
  	/* ref: INIT */
  	kref_put(&sp->cmd_kref, qla2x00_sp_release);
  	cmd->result = res;
++<<<<<<< HEAD
 +	CMD_SP(cmd) = NULL;
 +	cmd->scsi_done(cmd);
++=======
+ 	sp->type = 0;
+ 	scsi_done(cmd);
++>>>>>>> 5597616333ea (scsi: qla2xxx: Stop using the SCSI pointer)
  	if (comp)
  		complete(comp);
  }
diff --git a/drivers/scsi/qla2xxx/qla_def.h b/drivers/scsi/qla2xxx/qla_def.h
index b551a01e1b65..6025026c00c7 100644
--- a/drivers/scsi/qla2xxx/qla_def.h
+++ b/drivers/scsi/qla2xxx/qla_def.h
@@ -5196,8 +5196,6 @@ struct secure_flash_update_block_pk {
 
 #define	QLA_DSDS_PER_IOCB	37
 
-#define CMD_SP(Cmnd)		((Cmnd)->SCp.ptr)
-
 #define QLA_SG_ALL	1024
 
 enum nexus_wait_type {
* Unmerged path drivers/scsi/qla2xxx/qla_os.c
