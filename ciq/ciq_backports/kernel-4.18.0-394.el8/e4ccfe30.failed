NFSD: Update the NFSv3 READDIR3res encoder to use struct xdr_stream

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-394.el8
commit-author Chuck Lever <chuck.lever@oracle.com>
commit e4ccfe3014de435984939a3d84b7f241d3b57b0d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-394.el8/e4ccfe30.failed

	Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
(cherry picked from commit e4ccfe3014de435984939a3d84b7f241d3b57b0d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	fs/nfsd/nfs3xdr.c
diff --cc fs/nfsd/nfs3xdr.c
index 3fa16aaa5ee2,3d076d3c5c7b..000000000000
--- a/fs/nfsd/nfs3xdr.c
+++ b/fs/nfsd/nfs3xdr.c
@@@ -156,6 -159,32 +156,35 @@@ encode_fh(__be32 *p, struct svc_fh *fhp
  }
  
  static bool
++<<<<<<< HEAD
++=======
+ svcxdr_encode_cookieverf3(struct xdr_stream *xdr, const __be32 *verf)
+ {
+ 	__be32 *p;
+ 
+ 	p = xdr_reserve_space(xdr, NFS3_COOKIEVERFSIZE);
+ 	if (!p)
+ 		return false;
+ 	memcpy(p, verf, NFS3_COOKIEVERFSIZE);
+ 
+ 	return true;
+ }
+ 
+ static bool
+ svcxdr_encode_writeverf3(struct xdr_stream *xdr, const __be32 *verf)
+ {
+ 	__be32 *p;
+ 
+ 	p = xdr_reserve_space(xdr, NFS3_WRITEVERFSIZE);
+ 	if (!p)
+ 		return false;
+ 	memcpy(p, verf, NFS3_WRITEVERFSIZE);
+ 
+ 	return true;
+ }
+ 
+ static bool
++>>>>>>> e4ccfe3014de (NFSD: Update the NFSv3 READDIR3res encoder to use struct xdr_stream)
  svcxdr_decode_filename3(struct xdr_stream *xdr, char **name, unsigned int *len)
  {
  	u32 size, i;
diff --git a/fs/nfsd/nfs3proc.c b/fs/nfsd/nfs3proc.c
index 5d8b39219ffb..95a670d4138c 100644
--- a/fs/nfsd/nfs3proc.c
+++ b/fs/nfsd/nfs3proc.c
@@ -447,7 +447,8 @@ static void nfsd3_init_dirlist_pages(struct svc_rqst *rqstp,
 	 * and reserve room for the NULL ptr & eof flag (-2 words) */
 	resp->buflen = (count >> 2) - 2;
 
-	resp->buffer = page_address(*rqstp->rq_next_page);
+	resp->pages = rqstp->rq_next_page;
+	resp->buffer = page_address(*resp->pages);
 	while (count > 0) {
 		rqstp->rq_next_page++;
 		count -= PAGE_SIZE;
* Unmerged path fs/nfsd/nfs3xdr.c
diff --git a/fs/nfsd/xdr3.h b/fs/nfsd/xdr3.h
index 8759e771bbc6..301264f4913e 100644
--- a/fs/nfsd/xdr3.h
+++ b/fs/nfsd/xdr3.h
@@ -176,6 +176,7 @@ struct nfsd3_readdirres {
 	struct svc_fh		scratch;
 	int			count;
 	__be32			verf[2];
+	struct page		**pages;
 
 	struct readdir_cd	common;
 	__be32 *		buffer;
