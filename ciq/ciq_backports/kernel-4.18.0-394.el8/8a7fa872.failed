RDMA/rxe: Remove rxe_drop_all_macst_groups

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-394.el8
commit-author Bob Pearson <rpearsonhpe@gmail.com>
commit 8a7fa872ff7922db1477208ba27cae6dd7e48012
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-394.el8/8a7fa872.failed

With o10-2.2.3 enforced rxe_drop_all_mcast_groups is completely
unnecessary. Remove it and references to it.

Link: https://lore.kernel.org/r/20220127213755.31697-6-rpearsonhpe@gmail.com
	Signed-off-by: Bob Pearson <rpearsonhpe@gmail.com>
	Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
(cherry picked from commit 8a7fa872ff7922db1477208ba27cae6dd7e48012)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/infiniband/sw/rxe/rxe_loc.h
#	drivers/infiniband/sw/rxe/rxe_mcast.c
diff --cc drivers/infiniband/sw/rxe/rxe_loc.h
index 9b2391b4090f,af40e3c212fb..000000000000
--- a/drivers/infiniband/sw/rxe/rxe_loc.h
+++ b/drivers/infiniband/sw/rxe/rxe_loc.h
@@@ -37,21 -37,12 +37,27 @@@ int rxe_cq_post(struct rxe_cq *cq, stru
  
  void rxe_cq_disable(struct rxe_cq *cq);
  
 -void rxe_cq_cleanup(struct rxe_pool_elem *arg);
 +void rxe_cq_cleanup(struct rxe_pool_entry *arg);
  
  /* rxe_mcast.c */
++<<<<<<< HEAD
 +int rxe_mcast_get_grp(struct rxe_dev *rxe, union ib_gid *mgid,
 +		      struct rxe_mc_grp **grp_p);
 +
 +int rxe_mcast_add_grp_elem(struct rxe_dev *rxe, struct rxe_qp *qp,
 +			   struct rxe_mc_grp *grp);
 +
 +int rxe_mcast_drop_grp_elem(struct rxe_dev *rxe, struct rxe_qp *qp,
 +			    union ib_gid *mgid);
 +
 +void rxe_drop_all_mcast_groups(struct rxe_qp *qp);
 +
 +void rxe_mc_cleanup(struct rxe_pool_entry *arg);
++=======
+ void rxe_mc_cleanup(struct rxe_pool_elem *arg);
+ int rxe_attach_mcast(struct ib_qp *ibqp, union ib_gid *mgid, u16 mlid);
+ int rxe_detach_mcast(struct ib_qp *ibqp, union ib_gid *mgid, u16 mlid);
++>>>>>>> 8a7fa872ff79 (RDMA/rxe: Remove rxe_drop_all_macst_groups)
  
  /* rxe_mmap.c */
  struct rxe_mmap_info {
diff --cc drivers/infiniband/sw/rxe/rxe_mcast.c
index 5f1c72c1473c,39a41daa7a6b..000000000000
--- a/drivers/infiniband/sw/rxe/rxe_mcast.c
+++ b/drivers/infiniband/sw/rxe/rxe_mcast.c
@@@ -161,37 -162,37 +161,41 @@@ err1
  	return -EINVAL;
  }
  
 -void rxe_mc_cleanup(struct rxe_pool_elem *elem)
++<<<<<<< HEAD
 +void rxe_drop_all_mcast_groups(struct rxe_qp *qp)
  {
 -	struct rxe_mcg *grp = container_of(elem, typeof(*grp), elem);
 -	struct rxe_dev *rxe = grp->rxe;
 -
 -	rxe_drop_key(grp);
 -	rxe_mcast_delete(rxe, &grp->mgid);
 -}
 -
 -int rxe_attach_mcast(struct ib_qp *ibqp, union ib_gid *mgid, u16 mlid)
 -{
 -	int err;
 -	struct rxe_dev *rxe = to_rdev(ibqp->device);
 -	struct rxe_qp *qp = to_rqp(ibqp);
 -	struct rxe_mcg *grp;
 -
 -	/* takes a ref on grp if successful */
 -	err = rxe_mcast_get_grp(rxe, mgid, &grp);
 -	if (err)
 -		return err;
 +	struct rxe_mc_grp *grp;
 +	struct rxe_mc_elem *elem;
  
 -	err = rxe_mcast_add_grp_elem(rxe, qp, grp);
 -
 -	rxe_drop_ref(grp);
 -	return err;
 +	while (1) {
 +		spin_lock_bh(&qp->grp_lock);
 +		if (list_empty(&qp->grp_list)) {
 +			spin_unlock_bh(&qp->grp_lock);
 +			break;
 +		}
 +		elem = list_first_entry(&qp->grp_list, struct rxe_mc_elem,
 +					grp_list);
 +		list_del(&elem->grp_list);
 +		spin_unlock_bh(&qp->grp_lock);
 +
 +		grp = elem->grp;
 +		spin_lock_bh(&grp->mcg_lock);
 +		list_del(&elem->qp_list);
 +		grp->num_qp--;
 +		spin_unlock_bh(&grp->mcg_lock);
 +		rxe_drop_ref(grp);
 +		rxe_drop_ref(elem);
 +	}
  }
  
 -int rxe_detach_mcast(struct ib_qp *ibqp, union ib_gid *mgid, u16 mlid)
 +void rxe_mc_cleanup(struct rxe_pool_entry *arg)
++=======
++void rxe_mc_cleanup(struct rxe_pool_elem *elem)
++>>>>>>> 8a7fa872ff79 (RDMA/rxe: Remove rxe_drop_all_macst_groups)
  {
 -	struct rxe_dev *rxe = to_rdev(ibqp->device);
 -	struct rxe_qp *qp = to_rqp(ibqp);
 +	struct rxe_mc_grp *grp = container_of(arg, typeof(*grp), pelem);
 +	struct rxe_dev *rxe = grp->rxe;
  
 -	return rxe_mcast_drop_grp_elem(rxe, qp, mgid);
 +	rxe_drop_key(grp);
 +	rxe_mcast_delete(rxe, &grp->mgid);
  }
* Unmerged path drivers/infiniband/sw/rxe/rxe_loc.h
* Unmerged path drivers/infiniband/sw/rxe/rxe_mcast.c
diff --git a/drivers/infiniband/sw/rxe/rxe_qp.c b/drivers/infiniband/sw/rxe/rxe_qp.c
index cab1b2bbcdf3..9faa7bc0e8aa 100644
--- a/drivers/infiniband/sw/rxe/rxe_qp.c
+++ b/drivers/infiniband/sw/rxe/rxe_qp.c
@@ -805,8 +805,6 @@ static void rxe_qp_do_cleanup(struct work_struct *work)
 {
 	struct rxe_qp *qp = container_of(work, typeof(*qp), cleanup_work.work);
 
-	rxe_drop_all_mcast_groups(qp);
-
 	if (qp->sq.queue)
 		rxe_queue_cleanup(qp->sq.queue);
 
