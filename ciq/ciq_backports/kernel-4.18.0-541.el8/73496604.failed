tty: n_gsm: fix resource allocation order in gsm_activate_mux()

jira LE-1907
cve CVE-2023-6546
Rebuild_History Non-Buildable kernel-4.18.0-541.el8
commit-author Daniel Starke <daniel.starke@siemens.com>
commit 7349660438603ed19282e75949561406531785a5
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-541.el8/73496604.failed

Within gsm_activate_mux() all timers and locks are initiated before the
actual resource for the control channel is allocated. This can lead to race
conditions.

Allocate the control channel DLCI object first to avoid race conditions.

Fixes: e1eaea46bb40 ("tty: n_gsm line discipline")
	Signed-off-by: Daniel Starke <daniel.starke@siemens.com>
Link: https://lore.kernel.org/r/20220701122332.2039-2-daniel.starke@siemens.com
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 7349660438603ed19282e75949561406531785a5)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/tty/n_gsm.c
diff --cc drivers/tty/n_gsm.c
index 8ea93c6da6cd,ba399a660573..000000000000
--- a/drivers/tty/n_gsm.c
+++ b/drivers/tty/n_gsm.c
@@@ -2340,7 -2497,13 +2340,15 @@@ static int gsm_activate_mux(struct gsm_
  	struct gsm_dlci *dlci;
  	int ret;
  
++<<<<<<< HEAD
++=======
+ 	dlci = gsm_dlci_alloc(gsm, 0);
+ 	if (dlci == NULL)
+ 		return -ENOMEM;
+ 
+ 	timer_setup(&gsm->kick_timer, gsm_kick_timer, 0);
++>>>>>>> 734966043860 (tty: n_gsm: fix resource allocation order in gsm_activate_mux())
  	timer_setup(&gsm->t2_timer, gsm_control_retransmit, 0);
 -	INIT_WORK(&gsm->tx_work, gsmld_write_task);
  	init_waitqueue_head(&gsm->event);
  	spin_lock_init(&gsm->control_lock);
  	spin_lock_init(&gsm->tx_lock);
* Unmerged path drivers/tty/n_gsm.c
