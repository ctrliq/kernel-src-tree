mxser: remove cnt from mxser_receive_chars

jira LE-1907
cve CVE-2023-6546
Rebuild_History Non-Buildable kernel-4.18.0-541.el8
commit-author Jiri Slaby <jslaby@suse.cz>
commit 95b3ea4c6f45f3172dae29f303579743c2aa303d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-541.el8/95b3ea4c.failed

After the previous ioctls removal, cnt is needed only in
mxser_receive_chars_old now. So remove it from mxser_receive_chars and
mxser_receive_chars_new and account only in mxser_receive_chars_old.

	Signed-off-by: Jiri Slaby <jslaby@suse.cz>
Link: https://lore.kernel.org/r/20210618061516.662-32-jslaby@suse.cz
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 95b3ea4c6f45f3172dae29f303579743c2aa303d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/tty/mxser.c
diff --cc drivers/tty/mxser.c
index ff7a0e941388,d354c80083fd..000000000000
--- a/drivers/tty/mxser.c
+++ b/drivers/tty/mxser.c
@@@ -2160,44 -1742,45 +2160,87 @@@ static int mxser_rs_break(struct tty_st
  	return 0;
  }
  
++<<<<<<< HEAD
 +static void mxser_receive_chars(struct tty_struct *tty,
 +				struct mxser_port *port, int *status)
 +{
 +	unsigned char ch, gdl;
++=======
+ static bool mxser_receive_chars_new(struct tty_struct *tty,
+ 		struct mxser_port *port, u8 status)
+ {
+ 	enum mxser_must_hwid hwid = port->board->must_hwid;
+ 	u8 gdl;
+ 
+ 	if (hwid == MOXA_OTHER_UART)
+ 		return false;
+ 	if (status & UART_LSR_BRK_ERROR_BITS)
+ 		return false;
+ 	if (hwid == MOXA_MUST_MU860_HWID && (status & MOXA_MUST_LSR_RERR))
+ 		return false;
+ 	if (status & MOXA_MUST_LSR_RERR)
+ 		return false;
+ 
+ 	gdl = inb(port->ioaddr + MOXA_MUST_GDL_REGISTER);
+ 	if (hwid == MOXA_MUST_MU150_HWID)
+ 		gdl &= MOXA_MUST_GDL_MASK;
+ 
+ 	if (gdl >= tty->receive_room && !port->ldisc_stop_rx)
+ 		mxser_stoprx(tty);
+ 
+ 	while (gdl--) {
+ 		u8 ch = inb(port->ioaddr + UART_RX);
+ 		tty_insert_flip_char(&port->port, ch, 0);
+ 	}
+ 
+ 	return true;
+ }
+ 
+ static u8 mxser_receive_chars_old(struct tty_struct *tty,
+ 		                struct mxser_port *port, u8 status)
+ {
+ 	enum mxser_must_hwid hwid = port->board->must_hwid;
+ 	int recv_room = tty->receive_room;
++>>>>>>> 95b3ea4c6f45 (mxser: remove cnt from mxser_receive_chars)
  	int ignored = 0;
 +	int cnt = 0;
 +	int recv_room;
  	int max = 256;
++<<<<<<< HEAD
 +
 +	recv_room = tty->receive_room;
 +	if (recv_room == 0 && !port->ldisc_stop_rx)
 +		mxser_stoprx(tty);
 +	if (port->board->chip_flag != MOXA_OTHER_UART) {
 +
 +		if (*status & UART_LSR_SPECIAL)
 +			goto intr_old;
 +		if (port->board->chip_flag == MOXA_MUST_MU860_HWID &&
 +				(*status & MOXA_MUST_LSR_RERR))
 +			goto intr_old;
 +		if (*status & MOXA_MUST_LSR_RERR)
 +			goto intr_old;
 +
 +		gdl = inb(port->ioaddr + MOXA_MUST_GDL_REGISTER);
 +
 +		if (port->board->chip_flag == MOXA_MUST_MU150_HWID)
 +			gdl &= MOXA_MUST_GDL_MASK;
 +		if (gdl >= recv_room) {
 +			if (!port->ldisc_stop_rx)
 +				mxser_stoprx(tty);
 +		}
 +		while (gdl--) {
 +			ch = inb(port->ioaddr + UART_RX);
 +			tty_insert_flip_char(&port->port, ch, 0);
 +			cnt++;
 +		}
 +		goto end_intr;
 +	}
 +intr_old:
++=======
+ 	int cnt = 0;
+ 	u8 ch;
++>>>>>>> 95b3ea4c6f45 (mxser: remove cnt from mxser_receive_chars)
  
  	do {
  		if (max-- < 0)
@@@ -2240,18 -1823,27 +2283,32 @@@
  
  		}
  
 -		if (hwid)
 +		if (port->board->chip_flag)
  			break;
  
 -		status = inb(port->ioaddr + UART_LSR);
 -	} while (status & UART_LSR_DR);
 +		*status = inb(port->ioaddr + UART_LSR);
 +	} while (*status & UART_LSR_DR);
  
++<<<<<<< HEAD
 +end_intr:
 +	mxvar_log.rxcnt[tty->index] += cnt;
 +	port->mon_data.rxcnt += cnt;
 +	port->mon_data.up_rxcnt += cnt;
++=======
+ 	return status;
+ }
+ 
+ static u8 mxser_receive_chars(struct tty_struct *tty,
+ 		struct mxser_port *port, u8 status)
+ {
+ 	if (tty->receive_room == 0 && !port->ldisc_stop_rx)
+ 		mxser_stoprx(tty);
+ 
+ 	if (!mxser_receive_chars_new(tty, port, status))
+ 		status = mxser_receive_chars_old(tty, port, status);
++>>>>>>> 95b3ea4c6f45 (mxser: remove cnt from mxser_receive_chars)
  
  	tty_flip_buffer_push(&port->port);
 -
 -	return status;
  }
  
  static void mxser_transmit_chars(struct tty_struct *tty, struct mxser_port *port)
* Unmerged path drivers/tty/mxser.c
