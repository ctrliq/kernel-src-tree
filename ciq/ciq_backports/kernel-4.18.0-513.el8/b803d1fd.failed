net: mana: Add support for vlan tagging

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-513.el8
commit-author Haiyang Zhang <haiyangz@microsoft.com>
commit b803d1fded4085d268507a432dac8077ead68971
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-513.el8/b803d1fd.failed

To support vlan, use MANA_LONG_PKT_FMT if vlan tag is present in TX
skb. Then extract the vlan tag from the skb struct, and save it to
tx_oob for the NIC to transmit. For vlan tags on the payload, they
are accepted by the NIC too.

For RX, extract the vlan tag from CQE and put it into skb.

	Signed-off-by: Haiyang Zhang <haiyangz@microsoft.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit b803d1fded4085d268507a432dac8077ead68971)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/microsoft/mana/mana_en.c
diff --cc drivers/net/ethernet/microsoft/mana/mana_en.c
index 15c65ee44170,cd4d5ceb9f2d..000000000000
--- a/drivers/net/ethernet/microsoft/mana/mana_en.c
+++ b/drivers/net/ethernet/microsoft/mana/mana_en.c
@@@ -175,12 -179,27 +175,20 @@@ netdev_tx_t mana_start_xmit(struct sk_b
  		pkg.tx_oob.s_oob.short_vp_offset = txq->vp_offset;
  	}
  
+ 	if (skb_vlan_tag_present(skb)) {
+ 		pkt_fmt = MANA_LONG_PKT_FMT;
+ 		pkg.tx_oob.l_oob.inject_vlan_pri_tag = 1;
+ 		pkg.tx_oob.l_oob.pcp = skb_vlan_tag_get_prio(skb);
+ 		pkg.tx_oob.l_oob.dei = skb_vlan_tag_get_cfi(skb);
+ 		pkg.tx_oob.l_oob.vlan_id = skb_vlan_tag_get_id(skb);
+ 	}
+ 
  	pkg.tx_oob.s_oob.pkt_fmt = pkt_fmt;
  
 -	if (pkt_fmt == MANA_SHORT_PKT_FMT) {
 +	if (pkt_fmt == MANA_SHORT_PKT_FMT)
  		pkg.wqe_req.inline_oob_size = sizeof(struct mana_tx_short_oob);
 -		u64_stats_update_begin(&tx_stats->syncp);
 -		tx_stats->short_pkt_fmt++;
 -		u64_stats_update_end(&tx_stats->syncp);
 -	} else {
 +	else
  		pkg.wqe_req.inline_oob_size = sizeof(struct mana_tx_oob);
 -		u64_stats_update_begin(&tx_stats->syncp);
 -		tx_stats->long_pkt_fmt++;
 -		u64_stats_update_end(&tx_stats->syncp);
 -	}
  
  	pkg.wqe_req.inline_oob_data = &pkg.tx_oob;
  	pkg.wqe_req.flags = 0;
@@@ -2403,8 -2465,11 +2417,16 @@@ static int mana_probe_port(struct mana_
  	ndev->hw_features |= NETIF_F_RXCSUM;
  	ndev->hw_features |= NETIF_F_TSO | NETIF_F_TSO6;
  	ndev->hw_features |= NETIF_F_RXHASH;
++<<<<<<< HEAD
 +	ndev->features = ndev->hw_features;
 +	ndev->vlan_features = 0;
++=======
+ 	ndev->features = ndev->hw_features | NETIF_F_HW_VLAN_CTAG_TX |
+ 			 NETIF_F_HW_VLAN_CTAG_RX;
+ 	ndev->vlan_features = ndev->features;
+ 	ndev->xdp_features = NETDEV_XDP_ACT_BASIC | NETDEV_XDP_ACT_REDIRECT |
+ 			     NETDEV_XDP_ACT_NDO_XMIT;
++>>>>>>> b803d1fded40 (net: mana: Add support for vlan tagging)
  
  	err = register_netdev(ndev);
  	if (err) {
* Unmerged path drivers/net/ethernet/microsoft/mana/mana_en.c
