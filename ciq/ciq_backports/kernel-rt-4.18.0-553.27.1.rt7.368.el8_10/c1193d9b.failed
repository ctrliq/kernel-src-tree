netfilter: ipset: Add list flush to cancel_gc

jira LE-3201
cve CVE-2024-39503
Rebuild_History Non-Buildable kernel-rt-4.18.0-553.27.1.rt7.368.el8_10
commit-author Alexander Maltsev <keltar.gw@gmail.com>
commit c1193d9bbbd379defe9be3c6de566de684de8a6f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-rt-4.18.0-553.27.1.rt7.368.el8_10/c1193d9b.failed

Flushing list in cancel_gc drops references to other lists right away,
without waiting for RCU to destroy list. Fixes race when referenced
ipsets can't be destroyed while referring list is scheduled for destroy.

Fixes: 97f7cf1cd80e ("netfilter: ipset: fix performance regression in swap operation")
	Signed-off-by: Alexander Maltsev <keltar.gw@gmail.com>
	Acked-by: Jozsef Kadlecsik <kadlec@netfilter.org>
	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
(cherry picked from commit c1193d9bbbd379defe9be3c6de566de684de8a6f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/netfilter/ipset/ip_set_list_set.c
diff --cc net/netfilter/ipset/ip_set_list_set.c
index 7501303ebfa2,54e2a1dd7f5f..000000000000
--- a/net/netfilter/ipset/ip_set_list_set.c
+++ b/net/netfilter/ipset/ip_set_list_set.c
@@@ -552,7 -548,10 +552,14 @@@ list_set_cancel_gc(struct ip_set *set
  	struct list_set *map = set->data;
  
  	if (SET_WITH_TIMEOUT(set))
++<<<<<<< HEAD
 +		del_timer_sync(&map->gc);
++=======
+ 		timer_shutdown_sync(&map->gc);
+ 
+ 	/* Flush list to drop references to other ipsets */
+ 	list_set_flush(set);
++>>>>>>> c1193d9bbbd3 (netfilter: ipset: Add list flush to cancel_gc)
  }
  
  static const struct ip_set_type_variant set_variant = {
* Unmerged path net/netfilter/ipset/ip_set_list_set.c
