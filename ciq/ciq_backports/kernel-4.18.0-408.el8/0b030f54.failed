dmaengine: idxd: make submit failure path consistent on desc freeing

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-408.el8
commit-author Dave Jiang <dave.jiang@intel.com>
commit 0b030f54f094fcd42f4a607a675c1851129a58c8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-408.el8/0b030f54.failed

The submission path for dmaengine API does not do descriptor freeing on
failure. Also, with the abort mechanism, the freeing of descriptor happens
when the abort callback is completed. Therefore free descriptor on all
error paths for submission call to make things consistent. Also remove the
double free that would happen on abort in idxd_dma_tx_submit() call.

Fixes: 6b4b87f2c31a ("dmaengine: idxd: fix submission race window")
	Signed-off-by: Dave Jiang <dave.jiang@intel.com>
Link: https://lore.kernel.org/r/162827146072.3459011.10255348500504659810.stgit@djiang5-desk3.ch.intel.com
	Signed-off-by: Vinod Koul <vkoul@kernel.org>
(cherry picked from commit 0b030f54f094fcd42f4a607a675c1851129a58c8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/dma/idxd/submit.c
diff --cc drivers/dma/idxd/submit.c
index 0afcd1322339,de76fb4abac2..000000000000
--- a/drivers/dma/idxd/submit.c
+++ b/drivers/dma/idxd/submit.c
@@@ -120,6 -179,11 +124,14 @@@ int idxd_submit_desc(struct idxd_wq *wq
  		rc = enqcmds(portal, desc->hw);
  		if (rc < 0) {
  			percpu_ref_put(&wq->wq_active);
++<<<<<<< HEAD
++=======
+ 			/* abort operation frees the descriptor */
+ 			if (ie)
+ 				llist_abort_desc(wq, ie, desc);
+ 			else
+ 				idxd_free_desc(wq, desc);
++>>>>>>> 0b030f54f094 (dmaengine: idxd: make submit failure path consistent on desc freeing)
  			return rc;
  		}
  	}
diff --git a/drivers/dma/idxd/dma.c b/drivers/dma/idxd/dma.c
index 77439b645044..08231484f365 100644
--- a/drivers/dma/idxd/dma.c
+++ b/drivers/dma/idxd/dma.c
@@ -149,10 +149,8 @@ static dma_cookie_t idxd_dma_tx_submit(struct dma_async_tx_descriptor *tx)
 	cookie = dma_cookie_assign(tx);
 
 	rc = idxd_submit_desc(wq, desc);
-	if (rc < 0) {
-		idxd_free_desc(wq, desc);
+	if (rc < 0)
 		return rc;
-	}
 
 	return cookie;
 }
* Unmerged path drivers/dma/idxd/submit.c
