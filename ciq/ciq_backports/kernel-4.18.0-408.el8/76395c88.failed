scsi: lpfc: Transition to NPR state upon LOGO cmpl if link down or aborted

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-408.el8
commit-author James Smart <jsmart2021@gmail.com>
commit 76395c88d0afb82c9bec87e99e282c4ff11ea5f4
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-408.el8/76395c88.failed

In P2P topology, a target controller reboot sometimes results in not
reestablishing a login because the ndlp is stuck in LOGO state.

Fix by transitioning to NPR state if we get link down before LOGO
completes.

Link: https://lore.kernel.org/r/20220412222008.126521-12-jsmart2021@gmail.com
Co-developed-by: Justin Tee <justin.tee@broadcom.com>
	Signed-off-by: Justin Tee <justin.tee@broadcom.com>
	Signed-off-by: James Smart <jsmart2021@gmail.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 76395c88d0afb82c9bec87e99e282c4ff11ea5f4)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/lpfc/lpfc_els.c
diff --cc drivers/scsi/lpfc/lpfc_els.c
index a78140fea50c,50ecf9bfbf65..000000000000
--- a/drivers/scsi/lpfc/lpfc_els.c
+++ b/drivers/scsi/lpfc/lpfc_els.c
@@@ -2937,14 -2999,18 +2937,26 @@@ lpfc_cmpl_els_logo(struct lpfc_hba *phb
  	 * all acceptable.  Note the failure and move forward with
  	 * discovery.  The PLOGI will retry.
  	 */
 -	if (ulp_status) {
 +	if (irsp->ulpStatus) {
  		/* LOGO failed */
  		lpfc_printf_vlog(vport, KERN_ERR, LOG_TRACE_EVENT,
++<<<<<<< HEAD
 +				 "2756 LOGO failure, No Retry DID:%06X Status:x%x/x%x\n",
 +				 ndlp->nlp_DID, irsp->ulpStatus,
 +				 irsp->un.ulpWord[4]);
 +		/* Do not call DSM for lpfc_els_abort'ed ELS cmds */
 +		if (lpfc_error_lost_link(irsp)) {
++=======
+ 				 "2756 LOGO failure, No Retry DID:%06X "
+ 				 "Status:x%x/x%x\n",
+ 				 ndlp->nlp_DID, ulp_status,
+ 				 ulp_word4);
+ 
+ 		/* Call NLP_EVT_DEVICE_RM if link is down or LOGO is aborted */
+ 		if (lpfc_error_lost_link(ulp_status, ulp_word4)) {
+ 			lpfc_disc_state_machine(vport, ndlp, cmdiocb,
+ 						NLP_EVT_DEVICE_RM);
++>>>>>>> 76395c88d0af (scsi: lpfc: Transition to NPR state upon LOGO cmpl if link down or aborted)
  			skip_recovery = 1;
  			goto out;
  		}
* Unmerged path drivers/scsi/lpfc/lpfc_els.c
