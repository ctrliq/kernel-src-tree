rfkill: allow to get the software rfkill state

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-408.el8
commit-author Emmanuel Grumbach <emmanuel.grumbach@intel.com>
commit 5bc9a9dd75351023793d8aa4116ead005d659729
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-408.el8/5bc9a9dd.failed

iwlwifi needs to be able to differentiate between the
software rfkill state and the hardware rfkill state.

The reason for this is that iwlwifi needs to notify any
change in the software rfkill state even when it doesn't
own the device (which means even when the hardware rfkill
is asserted).

In order to be able to know the software rfkill when the
host does not own the device, iwlwifi needs to be able to
ask the state of the software rfkill ignoring the state
of the hardware rfkill.

	Signed-off-by: Emmanuel Grumbach <emmanuel.grumbach@intel.com>
Link: https://lore.kernel.org/r/20211219195124.125689-1-emmanuel.grumbach@intel.com
	Signed-off-by: Johannes Berg <johannes.berg@intel.com>
(cherry picked from commit 5bc9a9dd75351023793d8aa4116ead005d659729)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/linux/rfkill.h
diff --cc include/linux/rfkill.h
index f199371fc35c,c35f3962dc4f..000000000000
--- a/include/linux/rfkill.h
+++ b/include/linux/rfkill.h
@@@ -230,10 -230,17 +230,21 @@@ void rfkill_set_states(struct rfkill *r
  bool rfkill_blocked(struct rfkill *rfkill);
  
  /**
++<<<<<<< HEAD
 + * rfkill_find_type - Helpper for finding rfkill type by name
++=======
+  * rfkill_soft_blocked - Query soft rfkill block state
+  *
+  * @rfkill: rfkill struct to query
+  */
+ bool rfkill_soft_blocked(struct rfkill *rfkill);
+ 
+ /**
+  * rfkill_find_type - Helper for finding rfkill type by name
++>>>>>>> 5bc9a9dd7535 (rfkill: allow to get the software rfkill state)
   * @name: the name of the type
   *
 - * Returns enum rfkill_type that corresponds to the name.
 + * Returns enum rfkill_type that conrresponds the name.
   */
  enum rfkill_type rfkill_find_type(const char *name);
  
* Unmerged path include/linux/rfkill.h
diff --git a/net/rfkill/core.c b/net/rfkill/core.c
index b73a741a7923..631157157df6 100644
--- a/net/rfkill/core.c
+++ b/net/rfkill/core.c
@@ -958,6 +958,18 @@ bool rfkill_blocked(struct rfkill *rfkill)
 }
 EXPORT_SYMBOL(rfkill_blocked);
 
+bool rfkill_soft_blocked(struct rfkill *rfkill)
+{
+	unsigned long flags;
+	u32 state;
+
+	spin_lock_irqsave(&rfkill->lock, flags);
+	state = rfkill->state;
+	spin_unlock_irqrestore(&rfkill->lock, flags);
+
+	return !!(state & RFKILL_BLOCK_SW);
+}
+EXPORT_SYMBOL(rfkill_soft_blocked);
 
 struct rfkill * __must_check rfkill_alloc(const char *name,
 					  struct device *parent,
