drm/amd: Check if ASPM is enabled from PCIe subsystem

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-408.el8
commit-author Mario Limonciello <mario.limonciello@amd.com>
commit cba07cce39ace4c719e63b0410a53480aee6aaee
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-408.el8/cba07cce.failed

commit 0064b0ce85bb ("drm/amd/pm: enable ASPM by default") enabled ASPM
by default but a variety of hardware configurations it turns out that this
caused a regression.

* PPC64LE hardware does not support ASPM at a hardware level.
  CONFIG_PCIEASPM is often disabled on these architectures.
* Some dGPUs on ALD platforms don't work with ASPM enabled and PCIe subsystem
  disables it

Check with the PCIe subsystem to see that ASPM has been enabled
or not.

Fixes: 0064b0ce85bb ("drm/amd/pm: enable ASPM by default")
Link: https://wiki.raptorcs.com/w/images/a/ad/P9_PHB_version1.0_27July2018_pub.pdf
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/1723
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/1739
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/1885
Link: https://gitlab.freedesktop.org/drm/amd/-/issues/1907
	Tested-by: koba.ko@canonical.com
	Reviewed-by: Alex Deucher <alexander.deucher@amd.com>
	Signed-off-by: Mario Limonciello <mario.limonciello@amd.com>
	Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
(cherry picked from commit cba07cce39ace4c719e63b0410a53480aee6aaee)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c
diff --cc drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c
index 052fe9d2430e,d406659ee273..000000000000
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c
@@@ -1233,10 -1997,21 +1233,23 @@@ static int amdgpu_pci_probe(struct pci_
  	struct drm_device *ddev;
  	struct amdgpu_device *adev;
  	unsigned long flags = ent->driver_data;
 -	int ret, retry = 0, i;
 +	int ret, retry = 0;
  	bool supports_atomic = false;
 -	bool is_fw_fb;
 -	resource_size_t base, size;
  
++<<<<<<< HEAD
 +	if (!amdgpu_virtual_display &&
++=======
+ 	/* skip devices which are owned by radeon */
+ 	for (i = 0; i < ARRAY_SIZE(amdgpu_unsupported_pciidlist); i++) {
+ 		if (amdgpu_unsupported_pciidlist[i] == pdev->device)
+ 			return -ENODEV;
+ 	}
+ 
+ 	if (amdgpu_aspm == -1 && !pcie_aspm_enabled(pdev))
+ 		amdgpu_aspm = 0;
+ 
+ 	if (amdgpu_virtual_display ||
++>>>>>>> cba07cce39ac (drm/amd: Check if ASPM is enabled from PCIe subsystem)
  	    amdgpu_device_asic_has_dc_support(flags & AMD_ASIC_MASK))
  		supports_atomic = true;
  
* Unmerged path drivers/gpu/drm/amd/amdgpu/amdgpu_drv.c
