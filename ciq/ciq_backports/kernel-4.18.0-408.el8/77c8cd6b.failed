KVM: x86/mmu: Skip remote TLB flush when zapping all of TDP MMU

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-408.el8
commit-author Sean Christopherson <seanjc@google.com>
commit 77c8cd6b85af8840878063eb2df39780e808f74b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-408.el8/77c8cd6b.failed

Don't flush the TLBs when zapping all TDP MMU pages, as the only time KVM
uses the slow version of "zap everything" is when the VM is being
destroyed or the owning mm has exited.  In either case, KVM_RUN is
unreachable for the VM, i.e. the guest TLB entries cannot be consumed.

	Signed-off-by: Sean Christopherson <seanjc@google.com>
	Reviewed-by: Ben Gardon <bgardon@google.com>
Message-Id: <20220226001546.360188-15-seanjc@google.com>
	Reviewed-by: Mingwei Zhang <mizhang@google.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 77c8cd6b85af8840878063eb2df39780e808f74b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/mmu/tdp_mmu.c
diff --cc arch/x86/kvm/mmu/tdp_mmu.c
index 97bb57fe39ca,f59f3ff5cb75..000000000000
--- a/arch/x86/kvm/mmu/tdp_mmu.c
+++ b/arch/x86/kvm/mmu/tdp_mmu.c
@@@ -767,15 -860,15 +767,27 @@@ bool __kvm_tdp_mmu_zap_gfn_range(struc
  
  void kvm_tdp_mmu_zap_all(struct kvm *kvm)
  {
++<<<<<<< HEAD
 +	gfn_t max_gfn = 1ULL << (shadow_phys_bits - PAGE_SHIFT);
 +	bool flush = false;
++=======
++>>>>>>> 77c8cd6b85af (KVM: x86/mmu: Skip remote TLB flush when zapping all of TDP MMU)
  	int i;
  
+ 	/*
+ 	 * A TLB flush is unnecessary, KVM zaps everything if and only the VM
+ 	 * is being destroyed or the userspace VMM has exited.  In both cases,
+ 	 * KVM_RUN is unreachable, i.e. no vCPUs will ever service the request.
+ 	 */
  	for (i = 0; i < KVM_ADDRESS_SPACE_NUM; i++)
++<<<<<<< HEAD
 +		flush = kvm_tdp_mmu_zap_gfn_range(kvm, i, 0, max_gfn, flush);
 +
 +	if (flush)
 +		kvm_flush_remote_tlbs(kvm);
++=======
+ 		(void)kvm_tdp_mmu_zap_gfn_range(kvm, i, 0, -1ull, false);
++>>>>>>> 77c8cd6b85af (KVM: x86/mmu: Skip remote TLB flush when zapping all of TDP MMU)
  }
  
  static struct kvm_mmu_page *next_invalidated_root(struct kvm *kvm,
* Unmerged path arch/x86/kvm/mmu/tdp_mmu.c
