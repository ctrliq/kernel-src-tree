thermal: netlink: Add a new event to notify CPU capabilities change

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-408.el8
commit-author Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
commit e4b1eb24ce5a696ef7229f9926ff34d7502f0582
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-408.el8/e4b1eb24.failed

Add a new netlink event to notify change in CPU capabilities in terms of
performance and efficiency.

Firmware may change CPU capabilities as a result of thermal events in the
system or to account for changes in the TDP (thermal design power) level.

This notification type will allow user space to avoid running workloads
on certain CPUs or proactively adjust power limits to avoid future events.

The netlink message consists of a nested attribute
(THERMAL_GENL_ATTR_CPU_CAPABILITY) with three attributes:

 * THERMAL_GENL_ATTR_CPU_CAPABILITY_ID (type u32):
   -- logical CPU number
 * THERMAL_GENL_ATTR_CPU_CAPABILITY_PERFORMANCE (type u32):
   -- Scaled performance from 0-1023
 * THERMAL_GENL_ATTR_CPU_CAPABILITY_EFFICIENCY (type u32):
   -- Scaled efficiency from 0-1023

	Reviewed-by: Len Brown <len.brown@intel.com>
	Signed-off-by: Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>
	Signed-off-by: Rafael J. Wysocki <rafael.j.wysocki@intel.com>
(cherry picked from commit e4b1eb24ce5a696ef7229f9926ff34d7502f0582)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/thermal/thermal_netlink.c
#	drivers/thermal/thermal_netlink.h
#	include/uapi/linux/thermal.h
diff --cc include/uapi/linux/thermal.h
index 96218378dda8,fc78bf3aead7..000000000000
--- a/include/uapi/linux/thermal.h
+++ b/include/uapi/linux/thermal.h
@@@ -4,31 -4,90 +4,89 @@@
  
  #define THERMAL_NAME_LENGTH	20
  
 -enum thermal_device_mode {
 -	THERMAL_DEVICE_DISABLED = 0,
 -	THERMAL_DEVICE_ENABLED,
 -};
 +/* Adding event notification support elements */
 +#define THERMAL_GENL_FAMILY_NAME                "thermal_event"
 +#define THERMAL_GENL_VERSION                    0x01
 +#define THERMAL_GENL_MCAST_GROUP_NAME           "thermal_mc_grp"
  
 -enum thermal_trip_type {
 -	THERMAL_TRIP_ACTIVE = 0,
 -	THERMAL_TRIP_PASSIVE,
 -	THERMAL_TRIP_HOT,
 -	THERMAL_TRIP_CRITICAL,
 +/* Events supported by Thermal Netlink */
 +enum events {
 +	THERMAL_AUX0,
 +	THERMAL_AUX1,
 +	THERMAL_CRITICAL,
 +	THERMAL_DEV_FAULT,
  };
  
 -/* Adding event notification support elements */
 -#define THERMAL_GENL_FAMILY_NAME		"thermal"
 -#define THERMAL_GENL_VERSION			0x01
 -#define THERMAL_GENL_SAMPLING_GROUP_NAME	"sampling"
 -#define THERMAL_GENL_EVENT_GROUP_NAME		"event"
 -
 -/* Attributes of thermal_genl_family */
 -enum thermal_genl_attr {
 +/* attributes of thermal_genl_family */
 +enum {
  	THERMAL_GENL_ATTR_UNSPEC,
++<<<<<<< HEAD
 +	THERMAL_GENL_ATTR_EVENT,
++=======
+ 	THERMAL_GENL_ATTR_TZ,
+ 	THERMAL_GENL_ATTR_TZ_ID,
+ 	THERMAL_GENL_ATTR_TZ_TEMP,
+ 	THERMAL_GENL_ATTR_TZ_TRIP,
+ 	THERMAL_GENL_ATTR_TZ_TRIP_ID,
+ 	THERMAL_GENL_ATTR_TZ_TRIP_TYPE,
+ 	THERMAL_GENL_ATTR_TZ_TRIP_TEMP,
+ 	THERMAL_GENL_ATTR_TZ_TRIP_HYST,
+ 	THERMAL_GENL_ATTR_TZ_MODE,
+ 	THERMAL_GENL_ATTR_TZ_NAME,
+ 	THERMAL_GENL_ATTR_TZ_CDEV_WEIGHT,
+ 	THERMAL_GENL_ATTR_TZ_GOV,
+ 	THERMAL_GENL_ATTR_TZ_GOV_NAME,
+ 	THERMAL_GENL_ATTR_CDEV,
+ 	THERMAL_GENL_ATTR_CDEV_ID,
+ 	THERMAL_GENL_ATTR_CDEV_CUR_STATE,
+ 	THERMAL_GENL_ATTR_CDEV_MAX_STATE,
+ 	THERMAL_GENL_ATTR_CDEV_NAME,
+ 	THERMAL_GENL_ATTR_GOV_NAME,
+ 	THERMAL_GENL_ATTR_CPU_CAPABILITY,
+ 	THERMAL_GENL_ATTR_CPU_CAPABILITY_ID,
+ 	THERMAL_GENL_ATTR_CPU_CAPABILITY_PERFORMANCE,
+ 	THERMAL_GENL_ATTR_CPU_CAPABILITY_EFFICIENCY,
++>>>>>>> e4b1eb24ce5a (thermal: netlink: Add a new event to notify CPU capabilities change)
  	__THERMAL_GENL_ATTR_MAX,
  };
  #define THERMAL_GENL_ATTR_MAX (__THERMAL_GENL_ATTR_MAX - 1)
  
++<<<<<<< HEAD
 +/* commands supported by the thermal_genl_family */
 +enum {
++=======
+ enum thermal_genl_sampling {
+ 	THERMAL_GENL_SAMPLING_TEMP,
+ 	__THERMAL_GENL_SAMPLING_MAX,
+ };
+ #define THERMAL_GENL_SAMPLING_MAX (__THERMAL_GENL_SAMPLING_MAX - 1)
+ 
+ /* Events of thermal_genl_family */
+ enum thermal_genl_event {
+ 	THERMAL_GENL_EVENT_UNSPEC,
+ 	THERMAL_GENL_EVENT_TZ_CREATE,		/* Thermal zone creation */
+ 	THERMAL_GENL_EVENT_TZ_DELETE,		/* Thermal zone deletion */
+ 	THERMAL_GENL_EVENT_TZ_DISABLE,		/* Thermal zone disabled */
+ 	THERMAL_GENL_EVENT_TZ_ENABLE,		/* Thermal zone enabled */
+ 	THERMAL_GENL_EVENT_TZ_TRIP_UP,		/* Trip point crossed the way up */
+ 	THERMAL_GENL_EVENT_TZ_TRIP_DOWN,	/* Trip point crossed the way down */
+ 	THERMAL_GENL_EVENT_TZ_TRIP_CHANGE,	/* Trip point changed */
+ 	THERMAL_GENL_EVENT_TZ_TRIP_ADD,		/* Trip point added */
+ 	THERMAL_GENL_EVENT_TZ_TRIP_DELETE,	/* Trip point deleted */
+ 	THERMAL_GENL_EVENT_CDEV_ADD,		/* Cdev bound to the thermal zone */
+ 	THERMAL_GENL_EVENT_CDEV_DELETE,		/* Cdev unbound */
+ 	THERMAL_GENL_EVENT_CDEV_STATE_UPDATE,	/* Cdev state updated */
+ 	THERMAL_GENL_EVENT_TZ_GOV_CHANGE,	/* Governor policy changed  */
+ 	THERMAL_GENL_EVENT_CPU_CAPABILITY_CHANGE,	/* CPU capability changed */
+ 	__THERMAL_GENL_EVENT_MAX,
+ };
+ #define THERMAL_GENL_EVENT_MAX (__THERMAL_GENL_EVENT_MAX - 1)
+ 
+ /* Commands supported by the thermal_genl_family */
+ enum thermal_genl_cmd {
++>>>>>>> e4b1eb24ce5a (thermal: netlink: Add a new event to notify CPU capabilities change)
  	THERMAL_GENL_CMD_UNSPEC,
 -	THERMAL_GENL_CMD_TZ_GET_ID,	/* List of thermal zones id */
 -	THERMAL_GENL_CMD_TZ_GET_TRIP,	/* List of thermal trips */
 -	THERMAL_GENL_CMD_TZ_GET_TEMP,	/* Get the thermal zone temperature */
 -	THERMAL_GENL_CMD_TZ_GET_GOV,	/* Get the thermal zone governor */
 -	THERMAL_GENL_CMD_TZ_GET_MODE,	/* Get the thermal zone mode */
 -	THERMAL_GENL_CMD_CDEV_GET,	/* List of cdev id */
 +	THERMAL_GENL_CMD_EVENT,
  	__THERMAL_GENL_CMD_MAX,
  };
  #define THERMAL_GENL_CMD_MAX (__THERMAL_GENL_CMD_MAX - 1)
* Unmerged path drivers/thermal/thermal_netlink.c
* Unmerged path drivers/thermal/thermal_netlink.h
* Unmerged path drivers/thermal/thermal_netlink.c
* Unmerged path drivers/thermal/thermal_netlink.h
* Unmerged path include/uapi/linux/thermal.h
