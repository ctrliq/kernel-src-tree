selftests/bpf/test_xdp_redirect_multi: use temp netns for testing

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-408.el8
commit-author Hangbin Liu <liuhangbin@gmail.com>
commit cec74489a8dee93053340ec88ea938ff4008c3c0
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-408.el8/cec74489.failed

Use temp netns instead of hard code name for testing in case the netns
already exists.

Remove the hard code interface index when creating the veth interfaces.
Because when the system loads some virtual interface modules, e.g. tunnels.
the ifindex of 2 will be used and the cmd will fail.

As the netns has not created if checking environment failed. Trap the
clean up function after checking env.

Fixes: 8955c1a32987 ("selftests/bpf/xdp_redirect_multi: Limit the tests in netns")
	Signed-off-by: Hangbin Liu <liuhangbin@gmail.com>
	Acked-by: William Tu <u9012063@gmail.com>
Link: https://lore.kernel.org/r/20220125081717.1260849-2-liuhangbin@gmail.com
	Signed-off-by: Alexei Starovoitov <ast@kernel.org>
(cherry picked from commit cec74489a8dee93053340ec88ea938ff4008c3c0)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/bpf/test_xdp_redirect_multi.sh
diff --cc tools/testing/selftests/bpf/test_xdp_redirect_multi.sh
index bedff7aa7023,cc57cb87e65f..000000000000
--- a/tools/testing/selftests/bpf/test_xdp_redirect_multi.sh
+++ b/tools/testing/selftests/bpf/test_xdp_redirect_multi.sh
@@@ -79,23 -82,22 +82,28 @@@ setup_ns(
  		mode="xdpdrv"
  	fi
  
- 	ip netns add ns0
+ 	ip netns add ${NS[0]}
  	for i in $(seq $NUM); do
- 	        ip netns add ns$i
- 		ip -n ns$i link add veth0 index 2 type veth \
- 			peer name veth$i netns ns0 index $((1 + $i))
- 		ip -n ns0 link set veth$i up
- 		ip -n ns$i link set veth0 up
- 
- 		ip -n ns$i addr add 192.0.2.$i/24 dev veth0
- 		ip -n ns$i addr add 2001:db8::$i/64 dev veth0
+ 	        ip netns add ${NS[$i]}
+ 		ip -n ${NS[$i]} link add veth0 type veth peer name veth$i netns ${NS[0]}
+ 		ip -n ${NS[$i]} link set veth0 up
+ 		ip -n ${NS[0]} link set veth$i up
+ 
+ 		ip -n ${NS[$i]} addr add 192.0.2.$i/24 dev veth0
+ 		ip -n ${NS[$i]} addr add 2001:db8::$i/64 dev veth0
  		# Add a neigh entry for IPv4 ping test
++<<<<<<< HEAD
 +		ip -n ns$i neigh add 192.0.2.253 lladdr 00:00:00:00:00:01 dev veth0
 +		ip -n ns$i link set veth0 $mode obj \
 +			xdp_dummy.o sec xdp_dummy &> /dev/null || \
++=======
+ 		ip -n ${NS[$i]} neigh add 192.0.2.253 lladdr 00:00:00:00:00:01 dev veth0
+ 		ip -n ${NS[$i]} link set veth0 $mode obj \
+ 			xdp_dummy.o sec xdp &> /dev/null || \
++>>>>>>> cec74489a8de (selftests/bpf/test_xdp_redirect_multi: use temp netns for testing)
  			{ test_fail "Unable to load dummy xdp" && exit 1; }
  		IFACES="$IFACES veth$i"
- 		veth_mac[$i]=$(ip -n ns0 link show veth$i | awk '/link\/ether/ {print $2}')
+ 		veth_mac[$i]=$(ip -n ${NS[0]} link show veth$i | awk '/link\/ether/ {print $2}')
  	done
  }
  
* Unmerged path tools/testing/selftests/bpf/test_xdp_redirect_multi.sh
