iommu/amd: Enable swiotlb in all cases

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-408.el8
commit-author Mario Limonciello <mario.limonciello@amd.com>
commit 121660bba631104154b7c15e88f208c48c8c3297
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-408.el8/121660bb.failed

Previously the AMD IOMMU would only enable SWIOTLB in certain
circumstances:
 * IOMMU in passthrough mode
 * SME enabled

This logic however doesn't work when an untrusted device is plugged in
that doesn't do page aligned DMA transactions.  The expectation is
that a bounce buffer is used for those transactions.

This fails like this:

swiotlb buffer is full (sz: 4096 bytes), total 0 (slots), used 0 (slots)

That happens because the bounce buffers have been allocated, followed by
freed during startup but the bounce buffering code expects that all IOMMUs
have left it enabled.

Remove the criteria to set up bounce buffers on AMD systems to ensure
they're always available for supporting untrusted devices.

Fixes: 82612d66d51d ("iommu: Allow the dma-iommu api to use bounce buffers")
	Suggested-by: Christoph Hellwig <hch@infradead.org>
	Signed-off-by: Mario Limonciello <mario.limonciello@amd.com>
	Reviewed-by: Robin Murphy <robin.murphy@arm.com>
	Reviewed-by: Christoph Hellwig <hch@lst.de>
Link: https://lore.kernel.org/r/20220404204723.9767-2-mario.limonciello@amd.com
	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit 121660bba631104154b7c15e88f208c48c8c3297)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/amd/iommu.c
diff --cc drivers/iommu/amd/iommu.c
index 5958b4ca6282,079694f894b8..000000000000
--- a/drivers/iommu/amd/iommu.c
+++ b/drivers/iommu/amd/iommu.c
@@@ -1819,17 -1838,6 +1819,20 @@@ void amd_iommu_domain_update(struct pro
  	amd_iommu_domain_flush_complete(domain);
  }
  
++<<<<<<< HEAD
 +static void __init amd_iommu_init_dma_ops(void)
 +{
 +	swiotlb = (iommu_default_passthrough() || sme_me_mask) ? 1 : 0;
 +
 +	if (amd_iommu_unmap_flush)
 +		pr_info("IO/TLB flush on unmap enabled\n");
 +	else
 +		pr_info("Lazy IO/TLB flushing enabled\n");
 +	iommu_set_dma_strict(amd_iommu_unmap_flush);
 +}
 +
++=======
++>>>>>>> 121660bba631 (iommu/amd: Enable swiotlb in all cases)
  int __init amd_iommu_init_api(void)
  {
  	int err;
* Unmerged path drivers/iommu/amd/iommu.c
