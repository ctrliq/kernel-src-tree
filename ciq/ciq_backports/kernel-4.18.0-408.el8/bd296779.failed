KVM: x86/mmu: Do remote TLB flush before dropping RCU in TDP MMU resched

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-408.el8
commit-author Sean Christopherson <seanjc@google.com>
commit bd29677952fa96bf1f1fc31203aaad628a32bdb6
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-408.el8/bd296779.failed

When yielding in the TDP MMU iterator, service any pending TLB flush
before dropping RCU protections in anticipation of using the caller's RCU
"lock" as a proxy for vCPUs in the guest.

	Signed-off-by: Sean Christopherson <seanjc@google.com>
	Reviewed-by: Ben Gardon <bgardon@google.com>
Message-Id: <20220226001546.360188-19-seanjc@google.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit bd29677952fa96bf1f1fc31203aaad628a32bdb6)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kvm/mmu/tdp_mmu.c
diff --cc arch/x86/kvm/mmu/tdp_mmu.c
index 97bb57fe39ca,3a866fcb5ea9..000000000000
--- a/arch/x86/kvm/mmu/tdp_mmu.c
+++ b/arch/x86/kvm/mmu/tdp_mmu.c
@@@ -687,9 -719,13 +687,17 @@@ static inline bool __must_check tdp_mmu
  		if (flush)
  			kvm_flush_remote_tlbs(kvm);
  
++<<<<<<< HEAD
 +		cond_resched_rwlock_write(&kvm->mmu_lock);
++=======
+ 		rcu_read_unlock();
+ 
+ 		if (shared)
+ 			cond_resched_rwlock_read(&kvm->mmu_lock);
+ 		else
+ 			cond_resched_rwlock_write(&kvm->mmu_lock);
+ 
++>>>>>>> bd29677952fa (KVM: x86/mmu: Do remote TLB flush before dropping RCU in TDP MMU resched)
  		rcu_read_lock();
  
  		WARN_ON(iter->gfn > iter->next_last_level_gfn);
* Unmerged path arch/x86/kvm/mmu/tdp_mmu.c
