iommu/amd: X2apic mode: setup the INTX registers on mask/unmask

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-408.el8
commit-author Maxim Levitsky <mlevitsk@redhat.com>
commit 4691f79d62a637958f7b5f55c232a65399500b7a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-408.el8/4691f79d.failed

This is more logically correct and will also allow us to
to use mask/unmask logic to restore INTX setttings after
the resume from s3/s4.

Fixes: 66929812955bb ("iommu/amd: Add support for X2APIC IOMMU interrupts")

	Signed-off-by: Maxim Levitsky <mlevitsk@redhat.com>
Link: https://lore.kernel.org/r/20211123161038.48009-4-mlevitsk@redhat.com
	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit 4691f79d62a637958f7b5f55c232a65399500b7a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/amd/init.c
diff --cc drivers/iommu/amd/init.c
index 0a258965bf24,9e895bb8086a..000000000000
--- a/drivers/iommu/amd/init.c
+++ b/drivers/iommu/amd/init.c
@@@ -2053,23 -2021,6 +2041,26 @@@ static struct irq_chip intcapxt_control
  static int intcapxt_irqdomain_activate(struct irq_domain *domain,
  				       struct irq_data *irqd, bool reserve)
  {
++<<<<<<< HEAD
 +	struct amd_iommu *iommu = irqd->chip_data;
 +	struct irq_cfg *cfg = irqd_cfg(irqd);
 +	union intcapxt xt;
 +
 +	xt.capxt = 0ULL;
 +	xt.dest_mode_logical = apic->irq_dest_mode;
 +	xt.vector = cfg->vector;
 +	xt.destid_0_23 = cfg->dest_apicid & GENMASK(23, 0);
 +	xt.destid_24_31 = cfg->dest_apicid >> 24;
 +
 +	/**
 +	 * Current IOMMU implemtation uses the same IRQ for all
 +	 * 3 IOMMU interrupts.
 +	 */
 +	writeq(xt.capxt, iommu->mmio_base + MMIO_INTCAPXT_EVT_OFFSET);
 +	writeq(xt.capxt, iommu->mmio_base + MMIO_INTCAPXT_PPR_OFFSET);
 +	writeq(xt.capxt, iommu->mmio_base + MMIO_INTCAPXT_GALOG_OFFSET);
++=======
++>>>>>>> 4691f79d62a6 (iommu/amd: X2apic mode: setup the INTX registers on mask/unmask)
  	return 0;
  }
  
* Unmerged path drivers/iommu/amd/init.c
