net: bridge: mst: Notify switchdev drivers of MST mode changes

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-408.el8
commit-author Tobias Waldekranz <tobias@waldekranz.com>
commit 87c167bb94ee3fd49569d4aa2038b9b8840d906f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-408.el8/87c167bb.failed

Trigger a switchdev event whenever the bridge's MST mode is
enabled/disabled. This allows constituent ports to either perform any
required hardware config, or refuse the change if it not supported.

	Signed-off-by: Tobias Waldekranz <tobias@waldekranz.com>
	Acked-by: Nikolay Aleksandrov <razor@blackwall.org>
	Signed-off-by: Jakub Kicinski <kuba@kernel.org>
(cherry picked from commit 87c167bb94ee3fd49569d4aa2038b9b8840d906f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	include/net/switchdev.h
diff --cc include/net/switchdev.h
index fc7036c5869e,85dd004dc9ad..000000000000
--- a/include/net/switchdev.h
+++ b/include/net/switchdev.h
@@@ -28,10 -24,11 +28,15 @@@ enum switchdev_attr_id 
  	SWITCHDEV_ATTR_ID_PORT_MROUTER,
  	SWITCHDEV_ATTR_ID_BRIDGE_AGEING_TIME,
  	SWITCHDEV_ATTR_ID_BRIDGE_VLAN_FILTERING,
 -	SWITCHDEV_ATTR_ID_BRIDGE_VLAN_PROTOCOL,
 +	RH_KABI_BROKEN_INSERT_ENUM(SWITCHDEV_ATTR_ID_BRIDGE_VLAN_PROTOCOL)
  	SWITCHDEV_ATTR_ID_BRIDGE_MC_DISABLED,
  	SWITCHDEV_ATTR_ID_BRIDGE_MROUTER,
++<<<<<<< HEAD
 +	RH_KABI_BROKEN_INSERT_ENUM(SWITCHDEV_ATTR_ID_MRP_PORT_ROLE)
++=======
+ 	SWITCHDEV_ATTR_ID_BRIDGE_MST,
+ 	SWITCHDEV_ATTR_ID_MRP_PORT_ROLE,
++>>>>>>> 87c167bb94ee (net: bridge: mst: Notify switchdev drivers of MST mode changes)
  };
  
  struct switchdev_brport_flags {
@@@ -69,9 -49,9 +74,10 @@@ struct switchdev_attr 
  		clock_t ageing_time;			/* BRIDGE_AGEING_TIME */
  		bool vlan_filtering;			/* BRIDGE_VLAN_FILTERING */
  		u16 vlan_protocol;			/* BRIDGE_VLAN_PROTOCOL */
+ 		bool mst;				/* BRIDGE_MST */
  		bool mc_disabled;			/* MC_DISABLED */
  		u8 mrp_port_role;			/* MRP_PORT_ROLE */
 +		) /* RH_KABI_BROKEN_INSERT_BLOCK */
  	} u;
  };
  
* Unmerged path include/net/switchdev.h
diff --git a/net/bridge/br_mst.c b/net/bridge/br_mst.c
index 5c1831c73fc2..43ca6b97c5c3 100644
--- a/net/bridge/br_mst.c
+++ b/net/bridge/br_mst.c
@@ -7,6 +7,7 @@
  */
 
 #include <linux/kernel.h>
+#include <net/switchdev.h>
 
 #include "br_private.h"
 
@@ -102,8 +103,14 @@ void br_mst_vlan_init_state(struct net_bridge_vlan *v)
 int br_mst_set_enabled(struct net_bridge *br, bool on,
 		       struct netlink_ext_ack *extack)
 {
+	struct switchdev_attr attr = {
+		.id = SWITCHDEV_ATTR_ID_BRIDGE_MST,
+		.orig_dev = br->dev,
+		.u.mst = on,
+	};
 	struct net_bridge_vlan_group *vg;
 	struct net_bridge_port *p;
+	int err;
 
 	list_for_each_entry(p, &br->port_list, list) {
 		vg = nbp_vlan_group(p);
@@ -119,6 +126,10 @@ int br_mst_set_enabled(struct net_bridge *br, bool on,
 	if (br_opt_get(br, BROPT_MST_ENABLED) == on)
 		return 0;
 
+	err = switchdev_port_attr_set(br->dev, &attr, extack);
+	if (err && err != -EOPNOTSUPP)
+		return err;
+
 	if (on)
 		static_branch_enable(&br_mst_used);
 	else
