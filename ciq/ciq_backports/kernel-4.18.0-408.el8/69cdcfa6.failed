KVM: selftests: Require GPA to be aligned when backed by hugepages

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-408.el8
commit-author Sean Christopherson <seanjc@google.com>
commit 69cdcfa6f321da2cc1dd2e62fa4a9ee256299b18
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-408.el8/69cdcfa6.failed

Assert that the GPA for a memslot backed by a hugepage is aligned to
the hugepage size and fix perf_test_util accordingly.  Lack of GPA
alignment prevents KVM from backing the guest with hugepages, e.g. x86's
write-protection of hugepages when dirty logging is activated is
otherwise not exercised.

Add a comment explaining that guest_page_size is for non-huge pages to
try and avoid confusion about what it actually tracks.

	Cc: Ben Gardon <bgardon@google.com>
	Cc: Yanan Wang <wangyanan55@huawei.com>
	Cc: Andrew Jones <drjones@redhat.com>
	Cc: Peter Xu <peterx@redhat.com>
	Cc: Aaron Lewis <aaronlewis@google.com>
	Signed-off-by: Sean Christopherson <seanjc@google.com>
[Used get_backing_src_pagesz() to determine alignment dynamically.]
	Signed-off-by: David Matlack <dmatlack@google.com>
Message-Id: <20211111000310.1435032-5-dmatlack@google.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 69cdcfa6f321da2cc1dd2e62fa4a9ee256299b18)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/kvm/lib/perf_test_util.c
diff --cc tools/testing/selftests/kvm/lib/perf_test_util.c
index 0ef80dbdc116,a015f267d945..000000000000
--- a/tools/testing/selftests/kvm/lib/perf_test_util.c
+++ b/tools/testing/selftests/kvm/lib/perf_test_util.c
@@@ -92,10 -97,10 +97,14 @@@ struct kvm_vm *perf_test_create_vm(enu
  
  	guest_test_phys_mem = (vm_get_max_gfn(vm) - guest_num_pages) *
  			      perf_test_args.guest_page_size;
++<<<<<<< HEAD
 +	guest_test_phys_mem &= ~(perf_test_args.host_page_size - 1);
++=======
+ 	guest_test_phys_mem = align_down(guest_test_phys_mem, backing_src_pagesz);
++>>>>>>> 69cdcfa6f321 (KVM: selftests: Require GPA to be aligned when backed by hugepages)
  #ifdef __s390x__
  	/* Align to 1M (segment size) */
 -	guest_test_phys_mem = align_down(guest_test_phys_mem, 1 << 20);
 +	guest_test_phys_mem &= ~((1 << 20) - 1);
  #endif
  	pr_info("guest physical test memory offset: 0x%lx\n", guest_test_phys_mem);
  
diff --git a/tools/testing/selftests/kvm/lib/kvm_util.c b/tools/testing/selftests/kvm/lib/kvm_util.c
index e9d54f05f5c7..e17a94be8a85 100644
--- a/tools/testing/selftests/kvm/lib/kvm_util.c
+++ b/tools/testing/selftests/kvm/lib/kvm_util.c
@@ -917,6 +917,8 @@ void vm_userspace_mem_region_add(struct kvm_vm *vm,
 	if (src_type == VM_MEM_SRC_ANONYMOUS_THP)
 		alignment = max(backing_src_pagesz, alignment);
 
+	ASSERT_EQ(guest_paddr, align_up(guest_paddr, backing_src_pagesz));
+
 	/* Add enough memory to align up if necessary */
 	if (alignment > 1)
 		region->mmap_size += alignment;
* Unmerged path tools/testing/selftests/kvm/lib/perf_test_util.c
