cfg80211: Enable regulatory enforcement checks for drivers supporting mesh iface

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-408.el8
commit-author Sriram R <quic_srirrama@quicinc.com>
commit 701fdfe348f7e5c9fe71caa3558d63dbb4bc4b81
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-408.el8/701fdfe3.failed

Currently cfg80211 checks for invalid channels whenever there is a
regulatory update and stops the active interfaces if it is operating on
an unsupported channel in the new regulatory domain.

This is done based on a regulatory flag REGULATORY_IGNORE_STALE_KICKOFF
set during wiphy registration which disables this enforcement when
unsupported interface modes are supported by driver.

Add support to enable this enforcement when Mesh Point interface type
is advertised by drivers.

	Signed-off-by: Sriram R <quic_srirrama@quicinc.com>
Link: https://lore.kernel.org/r/1638409120-28997-1-git-send-email-quic_srirrama@quicinc.com
	Signed-off-by: Johannes Berg <johannes.berg@intel.com>
(cherry picked from commit 701fdfe348f7e5c9fe71caa3558d63dbb4bc4b81)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/wireless/reg.c
diff --cc net/wireless/reg.c
index f8f01a3e020b,58e4b33aff04..000000000000
--- a/net/wireless/reg.c
+++ b/net/wireless/reg.c
@@@ -2409,11 -2388,8 +2410,16 @@@ static bool reg_wdev_chan_valid(struct 
  	case NL80211_IFTYPE_AP:
  	case NL80211_IFTYPE_P2P_GO:
  	case NL80211_IFTYPE_ADHOC:
++<<<<<<< HEAD
 +		wiphy_lock(wiphy);
 +		ret = cfg80211_reg_can_beacon_relax(wiphy, &chandef, iftype);
 +		wiphy_unlock(wiphy);
 +
 +		return ret;
++=======
+ 	case NL80211_IFTYPE_MESH_POINT:
+ 		return cfg80211_reg_can_beacon_relax(wiphy, &chandef, iftype);
++>>>>>>> 701fdfe348f7 (cfg80211: Enable regulatory enforcement checks for drivers supporting mesh iface)
  	case NL80211_IFTYPE_STATION:
  	case NL80211_IFTYPE_P2P_CLIENT:
  		return cfg80211_chandef_usable(wiphy, &chandef,
diff --git a/net/wireless/core.c b/net/wireless/core.c
index c4ea903f8184..f244f15a43cd 100644
--- a/net/wireless/core.c
+++ b/net/wireless/core.c
@@ -736,6 +736,7 @@ int wiphy_register(struct wiphy *wiphy)
 	if (wiphy->interface_modes & ~(BIT(NL80211_IFTYPE_STATION) |
 				       BIT(NL80211_IFTYPE_P2P_CLIENT) |
 				       BIT(NL80211_IFTYPE_AP) |
+				       BIT(NL80211_IFTYPE_MESH_POINT) |
 				       BIT(NL80211_IFTYPE_P2P_GO) |
 				       BIT(NL80211_IFTYPE_ADHOC) |
 				       BIT(NL80211_IFTYPE_P2P_DEVICE) |
* Unmerged path net/wireless/reg.c
