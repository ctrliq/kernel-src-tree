scsi: mpi3mr: Rework mrioc->bsg_device model to fix warnings

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-408.el8
commit-author Sumit Saxena <sumit.saxena@broadcom.com>
commit 4094981db7b6ed6ebe3ebe398d8d9136ac5c44c8
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-408.el8/4094981d.failed

During driver unload, mrioc->bsg_device reference count becomes
negative. Also, as reported in [1], the driver's bsg_device model had few
more bugs. Fix all these up.

[1] https://marc.info/?l=linux-scsi&m=165183971411991&w=2

Link: https://lore.kernel.org/r/20220526170157.58274-1-sumit.saxena@broadcom.com
Fixes: 4268fa751365 ("scsi: mpi3mr: Add bsg device support")
	Reported-by: Dan Carpenter <dan.carpenter@oracle.com>
	Tested-by: Tomas Henzl <thenzl@redhat.com>
	Signed-off-by: Sumit Saxena <sumit.saxena@broadcom.com>
	Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
(cherry picked from commit 4094981db7b6ed6ebe3ebe398d8d9136ac5c44c8)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/scsi/mpi3mr/mpi3mr.h
#	drivers/scsi/mpi3mr/mpi3mr_app.c
diff --cc drivers/scsi/mpi3mr/mpi3mr.h
index b26d2677a53b,0e1cb4aa4ca2..000000000000
--- a/drivers/scsi/mpi3mr/mpi3mr.h
+++ b/drivers/scsi/mpi3mr/mpi3mr.h
@@@ -821,7 -936,30 +821,20 @@@ struct mpi3mr_ioc 
  	struct mpi3mr_fwevt *current_event;
  	struct mpi3_driver_info_layout driver_info;
  	u16 change_count;
 -
 -	u8 pel_enabled;
 -	u8 pel_abort_requested;
 -	u8 pel_class;
 -	u16 pel_locale;
 -	struct mpi3mr_drv_cmd pel_cmds;
 -	struct mpi3mr_drv_cmd pel_abort_cmd;
 -
 -	u32 pel_newest_seqnum;
 -	void *pel_seqnum_virt;
 -	dma_addr_t pel_seqnum_dma;
 -	u32 pel_seqnum_sz;
 -
  	u16 op_reply_q_offset;
++<<<<<<< HEAD
++=======
+ 	u16 default_qcount;
+ 	u16 active_poll_qcount;
+ 	u16 requested_poll_qcount;
+ 
+ 	struct device bsg_dev;
+ 	struct request_queue *bsg_queue;
+ 	u8 stop_bsgs;
+ 	u8 *logdata_buf;
+ 	u16 logdata_buf_idx;
+ 	u16 logdata_entry_sz;
++>>>>>>> 4094981db7b6 (scsi: mpi3mr: Rework mrioc->bsg_device model to fix warnings)
  };
  
  /**
* Unmerged path drivers/scsi/mpi3mr/mpi3mr_app.c
* Unmerged path drivers/scsi/mpi3mr/mpi3mr.h
* Unmerged path drivers/scsi/mpi3mr/mpi3mr_app.c
