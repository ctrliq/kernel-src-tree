dm: reduce code duplication in __map_bio

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-408.el8
commit-author Mike Snitzer <snitzer@redhat.com>
commit 90a2326edede9e801e45c24b3c71f3092b279b66
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-408.el8/90a2326e.failed

Error path code (for handling DM_MAPIO_REQUEUE and DM_MAPIO_KILL) is
effectively identical.

	Reviewed-by: Christoph Hellwig <hch@lst.de>
	Reviewed-by: Mikulas Patocka <mpatocka@redhat.com>
	Signed-off-by: Mike Snitzer <snitzer@redhat.com>
(cherry picked from commit 90a2326edede9e801e45c24b3c71f3092b279b66)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/dm.c
diff --cc drivers/md/dm.c
index 495368816d3f,fb129fe94a0d..000000000000
--- a/drivers/md/dm.c
+++ b/drivers/md/dm.c
@@@ -1301,25 -1176,18 +1301,36 @@@ static blk_qc_t __map_bio(struct dm_tar
  		break;
  	case DM_MAPIO_REMAPPED:
  		/* the bio has been remapped so dispatch it */
 -		trace_block_bio_remap(clone, bio_dev(io->orig_bio), sector);
 -		submit_bio_noacct(clone);
 +		trace_block_bio_remap(clone->bi_disk->queue, clone,
 +				      bio_dev(io->orig_bio), sector);
 +		ret = generic_make_request(clone);
  		break;
  	case DM_MAPIO_KILL:
++<<<<<<< HEAD
 +		if (unlikely(swap_bios_limit(ti, clone))) {
 +			struct mapped_device *md = io->md;
 +			up(&md->swap_bios_semaphore);
 +		}
 +		free_tio(tio);
 +		dm_io_dec_pending(io, BLK_STS_IOERR);
 +		break;
 +	case DM_MAPIO_REQUEUE:
 +		if (unlikely(swap_bios_limit(ti, clone))) {
 +			struct mapped_device *md = io->md;
 +			up(&md->swap_bios_semaphore);
 +		}
 +		free_tio(tio);
 +		dm_io_dec_pending(io, BLK_STS_DM_REQUEUE);
++=======
+ 	case DM_MAPIO_REQUEUE:
+ 		if (unlikely(swap_bios_limit(ti, clone)))
+ 			up(&io->md->swap_bios_semaphore);
+ 		free_tio(clone);
+ 		if (r == DM_MAPIO_KILL)
+ 			dm_io_dec_pending(io, BLK_STS_IOERR);
+ 		else
+ 			dm_io_dec_pending(io, BLK_STS_DM_REQUEUE);
++>>>>>>> 90a2326edede (dm: reduce code duplication in __map_bio)
  		break;
  	default:
  		DMWARN("unimplemented target map return value: %d", r);
* Unmerged path drivers/md/dm.c
