KVM: selftests: Capture per-vCPU GPA in perf_test_vcpu_args

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-408.el8
commit-author Sean Christopherson <seanjc@google.com>
commit 613d61182fffca6b36ea0df1e44927ccf45b1e9b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-408.el8/613d6118.failed

Capture the per-vCPU GPA in perf_test_vcpu_args so that tests can get
the GPA without having to calculate the GPA on their own.

No functional change intended.

	Signed-off-by: Sean Christopherson <seanjc@google.com>
	Reviewed-by: Ben Gardon <bgardon@google.com>
	Signed-off-by: David Matlack <dmatlack@google.com>
Message-Id: <20211111000310.1435032-7-dmatlack@google.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit 613d61182fffca6b36ea0df1e44927ccf45b1e9b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/kvm/lib/perf_test_util.c
diff --cc tools/testing/selftests/kvm/lib/perf_test_util.c
index 0ef80dbdc116,d9c6bcb7964d..000000000000
--- a/tools/testing/selftests/kvm/lib/perf_test_util.c
+++ b/tools/testing/selftests/kvm/lib/perf_test_util.c
@@@ -128,7 -135,7 +128,11 @@@ void perf_test_setup_vcpus(struct kvm_v
  			   uint64_t vcpu_memory_bytes,
  			   bool partition_vcpu_memory_access)
  {
++<<<<<<< HEAD
 +	vm_paddr_t vcpu_gpa;
++=======
+ 	struct perf_test_args *pta = &perf_test_args;
++>>>>>>> 613d61182fff (KVM: selftests: Capture per-vCPU GPA in perf_test_vcpu_args)
  	struct perf_test_vcpu_args *vcpu_args;
  	int vcpu_id;
  
@@@ -140,20 -147,20 +144,36 @@@
  			vcpu_args->gva = guest_test_virt_mem +
  					 (vcpu_id * vcpu_memory_bytes);
  			vcpu_args->pages = vcpu_memory_bytes /
++<<<<<<< HEAD
 +					   perf_test_args.guest_page_size;
 +			vcpu_gpa = guest_test_phys_mem +
 +				   (vcpu_id * vcpu_memory_bytes);
 +		} else {
 +			vcpu_args->gva = guest_test_virt_mem;
 +			vcpu_args->pages = (vcpus * vcpu_memory_bytes) /
 +					   perf_test_args.guest_page_size;
 +			vcpu_gpa = guest_test_phys_mem;
++=======
+ 					   pta->guest_page_size;
+ 			vcpu_args->gpa = guest_test_phys_mem +
+ 					 (vcpu_id * vcpu_memory_bytes);
+ 		} else {
+ 			vcpu_args->gva = guest_test_virt_mem;
+ 			vcpu_args->pages = (vcpus * vcpu_memory_bytes) /
+ 					   pta->guest_page_size;
+ 			vcpu_args->gpa = guest_test_phys_mem;
++>>>>>>> 613d61182fff (KVM: selftests: Capture per-vCPU GPA in perf_test_vcpu_args)
  		}
  
  		vcpu_args_set(vm, vcpu_id, 1, vcpu_id);
  
  		pr_debug("Added VCPU %d with test mem gpa [%lx, %lx)\n",
++<<<<<<< HEAD
 +			 vcpu_id, vcpu_gpa, vcpu_gpa +
 +			 (vcpu_args->pages * perf_test_args.guest_page_size));
++=======
+ 			 vcpu_id, vcpu_args->gpa, vcpu_args->gpa +
+ 			 (vcpu_args->pages * pta->guest_page_size));
++>>>>>>> 613d61182fff (KVM: selftests: Capture per-vCPU GPA in perf_test_vcpu_args)
  	}
  }
diff --git a/tools/testing/selftests/kvm/include/perf_test_util.h b/tools/testing/selftests/kvm/include/perf_test_util.h
index df9f1a3a3ffb..20aec72fe7b8 100644
--- a/tools/testing/selftests/kvm/include/perf_test_util.h
+++ b/tools/testing/selftests/kvm/include/perf_test_util.h
@@ -18,6 +18,7 @@
 #define PERF_TEST_MEM_SLOT_INDEX	1
 
 struct perf_test_vcpu_args {
+	uint64_t gpa;
 	uint64_t gva;
 	uint64_t pages;
 
* Unmerged path tools/testing/selftests/kvm/lib/perf_test_util.c
