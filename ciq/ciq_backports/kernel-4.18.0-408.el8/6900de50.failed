net/smc: Call trace_smc_tx_sendmsg when data corked

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-408.el8
commit-author Tony Lu <tonylu@linux.alibaba.com>
commit 6900de507cd471492d83aabd48f13abb9c016d4d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-408.el8/6900de50.failed

This also calls trace_smc_tx_sendmsg() even if data is corked. For ease
of understanding, if statements are not expanded here.

Link: https://lore.kernel.org/all/f4166712-9a1e-51a0-409d-b7df25a66c52@linux.ibm.com/
Fixes: 139653bc6635 ("net/smc: Remove corked dealyed work")
	Suggested-by: Stefan Raspl <raspl@linux.ibm.com>
	Signed-off-by: Tony Lu <tonylu@linux.alibaba.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 6900de507cd471492d83aabd48f13abb9c016d4d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/smc/smc_tx.c
diff --cc net/smc/smc_tx.c
index 65c0402df8d5,436ac836f363..000000000000
--- a/net/smc/smc_tx.c
+++ b/net/smc/smc_tx.c
@@@ -235,16 -235,16 +235,29 @@@ int smc_tx_sendmsg(struct smc_sock *smc
  		 */
  		if ((msg->msg_flags & MSG_OOB) && !send_remaining)
  			conn->urg_tx_pend = true;
++<<<<<<< HEAD
 +		if ((msg->msg_flags & MSG_MORE || smc_tx_is_corked(smc)) &&
 +		    (atomic_read(&conn->sndbuf_space) >
 +						(conn->sndbuf_desc->len >> 1)))
 +			/* for a corked socket defer the RDMA writes if there
 +			 * is still sufficient sndbuf_space available
 +			 */
 +			queue_delayed_work(conn->lgr->tx_wq, &conn->tx_work,
 +					   SMC_TX_CORK_DELAY);
 +		else
 +			smc_tx_sndbuf_nonempty(conn);
++=======
+ 		/* for a corked socket defer the RDMA writes if
+ 		 * sndbuf_space is still available. The applications
+ 		 * should known how/when to uncork it.
+ 		 */
+ 		if (!((msg->msg_flags & MSG_MORE || smc_tx_is_corked(smc) ||
+ 		       msg->msg_flags & MSG_SENDPAGE_NOTLAST) &&
+ 		      atomic_read(&conn->sndbuf_space)))
+ 			smc_tx_sndbuf_nonempty(conn);
+ 
+ 		trace_smc_tx_sendmsg(smc, copylen);
++>>>>>>> 6900de507cd4 (net/smc: Call trace_smc_tx_sendmsg when data corked)
  	} /* while (msg_data_left(msg)) */
  
  	return send_done;
* Unmerged path net/smc/smc_tx.c
