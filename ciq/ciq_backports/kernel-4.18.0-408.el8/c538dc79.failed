KVM: SVM: Do not activate AVIC for SEV-enabled guest

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-408.el8
commit-author Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
commit c538dc792ff7e456d777f585fdf96aa4e781ed66
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-408.el8/c538dc79.failed

Since current AVIC implementation cannot support encrypted memory,
inhibit AVIC for SEV-enabled guest.

	Signed-off-by: Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
Message-Id: <20220408133710.54275-1-suravee.suthikulpanit@amd.com>
	Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
(cherry picked from commit c538dc792ff7e456d777f585fdf96aa4e781ed66)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/include/asm/kvm_host.h
diff --cc arch/x86/include/asm/kvm_host.h
index 24742b8ee038,92843fcdc1cf..000000000000
--- a/arch/x86/include/asm/kvm_host.h
+++ b/arch/x86/include/asm/kvm_host.h
@@@ -1039,14 -1043,17 +1039,28 @@@ struct kvm_x86_msr_filter 
  	struct msr_bitmap_range ranges[16];
  };
  
++<<<<<<< HEAD
 +#define APICV_INHIBIT_REASON_DISABLE    0
 +#define APICV_INHIBIT_REASON_HYPERV     1
 +#define APICV_INHIBIT_REASON_NESTED     2
 +#define APICV_INHIBIT_REASON_IRQWIN     3
 +#define APICV_INHIBIT_REASON_PIT_REINJ  4
 +#define APICV_INHIBIT_REASON_X2APIC	5
 +#define APICV_INHIBIT_REASON_BLOCKIRQ	6
 +#define APICV_INHIBIT_REASON_ABSENT	7
++=======
+ enum kvm_apicv_inhibit {
+ 	APICV_INHIBIT_REASON_DISABLE,
+ 	APICV_INHIBIT_REASON_HYPERV,
+ 	APICV_INHIBIT_REASON_NESTED,
+ 	APICV_INHIBIT_REASON_IRQWIN,
+ 	APICV_INHIBIT_REASON_PIT_REINJ,
+ 	APICV_INHIBIT_REASON_X2APIC,
+ 	APICV_INHIBIT_REASON_BLOCKIRQ,
+ 	APICV_INHIBIT_REASON_ABSENT,
+ 	APICV_INHIBIT_REASON_SEV,
+ };
++>>>>>>> c538dc792ff7 (KVM: SVM: Do not activate AVIC for SEV-enabled guest)
  
  struct kvm_arch {
  	unsigned long n_used_mmu_pages;
* Unmerged path arch/x86/include/asm/kvm_host.h
diff --git a/arch/x86/kvm/svm/avic.c b/arch/x86/kvm/svm/avic.c
index 1e4664198347..0d50fc03288d 100644
--- a/arch/x86/kvm/svm/avic.c
+++ b/arch/x86/kvm/svm/avic.c
@@ -935,7 +935,8 @@ bool svm_check_apicv_inhibit_reasons(ulong bit)
 			  BIT(APICV_INHIBIT_REASON_IRQWIN) |
 			  BIT(APICV_INHIBIT_REASON_PIT_REINJ) |
 			  BIT(APICV_INHIBIT_REASON_X2APIC) |
-			  BIT(APICV_INHIBIT_REASON_BLOCKIRQ);
+			  BIT(APICV_INHIBIT_REASON_BLOCKIRQ) |
+			  BIT(APICV_INHIBIT_REASON_SEV);
 
 	return supported & BIT(bit);
 }
diff --git a/arch/x86/kvm/svm/sev.c b/arch/x86/kvm/svm/sev.c
index e68a6b0ebb16..d9255a751793 100644
--- a/arch/x86/kvm/svm/sev.c
+++ b/arch/x86/kvm/svm/sev.c
@@ -259,6 +259,8 @@ static int sev_guest_init(struct kvm *kvm, struct kvm_sev_cmd *argp)
 
 	INIT_LIST_HEAD(&sev->regions_list);
 
+	kvm_set_apicv_inhibit(kvm, APICV_INHIBIT_REASON_SEV);
+
 	return 0;
 
 e_free:
