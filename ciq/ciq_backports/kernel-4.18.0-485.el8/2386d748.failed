selftests: Add source route tests to fib_tests

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-485.el8
commit-author David Ahern <dsahern@kernel.org>
commit 2386d74845c358f464429c4b071bfc681e913013
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-485.el8/2386d748.failed

Add tests to verify routes with source address set are deleted when
source address is deleted.

	Signed-off-by: David Ahern <dsahern@kernel.org>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 2386d74845c358f464429c4b071bfc681e913013)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	tools/testing/selftests/net/fib_tests.sh
diff --cc tools/testing/selftests/net/fib_tests.sh
index c85734602cdf,6dd403103800..000000000000
--- a/tools/testing/selftests/net/fib_tests.sh
+++ b/tools/testing/selftests/net/fib_tests.sh
@@@ -9,7 -9,8 +9,12 @@@ ret=
  ksft_skip=4
  
  # all tests in this script. Can be overridden with -t option
++<<<<<<< HEAD
 +TESTS="unregister down carrier nexthop ipv6_rt ipv4_rt ipv6_addr_metric ipv4_addr_metric ipv6_route_metrics ipv4_route_metrics"
++=======
+ TESTS="unregister down carrier nexthop suppress ipv6_rt ipv4_rt ipv6_addr_metric ipv4_addr_metric ipv6_route_metrics ipv4_route_metrics ipv4_route_v6_gw rp_filter ipv4_del_addr"
+ 
++>>>>>>> 2386d74845c3 (selftests: Add source route tests to fib_tests)
  VERBOSE=0
  PAUSE_ON_FAIL=no
  PAUSE=no
@@@ -1509,6 -1500,119 +1514,122 @@@ ipv4_route_metrics_test(
  	route_cleanup
  }
  
++<<<<<<< HEAD
++=======
+ ipv4_del_addr_test()
+ {
+ 	echo
+ 	echo "IPv4 delete address route tests"
+ 
+ 	setup
+ 
+ 	set -e
+ 	$IP li add dummy1 type dummy
+ 	$IP li set dummy1 up
+ 	$IP li add dummy2 type dummy
+ 	$IP li set dummy2 up
+ 	$IP li add red type vrf table 1111
+ 	$IP li set red up
+ 	$IP ro add vrf red unreachable default
+ 	$IP li set dummy2 vrf red
+ 
+ 	$IP addr add dev dummy1 172.16.104.1/24
+ 	$IP addr add dev dummy1 172.16.104.11/24
+ 	$IP addr add dev dummy2 172.16.104.1/24
+ 	$IP addr add dev dummy2 172.16.104.11/24
+ 	$IP route add 172.16.105.0/24 via 172.16.104.2 src 172.16.104.11
+ 	$IP route add vrf red 172.16.105.0/24 via 172.16.104.2 src 172.16.104.11
+ 	set +e
+ 
+ 	# removing address from device in vrf should only remove route from vrf table
+ 	$IP addr del dev dummy2 172.16.104.11/24
+ 	$IP ro ls vrf red | grep -q 172.16.105.0/24
+ 	log_test $? 1 "Route removed from VRF when source address deleted"
+ 
+ 	$IP ro ls | grep -q 172.16.105.0/24
+ 	log_test $? 0 "Route in default VRF not removed"
+ 
+ 	$IP addr add dev dummy2 172.16.104.11/24
+ 	$IP route add vrf red 172.16.105.0/24 via 172.16.104.2 src 172.16.104.11
+ 
+ 	$IP addr del dev dummy1 172.16.104.11/24
+ 	$IP ro ls | grep -q 172.16.105.0/24
+ 	log_test $? 1 "Route removed in default VRF when source address deleted"
+ 
+ 	$IP ro ls vrf red | grep -q 172.16.105.0/24
+ 	log_test $? 0 "Route in VRF is not removed by address delete"
+ 
+ 	$IP li del dummy1
+ 	$IP li del dummy2
+ 	cleanup
+ }
+ 
+ 
+ ipv4_route_v6_gw_test()
+ {
+ 	local rc
+ 
+ 	echo
+ 	echo "IPv4 route with IPv6 gateway tests"
+ 
+ 	route_setup
+ 	sleep 2
+ 
+ 	#
+ 	# single path route
+ 	#
+ 	run_cmd "$IP ro add 172.16.104.0/24 via inet6 2001:db8:101::2"
+ 	rc=$?
+ 	log_test $rc 0 "Single path route with IPv6 gateway"
+ 	if [ $rc -eq 0 ]; then
+ 		check_route "172.16.104.0/24 via inet6 2001:db8:101::2 dev veth1"
+ 	fi
+ 
+ 	run_cmd "ip netns exec ns1 ping -w1 -c1 172.16.104.1"
+ 	log_test $rc 0 "Single path route with IPv6 gateway - ping"
+ 
+ 	run_cmd "$IP ro del 172.16.104.0/24 via inet6 2001:db8:101::2"
+ 	rc=$?
+ 	log_test $rc 0 "Single path route delete"
+ 	if [ $rc -eq 0 ]; then
+ 		check_route "172.16.112.0/24"
+ 	fi
+ 
+ 	#
+ 	# multipath - v6 then v4
+ 	#
+ 	run_cmd "$IP ro add 172.16.104.0/24 nexthop via inet6 2001:db8:101::2 dev veth1 nexthop via 172.16.103.2 dev veth3"
+ 	rc=$?
+ 	log_test $rc 0 "Multipath route add - v6 nexthop then v4"
+ 	if [ $rc -eq 0 ]; then
+ 		check_route "172.16.104.0/24 nexthop via inet6 2001:db8:101::2 dev veth1 weight 1 nexthop via 172.16.103.2 dev veth3 weight 1"
+ 	fi
+ 
+ 	run_cmd "$IP ro del 172.16.104.0/24 nexthop via 172.16.103.2 dev veth3 nexthop via inet6 2001:db8:101::2 dev veth1"
+ 	log_test $? 2 "    Multipath route delete - nexthops in wrong order"
+ 
+ 	run_cmd "$IP ro del 172.16.104.0/24 nexthop via inet6 2001:db8:101::2 dev veth1 nexthop via 172.16.103.2 dev veth3"
+ 	log_test $? 0 "    Multipath route delete exact match"
+ 
+ 	#
+ 	# multipath - v4 then v6
+ 	#
+ 	run_cmd "$IP ro add 172.16.104.0/24 nexthop via 172.16.103.2 dev veth3 nexthop via inet6 2001:db8:101::2 dev veth1"
+ 	rc=$?
+ 	log_test $rc 0 "Multipath route add - v4 nexthop then v6"
+ 	if [ $rc -eq 0 ]; then
+ 		check_route "172.16.104.0/24 nexthop via 172.16.103.2 dev veth3 weight 1 nexthop via inet6 2001:db8:101::2 dev veth1 weight 1"
+ 	fi
+ 
+ 	run_cmd "$IP ro del 172.16.104.0/24 nexthop via inet6 2001:db8:101::2 dev veth1 nexthop via 172.16.103.2 dev veth3"
+ 	log_test $? 2 "    Multipath route delete - nexthops in wrong order"
+ 
+ 	run_cmd "$IP ro del 172.16.104.0/24 nexthop via 172.16.103.2 dev veth3 nexthop via inet6 2001:db8:101::2 dev veth1"
+ 	log_test $? 0 "    Multipath route delete exact match"
+ 
+ 	route_cleanup
+ }
++>>>>>>> 2386d74845c3 (selftests: Add source route tests to fib_tests)
  
  ################################################################################
  # usage
@@@ -1576,8 -1682,10 +1697,9 @@@ d
  	ipv4_route_test|ipv4_rt)	ipv4_route_test;;
  	ipv6_addr_metric)		ipv6_addr_metric_test;;
  	ipv4_addr_metric)		ipv4_addr_metric_test;;
+ 	ipv4_del_addr)			ipv4_del_addr_test;;
  	ipv6_route_metrics)		ipv6_route_metrics_test;;
  	ipv4_route_metrics)		ipv4_route_metrics_test;;
 -	ipv4_route_v6_gw)		ipv4_route_v6_gw_test;;
  
  	help) echo "Test names: $TESTS"; exit 0;;
  	esac
* Unmerged path tools/testing/selftests/net/fib_tests.sh
