net/mlx5: FPGA, Add SBU infrastructure

jira LE-1907
Rebuild_History Non-Buildable kernel-3.10.0-862.el7
Rebuild_CHGLOG: - [netdrv] mlx5: FPGA, Add SBU infrastructure (Kamal Heib) [1456677 1456694]
Rebuild_FUZZ: 94.44%
commit-author Ilan Tayari <ilant@mellanox.com>
commit a9956d35d199beb406727a4496bc5d7f09c82976
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-3.10.0-862.el7/a9956d35.failed

Add interface to initialize and interact with Innova FPGA SBU
connections.
A client driver may use these functions to set up a high-speed DMA
connection with its SBU hardware logic, and send/receive messages
over this connection.

A later patch in this patchset will make use of these functions for
Innova IPSec offload in mlx5 Ethernet driver.

Add commands to retrieve Innova FPGA SBU capabilities, and to
read/write Innova FPGA configuration space registers and memory,
over internal I2C.

At high level, the FPGA configuration space is divided such:
 0x00000000 - 0x007fffff is reserved for the SBU
 0x00800000 - 0xffffffff is reserved for the Shell
0x400000000 - ...        is DDR memory

A later patchset will add support for accessing FPGA CrSpace and memory
over a high-speed connection. This is the reason for the ACCESS_TYPE
enumeration, which currently only supports I2C.

	Signed-off-by: Ilan Tayari <ilant@mellanox.com>
	Signed-off-by: Saeed Mahameed <saeedm@mellanox.com>
(cherry picked from commit a9956d35d199beb406727a4496bc5d7f09c82976)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/Makefile
#	drivers/net/ethernet/mellanox/mlx5/core/fpga/cmd.c
#	drivers/net/ethernet/mellanox/mlx5/core/fpga/cmd.h
#	drivers/net/ethernet/mellanox/mlx5/core/fpga/sdk.h
#	include/linux/mlx5/device.h
#	include/linux/mlx5/driver.h
#	include/linux/mlx5/mlx5_ifc.h
#	include/linux/mlx5/mlx5_ifc_fpga.h
diff --cc drivers/net/ethernet/mellanox/mlx5/core/Makefile
index 9e644615f07a,676388fde239..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/Makefile
+++ b/drivers/net/ethernet/mellanox/mlx5/core/Makefile
@@@ -3,7 -4,9 +3,13 @@@ obj-$(CONFIG_MLX5_CORE)		+= mlx5_core.
  mlx5_core-y :=	main.o cmd.o debugfs.o fw.o eq.o uar.o pagealloc.o \
  		health.o mcg.o cq.o srq.o alloc.o qp.o port.o mr.o pd.o \
  		mad.o transobj.o vport.o sriov.o fs_cmd.o fs_core.o \
++<<<<<<< HEAD
 +		fs_counters.o rl.o lag.o dev.o
++=======
+ 		fs_counters.o rl.o lag.o dev.o lib/gid.o
+ 
+ mlx5_core-$(CONFIG_MLX5_FPGA) += fpga/cmd.o fpga/core.o fpga/conn.o fpga/sdk.o
++>>>>>>> a9956d35d199 (net/mlx5: FPGA, Add SBU infrastructure)
  
  mlx5_core-$(CONFIG_MLX5_CORE_EN) += wq.o eswitch.o eswitch_offloads.o \
  		en_main.o en_common.o en_fs.o en_ethtool.o en_tx.o \
diff --cc include/linux/mlx5/device.h
index c687f8b8f7bb,f31a0b5377e1..000000000000
--- a/include/linux/mlx5/device.h
+++ b/include/linux/mlx5/device.h
@@@ -1094,6 -1100,12 +1094,15 @@@ enum mlx5_mcam_feature_groups 
  #define MLX5_CAP_MCAM_FEATURE(mdev, fld) \
  	MLX5_GET(mcam_reg, (mdev)->caps.mcam, mng_feature_cap_mask.enhanced_features.fld)
  
++<<<<<<< HEAD
++=======
+ #define MLX5_CAP_FPGA(mdev, cap) \
+ 	MLX5_GET(fpga_cap, (mdev)->caps.hca_cur[MLX5_CAP_FPGA], cap)
+ 
+ #define MLX5_CAP64_FPGA(mdev, cap) \
+ 	MLX5_GET64(fpga_cap, (mdev)->caps.hca_cur[MLX5_CAP_FPGA], cap)
+ 
++>>>>>>> a9956d35d199 (net/mlx5: FPGA, Add SBU infrastructure)
  enum {
  	MLX5_CMD_STAT_OK			= 0x0,
  	MLX5_CMD_STAT_INT_ERR			= 0x1,
diff --cc include/linux/mlx5/driver.h
index a9905f6fdc14,2ab4ae3e3a1a..000000000000
--- a/include/linux/mlx5/driver.h
+++ b/include/linux/mlx5/driver.h
@@@ -106,6 -109,9 +106,12 @@@ enum 
  	MLX5_REG_QTCT		 = 0x400a,
  	MLX5_REG_DCBX_PARAM      = 0x4020,
  	MLX5_REG_DCBX_APP        = 0x4021,
++<<<<<<< HEAD
++=======
+ 	MLX5_REG_FPGA_CAP	 = 0x4022,
+ 	MLX5_REG_FPGA_CTRL	 = 0x4023,
+ 	MLX5_REG_FPGA_ACCESS_REG = 0x4024,
++>>>>>>> a9956d35d199 (net/mlx5: FPGA, Add SBU infrastructure)
  	MLX5_REG_PCAP		 = 0x5001,
  	MLX5_REG_PMTU		 = 0x5003,
  	MLX5_REG_PTYS		 = 0x5004,
diff --cc include/linux/mlx5/mlx5_ifc.h
index fc41d24d9548,c72f9735119d..000000000000
--- a/include/linux/mlx5/mlx5_ifc.h
+++ b/include/linux/mlx5/mlx5_ifc.h
@@@ -8244,6 -8309,12 +8244,15 @@@ union mlx5_ifc_ports_control_registers_
  	struct mlx5_ifc_sltp_reg_bits sltp_reg;
  	struct mlx5_ifc_mtpps_reg_bits mtpps_reg;
  	struct mlx5_ifc_mtppse_reg_bits mtppse_reg;
++<<<<<<< HEAD
++=======
+ 	struct mlx5_ifc_fpga_access_reg_bits fpga_access_reg;
+ 	struct mlx5_ifc_fpga_ctrl_bits fpga_ctrl_bits;
+ 	struct mlx5_ifc_fpga_cap_bits fpga_cap_bits;
+ 	struct mlx5_ifc_mcqi_reg_bits mcqi_reg;
+ 	struct mlx5_ifc_mcc_reg_bits mcc_reg;
+ 	struct mlx5_ifc_mcda_reg_bits mcda_reg;
++>>>>>>> a9956d35d199 (net/mlx5: FPGA, Add SBU infrastructure)
  	u8         reserved_at_0[0x60e0];
  };
  
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/fpga/cmd.c
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/fpga/cmd.h
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/fpga/sdk.h
* Unmerged path include/linux/mlx5/mlx5_ifc_fpga.h
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/Makefile
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/fpga/cmd.c
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/fpga/cmd.h
diff --git a/drivers/net/ethernet/mellanox/mlx5/core/fpga/sdk.c b/drivers/net/ethernet/mellanox/mlx5/core/fpga/sdk.c
new file mode 100644
index 000000000000..3c11d6e2160a
--- /dev/null
+++ b/drivers/net/ethernet/mellanox/mlx5/core/fpga/sdk.c
@@ -0,0 +1,164 @@
+/*
+ * Copyright (c) 2017 Mellanox Technologies. All rights reserved.
+ *
+ * This software is available to you under a choice of one of two
+ * licenses.  You may choose to be licensed under the terms of the GNU
+ * General Public License (GPL) Version 2, available from the file
+ * COPYING in the main directory of this source tree, or the
+ * OpenIB.org BSD license below:
+ *
+ *     Redistribution and use in source and binary forms, with or
+ *     without modification, are permitted provided that the following
+ *     conditions are met:
+ *
+ *      - Redistributions of source code must retain the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer.
+ *
+ *      - Redistributions in binary form must reproduce the above
+ *        copyright notice, this list of conditions and the following
+ *        disclaimer in the documentation and/or other materials
+ *        provided with the distribution.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
+ * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+ * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+ * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
+ * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
+ * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
+ * SOFTWARE.
+ *
+ */
+
+#include <linux/mlx5/device.h>
+
+#include "fpga/core.h"
+#include "fpga/conn.h"
+#include "fpga/sdk.h"
+
+struct mlx5_fpga_conn *
+mlx5_fpga_sbu_conn_create(struct mlx5_fpga_device *fdev,
+			  struct mlx5_fpga_conn_attr *attr)
+{
+	return mlx5_fpga_conn_create(fdev, attr, MLX5_FPGA_QPC_QP_TYPE_SANDBOX_QP);
+}
+EXPORT_SYMBOL(mlx5_fpga_sbu_conn_create);
+
+void mlx5_fpga_sbu_conn_destroy(struct mlx5_fpga_conn *conn)
+{
+	mlx5_fpga_conn_destroy(conn);
+}
+EXPORT_SYMBOL(mlx5_fpga_sbu_conn_destroy);
+
+int mlx5_fpga_sbu_conn_sendmsg(struct mlx5_fpga_conn *conn,
+			       struct mlx5_fpga_dma_buf *buf)
+{
+	return mlx5_fpga_conn_send(conn, buf);
+}
+EXPORT_SYMBOL(mlx5_fpga_sbu_conn_sendmsg);
+
+static int mlx5_fpga_mem_read_i2c(struct mlx5_fpga_device *fdev, size_t size,
+				  u64 addr, u8 *buf)
+{
+	size_t max_size = MLX5_FPGA_ACCESS_REG_SIZE_MAX;
+	size_t bytes_done = 0;
+	u8 actual_size;
+	int err;
+
+	if (!fdev->mdev)
+		return -ENOTCONN;
+
+	while (bytes_done < size) {
+		actual_size = min(max_size, (size - bytes_done));
+
+		err = mlx5_fpga_access_reg(fdev->mdev, actual_size,
+					   addr + bytes_done,
+					   buf + bytes_done, false);
+		if (err) {
+			mlx5_fpga_err(fdev, "Failed to read over I2C: %d\n",
+				      err);
+			break;
+		}
+
+		bytes_done += actual_size;
+	}
+
+	return err;
+}
+
+static int mlx5_fpga_mem_write_i2c(struct mlx5_fpga_device *fdev, size_t size,
+				   u64 addr, u8 *buf)
+{
+	size_t max_size = MLX5_FPGA_ACCESS_REG_SIZE_MAX;
+	size_t bytes_done = 0;
+	u8 actual_size;
+	int err;
+
+	if (!fdev->mdev)
+		return -ENOTCONN;
+
+	while (bytes_done < size) {
+		actual_size = min(max_size, (size - bytes_done));
+
+		err = mlx5_fpga_access_reg(fdev->mdev, actual_size,
+					   addr + bytes_done,
+					   buf + bytes_done, true);
+		if (err) {
+			mlx5_fpga_err(fdev, "Failed to write FPGA crspace\n");
+			break;
+		}
+
+		bytes_done += actual_size;
+	}
+
+	return err;
+}
+
+int mlx5_fpga_mem_read(struct mlx5_fpga_device *fdev, size_t size, u64 addr,
+		       void *buf, enum mlx5_fpga_access_type access_type)
+{
+	int ret;
+
+	switch (access_type) {
+	case MLX5_FPGA_ACCESS_TYPE_I2C:
+		ret = mlx5_fpga_mem_read_i2c(fdev, size, addr, buf);
+		if (ret)
+			return ret;
+		break;
+	default:
+		mlx5_fpga_warn(fdev, "Unexpected read access_type %u\n",
+			       access_type);
+		return -EACCES;
+	}
+
+	return size;
+}
+EXPORT_SYMBOL(mlx5_fpga_mem_read);
+
+int mlx5_fpga_mem_write(struct mlx5_fpga_device *fdev, size_t size, u64 addr,
+			void *buf, enum mlx5_fpga_access_type access_type)
+{
+	int ret;
+
+	switch (access_type) {
+	case MLX5_FPGA_ACCESS_TYPE_I2C:
+		ret = mlx5_fpga_mem_write_i2c(fdev, size, addr, buf);
+		if (ret)
+			return ret;
+		break;
+	default:
+		mlx5_fpga_warn(fdev, "Unexpected write access_type %u\n",
+			       access_type);
+		return -EACCES;
+	}
+
+	return size;
+}
+EXPORT_SYMBOL(mlx5_fpga_mem_write);
+
+int mlx5_fpga_get_sbu_caps(struct mlx5_fpga_device *fdev, int size, void *buf)
+{
+	return mlx5_fpga_sbu_caps(fdev->mdev, buf, size);
+}
+EXPORT_SYMBOL(mlx5_fpga_get_sbu_caps);
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/fpga/sdk.h
* Unmerged path include/linux/mlx5/device.h
* Unmerged path include/linux/mlx5/driver.h
* Unmerged path include/linux/mlx5/mlx5_ifc.h
* Unmerged path include/linux/mlx5/mlx5_ifc_fpga.h
