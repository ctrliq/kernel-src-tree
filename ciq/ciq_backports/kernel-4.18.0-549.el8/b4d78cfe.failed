dm-integrity: align the outgoing bio in integrity_recheck

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-549.el8
commit-author Mikulas Patocka <mpatocka@redhat.com>
commit b4d78cfeb30476239cf08f4f40afc095c173d6e3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-549.el8/b4d78cfe.failed

It is possible to set up dm-integrity with smaller sector size than
the logical sector size of the underlying device. In this situation,
dm-integrity guarantees that the outgoing bios have the same alignment as
incoming bios (so, if you create a filesystem with 4k block size,
dm-integrity would send 4k-aligned bios to the underlying device).

This guarantee was broken when integrity_recheck was implemented.
integrity_recheck sends bio that is aligned to ic->sectors_per_block. So
if we set up integrity with 512-byte sector size on a device with logical
block size 4k, we would be sending unaligned bio. This triggered a bug in
one of our internal tests.

This commit fixes it by determining the actual alignment of the
incoming bio and then makes sure that the outgoing bio in
integrity_recheck has the same alignment.

Fixes: c88f5e553fe3 ("dm-integrity: recheck the integrity tag after a failure")
	Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
	Signed-off-by: Mike Snitzer <snitzer@kernel.org>
(cherry picked from commit b4d78cfeb30476239cf08f4f40afc095c173d6e3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/dm-integrity.c
diff --cc drivers/md/dm-integrity.c
index ffa70d6d4d61,37b9f8f1ae1a..000000000000
--- a/drivers/md/dm-integrity.c
+++ b/drivers/md/dm-integrity.c
@@@ -1734,7 -1727,15 +1734,19 @@@ static noinline void integrity_recheck(
  			io_loc.sector = sector;
  			io_loc.count = ic->sectors_per_block;
  
++<<<<<<< HEAD
 +			r = dm_io(&io_req, 1, &io_loc, NULL);
++=======
+ 			/* Align the bio to logical block size */
+ 			alignment = dio->range.logical_sector | bio_sectors(bio) | (PAGE_SIZE >> SECTOR_SHIFT);
+ 			alignment &= -alignment;
+ 			io_loc.sector = round_down(io_loc.sector, alignment);
+ 			io_loc.count += sector - io_loc.sector;
+ 			buffer += (sector - io_loc.sector) << SECTOR_SHIFT;
+ 			io_loc.count = round_up(io_loc.count, alignment);
+ 
+ 			r = dm_io(&io_req, 1, &io_loc, NULL, IOPRIO_DEFAULT);
++>>>>>>> b4d78cfeb304 (dm-integrity: align the outgoing bio in integrity_recheck)
  			if (unlikely(r)) {
  				dio->bi_status = errno_to_blk_status(r);
  				goto free_ret;
* Unmerged path drivers/md/dm-integrity.c
