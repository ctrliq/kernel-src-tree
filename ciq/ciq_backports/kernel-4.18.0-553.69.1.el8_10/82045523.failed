md/raid10: switch to use md_account_bio() for io accounting

jira LE-3845
Rebuild_History Non-Buildable kernel-4.18.0-553.69.1.el8_10
commit-author Yu Kuai <yukuai3@huawei.com>
commit 820455238366a78a44a85cc7d58a987e728464d9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.69.1.el8_10/82045523.failed

Make sure that 'active_io' will represent inflight io instead of io that
is dispatching, and io accounting from all levels will be consistent.

	Signed-off-by: Yu Kuai <yukuai3@huawei.com>
	Reviewed-by: Xiao Ni <xni@redhat.com>
	Signed-off-by: Song Liu <song@kernel.org>
Link: https://lore.kernel.org/r/20230621165110.1498313-6-yukuai1@huaweicloud.com
(cherry picked from commit 820455238366a78a44a85cc7d58a987e728464d9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/md/raid10.c
diff --cc drivers/md/raid10.c
index b1a170bf1f6a,d42e9b7d2608..000000000000
--- a/drivers/md/raid10.c
+++ b/drivers/md/raid10.c
@@@ -327,8 -325,6 +327,11 @@@ static void raid_end_bio_io(struct r10b
  	if (!test_bit(R10BIO_Uptodate, &r10_bio->state))
  		bio->bi_status = BLK_STS_IOERR;
  
++<<<<<<< HEAD
 +	if (blk_queue_io_stat(bio->bi_disk->queue))
 +		bio_end_io_acct(bio, r10_bio->start_time);
++=======
++>>>>>>> 820455238366 (md/raid10: switch to use md_account_bio() for io accounting)
  	bio_endio(bio);
  	/*
  	 * Wake up any possible resync thread that waits for the device
@@@ -1277,9 -1241,11 +1280,17 @@@ static void raid10_read_request(struct 
  	}
  	slot = r10_bio->read_slot;
  
++<<<<<<< HEAD
 +	if (blk_queue_io_stat(bio->bi_disk->queue))
 +		r10_bio->start_time = bio_start_io_acct(bio);
 +	read_bio = bio_clone_fast(bio, gfp, &mddev->bio_set);
++=======
+ 	if (io_accounting) {
+ 		md_account_bio(mddev, &bio);
+ 		r10_bio->master_bio = bio;
+ 	}
+ 	read_bio = bio_alloc_clone(rdev->bdev, bio, gfp, &mddev->bio_set);
++>>>>>>> 820455238366 (md/raid10: switch to use md_account_bio() for io accounting)
  
  	r10_bio->devs[slot].bio = read_bio;
  	r10_bio->devs[slot].rdev = rdev;
@@@ -1587,8 -1542,8 +1598,13 @@@ static void raid10_write_request(struc
  		r10_bio->master_bio = bio;
  	}
  
++<<<<<<< HEAD
 +	if (blk_queue_io_stat(bio->bi_disk->queue))
 +		r10_bio->start_time = bio_start_io_acct(bio);
++=======
+ 	md_account_bio(mddev, &bio);
+ 	r10_bio->master_bio = bio;
++>>>>>>> 820455238366 (md/raid10: switch to use md_account_bio() for io accounting)
  	atomic_set(&r10_bio->remaining, 1);
  	md_bitmap_startwrite(mddev->bitmap, r10_bio->sector, r10_bio->sectors, 0);
  
* Unmerged path drivers/md/raid10.c
diff --git a/drivers/md/raid10.h b/drivers/md/raid10.h
index e9a0efc5a831..a8ef24732c78 100644
--- a/drivers/md/raid10.h
+++ b/drivers/md/raid10.h
@@ -124,7 +124,6 @@ struct r10bio {
 	sector_t		sector;	/* virtual sector number */
 	int			sectors;
 	unsigned long		state;
-	unsigned long		start_time;
 	struct mddev		*mddev;
 	/*
 	 * original bio going to /dev/mdx
