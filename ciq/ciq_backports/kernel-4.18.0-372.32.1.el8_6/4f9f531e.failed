qed: Use dma_set_mask_and_coherent() and simplify code

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-372.32.1.el8_6
commit-author Christophe JAILLET <christophe.jaillet@wanadoo.fr>
commit 4f9f531e1505a126b4d66d8a8a29e8e54fa4075c
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-372.32.1.el8_6/4f9f531e.failed

Use dma_set_mask_and_coherent() instead of unrolling it with some
dma_set_mask()+dma_set_coherent_mask().

Moreover, as stated in [1], dma_set_mask() with a 64-bit mask will never
fail if dev->dma_mask is non-NULL.
So, if it fails, the 32 bits case will also fail for the same reason.

Simplify code and remove some dead code accordingly.

Now that qed_set_coherency_mask() is mostly a single call to
dma_set_mask_and_coherent(), fold it in its only caller.

[1]: https://lkml.org/lkml/2021/6/7/398

	Signed-off-by: Christophe JAILLET <christophe.jaillet@wanadoo.fr>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 4f9f531e1505a126b4d66d8a8a29e8e54fa4075c)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/qlogic/qed/qed_main.c
diff --cc drivers/net/ethernet/qlogic/qed/qed_main.c
index 510b52825967,c5003fa1a25e..000000000000
--- a/drivers/net/ethernet/qlogic/qed/qed_main.c
+++ b/drivers/net/ethernet/qlogic/qed/qed_main.c
@@@ -261,27 -255,6 +261,30 @@@ static void __exit qed_exit(void
  }
  module_exit(qed_exit);
  
++<<<<<<< HEAD
 +/* Check if the DMA controller on the machine can properly handle the DMA
 + * addressing required by the device.
 +*/
 +static int qed_set_coherency_mask(struct qed_dev *cdev)
 +{
 +	struct device *dev = &cdev->pdev->dev;
 +
 +	if (dma_set_mask(dev, DMA_BIT_MASK(64)) == 0) {
 +		if (dma_set_coherent_mask(dev, DMA_BIT_MASK(64)) != 0) {
 +			DP_NOTICE(cdev,
 +				  "Can't request 64-bit consistent allocations\n");
 +			return -EIO;
 +		}
 +	} else if (dma_set_mask(dev, DMA_BIT_MASK(32)) != 0) {
 +		DP_NOTICE(cdev, "Can't request 64b/32b DMA addresses\n");
 +		return -EIO;
 +	}
 +
 +	return 0;
 +}
 +
++=======
++>>>>>>> 4f9f531e1505 (qed: Use dma_set_mask_and_coherent() and simplify code)
  static void qed_free_pci(struct qed_dev *cdev)
  {
  	struct pci_dev *pdev = cdev->pdev;
* Unmerged path drivers/net/ethernet/qlogic/qed/qed_main.c
