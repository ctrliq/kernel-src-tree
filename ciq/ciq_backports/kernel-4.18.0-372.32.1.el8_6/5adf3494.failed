x86/module: Fix the paravirt vs alternative order

jira LE-1907
cve CVE-2022-23825
cve CVE-2022-29901
cve CVE-2022-29900
cve CVE-2022-23816
Rebuild_History Non-Buildable kernel-4.18.0-372.32.1.el8_6
commit-author Peter Zijlstra <peterz@infradead.org>
commit 5adf349439d29f92467e864f728dfc23180f3ef9
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-372.32.1.el8_6/5adf3494.failed

Ever since commit

  4e6292114c74 ("x86/paravirt: Add new features for paravirt patching")

there is an ordering dependency between patching paravirt ops and
patching alternatives, the module loader still violates this.

Fixes: 4e6292114c74 ("x86/paravirt: Add new features for paravirt patching")
	Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
	Signed-off-by: Borislav Petkov <bp@suse.de>
	Reviewed-by: Miroslav Benes <mbenes@suse.cz>
	Cc: <stable@vger.kernel.org>
Link: https://lore.kernel.org/r/20220303112825.068773913@infradead.org
(cherry picked from commit 5adf349439d29f92467e864f728dfc23180f3ef9)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/kernel/module.c
diff --cc arch/x86/kernel/module.c
index 6645f123419c,96d7c27b7093..000000000000
--- a/arch/x86/kernel/module.c
+++ b/arch/x86/kernel/module.c
@@@ -244,8 -269,22 +244,23 @@@ int module_finalize(const Elf_Ehdr *hdr
  			orc = s;
  		if (!strcmp(".orc_unwind_ip", secstrings + s->sh_name))
  			orc_ip = s;
 -		if (!strcmp(".retpoline_sites", secstrings + s->sh_name))
 -			retpolines = s;
  	}
  
++<<<<<<< HEAD
++=======
+ 	/*
+ 	 * See alternative_instructions() for the ordering rules between the
+ 	 * various patching types.
+ 	 */
+ 	if (para) {
+ 		void *pseg = (void *)para->sh_addr;
+ 		apply_paravirt(pseg, pseg + para->sh_size);
+ 	}
+ 	if (retpolines) {
+ 		void *rseg = (void *)retpolines->sh_addr;
+ 		apply_retpolines(rseg, rseg + retpolines->sh_size);
+ 	}
++>>>>>>> 5adf349439d2 (x86/module: Fix the paravirt vs alternative order)
  	if (alt) {
  		/* patch .altinstructions */
  		void *aseg = (void *)alt->sh_addr;
* Unmerged path arch/x86/kernel/module.c
