nvme: fix RCU hole that allowed for endless looping in multipath round robin

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-372.32.1.el8_6
commit-author Chris Leech <cleech@redhat.com>
commit d6d6742772d712ed2238f5071b96baf4924f5fad
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-372.32.1.el8_6/d6d67427.failed

Make nvme_ns_remove match the assumptions elsewhere.

1) !NVME_NS_READY needs to be srcu synchronized to make sure nothing is
   running in __nvme_find_path or nvme_round_robin_path that will
   re-assign this ns to current_path.

2) Any matching current_path entries need to be cleared before removing
   from the siblings list, to prevent calling nvme_round_robin_path with
   an "old" ns that's off list.

3) Finally the list_del_rcu can happen, and then synchronize again
   before releasing any reference counts.

	Signed-off-by: Christoph Hellwig <hch@lst.de>
(cherry picked from commit d6d6742772d712ed2238f5071b96baf4924f5fad)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/nvme/host/core.c
diff --cc drivers/nvme/host/core.c
index fbe5337a1fe5,a7d72ef01171..000000000000
--- a/drivers/nvme/host/core.c
+++ b/drivers/nvme/host/core.c
@@@ -3931,18 -4052,10 +3941,25 @@@ static void nvme_ns_remove(struct nvme_
  	/* guarantee not available in head->list */
  	synchronize_rcu();
  
++<<<<<<< HEAD
 +	/* wait for concurrent submissions */
 +	if (nvme_mpath_clear_current_path(ns))
 +		synchronize_srcu(&ns->head->srcu);
 +
 +	if (ns->disk->flags & GENHD_FL_UP) {
 +		if (!nvme_ns_head_multipath(ns->head))
 +			nvme_cdev_del(&ns->cdev, &ns->cdev_device);
 +		del_gendisk(ns->disk);
 +		blk_cleanup_queue(ns->queue);
 +		if (blk_get_integrity(ns->disk))
 +			blk_integrity_unregister(ns->disk);
 +	}
++=======
+ 	if (!nvme_ns_head_multipath(ns->head))
+ 		nvme_cdev_del(&ns->cdev, &ns->cdev_device);
+ 	del_gendisk(ns->disk);
+ 	blk_cleanup_queue(ns->queue);
++>>>>>>> d6d6742772d7 (nvme: fix RCU hole that allowed for endless looping in multipath round robin)
  
  	down_write(&ns->ctrl->namespaces_rwsem);
  	list_del_init(&ns->list);
* Unmerged path drivers/nvme/host/core.c
