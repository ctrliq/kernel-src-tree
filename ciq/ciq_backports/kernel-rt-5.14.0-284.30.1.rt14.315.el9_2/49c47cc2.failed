net: tls: fix possible race condition between do_tls_getsockopt_conf() and do_tls_setsockopt_conf()

jira LE-1907
cve CVE-2023-28466
Rebuild_History Non-Buildable kernel-rt-5.14.0-284.30.1.rt14.315.el9_2
commit-author Hangyu Hua <hbh25y@gmail.com>
commit 49c47cc21b5b7a3d8deb18fc57b0aa2ab1286962
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-rt-5.14.0-284.30.1.rt14.315.el9_2/49c47cc2.failed

ctx->crypto_send.info is not protected by lock_sock in
do_tls_getsockopt_conf(). A race condition between do_tls_getsockopt_conf()
and error paths of do_tls_setsockopt_conf() may lead to a use-after-free
or null-deref.

More discussion:  https://lore.kernel.org/all/Y/ht6gQL+u6fj3dG@hog/

Fixes: 3c4d7559159b ("tls: kernel TLS support")
	Signed-off-by: Hangyu Hua <hbh25y@gmail.com>
Link: https://lore.kernel.org/r/20230228023344.9623-1-hbh25y@gmail.com
	Signed-off-by: Jakub Kicinski <kuba@kernel.org>
(cherry picked from commit 49c47cc21b5b7a3d8deb18fc57b0aa2ab1286962)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/tls/tls_main.c
diff --cc net/tls/tls_main.c
index 08ddf9d837ae,b32c112984dd..000000000000
--- a/net/tls/tls_main.c
+++ b/net/tls/tls_main.c
@@@ -507,6 -512,50 +495,53 @@@ static int do_tls_getsockopt_conf(struc
  			rc = -EFAULT;
  		break;
  	}
++<<<<<<< HEAD
++=======
+ 	case TLS_CIPHER_ARIA_GCM_128: {
+ 		struct tls12_crypto_info_aria_gcm_128 *
+ 		  crypto_info_aria_gcm_128 =
+ 		  container_of(crypto_info,
+ 			       struct tls12_crypto_info_aria_gcm_128,
+ 			       info);
+ 
+ 		if (len != sizeof(*crypto_info_aria_gcm_128)) {
+ 			rc = -EINVAL;
+ 			goto out;
+ 		}
+ 		memcpy(crypto_info_aria_gcm_128->iv,
+ 		       cctx->iv + TLS_CIPHER_ARIA_GCM_128_SALT_SIZE,
+ 		       TLS_CIPHER_ARIA_GCM_128_IV_SIZE);
+ 		memcpy(crypto_info_aria_gcm_128->rec_seq, cctx->rec_seq,
+ 		       TLS_CIPHER_ARIA_GCM_128_REC_SEQ_SIZE);
+ 		if (copy_to_user(optval,
+ 				 crypto_info_aria_gcm_128,
+ 				 sizeof(*crypto_info_aria_gcm_128)))
+ 			rc = -EFAULT;
+ 		break;
+ 	}
+ 	case TLS_CIPHER_ARIA_GCM_256: {
+ 		struct tls12_crypto_info_aria_gcm_256 *
+ 		  crypto_info_aria_gcm_256 =
+ 		  container_of(crypto_info,
+ 			       struct tls12_crypto_info_aria_gcm_256,
+ 			       info);
+ 
+ 		if (len != sizeof(*crypto_info_aria_gcm_256)) {
+ 			rc = -EINVAL;
+ 			goto out;
+ 		}
+ 		memcpy(crypto_info_aria_gcm_256->iv,
+ 		       cctx->iv + TLS_CIPHER_ARIA_GCM_256_SALT_SIZE,
+ 		       TLS_CIPHER_ARIA_GCM_256_IV_SIZE);
+ 		memcpy(crypto_info_aria_gcm_256->rec_seq, cctx->rec_seq,
+ 		       TLS_CIPHER_ARIA_GCM_256_REC_SEQ_SIZE);
+ 		if (copy_to_user(optval,
+ 				 crypto_info_aria_gcm_256,
+ 				 sizeof(*crypto_info_aria_gcm_256)))
+ 			rc = -EFAULT;
+ 		break;
+ 	}
++>>>>>>> 49c47cc21b5b (net: tls: fix possible race condition between do_tls_getsockopt_conf() and do_tls_setsockopt_conf())
  	default:
  		rc = -EINVAL;
  	}
* Unmerged path net/tls/tls_main.c
