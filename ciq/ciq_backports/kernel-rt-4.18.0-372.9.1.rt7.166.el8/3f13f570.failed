ice: Refactor PR ethtool ops

jira LE-1907
Rebuild_History Non-Buildable kernel-rt-4.18.0-372.9.1.rt7.166.el8
commit-author Wojciech Drewek <wojciech.drewek@intel.com>
commit 3f13f570ff2c413dbdf088058a3e019db376f49d
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-rt-4.18.0-372.9.1.rt7.166.el8/3f13f570.failed

This patch improves a few things:

- it fixes issue where ethtool -i reports that PR supports
  priv-flags and tests when in fact it does not support them
- instead of using the same functions for both PF and PR ethtool ops,
  this patch introduces separate ops for both cases and internal
  functions with core logic.
- prevent accessing VF VSI while VF is not ready by calling
  ice_check_vf_ready_for_cfg
- all PR specific functions in ethtool.c were moved to one place in
  file
- instead overwriting n_priv_flags in ice_repr_get_drvinfo,
  priv-flags code was moved from __ice_get_drvinfo to ice_get_drvinfo

	Signed-off-by: Wojciech Drewek <wojciech.drewek@intel.com>
	Tested-by: Sandeep Penigalapati <sandeep.penigalapati@intel.com>
	Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
(cherry picked from commit 3f13f570ff2c413dbdf088058a3e019db376f49d)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/intel/ice/ice_ethtool.c
diff --cc drivers/net/ethernet/intel/ice/ice_ethtool.c
index ddf868828876,8b3eef6632e9..000000000000
--- a/drivers/net/ethernet/intel/ice/ice_ethtool.c
+++ b/drivers/net/ethernet/intel/ice/ice_ethtool.c
@@@ -193,9 -192,18 +193,21 @@@ ice_get_drvinfo(struct net_device *netd
  
  	strscpy(drvinfo->bus_info, pci_name(pf->pdev),
  		sizeof(drvinfo->bus_info));
+ }
+ 
++<<<<<<< HEAD
++=======
+ static void
+ ice_get_drvinfo(struct net_device *netdev, struct ethtool_drvinfo *drvinfo)
+ {
+ 	struct ice_netdev_priv *np = netdev_priv(netdev);
+ 
+ 	__ice_get_drvinfo(netdev, drvinfo, np->vsi);
+ 
  	drvinfo->n_priv_flags = ICE_PRIV_FLAG_ARRAY_SIZE;
  }
  
++>>>>>>> 3f13f570ff2c (ice: Refactor PR ethtool ops)
  static int ice_get_regs_len(struct net_device __always_unused *netdev)
  {
  	return sizeof(ice_regs_dump_list);
@@@ -867,12 -875,12 +879,17 @@@ skip_ol_tests
  	netdev_info(netdev, "testing finished\n");
  }
  
- static void ice_get_strings(struct net_device *netdev, u32 stringset, u8 *data)
+ static void
+ __ice_get_strings(struct net_device *netdev, u32 stringset, u8 *data,
+ 		  struct ice_vsi *vsi)
  {
++<<<<<<< HEAD
 +	struct ice_netdev_priv *np = netdev_priv(netdev);
 +	struct ice_vsi *vsi = np->vsi;
 +	char *p = (char *)data;
++=======
++>>>>>>> 3f13f570ff2c (ice: Refactor PR ethtool ops)
  	unsigned int i;
 -	u8 *p = data;
  
  	switch (stringset) {
  	case ETH_SS_STATS:
@@@ -1341,11 -1338,10 +1365,15 @@@ static int ice_get_sset_count(struct ne
  }
  
  static void
- ice_get_ethtool_stats(struct net_device *netdev,
- 		      struct ethtool_stats __always_unused *stats, u64 *data)
+ __ice_get_ethtool_stats(struct net_device *netdev,
+ 			struct ethtool_stats __always_unused *stats, u64 *data,
+ 			struct ice_vsi *vsi)
  {
++<<<<<<< HEAD
 +	struct ice_netdev_priv *np = netdev_priv(netdev);
 +	struct ice_vsi *vsi = np->vsi;
++=======
++>>>>>>> 3f13f570ff2c (ice: Refactor PR ethtool ops)
  	struct ice_pf *pf = vsi->back;
  	struct ice_tx_ring *tx_ring;
  	struct ice_rx_ring *rx_ring;
@@@ -4083,6 -4139,23 +4168,26 @@@ void ice_set_ethtool_safe_mode_ops(stru
  	netdev->ethtool_ops = &ice_ethtool_safe_mode_ops;
  }
  
++<<<<<<< HEAD
++=======
+ static const struct ethtool_ops ice_ethtool_repr_ops = {
+ 	.get_drvinfo		= ice_repr_get_drvinfo,
+ 	.get_link		= ethtool_op_get_link,
+ 	.get_strings		= ice_repr_get_strings,
+ 	.get_ethtool_stats      = ice_repr_get_ethtool_stats,
+ 	.get_sset_count		= ice_repr_get_sset_count,
+ };
+ 
+ /**
+  * ice_set_ethtool_repr_ops - setup VF's port representor ethtool ops
+  * @netdev: network interface device structure
+  */
+ void ice_set_ethtool_repr_ops(struct net_device *netdev)
+ {
+ 	netdev->ethtool_ops = &ice_ethtool_repr_ops;
+ }
+ 
++>>>>>>> 3f13f570ff2c (ice: Refactor PR ethtool ops)
  /**
   * ice_set_ethtool_ops - setup netdev ethtool ops
   * @netdev: network interface device structure
* Unmerged path drivers/net/ethernet/intel/ice/ice_ethtool.c
