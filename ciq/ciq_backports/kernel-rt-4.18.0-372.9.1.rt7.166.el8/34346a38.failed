ASoC: SOF: debug: Add SOF_DBG_DUMP_OPTIONAL flag for DSP dumping

jira LE-1907
Rebuild_History Non-Buildable kernel-rt-4.18.0-372.9.1.rt7.166.el8
commit-author Peter Ujfalusi <peter.ujfalusi@linux.intel.com>
commit 34346a383de96e9fcecb1906d711fc1b09d9b90a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-rt-4.18.0-372.9.1.rt7.166.el8/34346a38.failed

The new SOF_DBG_DUMP_OPTIONAL flag can be used to mark a DSP dump that
should only be printed when the SOF_DBG_PRINT_ALL_DUMPS sof_core_debug
flag is set, otherwise it should be ignored and not printed.

	Signed-off-by: Peter Ujfalusi <peter.ujfalusi@linux.intel.com>
	Reviewed-by: Ranjani Sridharan <ranjani.sridharan@linux.intel.com>
	Reviewed-by: Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
Link: https://lore.kernel.org/r/20211006110645.26679-9-peter.ujfalusi@linux.intel.com
	Signed-off-by: Mark Brown <broonie@kernel.org>
(cherry picked from commit 34346a383de96e9fcecb1906d711fc1b09d9b90a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	sound/soc/sof/debug.c
diff --cc sound/soc/sof/debug.c
index 00041313bde2,bcd381f495c0..000000000000
--- a/sound/soc/sof/debug.c
+++ b/sound/soc/sof/debug.c
@@@ -833,6 -822,34 +833,37 @@@ void snd_sof_free_debug(struct snd_sof_
  }
  EXPORT_SYMBOL_GPL(snd_sof_free_debug);
  
++<<<<<<< HEAD
++=======
+ void snd_sof_dsp_dbg_dump(struct snd_sof_dev *sdev, u32 flags)
+ {
+ 	bool print_all = !!(sof_core_debug & SOF_DBG_PRINT_ALL_DUMPS);
+ 
+ 	if (flags & SOF_DBG_DUMP_OPTIONAL && !print_all)
+ 		return;
+ 
+ 	if (sof_ops(sdev)->dbg_dump && !sdev->dbg_dump_printed) {
+ 		dev_err(sdev->dev, "------------[ DSP dump start ]------------\n");
+ 		sof_ops(sdev)->dbg_dump(sdev, flags);
+ 		dev_err(sdev->dev, "------------[ DSP dump end ]------------\n");
+ 		if (!print_all)
+ 			sdev->dbg_dump_printed = true;
+ 	}
+ }
+ EXPORT_SYMBOL(snd_sof_dsp_dbg_dump);
+ 
+ static void snd_sof_ipc_dump(struct snd_sof_dev *sdev)
+ {
+ 	if (sof_ops(sdev)->ipc_dump  && !sdev->ipc_dump_printed) {
+ 		dev_err(sdev->dev, "------------[ IPC dump start ]------------\n");
+ 		sof_ops(sdev)->ipc_dump(sdev);
+ 		dev_err(sdev->dev, "------------[ IPC dump end ]------------\n");
+ 		if (!(sof_core_debug & SOF_DBG_PRINT_ALL_DUMPS))
+ 			sdev->ipc_dump_printed = true;
+ 	}
+ }
+ 
++>>>>>>> 34346a383de9 (ASoC: SOF: debug: Add SOF_DBG_DUMP_OPTIONAL flag for DSP dumping)
  void snd_sof_handle_fw_exception(struct snd_sof_dev *sdev)
  {
  	if (IS_ENABLED(CONFIG_SND_SOC_SOF_DEBUG_RETAIN_DSP_CONTEXT) ||
* Unmerged path sound/soc/sof/debug.c
diff --git a/sound/soc/sof/sof-priv.h b/sound/soc/sof/sof-priv.h
index 94632a45d6b0..bf9e62863c55 100644
--- a/sound/soc/sof/sof-priv.h
+++ b/sound/soc/sof/sof-priv.h
@@ -29,7 +29,7 @@
 #define SOF_DBG_DUMP_TEXT		BIT(2)
 #define SOF_DBG_DUMP_PCI		BIT(3)
 #define SOF_DBG_DUMP_FORCE_ERR_LEVEL	BIT(4) /* used to dump dsp status with error log level */
-
+#define SOF_DBG_DUMP_OPTIONAL		BIT(5) /* only dump if SOF_DBG_PRINT_ALL_DUMPS is set */
 
 /* global debug state set by SOF_DBG_ flags */
 extern int sof_core_debug;
