xhci: use pm_ptr() instead of #ifdef for CONFIG_PM conditionals

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-526.el8
commit-author Arnd Bergmann <arnd@arndb.de>
commit 130eac4170859fb368681e00d390f20f44bbf27b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-526.el8/130eac41.failed

A recent patch caused an unused-function warning in builds with
CONFIG_PM disabled, after the function became marked 'static':

drivers/usb/host/xhci-pci.c:91:13: error: 'xhci_msix_sync_irqs' defined but not used [-Werror=unused-function]
   91 | static void xhci_msix_sync_irqs(struct xhci_hcd *xhci)
      |             ^~~~~~~~~~~~~~~~~~~

This could be solved by adding another #ifdef, but as there is
a trend towards removing CONFIG_PM checks in favor of helper
macros, do the same conversion here and use pm_ptr() to get
either a function pointer or NULL but avoid the warning.

As the hidden functions reference some other symbols, make
sure those are visible at compile time, at the minimal cost of
a few extra bytes for 'struct usb_device'.

Fixes: 9abe15d55dcc ("xhci: Move xhci MSI sync function to to xhci-pci")
	Signed-off-by: Arnd Bergmann <arnd@arndb.de>
Link: https://lore.kernel.org/r/20230328131114.1296430-1-arnd@kernel.org
	Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
(cherry picked from commit 130eac4170859fb368681e00d390f20f44bbf27b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/usb/host/xhci-pci.c
diff --cc drivers/usb/host/xhci-pci.c
index efa5776a3849,bbbb01282038..000000000000
--- a/drivers/usb/host/xhci-pci.c
+++ b/drivers/usb/host/xhci-pci.c
@@@ -970,11 -967,10 +968,17 @@@ static struct pci_driver xhci_pci_drive
  	/* suspend and resume implemented later */
  
  	.shutdown = 	usb_hcd_pci_shutdown,
++<<<<<<< HEAD
 +#ifdef CONFIG_PM
 +	.driver = {
 +		.pm = &usb_hcd_pci_pm_ops
++=======
+ 	.driver = {
+ 		.pm = pm_ptr(&usb_hcd_pci_pm_ops),
+ 		.probe_type = PROBE_PREFER_ASYNCHRONOUS,
++>>>>>>> 130eac417085 (xhci: use pm_ptr() instead of #ifdef for CONFIG_PM conditionals)
  	},
 +#endif
  };
  
  static int __init xhci_pci_init(void)
* Unmerged path drivers/usb/host/xhci-pci.c
diff --git a/include/linux/usb.h b/include/linux/usb.h
index d7580b040d7e..5e9d4311a7d9 100644
--- a/include/linux/usb.h
+++ b/include/linux/usb.h
@@ -704,13 +704,12 @@ struct usb_device {
 
 	unsigned long active_duration;
 
-#ifdef CONFIG_PM
 	unsigned long connect_time;
 
 	unsigned do_remote_wakeup:1;
 	unsigned reset_resume:1;
 	unsigned port_is_suspended:1;
-#endif
+
 	struct wusb_dev *wusb_dev;
 	int slot_id;
 	struct usb2_lpm_parameters l1_params;
diff --git a/include/linux/usb/hcd.h b/include/linux/usb/hcd.h
index d27e4ef59546..74e901430753 100644
--- a/include/linux/usb/hcd.h
+++ b/include/linux/usb/hcd.h
@@ -502,9 +502,7 @@ extern void usb_hcd_pci_shutdown(struct pci_dev *dev);
 
 extern int usb_hcd_amd_remote_wakeup_quirk(struct pci_dev *dev);
 
-#ifdef CONFIG_PM
 extern const struct dev_pm_ops usb_hcd_pci_pm_ops;
-#endif
 #endif /* CONFIG_USB_PCI */
 
 /* pci-ish (pdev null is ok) buffer alloc/mapping support */
