net/sched: act_ct: additional checks for outdated flows

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-526.el8
commit-author Vlad Buslov <vladbu@nvidia.com>
commit a63b6622120cd03a304796dbccb80655b3a21798
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-526.el8/a63b6622.failed

Current nf_flow_is_outdated() implementation considers any flow table flow
which state diverged from its underlying CT connection status for teardown
which can be problematic in the following cases:

- Flow has never been offloaded to hardware in the first place either
because flow table has hardware offload disabled (flag
NF_FLOWTABLE_HW_OFFLOAD is not set) or because it is still pending on 'add'
workqueue to be offloaded for the first time. The former is incorrect, the
later generates excessive deletions and additions of flows.

- Flow is already pending to be updated on the workqueue. Tearing down such
flows will also generate excessive removals from the flow table, especially
on highly loaded system where the latency to re-offload a flow via 'add'
workqueue can be quite high.

When considering a flow for teardown as outdated verify that it is both
offloaded to hardware and doesn't have any pending updates.

Fixes: 41f2c7c342d3 ("net/sched: act_ct: Fix promotion of offloaded unreplied tuple")
	Reviewed-by: Paul Blakey <paulb@nvidia.com>
	Signed-off-by: Vlad Buslov <vladbu@nvidia.com>
	Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
(cherry picked from commit a63b6622120cd03a304796dbccb80655b3a21798)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sched/act_ct.c
diff --cc net/sched/act_ct.c
index adb56fcdd4bd,fb52d6f9aff9..000000000000
--- a/net/sched/act_ct.c
+++ b/net/sched/act_ct.c
@@@ -277,7 -278,16 +277,18 @@@ err_nat
  	return err;
  }
  
++<<<<<<< HEAD
++=======
+ static bool tcf_ct_flow_is_outdated(const struct flow_offload *flow)
+ {
+ 	return test_bit(IPS_SEEN_REPLY_BIT, &flow->ct->status) &&
+ 	       test_bit(IPS_HW_OFFLOAD_BIT, &flow->ct->status) &&
+ 	       !test_bit(NF_FLOW_HW_PENDING, &flow->flags) &&
+ 	       !test_bit(NF_FLOW_HW_ESTABLISHED, &flow->flags);
+ }
+ 
++>>>>>>> a63b6622120c (net/sched: act_ct: additional checks for outdated flows)
  static struct nf_flowtable_type flowtable_ct = {
 -	.gc		= tcf_ct_flow_is_outdated,
  	.action		= tcf_ct_flow_table_fill_actions,
  	.owner		= THIS_MODULE,
  };
* Unmerged path net/sched/act_ct.c
