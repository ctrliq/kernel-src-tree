net: phy: broadcom: Set proper 1000BaseX/SGMII interface mode for BCM54616S

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-383.el8
commit-author Robert Hancock <robert.hancock@calian.com>
commit 3afd0218992a8d1398e9791d6c2edd4c948ae7ee
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-383.el8/3afd0218.failed

The default configuration for the BCM54616S PHY may not match the desired
mode when using 1000BaseX or SGMII interface modes, such as when it is on
an SFP module. Add code to explicitly set the correct mode using
programming sequences provided by Bel-Fuse:

https://www.belfuse.com/resources/datasheets/powersolutions/ds-bps-sfp-1gbt-05-series.pdf
https://www.belfuse.com/resources/datasheets/powersolutions/ds-bps-sfp-1gbt-06-series.pdf

	Signed-off-by: Robert Hancock <robert.hancock@calian.com>
	Acked-by: Florian Fainelli <f.fainelli@gmail.com>
	Signed-off-by: David S. Miller <davem@davemloft.net>
(cherry picked from commit 3afd0218992a8d1398e9791d6c2edd4c948ae7ee)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/phy/broadcom.c
diff --cc drivers/net/phy/broadcom.c
index 9f8036cf3c20,8e7fc3368380..000000000000
--- a/drivers/net/phy/broadcom.c
+++ b/drivers/net/phy/broadcom.c
@@@ -383,9 -444,20 +444,14 @@@ static int bcm5481_config_aneg(struct p
  	return ret;
  }
  
 -struct bcm54616s_phy_priv {
 -	bool mode_1000bx_en;
 -};
 -
  static int bcm54616s_probe(struct phy_device *phydev)
  {
++<<<<<<< HEAD
 +	int val, intf_sel;
++=======
+ 	struct bcm54616s_phy_priv *priv;
+ 	int val;
 -
 -	priv = devm_kzalloc(&phydev->mdio.dev, sizeof(*priv), GFP_KERNEL);
 -	if (!priv)
 -		return -ENOMEM;
 -
 -	phydev->priv = priv;
++>>>>>>> 3afd0218992a (net: phy: broadcom: Set proper 1000BaseX/SGMII interface mode for BCM54616S)
  
  	val = bcm_phy_read_shadow(phydev, BCM54XX_SHD_MODE);
  	if (val < 0)
* Unmerged path drivers/net/phy/broadcom.c
diff --git a/include/linux/brcmphy.h b/include/linux/brcmphy.h
index d85ad2acff6f..de53a8508853 100644
--- a/include/linux/brcmphy.h
+++ b/include/linux/brcmphy.h
@@ -132,6 +132,7 @@
 
 #define MII_BCM54XX_AUXCTL_SHDWSEL_MISC			0x07
 #define MII_BCM54XX_AUXCTL_SHDWSEL_MISC_WIRESPEED_EN	0x0010
+#define MII_BCM54XX_AUXCTL_SHDWSEL_MISC_RGMII_EN	0x0080
 #define MII_BCM54XX_AUXCTL_SHDWSEL_MISC_RGMII_SKEW_EN	0x0100
 #define MII_BCM54XX_AUXCTL_MISC_FORCE_AMDIX		0x0200
 #define MII_BCM54XX_AUXCTL_MISC_WREN			0x8000
@@ -219,6 +220,9 @@
 /* 11111: Mode Control Register */
 #define BCM54XX_SHD_MODE		0x1f
 #define BCM54XX_SHD_INTF_SEL_MASK	GENMASK(2, 1)	/* INTERF_SEL[1:0] */
+#define BCM54XX_SHD_INTF_SEL_RGMII	0x02
+#define BCM54XX_SHD_INTF_SEL_SGMII	0x04
+#define BCM54XX_SHD_INTF_SEL_GBIC	0x06
 #define BCM54XX_SHD_MODE_1000BX		BIT(0)	/* Enable 1000-X registers */
 
 /*
