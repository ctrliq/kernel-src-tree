kasan: test: avoid writing invalid memory

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-383.el8
commit-author Andrey Konovalov <andreyknvl@gmail.com>
commit 8fbad19bdcb4b9be8131536e5bb9616ab2e4eeb3
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-383.el8/8fbad19b.failed

Multiple KASAN tests do writes past the allocated objects or writes to
freed memory.  Turn these writes into reads to avoid corrupting memory.
Otherwise, these tests might lead to crashes with the HW_TAGS mode, as it
neither uses quarantine nor redzones.

Link: https://lkml.kernel.org/r/c3cd2a383e757e27dd9131635fc7d09a48a49cf9.1628779805.git.andreyknvl@gmail.com
	Signed-off-by: Andrey Konovalov <andreyknvl@gmail.com>
	Reviewed-by: Marco Elver <elver@google.com>
	Cc: Alexander Potapenko <glider@google.com>
	Cc: Andrey Ryabinin <aryabinin@virtuozzo.com>
	Cc: Dmitry Vyukov <dvyukov@google.com>
	Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
	Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
(cherry picked from commit 8fbad19bdcb4b9be8131536e5bb9616ab2e4eeb3)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	lib/test_kasan.c
diff --cc lib/test_kasan.c
index 4d6c9e02bdb0,c82a82eb5393..000000000000
--- a/lib/test_kasan.c
+++ b/lib/test_kasan.c
@@@ -520,7 -544,16 +520,20 @@@ static void kmalloc_uaf2(struct kunit *
  	ptr2 = kmalloc(size, GFP_KERNEL);
  	KUNIT_ASSERT_NOT_ERR_OR_NULL(test, ptr2);
  
++<<<<<<< HEAD
 +	KUNIT_EXPECT_KASAN_FAIL(test, ptr1[40] = 'x');
++=======
+ 	/*
+ 	 * For tag-based KASAN ptr1 and ptr2 tags might happen to be the same.
+ 	 * Allow up to 16 attempts at generating different tags.
+ 	 */
+ 	if (!IS_ENABLED(CONFIG_KASAN_GENERIC) && ptr1 == ptr2 && counter++ < 16) {
+ 		kfree(ptr2);
+ 		goto again;
+ 	}
+ 
+ 	KUNIT_EXPECT_KASAN_FAIL(test, ((volatile char *)ptr1)[40]);
++>>>>>>> 8fbad19bdcb4 (kasan: test: avoid writing invalid memory)
  	KUNIT_EXPECT_PTR_NE(test, ptr1, ptr2);
  
  	kfree(ptr2);
* Unmerged path lib/test_kasan.c
