drm/amdgpu: Use correct VIEWPORT_DIMENSION for DCN2

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-383.el8
commit-author Harry Wentland <harry.wentland@amd.com>
commit dc5d4aff2e99c312df8abbe1ee9a731d2913bc1b
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-383.el8/dc5d4aff.failed

For some reason this file isn't using the appropriate register
headers for DCN headers, which means that on DCN2 we're getting
the VIEWPORT_DIMENSION offset wrong.

This means that we're not correctly carving out the framebuffer
memory correctly for a framebuffer allocated by EFI and
therefore see corruption when loading amdgpu before the display
driver takes over control of the framebuffer scanout.

Fix this by checking the DCE_HWIP and picking the correct offset
accordingly.

Long-term we should expose this info from DC as GMC shouldn't
need to know about DCN registers.

	Cc: stable@vger.kernel.org
	Signed-off-by: Harry Wentland <harry.wentland@amd.com>
	Reviewed-by: Huang Rui <ray.huang@amd.com>
	Acked-by: Christian KÃ¶nig <christian.koenig@amd.com>
	Reviewed-by: Alex Deucher <alexander.deucher@amd.com>
	Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
(cherry picked from commit dc5d4aff2e99c312df8abbe1ee9a731d2913bc1b)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/amd/amdgpu/gmc_v9_0.c
diff --cc drivers/gpu/drm/amd/amdgpu/gmc_v9_0.c
index 5d8510b8c725,88c1eb9ad068..000000000000
--- a/drivers/gpu/drm/amd/amdgpu/gmc_v9_0.c
+++ b/drivers/gpu/drm/amd/amdgpu/gmc_v9_0.c
@@@ -1105,9 -1144,9 +1110,15 @@@ static unsigned gmc_v9_0_get_vbios_fb_s
  	} else {
  		u32 viewport;
  
++<<<<<<< HEAD
 +		switch (adev->asic_type) {
 +		case CHIP_RAVEN:
 +		case CHIP_RENOIR:
++=======
+ 		switch (adev->ip_versions[DCE_HWIP][0]) {
+ 		case IP_VERSION(1, 0, 0):
+ 		case IP_VERSION(1, 0, 1):
++>>>>>>> dc5d4aff2e99 (drm/amdgpu: Use correct VIEWPORT_DIMENSION for DCN2)
  			viewport = RREG32_SOC15(DCE, 0, mmHUBP0_DCSURF_PRI_VIEWPORT_DIMENSION);
  			size = (REG_GET_FIELD(viewport,
  					      HUBP0_DCSURF_PRI_VIEWPORT_DIMENSION, PRI_VIEWPORT_HEIGHT) *
@@@ -1115,9 -1154,14 +1126,20 @@@
  					      HUBP0_DCSURF_PRI_VIEWPORT_DIMENSION, PRI_VIEWPORT_WIDTH) *
  				4);
  			break;
++<<<<<<< HEAD
 +		case CHIP_VEGA10:
 +		case CHIP_VEGA12:
 +		case CHIP_VEGA20:
++=======
+ 		case IP_VERSION(2, 1, 0):
+ 			viewport = RREG32_SOC15(DCE, 0, mmHUBP0_DCSURF_PRI_VIEWPORT_DIMENSION_DCN2);
+ 			size = (REG_GET_FIELD(viewport,
+ 					      HUBP0_DCSURF_PRI_VIEWPORT_DIMENSION, PRI_VIEWPORT_HEIGHT) *
+ 				REG_GET_FIELD(viewport,
+ 					      HUBP0_DCSURF_PRI_VIEWPORT_DIMENSION, PRI_VIEWPORT_WIDTH) *
+ 				4);
+ 			break;
++>>>>>>> dc5d4aff2e99 (drm/amdgpu: Use correct VIEWPORT_DIMENSION for DCN2)
  		default:
  			viewport = RREG32_SOC15(DCE, 0, mmSCL0_VIEWPORT_SIZE);
  			size = (REG_GET_FIELD(viewport, SCL0_VIEWPORT_SIZE, VIEWPORT_HEIGHT) *
* Unmerged path drivers/gpu/drm/amd/amdgpu/gmc_v9_0.c
