iommu/amd: Fix I/O page table memory leak

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-383.el8
commit-author Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
commit 6b0b2d9a6a308bcd9300c2d83000a82812c56cea
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-383.el8/6b0b2d9a.failed

The current logic updates the I/O page table mode for the domain
before calling the logic to free memory used for the page table.
This results in IOMMU page table memory leak, and can be observed
when launching VM w/ pass-through devices.

Fix by freeing the memory used for page table before updating the mode.

	Cc: Joerg Roedel <joro@8bytes.org>
	Reported-by: Daniel Jordan <daniel.m.jordan@oracle.com>
	Tested-by: Daniel Jordan <daniel.m.jordan@oracle.com>
	Signed-off-by: Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
Fixes: e42ba0633064 ("iommu/amd: Restructure code for freeing page table")
Link: https://lore.kernel.org/all/20220118194720.urjgi73b7c3tq2o6@oracle.com/
Link: https://lore.kernel.org/r/20220210154745.11524-1-suravee.suthikulpanit@amd.com
	Signed-off-by: Joerg Roedel <jroedel@suse.de>
(cherry picked from commit 6b0b2d9a6a308bcd9300c2d83000a82812c56cea)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/iommu/amd/io_pgtable.c
diff --cc drivers/iommu/amd/io_pgtable.c
index 182c93a43efd,6608d1717574..000000000000
--- a/drivers/iommu/amd/io_pgtable.c
+++ b/drivers/iommu/amd/io_pgtable.c
@@@ -529,10 -496,15 +523,20 @@@ static void v1_free_pgtable(struct io_p
  	BUG_ON(pgtable->mode < PAGE_MODE_NONE ||
  	       pgtable->mode > PAGE_MODE_6_LEVEL);
  
 -	free_sub_pt(pgtable->root, pgtable->mode, &freelist);
 +	root = (unsigned long)pgtable->root;
 +	freelist = free_sub_pt(root, pgtable->mode, freelist);
  
++<<<<<<< HEAD
 +	free_page_list(freelist);
++=======
+ 	/* Update data structure */
+ 	amd_iommu_domain_clr_pt_root(dom);
+ 
+ 	/* Make changes visible to IOMMUs */
+ 	amd_iommu_domain_update(dom);
+ 
+ 	put_pages_list(&freelist);
++>>>>>>> 6b0b2d9a6a30 (iommu/amd: Fix I/O page table memory leak)
  }
  
  static struct io_pgtable *v1_alloc_pgtable(struct io_pgtable_cfg *cfg, void *cookie)
* Unmerged path drivers/iommu/amd/io_pgtable.c
