x86/boot: Remove the 'bugger off' message

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-547.el8
commit-author Ard Biesheuvel <ardb@kernel.org>
commit 768171d7ebbce005210e1cf8456f043304805c15
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-547.el8/768171d7.failed

Ancient (pre-2003) x86 kernels could boot from a floppy disk straight from
the BIOS, using a small real mode boot stub at the start of the image
where the BIOS would expect the boot record (or boot block) to appear.

Due to its limitations (kernel size < 1 MiB, no support for IDE, USB or
El Torito floppy emulation), this support was dropped, and a Linux aware
bootloader is now always required to boot the kernel from a legacy BIOS.

To smoothen this transition, the boot stub was not removed entirely, but
replaced with one that just prints an error message telling the user to
install a bootloader.

As it is unlikely that anyone doing direct floppy boot with such an
ancient kernel is going to upgrade to v6.5+ and expect that this boot
method still works, printing this message is kind of pointless, and so
it should be possible to remove the logic that emits it.

Let's free up this space so it can be used to expand the PE header in a
subsequent patch.

	Signed-off-by: Ard Biesheuvel <ardb@kernel.org>
	Signed-off-by: Ingo Molnar <mingo@kernel.org>
	Acked-by: H. Peter Anvin (Intel) <hpa@zytor.com>
Link: https://lore.kernel.org/r/20230912090051.4014114-21-ardb@google.com
(cherry picked from commit 768171d7ebbce005210e1cf8456f043304805c15)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/boot/header.S
diff --cc arch/x86/boot/header.S
index 4df6cba47914,b24fa50a9898..000000000000
--- a/arch/x86/boot/header.S
+++ b/arch/x86/boot/header.S
@@@ -38,67 -38,17 +38,59 @@@ SYSSEG		= 0x1000		/* historical load ad
  
  	.code16
  	.section ".bstext", "ax"
- 
- 	.global bootsect_start
- bootsect_start:
  #ifdef CONFIG_EFI_STUB
  	# "MZ", MS-DOS header
++<<<<<<< HEAD
 +	.byte 0x4d
 +	.byte 0x5a
 +#endif
 +
 +	# Normalize the start address
 +	ljmp	$BOOTSEG, $start2
 +
 +start2:
 +	movw	%cs, %ax
 +	movw	%ax, %ds
 +	movw	%ax, %es
 +	movw	%ax, %ss
 +	xorw	%sp, %sp
 +	sti
 +	cld
 +
 +	movw	$bugger_off_msg, %si
 +
 +msg_loop:
 +	lodsb
 +	andb	%al, %al
 +	jz	bs_die
 +	movb	$0xe, %ah
 +	movw	$7, %bx
 +	int	$0x10
 +	jmp	msg_loop
 +
 +bs_die:
 +	# Allow the user to press a key, then reboot
 +	xorw	%ax, %ax
 +	int	$0x16
 +	int	$0x19
 +
 +	# int 0x19 should never return.  In case it does anyway,
 +	# invoke the BIOS reset code...
 +	ljmp	$0xf000,$0xfff0
 +
 +#ifdef CONFIG_EFI_STUB
 +	.org	0x3c
++=======
+ 	.word	MZ_MAGIC
+ 	.org	0x38
++>>>>>>> 768171d7ebbc (x86/boot: Remove the 'bugger off' message)
  	#
  	# Offset to the PE header.
  	#
 -	.long	LINUX_PE_MAGIC
  	.long	pe_header
- #endif /* CONFIG_EFI_STUB */
- 
- 	.section ".bsdata", "a"
- bugger_off_msg:
- 	.ascii	"Use a boot loader.\r\n"
- 	.ascii	"\n"
- 	.ascii	"Remove disk and press any key to reboot...\r\n"
- 	.byte	0
- 
- #ifdef CONFIG_EFI_STUB
  pe_header:
 -	.long	PE_MAGIC
 +	.ascii	"PE"
 +	.word 	0
  
  coff_header:
  #ifdef CONFIG_X86_32
* Unmerged path arch/x86/boot/header.S
diff --git a/arch/x86/boot/setup.ld b/arch/x86/boot/setup.ld
index 96a6c7563538..8c6c862fd385 100644
--- a/arch/x86/boot/setup.ld
+++ b/arch/x86/boot/setup.ld
@@ -10,10 +10,11 @@ ENTRY(_start)
 SECTIONS
 {
 	. = 0;
-	.bstext		: { *(.bstext) }
-	.bsdata		: { *(.bsdata) }
+	.bstext	: {
+		*(.bstext)
+		. = 495;
+	} =0xffffffff
 
-	. = 495;
 	.header		: { *(.header) }
 	.entrytext	: { *(.entrytext) }
 	.inittext	: { *(.inittext) }
