sunrpc: fix client side handling of tls alerts

jira KERNEL-216
cve CVE-2025-38571
Rebuild_History Non-Buildable kernel-5.14.0-611.9.1.el9_7
commit-author Olga Kornievskaia <okorniev@redhat.com>
commit cc5d59081fa26506d02de2127ab822f40d88bc5a
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-5.14.0-611.9.1.el9_7/cc5d5908.failed

A security exploit was discovered in NFS over TLS in tls_alert_recv
due to its assumption that there is valid data in the msghdr's
iterator's kvec.

Instead, this patch proposes the rework how control messages are
setup and used by sock_recvmsg().

If no control message structure is setup, kTLS layer will read and
process TLS data record types. As soon as it encounters a TLS control
message, it would return an error. At that point, NFS can setup a kvec
backed control buffer and read in the control message such as a TLS
alert. Scott found that a msg iterator can advance the kvec pointer
as a part of the copy process thus we need to revert the iterator
before calling into the tls_alert_recv.

Fixes: dea034b963c8 ("SUNRPC: Capture CMSG metadata on client-side receive")
	Suggested-by: Trond Myklebust <trondmy@hammerspace.com>
	Suggested-by: Scott Mayhew <smayhew@redhat.com>
	Signed-off-by: Olga Kornievskaia <okorniev@redhat.com>
Link: https://lore.kernel.org/r/20250731180058.4669-3-okorniev@redhat.com
	Signed-off-by: Trond Myklebust <trond.myklebust@hammerspace.com>
(cherry picked from commit cc5d59081fa26506d02de2127ab822f40d88bc5a)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sunrpc/xprtsock.c
diff --cc net/sunrpc/xprtsock.c
index 59748783df21,c5f7bbf5775f..000000000000
--- a/net/sunrpc/xprtsock.c
+++ b/net/sunrpc/xprtsock.c
@@@ -434,8 -453,8 +454,13 @@@ static ssize_
  xs_read_discard(struct socket *sock, struct msghdr *msg, int flags,
  		size_t count)
  {
++<<<<<<< HEAD
 +	iov_iter_discard(&msg->msg_iter, READ, count);
 +	return xs_sock_recv_cmsg(sock, msg, flags);
++=======
+ 	iov_iter_discard(&msg->msg_iter, ITER_DEST, count);
+ 	return xs_sock_recvmsg(sock, msg, flags, 0);
++>>>>>>> cc5d59081fa2 (sunrpc: fix client side handling of tls alerts)
  }
  
  #if ARCH_IMPLEMENTS_FLUSH_DCACHE_PAGE
* Unmerged path net/sunrpc/xprtsock.c
