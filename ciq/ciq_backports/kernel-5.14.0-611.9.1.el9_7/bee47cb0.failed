sunrpc: fix handling of server side tls alerts

jira KERNEL-216
cve CVE-2025-38566
Rebuild_History Non-Buildable kernel-5.14.0-611.9.1.el9_7
commit-author Olga Kornievskaia <okorniev@redhat.com>
commit bee47cb026e762841f3faece47b51f985e215edb
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-5.14.0-611.9.1.el9_7/bee47cb0.failed

Scott Mayhew discovered a security exploit in NFS over TLS in
tls_alert_recv() due to its assumption it can read data from
the msg iterator's kvec..

kTLS implementation splits TLS non-data record payload between
the control message buffer (which includes the type such as TLS
aler or TLS cipher change) and the rest of the payload (say TLS
alert's level/description) which goes into the msg payload buffer.

This patch proposes to rework how control messages are setup and
used by sock_recvmsg().

If no control message structure is setup, kTLS layer will read and
process TLS data record types. As soon as it encounters a TLS control
message, it would return an error. At that point, NFS can setup a
kvec backed msg buffer and read in the control message such as a
TLS alert. Msg iterator can advance the kvec pointer as a part of
the copy process thus we need to revert the iterator before calling
into the tls_alert_recv.

	Reported-by: Scott Mayhew <smayhew@redhat.com>
Fixes: 5e052dda121e ("SUNRPC: Recognize control messages in server-side TCP socket code")
	Suggested-by: Trond Myklebust <trondmy@hammerspace.com>
	Cc: stable@vger.kernel.org
	Signed-off-by: Olga Kornievskaia <okorniev@redhat.com>
	Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
(cherry picked from commit bee47cb026e762841f3faece47b51f985e215edb)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	net/sunrpc/svcsock.c
diff --cc net/sunrpc/svcsock.c
index 4619340cd6e5,e2c5e0e626f9..000000000000
--- a/net/sunrpc/svcsock.c
+++ b/net/sunrpc/svcsock.c
@@@ -1017,8 -1044,8 +1044,13 @@@ static ssize_t svc_tcp_read_marker(stru
  		want = sizeof(rpc_fraghdr) - svsk->sk_tcplen;
  		iov.iov_base = ((char *)&svsk->sk_marker) + svsk->sk_tcplen;
  		iov.iov_len  = want;
++<<<<<<< HEAD
 +		iov_iter_kvec(&msg.msg_iter, READ, &iov, 1, want);
 +		len = svc_tcp_sock_recv_cmsg(svsk, &msg);
++=======
+ 		iov_iter_kvec(&msg.msg_iter, ITER_DEST, &iov, 1, want);
+ 		len = svc_tcp_sock_recvmsg(svsk, &msg);
++>>>>>>> bee47cb026e7 (sunrpc: fix handling of server side tls alerts)
  		if (len < 0)
  			return len;
  		svsk->sk_tcplen += len;
* Unmerged path net/sunrpc/svcsock.c
