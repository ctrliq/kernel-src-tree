ibmvnic: Add stat for tx direct vs tx batched

jira KERNEL-216
Rebuild_History Non-Buildable kernel-5.14.0-611.9.1.el9_7
commit-author Nick Child <nnac123@linux.ibm.com>
commit 2ee73c54a615b74d2e7ee6f20844fd3ba63fc485
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-5.14.0-611.9.1.el9_7/2ee73c54.failed

Allow tracking of packets sent with send_subcrq direct vs
indirect. `ethtool -S <dev>` will now provide a counter
of the number of uses of each xmit method. This metric will
be useful in performance debugging.

	Signed-off-by: Nick Child <nnac123@linux.ibm.com>
	Reviewed-by: Simon Horman <horms@kernel.org>
Link: https://patch.msgid.link/20241001163531.1803152-1-nnac123@linux.ibm.com
	Signed-off-by: Jakub Kicinski <kuba@kernel.org>
(cherry picked from commit 2ee73c54a615b74d2e7ee6f20844fd3ba63fc485)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/ibm/ibmvnic.c
diff --cc drivers/net/ethernet/ibm/ibmvnic.c
index 3ffc3a7c0eee,53b309ddc63b..000000000000
--- a/drivers/net/ethernet/ibm/ibmvnic.c
+++ b/drivers/net/ethernet/ibm/ibmvnic.c
@@@ -2405,8 -2612,7 +2409,12 @@@ early_exit
  		netif_stop_subqueue(netdev, queue_num);
  	}
  
++<<<<<<< HEAD
 +	tx_packets++;
 +	tx_bytes += skblen;
++=======
+ 	tx_bytes += skb->len;
++>>>>>>> 2ee73c54a615 (ibmvnic: Add stat for tx direct vs tx batched)
  	txq_trans_cond_update(txq);
  	ret = NETDEV_TX_OK;
  	goto out;
@@@ -3620,43 -3803,35 +3629,73 @@@ static void ibmvnic_get_strings(struct 
  	struct ibmvnic_adapter *adapter = netdev_priv(dev);
  	int i;
  
 -	if (stringset != ETH_SS_STATS)
 +	switch (stringset) {
 +	case ETH_SS_STATS:
 +		for (i = 0; i < ARRAY_SIZE(ibmvnic_stats);
 +				i++, data += ETH_GSTRING_LEN)
 +			memcpy(data, ibmvnic_stats[i].name, ETH_GSTRING_LEN);
 +
 +		for (i = 0; i < adapter->req_tx_queues; i++) {
 +			snprintf(data, ETH_GSTRING_LEN, "tx%d_packets", i);
 +			data += ETH_GSTRING_LEN;
 +
 +			snprintf(data, ETH_GSTRING_LEN, "tx%d_bytes", i);
 +			data += ETH_GSTRING_LEN;
 +
 +			snprintf(data, ETH_GSTRING_LEN,
 +				 "tx%d_dropped_packets", i);
 +			data += ETH_GSTRING_LEN;
 +		}
 +
 +		for (i = 0; i < adapter->req_rx_queues; i++) {
 +			snprintf(data, ETH_GSTRING_LEN, "rx%d_packets", i);
 +			data += ETH_GSTRING_LEN;
 +
 +			snprintf(data, ETH_GSTRING_LEN, "rx%d_bytes", i);
 +			data += ETH_GSTRING_LEN;
 +
 +			snprintf(data, ETH_GSTRING_LEN, "rx%d_interrupts", i);
 +			data += ETH_GSTRING_LEN;
 +		}
 +		break;
 +
 +	case ETH_SS_PRIV_FLAGS:
 +		for (i = 0; i < ARRAY_SIZE(ibmvnic_priv_flags); i++)
 +			strcpy(data + i * ETH_GSTRING_LEN,
 +			       ibmvnic_priv_flags[i]);
 +		break;
 +	default:
  		return;
++<<<<<<< HEAD
++=======
+ 
+ 	for (i = 0; i < ARRAY_SIZE(ibmvnic_stats); i++, data += ETH_GSTRING_LEN)
+ 		memcpy(data, ibmvnic_stats[i].name, ETH_GSTRING_LEN);
+ 
+ 	for (i = 0; i < adapter->req_tx_queues; i++) {
+ 		snprintf(data, ETH_GSTRING_LEN, "tx%d_batched_packets", i);
+ 		data += ETH_GSTRING_LEN;
+ 
+ 		snprintf(data, ETH_GSTRING_LEN, "tx%d_direct_packets", i);
+ 		data += ETH_GSTRING_LEN;
+ 
+ 		snprintf(data, ETH_GSTRING_LEN, "tx%d_bytes", i);
+ 		data += ETH_GSTRING_LEN;
+ 
+ 		snprintf(data, ETH_GSTRING_LEN, "tx%d_dropped_packets", i);
+ 		data += ETH_GSTRING_LEN;
+ 	}
+ 
+ 	for (i = 0; i < adapter->req_rx_queues; i++) {
+ 		snprintf(data, ETH_GSTRING_LEN, "rx%d_packets", i);
+ 		data += ETH_GSTRING_LEN;
+ 
+ 		snprintf(data, ETH_GSTRING_LEN, "rx%d_bytes", i);
+ 		data += ETH_GSTRING_LEN;
+ 
+ 		snprintf(data, ETH_GSTRING_LEN, "rx%d_interrupts", i);
+ 		data += ETH_GSTRING_LEN;
++>>>>>>> 2ee73c54a615 (ibmvnic: Add stat for tx direct vs tx batched)
  	}
  }
  
* Unmerged path drivers/net/ethernet/ibm/ibmvnic.c
diff --git a/drivers/net/ethernet/ibm/ibmvnic.h b/drivers/net/ethernet/ibm/ibmvnic.h
index a145c0d11f64..c4f90d52782c 100644
--- a/drivers/net/ethernet/ibm/ibmvnic.h
+++ b/drivers/net/ethernet/ibm/ibmvnic.h
@@ -177,7 +177,8 @@ struct ibmvnic_statistics {
 
 #define NUM_TX_STATS 3
 struct ibmvnic_tx_queue_stats {
-	u64 packets;
+	u64 batched_packets;
+	u64 direct_packets;
 	u64 bytes;
 	u64 dropped_packets;
 };
