net: mana: Handle unsupported HWC commands

jira KERNEL-216
Rebuild_History Non-Buildable kernel-5.14.0-611.9.1.el9_7
commit-author Erni Sri Satya Vennela <ernis@linux.microsoft.com>
commit ca8ac489ca33c986ff02ee14c3e1c10b86355428
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-5.14.0-611.9.1.el9_7/ca8ac489.failed

If any of the HWC commands are not recognized by the
underlying hardware, the hardware returns the response
header status of -1. Log the information using
netdev_info_once to avoid multiple error logs in dmesg.

	Signed-off-by: Erni Sri Satya Vennela <ernis@linux.microsoft.com>
	Reviewed-by: Haiyang Zhang <haiyangz@microsoft.com>
	Reviewed-by: Shradha Gupta <shradhagupta@linux.microsoft.com>
	Reviewed-by: Saurabh Singh Sengar <ssengar@linux.microsoft.com>
	Reviewed-by: Dipayaan Roy <dipayanroy@linux.microsoft.com>
Link: https://patch.msgid.link/1750144656-2021-5-git-send-email-ernis@linux.microsoft.com
	Signed-off-by: Paolo Abeni <pabeni@redhat.com>

(cherry picked from commit ca8ac489ca33c986ff02ee14c3e1c10b86355428)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/microsoft/mana/mana_en.c
diff --cc drivers/net/ethernet/microsoft/mana/mana_en.c
index c4443583b4f0,5aee7bda1504..000000000000
--- a/drivers/net/ethernet/microsoft/mana/mana_en.c
+++ b/drivers/net/ethernet/microsoft/mana/mana_en.c
@@@ -1161,6 -1238,95 +1164,98 @@@ out
  	return err;
  }
  
++<<<<<<< HEAD
++=======
+ int mana_query_link_cfg(struct mana_port_context *apc)
+ {
+ 	struct net_device *ndev = apc->ndev;
+ 	struct mana_query_link_config_resp resp = {};
+ 	struct mana_query_link_config_req req = {};
+ 	int err;
+ 
+ 	mana_gd_init_req_hdr(&req.hdr, MANA_QUERY_LINK_CONFIG,
+ 			     sizeof(req), sizeof(resp));
+ 
+ 	req.vport = apc->port_handle;
+ 	req.hdr.resp.msg_version = GDMA_MESSAGE_V2;
+ 
+ 	err = mana_send_request(apc->ac, &req, sizeof(req), &resp,
+ 				sizeof(resp));
+ 
+ 	if (err) {
+ 		if (err == -EOPNOTSUPP) {
+ 			netdev_info_once(ndev, "MANA_QUERY_LINK_CONFIG not supported\n");
+ 			return err;
+ 		}
+ 		netdev_err(ndev, "Failed to query link config: %d\n", err);
+ 		return err;
+ 	}
+ 
+ 	err = mana_verify_resp_hdr(&resp.hdr, MANA_QUERY_LINK_CONFIG,
+ 				   sizeof(resp));
+ 
+ 	if (err || resp.hdr.status) {
+ 		netdev_err(ndev, "Failed to query link config: %d, 0x%x\n", err,
+ 			   resp.hdr.status);
+ 		if (!err)
+ 			err = -EOPNOTSUPP;
+ 		return err;
+ 	}
+ 
+ 	if (resp.qos_unconfigured) {
+ 		err = -EINVAL;
+ 		return err;
+ 	}
+ 	apc->speed = resp.link_speed_mbps;
+ 	apc->max_speed = resp.qos_speed_mbps;
+ 	return 0;
+ }
+ 
+ int mana_set_bw_clamp(struct mana_port_context *apc, u32 speed,
+ 		      int enable_clamping)
+ {
+ 	struct mana_set_bw_clamp_resp resp = {};
+ 	struct mana_set_bw_clamp_req req = {};
+ 	struct net_device *ndev = apc->ndev;
+ 	int err;
+ 
+ 	mana_gd_init_req_hdr(&req.hdr, MANA_SET_BW_CLAMP,
+ 			     sizeof(req), sizeof(resp));
+ 	req.vport = apc->port_handle;
+ 	req.link_speed_mbps = speed;
+ 	req.enable_clamping = enable_clamping;
+ 
+ 	err = mana_send_request(apc->ac, &req, sizeof(req), &resp,
+ 				sizeof(resp));
+ 
+ 	if (err) {
+ 		if (err == -EOPNOTSUPP) {
+ 			netdev_info_once(ndev, "MANA_SET_BW_CLAMP not supported\n");
+ 			return err;
+ 		}
+ 		netdev_err(ndev, "Failed to set bandwidth clamp for speed %u, err = %d",
+ 			   speed, err);
+ 		return err;
+ 	}
+ 
+ 	err = mana_verify_resp_hdr(&resp.hdr, MANA_SET_BW_CLAMP,
+ 				   sizeof(resp));
+ 
+ 	if (err || resp.hdr.status) {
+ 		netdev_err(ndev, "Failed to set bandwidth clamp: %d, 0x%x\n", err,
+ 			   resp.hdr.status);
+ 		if (!err)
+ 			err = -EOPNOTSUPP;
+ 		return err;
+ 	}
+ 
+ 	if (resp.qos_unconfigured)
+ 		netdev_info(ndev, "QoS is unconfigured\n");
+ 
+ 	return 0;
+ }
+ 
++>>>>>>> ca8ac489ca33 (net: mana: Handle unsupported HWC commands)
  int mana_create_wq_obj(struct mana_port_context *apc,
  		       mana_handle_t vport,
  		       u32 wq_type, struct mana_obj_spec *wq_spec,
diff --git a/drivers/net/ethernet/microsoft/mana/hw_channel.c b/drivers/net/ethernet/microsoft/mana/hw_channel.c
index 2bdfc3328437..34e32f6a4d3a 100644
--- a/drivers/net/ethernet/microsoft/mana/hw_channel.c
+++ b/drivers/net/ethernet/microsoft/mana/hw_channel.c
@@ -890,6 +890,10 @@ int mana_hwc_send_request(struct hw_channel_context *hwc, u32 req_len,
 	}
 
 	if (ctx->status_code && ctx->status_code != GDMA_STATUS_MORE_ENTRIES) {
+		if (ctx->status_code == GDMA_STATUS_CMD_UNSUPPORTED) {
+			err = -EOPNOTSUPP;
+			goto out;
+		}
 		if (req_msg->req.msg_type != MANA_QUERY_PHY_STAT)
 			dev_err(hwc->dev, "HWC: Failed hw_channel req: 0x%x\n",
 				ctx->status_code);
* Unmerged path drivers/net/ethernet/microsoft/mana/mana_en.c
diff --git a/include/net/mana/gdma.h b/include/net/mana/gdma.h
index bfae59202669..fdf144988cec 100644
--- a/include/net/mana/gdma.h
+++ b/include/net/mana/gdma.h
@@ -10,6 +10,7 @@
 #include "shm_channel.h"
 
 #define GDMA_STATUS_MORE_ENTRIES	0x00000105
+#define GDMA_STATUS_CMD_UNSUPPORTED	0xffffffff
 
 /* Structures labeled with "HW DATA" are exchanged with the hardware. All of
  * them are naturally aligned and hence don't need __packed.
