s390/pci: Refactor arch_setup_msi_irqs()

jira LE-2349
Rebuild_History Non-Buildable kernel-4.18.0-553.40.1.el8_10
commit-author Gerd Bayer <gbayer@linux.ibm.com>
commit 5fd11b96b43708f2f6e3964412c301c1bd20ec0f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-553.40.1.el8_10/5fd11b96.failed

Factor out adapter interrupt allocation from arch_setup_msi_irqs() in
preparation for enabling registration of multiple MSIs. Code movement
only, no change of functionality intended.

	Signed-off-by: Gerd Bayer <gbayer@linux.ibm.com>
	Reviewed-by: Niklas Schnelle <schnelle@linux.ibm.com>
	Signed-off-by: Vasily Gorbik <gor@linux.ibm.com>
(cherry picked from commit 5fd11b96b43708f2f6e3964412c301c1bd20ec0f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/s390/pci/pci_irq.c
diff --cc arch/s390/pci/pci_irq.c
index 192f3b104ae4,979f776b09b8..000000000000
--- a/arch/s390/pci/pci_irq.c
+++ b/arch/s390/pci/pci_irq.c
@@@ -269,25 -268,13 +269,29 @@@ static void zpci_floating_irq_handler(s
  	}
  }
  
- int arch_setup_msi_irqs(struct pci_dev *pdev, int nvec, int type)
+ static int __alloc_airq(struct zpci_dev *zdev, int msi_vecs,
+ 			unsigned long *bit)
  {
++<<<<<<< HEAD
 +	struct zpci_dev *zdev = to_zpci(pdev);
 +	unsigned int hwirq, msi_vecs, cpu;
 +	unsigned long bit;
 +	struct msi_desc *msi;
 +	struct msi_msg msg;
 +	int rc, irq;
 +
 +	zdev->aisb = -1UL;
 +	zdev->msi_first_bit = -1U;
 +	if (type == PCI_CAP_ID_MSI && nvec > 1)
 +		return 1;
 +	msi_vecs = min_t(unsigned int, nvec, zdev->max_msi);
 +
++=======
++>>>>>>> 5fd11b96b437 (s390/pci: Refactor arch_setup_msi_irqs())
  	if (irq_delivery == DIRECTED) {
  		/* Allocate cpu vector bits */
- 		bit = airq_iv_alloc(zpci_ibv[0], msi_vecs);
- 		if (bit == -1UL)
+ 		*bit = airq_iv_alloc(zpci_ibv[0], msi_vecs);
+ 		if (*bit == -1UL)
  			return -EIO;
  	} else {
  		/* Allocate adapter summary indicator bit */
* Unmerged path arch/s390/pci/pci_irq.c
