s390/pci: Fix duplicate pci_dev_put() in disable_slot() when PF has child VFs

jira LE-4018
cve CVE-2025-37946
Rebuild_History Non-Buildable kernel-5.14.0-570.39.1.el9_6
commit-author Niklas Schnelle <schnelle@linux.ibm.com>
commit 05a2538f2b48500cf4e8a0a0ce76623cc5bafcf1
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-5.14.0-570.39.1.el9_6/05a2538f.failed

With commit bcb5d6c76903 ("s390/pci: introduce lock to synchronize state
of zpci_dev's") the code to ignore power off of a PF that has child VFs
was changed from a direct return to a goto to the unlock and
pci_dev_put() section. The change however left the existing pci_dev_put()
untouched resulting in a doubple put. This can subsequently cause a use
after free if the struct pci_dev is released in an unexpected state.
Fix this by removing the extra pci_dev_put().

	Cc: stable@vger.kernel.org
Fixes: bcb5d6c76903 ("s390/pci: introduce lock to synchronize state of zpci_dev's")
	Signed-off-by: Niklas Schnelle <schnelle@linux.ibm.com>
	Reviewed-by: Gerd Bayer <gbayer@linux.ibm.com>
	Signed-off-by: Heiko Carstens <hca@linux.ibm.com>
(cherry picked from commit 05a2538f2b48500cf4e8a0a0ce76623cc5bafcf1)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/pci/hotplug/s390_pci_hpc.c
diff --cc drivers/pci/hotplug/s390_pci_hpc.c
index a89b7de72dcf,e9e9aaa91770..000000000000
--- a/drivers/pci/hotplug/s390_pci_hpc.c
+++ b/drivers/pci/hotplug/s390_pci_hpc.c
@@@ -49,12 -59,16 +49,17 @@@ static int disable_slot(struct hotplug_
  
  	pdev = pci_get_slot(zdev->zbus->bus, zdev->devfn);
  	if (pdev && pci_num_vf(pdev)) {
++<<<<<<< HEAD
 +		pci_dev_put(pdev);
 +		return -EBUSY;
++=======
+ 		rc = -EBUSY;
+ 		goto out;
++>>>>>>> 05a2538f2b48 (s390/pci: Fix duplicate pci_dev_put() in disable_slot() when PF has child VFs)
  	}
 +	pci_dev_put(pdev);
  
 -	rc = zpci_deconfigure_device(zdev);
 -out:
 -	mutex_unlock(&zdev->state_lock);
 -	if (pdev)
 -		pci_dev_put(pdev);
 -	return rc;
 +	return zpci_deconfigure_device(zdev);
  }
  
  static int reset_slot(struct hotplug_slot *hotplug_slot, bool probe)
* Unmerged path drivers/pci/hotplug/s390_pci_hpc.c
