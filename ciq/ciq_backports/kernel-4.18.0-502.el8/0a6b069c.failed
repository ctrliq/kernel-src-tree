net/mlx5e: Fix error flow in representor failing to add vport rx rule

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-502.el8
commit-author Roi Dayan <roid@nvidia.com>
commit 0a6b069cc60d68d33b4f6e7dd7f1adc3ec749766
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-502.el8/0a6b069c.failed

On representor init rx error flow the flow steering pointer is being
released so mlx5e_attach_netdev() doesn't have a valid fs pointer
in its error flow. Make sure the pointer is nullified when released
and add a check in mlx5e_fs_cleanup() to verify fs is not null
as representor cleanup callback would be called anyway.

Fixes: af8bbf730068 ("net/mlx5e: Convert mlx5e_flow_steering member of mlx5e_priv to pointer")
	Signed-off-by: Roi Dayan <roid@nvidia.com>
	Reviewed-by: Maor Dickman <maord@nvidia.com>
	Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
(cherry picked from commit 0a6b069cc60d68d33b4f6e7dd7f1adc3ec749766)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/en_fs.c
#	drivers/net/ethernet/mellanox/mlx5/core/en_rep.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_fs.c
index 6768f21c4eb1,f1dac0244958..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_fs.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_fs.c
@@@ -1406,6 -1490,10 +1406,13 @@@ err
  
  void mlx5e_fs_cleanup(struct mlx5e_flow_steering *fs)
  {
++<<<<<<< HEAD
++=======
+ 	if (!fs)
+ 		return;
+ 	debugfs_remove_recursive(fs->dfs_root);
+ 	mlx5e_fs_ethtool_free(fs);
++>>>>>>> 0a6b069cc60d (net/mlx5e: Fix error flow in representor failing to add vport rx rule)
  	mlx5e_fs_tc_free(fs);
  	mlx5e_fs_vlan_free(fs);
  	kvfree(fs);
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_rep.c
index 7c0eb504ee7f,6e18d91c3d76..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_rep.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_rep.c
@@@ -837,7 -828,7 +837,11 @@@ static int mlx5e_init_ul_rep(struct mlx
  static void mlx5e_cleanup_rep(struct mlx5e_priv *priv)
  {
  	mlx5e_fs_cleanup(priv->fs);
++<<<<<<< HEAD
 +	mlx5e_ipsec_cleanup(priv);
++=======
+ 	priv->fs = NULL;
++>>>>>>> 0a6b069cc60d (net/mlx5e: Fix error flow in representor failing to add vport rx rule)
  }
  
  static int mlx5e_create_rep_ttc_table(struct mlx5e_priv *priv)
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_fs.c
diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en_main.c b/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
index 7c2ae6235103..94ba09c66b5c 100644
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
@@ -5108,6 +5108,7 @@ static void mlx5e_nic_cleanup(struct mlx5e_priv *priv)
 	mlx5e_ktls_cleanup(priv);
 	mlx5e_ipsec_cleanup(priv);
 	mlx5e_fs_cleanup(priv->fs);
+	priv->fs = NULL;
 }
 
 static int mlx5e_init_nic_rx(struct mlx5e_priv *priv)
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_rep.c
