r8152: adjust the flow of power cut for RTL8153B

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-502.el8
commit-author Hayes Wang <hayeswang@realtek.com>
commit 80fd850b31f09263ad175b2f640d5c5c6f76ed41
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-502.el8/80fd850b.failed

For runtime resuming, the RTL8153B may be resumed from the state
of power cut, when enabling the feature of UPS. Then, the PHY
would be reset, so it is necessary to be initailized again.

Besides, the USB_U1U2_TIMER also has to be set again, so I move
it from r8153b_init() to r8153b_hw_phy_cfg().

	Signed-off-by: Hayes Wang <hayeswang@realtek.com>
	Signed-off-by: Jakub Kicinski <kuba@kernel.org>
(cherry picked from commit 80fd850b31f09263ad175b2f640d5c5c6f76ed41)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/usb/r8152.c
diff --cc drivers/net/usb/r8152.c
index 0ee22626dddf,2d7cc63bef89..000000000000
--- a/drivers/net/usb/r8152.c
+++ b/drivers/net/usb/r8152.c
@@@ -3210,31 -3216,20 +3212,36 @@@ static void r8153b_ups_en(struct r8152 
  		ocp_data &= ~BIT(0);
  		ocp_write_byte(tp, MCU_TYPE_USB, 0xcfff, ocp_data);
  
- 		ocp_data = ocp_read_word(tp, MCU_TYPE_USB, USB_MISC_0);
- 		ocp_data &= ~PCUT_STATUS;
- 		ocp_write_word(tp, MCU_TYPE_USB, USB_MISC_0, ocp_data);
+ 		if (ocp_read_word(tp, MCU_TYPE_USB, USB_MISC_0) & PCUT_STATUS) {
+ 			int i;
  
- 		data = r8153_phy_status(tp, 0);
+ 			for (i = 0; i < 500; i++) {
+ 				if (ocp_read_word(tp, MCU_TYPE_PLA, PLA_BOOT_CTRL) &
+ 				    AUTOLOAD_DONE)
+ 					break;
+ 				msleep(20);
+ 			}
  
- 		switch (data) {
- 		case PHY_STAT_PWRDN:
- 		case PHY_STAT_EXT_INIT:
- 			r8153b_green_en(tp,
- 					test_bit(GREEN_ETHERNET, &tp->flags));
+ 			tp->rtl_ops.hw_phy_cfg(tp);
  
++<<<<<<< HEAD
 +			data = r8152_mdio_read(tp, MII_BMCR);
 +			data &= ~BMCR_PDOWN;
 +			data |= BMCR_RESET;
 +			r8152_mdio_write(tp, MII_BMCR, data);
 +
 +			data = r8153_phy_status(tp, PHY_STAT_LAN_ON);
 +			/* fall through */
 +
 +		default:
 +			if (data != PHY_STAT_LAN_ON)
 +				netif_warn(tp, link, tp->netdev,
 +					   "PHY not ready");
 +			break;
++=======
+ 			rtl8152_set_speed(tp, tp->autoneg, tp->speed,
+ 					  tp->duplex, tp->advertising);
++>>>>>>> 80fd850b31f0 (r8152: adjust the flow of power cut for RTL8153B)
  		}
  	}
  }
* Unmerged path drivers/net/usb/r8152.c
