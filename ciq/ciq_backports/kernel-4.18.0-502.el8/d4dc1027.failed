arm64: Convert cpu_do_idle() to using cpuidle context helpers

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-502.el8
commit-author Marc Zyngier <maz@kernel.org>
commit d4dc10277255afc303de4f00cbee0b9ce74d870f
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-502.el8/d4dc1027.failed

Now that we have helpers that are aware of the pseudo-NMI
feature, introduce them to cpu_do_idle(). This allows for
some nice cleanup.

No functional change intended.

	Tested-by: Valentin Schneider <valentin.schneider@arm.com>
	Reviewed-by: Lorenzo Pieralisi <lorenzo.pieralisi@arm.com>
	Signed-off-by: Marc Zyngier <maz@kernel.org>
Link: https://lore.kernel.org/r/20210615111227.2454465-3-maz@kernel.org
	Signed-off-by: Will Deacon <will@kernel.org>
(cherry picked from commit d4dc10277255afc303de4f00cbee0b9ce74d870f)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/arm64/kernel/process.c
diff --cc arch/arm64/kernel/process.c
index e5d7925d7a3a,b715c6b2558f..000000000000
--- a/arch/arm64/kernel/process.c
+++ b/arch/arm64/kernel/process.c
@@@ -79,33 -74,6 +79,36 @@@ EXPORT_SYMBOL_GPL(pm_power_off)
  
  void (*arm_pm_restart)(enum reboot_mode reboot_mode, const char *cmd);
  
++<<<<<<< HEAD
 +static void noinstr __cpu_do_idle(void)
 +{
 +	dsb(sy);
 +	wfi();
 +}
 +
 +static void noinstr __cpu_do_idle_irqprio(void)
 +{
 +	unsigned long pmr;
 +	unsigned long daif_bits;
 +
 +	daif_bits = read_sysreg(daif);
 +	write_sysreg(daif_bits | PSR_I_BIT, daif);
 +
 +	/*
 +	 * Unmask PMR before going idle to make sure interrupts can
 +	 * be raised.
 +	 */
 +	pmr = gic_read_pmr();
 +	gic_write_pmr(GIC_PRIO_IRQON | GIC_PRIO_PSR_I_SET);
 +
 +	__cpu_do_idle();
 +
 +	gic_write_pmr(pmr);
 +	write_sysreg(daif_bits, daif);
 +}
 +
++=======
++>>>>>>> d4dc10277255 (arm64: Convert cpu_do_idle() to using cpuidle context helpers)
  /*
   *	cpu_do_idle()
   *
* Unmerged path arch/arm64/kernel/process.c
