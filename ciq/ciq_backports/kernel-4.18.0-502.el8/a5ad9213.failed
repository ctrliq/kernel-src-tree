x86/microcode/AMD: Add a @cpu parameter to the reloading functions

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-502.el8
commit-author Borislav Petkov (AMD) <bp@alien8.de>
commit a5ad92134bd153a9ccdcddf09a95b088f36c3cce
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-502.el8/a5ad9213.failed

Will be used in a subsequent change.

	Signed-off-by: Borislav Petkov (AMD) <bp@alien8.de>
Link: https://lore.kernel.org/r/20230130161709.11615-3-bp@alien8.de
(cherry picked from commit a5ad92134bd153a9ccdcddf09a95b088f36c3cce)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/include/asm/microcode.h
#	arch/x86/kernel/cpu/microcode/core.c
diff --cc arch/x86/include/asm/microcode.h
index e1ebd9e7c880,320566a0443d..000000000000
--- a/arch/x86/include/asm/microcode.h
+++ b/arch/x86/include/asm/microcode.h
@@@ -126,15 -125,14 +126,24 @@@ static inline unsigned int x86_cpuid_fa
  #ifdef CONFIG_MICROCODE
  extern void __init load_ucode_bsp(void);
  extern void load_ucode_ap(void);
++<<<<<<< HEAD
 +void reload_early_microcode(void);
 +extern bool get_builtin_firmware(struct cpio_data *cd, const char *name);
++=======
+ void reload_early_microcode(unsigned int cpu);
++>>>>>>> a5ad92134bd1 (x86/microcode/AMD: Add a @cpu parameter to the reloading functions)
  extern bool initrd_gone;
 -void microcode_bsp_resume(void);
  #else
  static inline void __init load_ucode_bsp(void)			{ }
  static inline void load_ucode_ap(void)				{ }
++<<<<<<< HEAD
 +static inline void reload_early_microcode(void)			{ }
 +static inline bool
 +get_builtin_firmware(struct cpio_data *cd, const char *name)	{ return false; }
++=======
+ static inline void reload_early_microcode(unsigned int cpu)	{ }
+ static inline void microcode_bsp_resume(void)			{ }
++>>>>>>> a5ad92134bd1 (x86/microcode/AMD: Add a @cpu parameter to the reloading functions)
  #endif
  
  #endif /* _ASM_X86_MICROCODE_H */
diff --cc arch/x86/kernel/cpu/microcode/core.c
index 9e6f4deb9020,ddc0958428a5..000000000000
--- a/arch/x86/kernel/cpu/microcode/core.c
+++ b/arch/x86/kernel/cpu/microcode/core.c
@@@ -787,10 -561,10 +787,15 @@@ static void mc_bp_resume(void
  	int cpu = smp_processor_id();
  	struct ucode_cpu_info *uci = ucode_cpu_info + cpu;
  
 -	if (uci->mc)
 +	if (uci->valid && uci->mc)
  		microcode_ops->apply_microcode(cpu);
++<<<<<<< HEAD
 +	else if (!uci->mc)
 +		reload_early_microcode();
++=======
+ 	else
+ 		reload_early_microcode(cpu);
++>>>>>>> a5ad92134bd1 (x86/microcode/AMD: Add a @cpu parameter to the reloading functions)
  }
  
  static struct syscore_ops mc_syscore_ops = {
* Unmerged path arch/x86/include/asm/microcode.h
diff --git a/arch/x86/include/asm/microcode_amd.h b/arch/x86/include/asm/microcode_amd.h
index 7063b5a43220..a645b25ee442 100644
--- a/arch/x86/include/asm/microcode_amd.h
+++ b/arch/x86/include/asm/microcode_amd.h
@@ -47,12 +47,12 @@ struct microcode_amd {
 extern void __init load_ucode_amd_bsp(unsigned int family);
 extern void load_ucode_amd_ap(unsigned int family);
 extern int __init save_microcode_in_initrd_amd(unsigned int family);
-void reload_ucode_amd(void);
+void reload_ucode_amd(unsigned int cpu);
 #else
 static inline void __init load_ucode_amd_bsp(unsigned int family) {}
 static inline void load_ucode_amd_ap(unsigned int family) {}
 static inline int __init
 save_microcode_in_initrd_amd(unsigned int family) { return -EINVAL; }
-static inline void reload_ucode_amd(void) {}
+static inline void reload_ucode_amd(unsigned int cpu) {}
 #endif
 #endif /* _ASM_X86_MICROCODE_AMD_H */
diff --git a/arch/x86/kernel/cpu/microcode/amd.c b/arch/x86/kernel/cpu/microcode/amd.c
index ad109e7f2da6..f1edf5edbc81 100644
--- a/arch/x86/kernel/cpu/microcode/amd.c
+++ b/arch/x86/kernel/cpu/microcode/amd.c
@@ -572,7 +572,7 @@ int __init save_microcode_in_initrd_amd(unsigned int cpuid_1_eax)
 	return 0;
 }
 
-void reload_ucode_amd(void)
+void reload_ucode_amd(unsigned int cpu)
 {
 	struct microcode_amd *mc;
 	u32 rev, dummy __always_unused;
* Unmerged path arch/x86/kernel/cpu/microcode/core.c
