x86/microcode: Do not select FW_LOADER

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-502.el8
commit-author Herbert Xu <herbert@gondor.apana.org.au>
commit c8a59a4d8e3c9e609fa915e39c3628c6dd08aeea
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-502.el8/c8a59a4d.failed

The x86 microcode support works just fine without FW_LOADER. In fact,
these days most people load microcode early during boot so FW_LOADER
never gets into the picture anyway.

As almost everyone on x86 needs to enable MICROCODE, this by extension
means that FW_LOADER is always built into the kernel even if nothing
uses it. The FW_LOADER system is about two thousand lines long and
contains user-space facing interfaces that could potentially provide an
entry point into the kernel (or beyond).

Remove the unnecessary select of FW_LOADER by MICROCODE. People who need
the FW_LOADER capability can still enable it.

 [ bp: Massage a bit. ]

	Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
	Signed-off-by: Borislav Petkov <bp@suse.de>
Link: https://lkml.kernel.org/r/20200610042911.GA20058@gondor.apana.org.au
(cherry picked from commit c8a59a4d8e3c9e609fa915e39c3628c6dd08aeea)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	arch/x86/Kconfig
diff --cc arch/x86/Kconfig
index f26d1d596e9a,5c44eacca449..000000000000
--- a/arch/x86/Kconfig
+++ b/arch/x86/Kconfig
@@@ -1321,8 -1292,7 +1321,12 @@@ config MICROCOD
  	bool "CPU microcode loading support"
  	default y
  	depends on CPU_SUP_AMD || CPU_SUP_INTEL
++<<<<<<< HEAD
 +	select FW_LOADER
 +	---help---
++=======
+ 	help
++>>>>>>> c8a59a4d8e3c (x86/microcode: Do not select FW_LOADER)
  	  If you say Y here, you will be able to update the microcode on
  	  Intel and AMD processors. The Intel support is for the IA32 family,
  	  e.g. Pentium Pro, Pentium II, Pentium III, Pentium 4, Xeon etc. The
@@@ -1343,8 -1313,7 +1347,12 @@@ config MICROCODE_INTE
  	bool "Intel microcode loading support"
  	depends on MICROCODE
  	default MICROCODE
++<<<<<<< HEAD
 +	select FW_LOADER
 +	---help---
++=======
+ 	help
++>>>>>>> c8a59a4d8e3c (x86/microcode: Do not select FW_LOADER)
  	  This options enables microcode patch loading support for Intel
  	  processors.
  
@@@ -1355,8 -1324,7 +1363,12 @@@
  config MICROCODE_AMD
  	bool "AMD microcode loading support"
  	depends on MICROCODE
++<<<<<<< HEAD
 +	select FW_LOADER
 +	---help---
++=======
+ 	help
++>>>>>>> c8a59a4d8e3c (x86/microcode: Do not select FW_LOADER)
  	  If you select this option, microcode patch loading support for AMD
  	  processors will be enabled.
  
* Unmerged path arch/x86/Kconfig
diff --git a/arch/x86/kernel/cpu/microcode/core.c b/arch/x86/kernel/cpu/microcode/core.c
index f1a4c64d7a20..312933a76490 100644
--- a/arch/x86/kernel/cpu/microcode/core.c
+++ b/arch/x86/kernel/cpu/microcode/core.c
@@ -145,7 +145,6 @@ extern struct builtin_fw __end_builtin_fw[];
 
 bool get_builtin_firmware(struct cpio_data *cd, const char *name)
 {
-#ifdef CONFIG_FW_LOADER
 	struct builtin_fw *b_fw;
 
 	for (b_fw = __start_builtin_fw; b_fw != __end_builtin_fw; b_fw++) {
@@ -155,7 +154,6 @@ bool get_builtin_firmware(struct cpio_data *cd, const char *name)
 			return true;
 		}
 	}
-#endif
 	return false;
 }
 
