drm/amd/display: Add missing WA and MCLK validation

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-502.el8
commit-author Rodrigo Siqueira <Rodrigo.Siqueira@amd.com>
commit e0a77e09c707cf89317de00f87b94b1168f27acd
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-502.el8/e0a77e09.failed

When the commit fff7eb56b376 ("drm/amd/display: Don't set dram clock
change requirement for SubVP") was merged, we missed some parts
associated with the MCLK switch. This commit adds all the missing parts.

Fixes: fff7eb56b376 ("drm/amd/display: Don't set dram clock change requirement for SubVP")
	Reviewed-by: Aurabindo Pillai <aurabindo.pillai@amd.com>
	Signed-off-by: Rodrigo Siqueira <Rodrigo.Siqueira@amd.com>
	Tested-by: Daniel Wheeler <daniel.wheeler@amd.com>
	Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
(cherry picked from commit e0a77e09c707cf89317de00f87b94b1168f27acd)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/gpu/drm/amd/display/dc/dml/dcn30/dcn30_fpu.c
diff --cc drivers/gpu/drm/amd/display/dc/dml/dcn30/dcn30_fpu.c
index e1e92daba668,a352c703e258..000000000000
--- a/drivers/gpu/drm/amd/display/dc/dml/dcn30/dcn30_fpu.c
+++ b/drivers/gpu/drm/amd/display/dc/dml/dcn30/dcn30_fpu.c
@@@ -520,9 -565,21 +522,26 @@@ void dcn30_fpu_calculate_wm_and_dlg
  		pipe_idx++;
  	}
  
++<<<<<<< HEAD
 +	DC_FP_START();
++=======
+ 	// WA: restrict FPO to use first non-strobe mode (NV24 BW issue)
+ 	if (context->bw_ctx.bw.dcn.clk.fw_based_mclk_switching &&
+ 			dc->dml.soc.num_chans <= 4 &&
+ 			context->bw_ctx.dml.vba.DRAMSpeed <= 1700 &&
+ 			context->bw_ctx.dml.vba.DRAMSpeed >= 1500) {
+ 
+ 		for (i = 0; i < dc->dml.soc.num_states; i++) {
+ 			if (dc->dml.soc.clock_limits[i].dram_speed_mts > 1700) {
+ 				context->bw_ctx.dml.vba.DRAMSpeed = dc->dml.soc.clock_limits[i].dram_speed_mts;
+ 				break;
+ 			}
+ 		}
+ 	}
+ 
++>>>>>>> e0a77e09c707 (drm/amd/display: Add missing WA and MCLK validation)
  	dcn20_calculate_dlg_params(dc, context, pipes, pipe_cnt, vlevel);
 +	DC_FP_END();
  
  	if (!pstate_en)
  		/* Restore full p-state latency */
diff --git a/drivers/gpu/drm/amd/display/dc/dcn32/dcn32_hwseq.c b/drivers/gpu/drm/amd/display/dc/dcn32/dcn32_hwseq.c
index 3128c111c619..8286c4a18fb1 100644
--- a/drivers/gpu/drm/amd/display/dc/dcn32/dcn32_hwseq.c
+++ b/drivers/gpu/drm/amd/display/dc/dcn32/dcn32_hwseq.c
@@ -985,6 +985,7 @@ void dcn32_init_hw(struct dc *dc)
 	if (dc->ctx->dmub_srv) {
 		dc_dmub_srv_query_caps_cmd(dc->ctx->dmub_srv->dmub);
 		dc->caps.dmub_caps.psr = dc->ctx->dmub_srv->dmub->feature_caps.psr;
+		dc->caps.dmub_caps.mclk_sw = dc->ctx->dmub_srv->dmub->feature_caps.fw_assisted_mclk_switch;
 	}
 
 	/* Enable support for ODM and windowed MPO if policy flag is set */
diff --git a/drivers/gpu/drm/amd/display/dc/dcn32/dcn32_resource.c b/drivers/gpu/drm/amd/display/dc/dcn32/dcn32_resource.c
index 6f1bcb45a3b2..83daa2adcc3b 100644
--- a/drivers/gpu/drm/amd/display/dc/dcn32/dcn32_resource.c
+++ b/drivers/gpu/drm/amd/display/dc/dcn32/dcn32_resource.c
@@ -1938,7 +1938,7 @@ int dcn32_populate_dml_pipes_from_context(
 	// In general cases we want to keep the dram clock change requirement
 	// (prefer configs that support MCLK switch). Only override to false
 	// for SubVP
-	if (subvp_in_use)
+	if (context->bw_ctx.bw.dcn.clk.fw_based_mclk_switching || subvp_in_use)
 		context->bw_ctx.dml.soc.dram_clock_change_requirement_final = false;
 	else
 		context->bw_ctx.dml.soc.dram_clock_change_requirement_final = true;
* Unmerged path drivers/gpu/drm/amd/display/dc/dml/dcn30/dcn30_fpu.c
