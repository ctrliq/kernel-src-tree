net/mlx5e: Move Ethernet driver debugfs to profile init callback

jira LE-1907
Rebuild_History Non-Buildable kernel-4.18.0-502.el8
commit-author Jianbo Liu <jianbol@nvidia.com>
commit c4c24fc30cc417ace332ceceaba4f70f81dcd521
Empty-Commit: Cherry-Pick Conflicts during history rebuild.
Will be included in final tarball splat. Ref for failed cherry-pick at:
ciq/ciq_backports/kernel-4.18.0-502.el8/c4c24fc3.failed

As priv->dfs_root is cleared, and therefore missed, when change
eswitch mode, move the creation of the root debugfs to the init
callback of mlx5e_nic_profile and mlx5e_uplink_rep_profile, and
the destruction to the cleanup callback for symmeter.

Fixes: 288eca60cc31 ("net/mlx5e: Add Ethernet driver debugfs")
	Signed-off-by: Jianbo Liu <jianbol@nvidia.com>
	Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
(cherry picked from commit c4c24fc30cc417ace332ceceaba4f70f81dcd521)
	Signed-off-by: Jonathan Maple <jmaple@ciq.com>

# Conflicts:
#	drivers/net/ethernet/mellanox/mlx5/core/en_main.c
#	drivers/net/ethernet/mellanox/mlx5/core/en_rep.c
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_main.c
index 7c2ae6235103,a7c526ee5024..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_main.c
@@@ -5071,8 -5261,12 +5071,11 @@@ static int mlx5e_nic_init(struct mlx5_c
  
  	mlx5e_timestamp_init(priv);
  
+ 	priv->dfs_root = debugfs_create_dir("nic",
+ 					    mlx5_debugfs_get_dev_root(mdev));
+ 
  	fs = mlx5e_fs_init(priv->profile, mdev,
 -			   !test_bit(MLX5E_STATE_DESTROYING, &priv->state),
 -			   priv->dfs_root);
 +			   !test_bit(MLX5E_STATE_DESTROYING, &priv->state));
  	if (!fs) {
  		err = -ENOMEM;
  		mlx5_core_err(mdev, "FS initialization failed, %d\n", err);
@@@ -5101,13 -5288,11 +5105,18 @@@
  
  static void mlx5e_nic_cleanup(struct mlx5e_priv *priv)
  {
 -	mlx5e_health_destroy_reporters(priv);
 +	/* RHEL-only: Disable 'devlink port' support for non-switchdev mode*/
 +	if (!mlx5_core_is_sf(priv->mdev))
 +		mlx5e_health_destroy_reporters(priv);
 +	mlx5e_devlink_port_unregister(priv);
  	mlx5e_ktls_cleanup(priv);
 +	mlx5e_ipsec_cleanup(priv);
  	mlx5e_fs_cleanup(priv->fs);
++<<<<<<< HEAD
++=======
+ 	debugfs_remove_recursive(priv->dfs_root);
+ 	priv->fs = NULL;
++>>>>>>> c4c24fc30cc4 (net/mlx5e: Move Ethernet driver debugfs to profile init callback)
  }
  
  static int mlx5e_init_nic_rx(struct mlx5e_priv *priv)
@@@ -5779,6 -6015,7 +5788,10 @@@ static int mlx5e_probe(struct auxiliary
  
  	priv->profile = profile;
  	priv->ppriv = NULL;
++<<<<<<< HEAD
++=======
+ 
++>>>>>>> c4c24fc30cc4 (net/mlx5e: Move Ethernet driver debugfs to profile init callback)
  	err = profile->init(mdev, netdev);
  	if (err) {
  		mlx5_core_err(mdev, "mlx5e_nic_profile init failed, %d\n", err);
diff --cc drivers/net/ethernet/mellanox/mlx5/core/en_rep.c
index 7c0eb504ee7f,3e7041bd5705..000000000000
--- a/drivers/net/ethernet/mellanox/mlx5/core/en_rep.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_rep.c
@@@ -815,12 -812,16 +816,16 @@@ static int mlx5e_init_ul_rep(struct mlx
  			     struct net_device *netdev)
  {
  	struct mlx5e_priv *priv = netdev_priv(netdev);
 +	int err;
  
+ 	priv->dfs_root = debugfs_create_dir("nic",
+ 					    mlx5_debugfs_get_dev_root(mdev));
+ 
  	priv->fs = mlx5e_fs_init(priv->profile, mdev,
 -				 !test_bit(MLX5E_STATE_DESTROYING, &priv->state),
 -				 priv->dfs_root);
 +				 !test_bit(MLX5E_STATE_DESTROYING, &priv->state));
  	if (!priv->fs) {
  		netdev_err(priv->netdev, "FS allocation failed\n");
+ 		debugfs_remove_recursive(priv->dfs_root);
  		return -ENOMEM;
  	}
  
@@@ -837,7 -834,8 +842,12 @@@
  static void mlx5e_cleanup_rep(struct mlx5e_priv *priv)
  {
  	mlx5e_fs_cleanup(priv->fs);
++<<<<<<< HEAD
 +	mlx5e_ipsec_cleanup(priv);
++=======
+ 	debugfs_remove_recursive(priv->dfs_root);
+ 	priv->fs = NULL;
++>>>>>>> c4c24fc30cc4 (net/mlx5e: Move Ethernet driver debugfs to profile init callback)
  }
  
  static int mlx5e_create_rep_ttc_table(struct mlx5e_priv *priv)
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_main.c
* Unmerged path drivers/net/ethernet/mellanox/mlx5/core/en_rep.c
